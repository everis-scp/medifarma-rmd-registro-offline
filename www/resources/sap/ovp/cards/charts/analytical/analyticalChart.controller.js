sap.ui.define(["sap/ovp/cards/generic/Card.controller","sap/ovp/cards/charts/VizAnnotationManager","sap/viz/ui5/data/FlattenedDataset","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/app/resources","sap/base/util/each","sap/ovp/cards/ovpLogger","sap/ovp/app/FilterHelper"],function(C,V,F,O,a,b,o,c){"use strict";var l=new o("OVP.analytical.analyticalChart");return C.extend("sap.ovp.cards.charts.analytical.analyticalChart",{onInit:function(){C.prototype.onInit.apply(this,arguments);V.formatChartAxes();var t=this;this.eventhandler=function(s,E,f){var d=t.getEntityType();var g=t.oMainComponent.getMDCFilter();var h=g.getModel();var i=t.getView().getController().getModel();if(d&&h){var r=c.getEntityRelevantFilters(d,f,i,h);var A=c.mergeFilters(r,t.selectionVaraintFilter);try{t.getCardItemsBinding().filter(A);if(t.getKPIBinding()){t.getKPIBinding().filter(A);}}catch(e){l.error(e);}}};this.GloabalEventBus=sap.ui.getCore().getEventBus();if(this.oMainComponent&&this.oMainComponent.isMDCFilter&&this.oCardComponentData&&this.oCardComponentData.mainComponent){this.GloabalEventBus.subscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",t.eventhandler);}},onBeforeRendering:function(){if(this.bCardProcessed){return;}V.validateCardConfiguration(this);var v=this.getView().byId("analyticalChart");var d=this.getOwnerComponent().getComponentData();if(v){v.setHeight("21rem");}if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"&&d&&d.appComponent){var D=d.appComponent.getDashboardLayoutUtil();var e=D.dashboardLayoutModel.getCardById(d.cardId);if(e.dashboardLayout.autoSpan&&v){v.setHeight("21rem");}}var f=this.getView().byId("vbLayout");var n;var i=false;var g=new F({data:{path:"/"}});this.isVizPropSet=i;this.oDataSet=g;this.vizFrame=v;this.vbLayout=f;if(!v){l.error(V.constants.ERROR_NO_CHART+": ("+this.getView().getId()+")");}else{this.vbLayout.setBusy(true);n=v.getModel('ovpCardProperties').getProperty("/navigation");if(n===undefined||n=="datapointNav"||n!="headerNav"){V.getSelectedDataPoint(v,this);}v.destroyDataset();var h=v.getParent().getBinding("data");this._handleKPIHeader();if(h&&h.getPath()){h.attachDataReceived(this.onDataReceived.bind(this));h.attachDataRequested(this.onDataRequested.bind(this));}else{var j=sap.ui.xmlfragment("sap.ovp.cards.charts.generic.noData");var k=this.getCardContentContainer();k.removeAllItems();k.addItem(j);}v.addEventDelegate({onmouseover:function(){var m=v._oOvpVizFrameTooltip;if(m){m._oPopup.close();}}});}this.bCardProcessed=true;},onAfterRendering:function(){C.prototype.onAfterRendering.apply(this,arguments);if(!O.checkIfAPIIsUsed(this)&&this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var d=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var s=this.oDashboardLayoutUtil.getCardDomId(this.cardId);var e=document.getElementById(s);var h=this.getHeaderHeight();if(!d.dashboardLayout.autoSpan){if(e){var f=e.getElementsByClassName('sapOvpWrapper')[0];if(f){f.style.height=d.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(h+2*this.oDashboardLayoutUtil.CARD_BORDER_PX)+"px";}}}if(d.dashboardLayout.showOnlyHeader){e.classList.add("sapOvpMinHeightContainer");}var v=this.getView().byId("analyticalChart");if(v){v.setHeight(this._calculateVizFrameHeight()+"px");}}},onDataReceived:function(e){var t=this;var d=this.getView().byId("analyticalChart");var f=this.getView().byId("bubbleText");var g=this.getView().byId("ovpCT");var h=a.getText("BUBBLESIZE");this.oDataSet.bindData("analyticalmodel>/","");d.setDataset(this.oDataSet);var j=d.getParent();if(!this.isVizPropSet){V.buildVizAttributes(d,j,g,this);this.isVizPropSet=true;if(f!=undefined){var k=d.getFeeds();b(k,function(i,v){if(k[i].getUid()=="bubbleWidth"){f.setText(h+" "+k[i].getValues());}});}V.hideDateTimeAxis(d);}if(this.getCardPropertiesModel()&&this.getCardPropertiesModel().getData()&&this.getCardPropertiesModel().getData().colorPalette&&(d.getVizType()==="stacked_column")){var p=d.getDataset().getDimensions(),q=d.getFeeds(),r,s;for(var m=0;m<q.length;m++){if(q[m].getUid()==="color"){r=q[m].getValues()[0];break;}}for(var n=0;n<p.length;n++){if(p[n].getName()===r){s=p[n];break;}}if(r&&s){var u={};u["bDescending"]=true;s.setSorter(u);}}var w=this.getView().byId("ovpUoMTitle");var x=e?e.getParameter('data'):null;V.setChartUoMTitle(d,x,w);if(this.bFlag==true){this.bFlag=false;this.vbLayout.setBusy(false);}else{setTimeout(function(){t.vbLayout.setBusy(false);},0);}V.checkNoData(e,this.getCardContentContainer(),d);},onDataRequested:function(){this.vbLayout.setBusy(true);},getCardItemsBinding:function(){var v=this.getView().byId("analyticalChart");if(v&&v.getDataset()&&v.getDataset().getBinding("data")&&this.vbLayout){this.vbLayout.setBusy(false);}if(v&&v.getParent()){return v.getParent().getBinding("data");}return null;},resizeCard:function(n){var d=this.getCardPropertiesModel();this.newCardLayout=n;d.setProperty("/cardLayout/rowSpan",n.rowSpan);d.setProperty("/cardLayout/colSpan",n.colSpan);var e=this.getCardPropertiesModel().getProperty("/cardLayout");var h=this.getHeaderHeight();var s=this.getView().getDomRef().querySelectorAll(".sapOvpWrapper");for(var i=0;i<s.length;i++){s[i].style.height=(n.rowSpan*e.iRowHeightPx+2)-(h+2*e.iCardBorderPx)+"px";}var f=this.getView().byId("analyticalChart");var g=this.getView().byId("bubbleText");var j=this.getView().byId("ovpCT");if(f){if(f.getVizType()==='timeseries_bubble'||f.getVizType()==='bubble'){if(e.colSpan>1){g.setVisible(false);}else{g.setVisible(true);}}f.setHeight(this._calculateVizFrameHeight()+"px");}var k=this.getView().byId('ovpCardContentContainer').getDomRef();if(k){if(!n.showOnlyHeader){k.classList.remove('sapOvpContentHidden');}else{k.classList.add('sapOvpContentHidden');}}var m=a.getText("BUBBLESIZE");this.oDataSet.bindData("analyticalmodel>/","");this.vizFrame.setDataset(this.oDataSet);var p=f.getParent();if(!this.isVizPropSet){V.buildVizAttributes(f,p,j,this);this.isVizPropSet=true;if(g!=undefined){var q=f.getFeeds();b(q,function(i,v){if(q[i].getUid()=="bubbleWidth"){g.setText(m+" "+q[i].getValues());}});}V.hideDateTimeAxis(f);}V.reprioritizeContent(this.newCardLayout,f);},_calculateVizFrameHeight:function(){var v;var d=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var e=this.getView().byId("analyticalChart");if(d){var g=this.getView().getController();var D=this.getItemHeight(g,'toolbar');var h=this.getHeaderHeight();var i=this.getView().byId("ovpCT")?24:0;var B=(e.getVizType()==='timeseries_bubble'||e.getVizType()==="bubble")&&d.dashboardLayout.colSpan===1?43:0;v=d.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(h+2*this.oDashboardLayoutUtil.CARD_BORDER_PX+D+i+B+30);}return v;},refreshCard:function(){this.getView().rerender();}});});
