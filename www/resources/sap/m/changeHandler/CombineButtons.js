/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/uid","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/fl/util/ManagedObjectModel"],function(u,J,C){"use strict";var a={};function h(b,m,A,M,p,P,v,c,r){var s="";var e="";var o="";var f=[];var g="$sap.m.flexibility.CombineButtonsModel";var i=sap.ui.getCore().getConfiguration().getRTL();var j=[];return b.reduce(function(k,B,l){var I;var n=l;var q;var t;var S=c.content.buttonsIdForSave[n];var w;var x="$sap.m.flexibility.MenuButtonModel"+n;return k.then(m.getProperty.bind(m,B,"text")).then(function(R){w=R;return m.createControl("sap.m.MenuItem",A,v,S);}).then(function(y){q=y;return m.findIndexInParentAggregation(B);}).then(function(y){r.insertIndexes[n]=y;return m.attachEvent(q,"press","sap.m.changeHandler.CombineButtons.pressHandler",{selector:m.getSelector(B,A),appComponentId:A.getId()});}).then(function(){return m.createControl("sap.ui.fl.util.ManagedObjectModel",A,v,Object.assign({},S,{id:S.id+'-managedObjectModel'}),{object:B,name:g});}).then(function(y){t=y;return m.insertAggregation(q,"dependents",t,0,v);}).then(function(){return m.createControl("sap.ui.core.CustomData",A,v,Object.assign({},S,{id:S.id+'-customData'}),{key:"{ path: '"+g+">key' }",value:"{ path: '"+g+">value' }"});}).then(function(y){m.bindProperty(q,"text",g+">/text");m.bindProperty(q,"icon",g+">/icon");m.bindProperty(q,"enabled",g+">/enabled");m.bindProperty(q,"visible",g+">/visible");return m.bindAggregation(q,"customData",{path:g+">/customData",template:y,templateShareable:false},v);}).then(function(){if(w){i?j.unshift(w):j.push(w);}S.id=S.id+"-originalButtonId";return m.createControl("sap.ui.core.CustomData",A,v,S);}).then(function(R){I=R;m.setProperty(I,"key","originalButtonId");m.setProperty(I,"value",m.getId(B));return m.removeAggregation(p,P,B);}).then(function(){return m.insertAggregation(p,"dependents",B,0,v);}).then(function(){m.insertAggregation(B,"customData",I,0,v);}).then(function(){m.insertAggregation(M,"items",q,n,v);}).then(function(){return m.createControl("sap.ui.fl.util.ManagedObjectModel",A,v,Object.assign({},S,{id:S.id+'-managedObjectModelMenuItem'}),{object:q,name:x});}).then(function(y){f[n]=y;s=s+o+"${"+x+">/enabled}";e=e+o+"${"+x+">/visible}";o=" || ";return{menuButtonModels:f,menuButtonName:j,propertyEnabled:s,propertyVisible:e};});},Promise.resolve());}a.applyChange=function(c,o,p){if(p.modifier.targets!=="jsControlTree"){return Promise.reject(new Error("Combine buttons change can't be applied on XML tree"));}var b=c.getDefinition();var m=p.modifier;var v=p.view;var A=p.appComponent;var P;var s;var i;var e;var B;var M;var f;var r={parentAggregation:"",insertIndexes:[]};var g=[];var j=[];return Promise.resolve().then(m.bySelector.bind(m,b.content.combineButtonSelectors[0],A,v)).then(function(R){s=R;P=m.getParent(s);var k=[];b.content.combineButtonSelectors.forEach(function(l){var n=Promise.resolve().then(m.bySelector.bind(m,l,A,v));k.push(n);});return Promise.all(k);}).then(function(k){B=k;return m.getParentAggregationName(B[0],P);}).then(function(R){e=R;r.parentAggregation=e;return m.findIndexInParentAggregation(s);}).then(function(k){i=k;return m.createControl("sap.m.Menu",A,v,b.content.menuIdSelector);}).then(function(k){M=k;return h(B,m,A,M,P,e,v,b,r);}).then(function(k){g=k.menuButtonModels;j=k.menuButtonName;var l=k.propertyVisible;var n=k.propertyEnabled;return m.createControl("sap.m.MenuButton",A,v,b.content.menuButtonIdSelector,{visible:"{= "+l+"}",enabled:"{= "+n+"}"});}).then(function(k){f=k;return g.reduce(function(l,n){return l.then(m.insertAggregation.bind(m,f,"dependents",n,0,v));},Promise.resolve());}).then(function(){m.setProperty(f,"text",j.join("/"));return Promise.resolve().then(m.insertAggregation.bind(m,f,"menu",M,0,v)).then(m.insertAggregation.bind(m,P,e,f,i,v)).then(function(){c.setRevertData(r);});});};function d(c,m){return c.reduce(function(p,o){return p.then(function(){return m.getProperty(o,"key");}).then(function(k){if(k==="originalButtonId"){return m.destroy(o);}return undefined;});},Promise.resolve());}a.revertChange=function(c,o,p){var m=p.modifier;var v=p.view;var r=c.getRevertData();var b=c.getDefinition();var P=r.parentAggregation;var M,e,B;return Promise.resolve().then(function(){return m.bySelector(b.content.menuButtonIdSelector,p.appComponent,v);}).then(function(R){M=R;e=m.getParent(M);B=b.content.combineButtonSelectors.slice().reverse();return m.removeAggregation(e,P,M);}).then(function(){return m.destroy(M);}).then(function(){var l=B.length;return B.reduce(function(f,g,i){var I=i;var j;return f.then(function(){return m.bySelector(g,p.appComponent,v);}).then(function(R){j=R;return m.getAggregation(j,"customData");}).then(function(k){return d(k,m);}).then(function(){return m.insertAggregation(e,P,j,r.insertIndexes[l-I-1],v);});},Promise.resolve()).then(function(){c.resetRevertData();});});};a.completeChangeContent=function(c,s,p){var m=p.modifier;var A=p.appComponent;var o=c.getDefinition();var b=s.combineElementIds;if(b&&b.length>1){c.addDependentControl(b,"combinedButtons",p);o.content.combineButtonSelectors=b.map(function(e){return m.getSelector(e,A);});o.content.menuButtonIdSelector=m.getSelector(A.createId(u()),A);o.content.menuIdSelector=m.getSelector(A.createId(u()),A);o.content.buttonsIdForSave=b.map(function(){return m.getSelector(A.createId(u()),A);});}else{throw new Error("Combine buttons action cannot be completed: oSpecificChangeInfo.combineElementIds attribute required");}};a.pressHandler=function(e,p){var b=J.bySelector(p.selector,C.get(p.appComponentId));b.firePress();};return a;},true);
