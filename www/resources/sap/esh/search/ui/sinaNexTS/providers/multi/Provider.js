/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){var a=(this&&this.__extends)||(function(){var e=function(d,b){e=Object.setPrototypeOf||({__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b;})||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p];};return e(d,b);};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");e(d,b);function _(){this.constructor=d;}d.prototype=b===null?Object.create(b):(_.prototype=b.prototype,new _());};})();var c=(this&&this.__awaiter)||function(t,_,P,g){function b(v){return v instanceof P?v:new P(function(r){r(v);});}return new(P||(P=Promise))(function(r,d){function f(v){try{s(g.next(v));}catch(e){d(e);}}function i(v){try{s(g["throw"](v));}catch(e){d(e);}}function s(e){e.done?r(e.value):b(e.value).then(f,i);}s((g=g.apply(t,_||[])).next());});};var h=(this&&this.__generator)||function(b,d){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1];},trys:[],ops:[]},f,y,t,g;return g={next:i(0),"throw":i(1),"return":i(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this;}),g;function i(n){return function(v){return s([n,v]);};}function s(o){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=o[0]&2?y["return"]:o[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,o[1])).done)return t;if(y=0,t)o=[o[0]&2,t.value];switch(o[0]){case 0:case 1:t=o;break;case 4:_.label++;return{value:o[1],done:false};case 5:_.label++;y=o[1];o=[0];continue;case 7:o=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(o[0]===6||o[0]===2)){_=0;continue;}if(o[0]===3&&(!t||(o[1]>t[0]&&o[1]<t[3]))){_.label=o[1];break;}if(o[0]===6&&_.label<t[1]){_.label=t[1];t=o;break;}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(o);break;}if(t[2])_.ops.pop();_.trys.pop();continue;}o=d.call(b,_);}catch(e){o=[6,e];y=0;}finally{f=t=0;}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true};}};sap.ui.define(["require","exports","../AbstractProvider","./FacetMode","./FederationType","./ProviderHelper","../../sina/Sina","./FederationMethod","../../core/Log","../../sina/SinaConfiguration","../abap_odata/Provider","../hana_odata/Provider","../sample/Provider","../inav2/Provider","../dummy/Provider"],function(r,e,A,F,b,P,S,d,L,f,g,l,m,n,o){"use strict";Object.defineProperty(e,"__esModule",{value:true});e.MultiProvider=void 0;var M=(function(_){a(M,_);function M(){var i=_!==null&&_.apply(this,arguments)||this;i.id="multi";return i;}M.prototype._initAsync=function(p){return c(this,void 0,void 0,function(){var j,k,q;var s=this;return h(this,function(t){switch(t.label){case 0:this.log=new L.Log("MultiProvider");this.sina=p.sina;this.facetMode=F.FacetMode[p.facetMode]||F.FacetMode.flat;this.federationType=b.FederationType[p.federationType]||b.FederationType.advanced_round_robin;this.multiSina=[];this.multiDataSourceMap={};this.sina.dataSourceMap[this.sina.allDataSource.id]=this.sina.allDataSource;this.providerHelper=new P.ProviderHelper(this);switch(this.federationType){case b.FederationType.advanced_round_robin:{this.federationMethod=new d.AdvancedRoundRobin();break;}case b.FederationType.ranking:{this.federationMethod=new d.Ranking();break;}case b.FederationType.round_robin:{this.federationMethod=new d.RoundRobin();break;}}this.sina.capabilities=this.sina._createCapabilities({fuzzy:false,});j=[];p.subProviders.forEach(function(u){var v=s.createAsync(u).then(function(w){s.providerHelper.updateProviderId(w);for(var i=0;i<w.dataSources.length;i++){var x=w.dataSources[i];var y=s.providerHelper.calculateMultiDataSourceId(x.id,w.provider.id);s.providerHelper.createMultiDataSource(y,x);s.multiDataSourceMap[y]=x;}s.multiSina.push(w);return w;});j.push(v);});k=false;return[4,Promise.allSettled(j)];case 1:q=t.sent();q.forEach(function(i){if(i.status==="rejected"){s.log.warn("Error during creation of subprovider: "+i.reason.stack);}else if(i.status==="fulfilled"){k=true;if(i.value.capabilities.fuzzy){s.sina.capabilities.fuzzy=true;}}});if(!k){this.log.error("Error during creation of multi provider: no valid subproviders");return[2,Promise.reject()];}return[2,this.sina];}});});};M.prototype.createAsync=function(i){return c(this,void 0,void 0,function(){var j,p,s;return h(this,function(k){switch(k.label){case 0:this.log.debug("Creating new eshclient instance using provider "+i.provider);return[4,f._normalizeConfiguration(i)];case 1:j=k.sent();switch(j.provider){case f.AvailableProviders.HANA_ODATA:{p=new l.Provider();break;}case f.AvailableProviders.ABAP_ODATA:{p=new g.Provider();break;}case f.AvailableProviders.INAV2:{p=new n.Provider();break;}case f.AvailableProviders.MULTI:{p=new M();break;}case f.AvailableProviders.SAMPLE:{p=new m.Provider();break;}case f.AvailableProviders.DUMMY:{p=new o.Provider();break;}default:{throw new Error("Unknown Provider: '"+i.provider+"' - Available Providers: "+f.AvailableProviders.HANA_ODATA+", "+f.AvailableProviders.ABAP_ODATA+", "+f.AvailableProviders.INAV2+", "+f.AvailableProviders.MULTI+", "+f.AvailableProviders.SAMPLE+", "+f.AvailableProviders.DUMMY);}}s=new S.Sina(p);return[4,s._initAsync(j)];case 2:k.sent();return[2,s];}});});};M.prototype.executeSearchQuery=function(q){var t=this;var p;t.searchResultSet=t.sina._createSearchResultSet({title:"Search Multi Result List",query:q,items:[],totalCount:0,facets:[],});t.searchResultSetItemList=[];if(q.filter.dataSource===t.sina.allDataSource){t.searchResultSet.facets.push(t.sina._createDataSourceResultSet({title:q.filter.dataSource.label,items:[],query:q,}));var s=[];for(var i=0;i<t.multiSina.length;i++){p=t.multiSina[i].createSearchQuery({calculateFacets:q.calculateFacets,multiSelectFacets:q.multiSelectFacets,dataSource:t.multiSina[i].allDataSource,searchTerm:q.getSearchTerm(),top:q.top,skip:q.skip,sortOrder:q.sortOrder,sina:t.multiSina[i],});s.push(p.getResultSetAsync());}return Promise.all(s).then(function(w){for(var j=0;j<w.length;j++){var x=w[j];for(var k=0;k<x.items.length;k++){var y=x.items[k];var z=t.providerHelper.calculateMultiDataSourceId(y.dataSource.id,y.sina.provider.id);var B=t.sina.dataSourceMap[z];y.dataSource=B;y.sina=t.sina;}t.searchResultSet.totalCount+=x.totalCount;t.searchResultSetItemList.push(x.items);if(x.facets[0]){if(t.facetMode===F.FacetMode.tree){var C=t.sina.getDataSource(t.providerHelper.calculateMultiDataSourceId(x.query.filter.dataSource.id,x.sina.provider.id));t.searchResultSet.facets[0].items.push(t.sina._createDataSourceResultSetItem({dataSource:C,dimensionValueFormatted:t.providerHelper.calculateMultiDataSourceLabel(x.query.filter.dataSource.label,x.sina.provider),measureValue:x.totalCount,measureValueFormatted:x.totalCount,}));}else{var D=t.providerHelper.updateDataSourceFacets(x.facets);D[0].items.forEach(function(E){t.searchResultSet.facets[0].items.push(E);});}}}t.searchResultSet.items=t.federationMethod.sort(t.searchResultSetItemList);t.searchResultSet.items=t.searchResultSet.items.slice(q.skip,q.top);return t.searchResultSet;});}var u=t.multiDataSourceMap[q.filter.dataSource.id];var v=q.getRootCondition().clone();t.providerHelper.updateRootCondition(v,u.sina);p=u.sina.createSearchQuery({calculateFacets:q.calculateFacets,multiSelectFacets:q.multiSelectFacets,dataSource:u,searchTerm:q.getSearchTerm(),rootCondition:q.getRootCondition(),top:q.top,skip:q.skip,sortOrder:q.sortOrder,sina:u.sina,});return p.getResultSetAsync().then(function(j){t.searchResultSet.items=j.items;t.searchResultSet.totalCount=j.totalCount;for(var i=0;i<t.searchResultSet.items.length;i++){var w=t.searchResultSet.items[i];var x=t.providerHelper.calculateMultiDataSourceId(w.dataSource.id,w.sina.provider.id);t.providerHelper.updateAttributesMetadata(w.dataSource,t.sina.dataSourceMap[x]);w.dataSource=t.sina.dataSourceMap[x];w.sina=t.sina;}var y;if(j.facets.length===1&&j.facets[0].items[0].dataSource){y=j.facets;y[0].title=t.providerHelper.calculateMultiDataSourceLabel(j.facets[0].title,j.facets[0].sina.provider);t.providerHelper.updateDataSourceFacets(y);}else{y=[];for(var k=0;k<j.facets.length;k++){var z=j.facets[k];y.push(t.providerHelper.createMultiChartResultSet(z));}}t.searchResultSet.facets=y;return t.searchResultSet;});};M.prototype.executeChartQuery=function(q){var t=this;var i=t.multiDataSourceMap[q.filter.dataSource.id];var j=q.getRootCondition().clone();t.providerHelper.updateRootCondition(j,i.sina);var k=i.sina.createChartQuery({dimension:q.dimension,dataSource:i,searchTerm:q.getSearchTerm(),rootCondition:j,top:q.top,skip:q.skip,sortOrder:q.sortOrder,});return k.getResultSetAsync().then(function(p){return t.providerHelper.createMultiChartResultSet(p);});};M.prototype.executeHierarchyQuery=function(q){throw new Error("Method not implmented.");};M.prototype.executeSuggestionQuery=function(q){var t=this;var k;if(q.filter.dataSource===t.sina.allDataSource){var p=[];for(var i=0;i<t.multiSina.length;i++){k=t.multiSina[i].createSuggestionQuery({types:q.types,calculationModes:q.calculationModes,dataSource:t.multiSina[i].allDataSource,searchTerm:q.getSearchTerm(),top:q.top,skip:q.skip,sortOrder:q.sortOrder,});p.push(k.getResultSetAsync());}return Promise.all(p).then(function(u){var v=t.sina._createSuggestionResultSet({title:"Multi Suggestions",query:q,items:[],});for(var j=0;j<u.length;j++){var w=t.providerHelper.updateSuggestionDataSource(u[j]);v.items=new d.RoundRobin().mergeMultiResults(v.items,w.items,j+1);}return v;});}var s=t.multiDataSourceMap[q.filter.dataSource.id];k=s.sina.createSuggestionQuery({types:q.types,calculationModes:q.calculationModes,dataSource:s,searchTerm:q.getSearchTerm(),top:q.top,skip:q.skip,sortOrder:q.sortOrder,});return k.getResultSetAsync().then(function(j){return t.providerHelper.updateSuggestionDataSource(j);});};return M;}(A.AbstractProvider));e.MultiProvider=M;});})();
