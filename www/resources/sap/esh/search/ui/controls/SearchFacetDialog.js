/*!
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/esh/search/ui/SearchHelper","sap/esh/search/ui/SearchFacetDialogHelper","sap/esh/search/ui/SearchFacetDialogHelper_SearchAdvancedCondition_ModuleLoader","sap/esh/search/ui/SearchFacetDialogHelperCharts","sap/esh/search/ui/controls/SearchAdvancedCondition","sap/esh/search/ui/FacetItem","sap/m/Dialog","sap/m/Select","sap/m/CheckBox","sap/m/SearchField","sap/m/ToggleButton","sap/m/Button","sap/m/ButtonType","sap/m/List","sap/m/ListMode","sap/m/ListSeparators","sap/m/StandardListItem","sap/m/Page","sap/m/SplitContainer","sap/ui/core/Item","sap/m/HBox","sap/m/VBox","sap/m/FlexAlignItems","sap/m/FlexJustifyContent","sap/m/BackgroundDesign","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/ScrollContainer","sap/m/Toolbar","sap/m/IconTabBar","sap/m/IconTabFilter","sap/ui/model/json/JSONModel",],function(s,a,_,b,S,F,D,c,C,d,T,B,f,L,g,h,k,P,l,I,H,V,o,p,q,r,t,u,v,w,x,J){"use strict";D.extend("sap.esh.search.ui.controls.SearchFacetDialog",{constructor:function(e){var i=this;i.bConditionValidateError=false;i.bShowCharts=true;i.bOldPieChart=true;if(jQuery.sap.getUriParameters().mParams.newpie&&jQuery.sap.getUriParameters().get("newpie")!=="false"){i.bOldPieChart=false;}i.chartOnDisplayIndex=e.selectedTabBarIndex;i.facetOnDisplayIndex=0;i.chartOnDisplayIndexByFilterArray=[];i.aItemsForBarChart=[];i.tabBarItems=e.tabBarItems;i.searchFacetDialogHelperCharts=b;if(!i.tabBarItems){b.setDummyTabBarItems(i);}e=jQuery.extend({},{showHeader:false,horizontalScrolling:false,verticalScrolling:false,contentHeight:"35rem",beginButton:new B({text:sap.esh.search.ui.resources.i18n.getText("okDialogBtn"),type:f.Emphasized,press:function(E){i.onOkClick(E);i.close();i.destroy();},}),endButton:new B({text:sap.esh.search.ui.resources.i18n.getText("cancelDialogBtn"),press:function(E){i.onCancelClick(E);i.close();i.destroy();},}),content:[i.createContainer()],},e);i.selectedAttribute=e.selectedAttribute?e.selectedAttribute:"";delete e.selectedAttribute;delete e.selectedTabBarIndex;delete e.tabBarItems;D.prototype.constructor.apply(this,[e]);a.init(i);b.init(i);i.addStyleClass("sapUshellSearchFacetDialog");i.onSearchFieldLiveChange=s.delayedExecution(i.onSearchFieldLiveChange,1000);},renderer:"sap.m.DialogRenderer",createContainer:function(){var e=this;e.oSplitContainer=new l({masterPages:e.createMasterPages(),});e.oSplitContainer.bindAggregation("detailPages","/facetDialog",function(i,j){return e.createDetailPages(i,j);});e.oSplitContainer.addStyleClass("sapUshellSearchFacetDialogContainer");return e.oSplitContainer;},createMasterPages:function(){var e=this;var m=new L({mode:g.SingleSelectMaster,selectionChange:function(E){e.onMasterPageSelectionChange(E);},});m.addStyleClass("sapUshellSearchFacetDialogFacetList");m.bindAggregation("items","/facetDialog",function(){var i=new k({title:"{title}",counter:"{count}",visible:"{visible}",});return i;});var R=new B({icon:"sap-icon://clear-filter",tooltip:sap.esh.search.ui.resources.i18n.getText("resetFilterButton_tooltip"),type:"Transparent",enabled:false,press:function(E){e.resetAllFilters(E);},});R.addStyleClass("sapUshellSearchFacetDialogFilterResetButton");var M=new P({title:sap.esh.search.ui.resources.i18n.getText("filters"),headerContent:R,content:[m],}).addStyleClass("sapUshellSearchFacetDialogMasterContainer");M.addEventDelegate({onAfterRendering:function(){if(e.selectedAttribute){for(var i=0;i<m.getItems().length;i++){var z=m.getItems()[i];var A=z.getBindingContext().getObject();if(e.selectedAttribute===A.dimension){m.setSelectedItem(z);e.facetOnDisplayIndex=i;e.chartOnDisplayIndexByFilterArray.push(e.chartOnDisplayIndex);}else{var n=0;var E=z.getBindingContext().getModel().oData.facets;for(var j=0;j<E.length;j++){if(E[j].chartIndex&&E[j].dimension===A.dimension&&!isNaN(E[j].chartIndex)){n=E[j].chartIndex;}}e.chartOnDisplayIndexByFilterArray.push(n);}}}if(!m.getSelectedItem()){m.setSelectedItem(m.getItems()[0]);}var G=m.getSelectedItem();a.updateDetailPage(G,null,true);e.resetEnabledForFilterResetButton();},});var y=[M];return y;},resetAllFilters:function(){var e=$(".sapUshellSearchFacetDialogSettingsContainer").find(".sapMCbBg.sapMCbHoverable.sapMCbMark");if(e.length===1){var i=e[0].parentNode.id;var m=sap.ui.getCore().byId(i);m.setSelected(false);m.setEnabled(false);}var M=this.getModel();M.aFilters=[];a.bResetFilterIsActive=true;var n=a.getFacetList();var y=n.getItems();for(var j=0;j<y.length;j++){y[j].setCounter(0);}this.resetAdvancedConditionFilters();a.resetChartQueryFilters();a.updateDetailPage(n.getSelectedItem());this.resetEnabledForFilterResetButton();a.bResetFilterIsActive=false;},resetAdvancedConditionFilters:function(){var e=this;var A,m,n,y,z,E,j;var G=e.oSplitContainer.getDetailPages();for(var i=0;i<G.length;i++){var K=G[i];n=a.POS_ATTRIBUTE_LIST_CONTAINER;A=K.getContent()[n];if(A){for(j=A.getContent().length-2;j>0;j--){m=A.getContent()[j];z=m.getParent();E=m;z.removeContent(E);}}else{n=a.POS_ICONTABBAR;y=a.POS_TABBAR_CONDITION;A=K.getContent()[n].getItems()[y].getContent()[0];if(A){for(j=A.getContent().length-1;j>-1;j--){m=A.getContent()[j];if(m.getContent&&m.getContent()[1]){var M=m.getContent()[1].getContent()[1];var N=M.getValue();if(N&&(""+N).length>0){z=m.getParent();E=m;z.removeContent(E);}}}}}}},resetEnabledForFilterResetButton:function(e){var j=false;var m=0;var M=a.getFacetList();var n=M.getItems();for(var i=0;i<n.length;i++){m+=n[i].getCounter();}var y=this.getModel();if((y.aFilters&&y.aFilters.length>0)||e||m>0){j=true;}var z=$(".sapUshellSearchFacetDialogFilterResetButton")[0].id;var R=sap.ui.getCore().byId(z);R.setEnabled(j);},onMasterPageSelectionChange:function(e){var i=this;var j=e.mParameters.listItem;i.facetOnDisplayIndex=j.getParent().indexOfItem(j.getParent().getSelectedItem());i.setChartOnDisplayIndexForFacetListItem(i.facetOnDisplayIndex);var m=j.getParent().getModel();var n=j.getBindingContext().sPath;i.resetIcons(m,n,i);a.updateDetailPage(j);if(i.oSplitContainer.getMode()==="ShowHideMode"){i.oSplitContainer.hideMaster();}i.controlChartVisibility(i,i.chartOnDisplayIndex);},createDetailPages:function(i,e){var j=this;var m=e.oModel.getProperty(e.sPath).facetType;var n=e.oModel.getAttributeDataType(e.oModel.getProperty(e.sPath));var y=new c({items:[new I({text:sap.esh.search.ui.resources.i18n.getText("notSorted"),key:"notSorted",}),new I({text:sap.esh.search.ui.resources.i18n.getText("sortByCount"),key:"sortCount",}),new I({text:sap.esh.search.ui.resources.i18n.getText("sortByName"),key:"sortName",}),],selectedKey:n==="string"||n==="text"?"sortCount":"notSorted",change:function(c1){j.onSelectChange(c1);},}).addStyleClass("sapUshellSearchFacetDialogSettingsSelect");var z=new H({alignItems:o.End,justifyContent:p.End,items:[y],});var A=new C({text:sap.esh.search.ui.resources.i18n.getText("showSelectedOnTop"),enabled:false,select:function(c1){j.onCheckBoxSelect(c1);},});var E=new V({items:[z,A],}).addStyleClass("sapUshellSearchFacetDialogSettingsContainer");E.setVisible(false);var G=new L({backgroundDesign:q.Transparent,includeItemInSelection:true,showNoData:false,showSeparators:h.None,selectionChange:function(c1){j.onDetailPageSelectionChange(c1);},});G.addStyleClass("sapUshellSearchFacetDialogDetailPageList");G.addStyleClass("largeChart0");if(m==="attribute"){G.setMode(g.MultiSelect);}var K={path:"items",factory:function(i,e){var c1=e.oModel.getProperty(e.sPath);var d1=new k({title:"{label}",tooltip:sap.esh.search.ui.resources.i18n.getText("facetListTooltip",["{label}","{value}",]),info:"{valueLabel}",selected:"{selected}",});if(c1.selected){e.oModel.addFilter(c1);}return d1;},};if(n==="number"||n==="integer"){y.removeItem(2);}K.filters=new r("advanced",t.NE,true);G.bindAggregation("items",K);G.data("dataType",n);if(j.bShowCharts){G.addEventDelegate({onAfterRendering:function(c1){j.hideSelectively(c1,j,0);},});}var M,N,O;N=b.getBarChartPlaceholder();N.addEventDelegate({onAfterRendering:function(c1){j.hideSelectively(c1,j,1);},});N.data("dataType",n);if(j.bOldPieChart){O=b.getPieChartPlaceholder();}else{O={};}O.addEventDelegate({onAfterRendering:function(c1){j.hideSelectively(c1,j,2);},});if(j.bShowCharts&&(n==="string"||n==="text")){M=new u({height:"67.2%",horizontal:false,vertical:true,content:[G,N,O],});}else{M=new u({height:"calc(100% - 0.25rem)",horizontal:false,vertical:true,content:[G],});}M.addStyleClass("sapUshellSearchFacetDialogDetailPageListContainer");M.addStyleClass("searchFacetLargeChartContainer");M.setBusyIndicatorDelay(0);var Q=new S({type:n,});var R;if(n==="string"||n==="text"){var U=new u({horizontal:false,vertical:true,content:[Q],});U.addStyleClass("sapUshellSearchFacetDialogDetailPageAdvancedContainer");var W=new B({icon:"sap-icon://add",type:f.Transparent,press:function(c1){j.onPlusButtonPress(c1,n);},});W.addStyleClass("sapUshellSearchFacetDialogDetailPageAdvancedContainerPlusButton");U.addContent(W);U.data("dataType",n);U.data("initial",true);M.setHeight("calc(100% - 0.25rem)");U.setHeight("100%");var X=b.getDropDownButton(j);var Y=new v({content:[new d({placeholder:sap.esh.search.ui.resources.i18n.getText("filterPlaceholder"),liveChange:function(c1){j.onSearchFieldLiveChange(c1.oSource.getValue());},}),new T({icon:"sap-icon://sort",press:function(c1){j.onSettingButtonPress(c1);},}).addStyleClass("sapUshellSearchFacetDialogSortButton"),],}).addStyleClass("sapUshellSearchFacetDialogSubheaderToolbar");Y.addEventDelegate({onAfterRendering:function(){$(".sapUshellSearchFacetDialogSubheaderToolbar").removeClass("sapContrastPlus");},});if(j.bShowCharts){Y.addContent(X);}var Z=new P({showHeader:false,subHeader:Y,content:[E,M],}).addStyleClass("sapUshellSearchFacetDialogDetailPage");var a1=new w({expandable:false,stretchContentHeight:true,backgroundDesign:q.Transparent,applyContentPadding:false,select:function(){j.controlChartVisibility(j,j.chartOnDisplayIndex);},items:[new x({text:sap.esh.search.ui.resources.i18n.getText("selectFromList"),content:[Z],}),new x({text:sap.esh.search.ui.resources.i18n.getText("defineCondition"),content:[U],}),],});a1.addStyleClass("sapUshellSearchFacetDialogIconTabBar");R=new P({showHeader:true,title:e.oModel.getProperty(e.sPath).title,content:[a1],});R.addStyleClass("sapUshellSearchFacetDialogDetailPageString");}else{M.addContent(Q);M.data("dataType",n);M.data("initial",true);if(j.bShowCharts){var b1=e.oModel.getProperty(e.sPath).title;R=new P({title:b1,showHeader:true,content:[E,M],});}else{R=new P({showHeader:true,title:e.oModel.getProperty(e.sPath).title,content:[E,M],});}R.addStyleClass("sapUshellSearchFacetDialogDetailPage");}R.addEventDelegate({onAfterRendering:function(){j.controlChartVisibility(j,j.chartOnDisplayIndex);},});return R;},onDetailPageSelectionChange:function(e){var i=this;var j=e.mParameters.listItem;var m=j.getBindingContext().getObject();if(j.getSelected()){m.listed=true;i.getModel().addFilter(m);}else{m.listed=false;i.getModel().removeFilter(m);}var n=e.oSource;var y;if(n.data("dataType")==="string"||n.data("dataType")==="text"){y=n.getParent().getParent().getParent().getParent().getParent().getParent();}else{y=n.getParent().getParent();}a.updateCountInfo(y);var z=n.getParent().getParent().getContent()[a.POS_SETTING_CONTAINER];var A=z.getItems()[a.POS_SHOWONTOP_CHECKBOX];var E=z.getItems()[a.POS_SORTING_SELECT].getItems()[0];if(A.getSelected()){A.setSelected(false);E.setSelectedKey("notSorted");}if(n.getSelectedContexts().length>0){A.setEnabled(true);}else{A.setEnabled(false);}},onSearchFieldLiveChange:function(e){var i=a.getFacetList().getSelectedItem();a.updateDetailPage(i,e);},onSettingButtonPress:function(e){var i=e.oSource.getPressed();var j=e.oSource.getParent().getParent().getContent()[a.POS_SETTING_CONTAINER];var m=e.oSource.getParent().getParent().getContent()[a.POS_ATTRIBUTE_LIST_CONTAINER];if(i){j.setVisible(true);m.setHeight("calc(100% - 4.25rem)");}else{j.setVisible(false);m.setHeight("calc(100% - 0.25rem)");}},onSelectChange:function(e){a.sortingAttributeList(e.oSource.getParent().getParent().getParent());},onCheckBoxSelect:function(e){a.sortingAttributeList(e.oSource.getParent().getParent());},onPlusButtonPress:function(e,i){var A=e.getSource().getParent();var n=new S({type:i,});var j=A.getAggregation("content").length-1;A.insertAggregation("content",n,j);},onOkClick:function(){var e=this;var M=e.getModel();var j=e.getModel("searchModel");j.resetFilterConditions(false);var n=e.oSplitContainer.getDetailPages();for(var m=0;m<M.aFilters.length;m++){var y=M.aFilters[m];if(!y.advanced||y.listed){j.addFilterCondition(y.filterCondition,false);}}for(var i=0;i<n.length;i++){if(a.getFacetList().getItems()[i]){a.applyAdvancedCondition(n[i],a.getFacetList().getItems()[i].getBindingContext().getObject(),j);}}if(!e.bConditionValidateError){j.filterChanged=true;j._firePerspectiveQuery();}j.eventLogger.logEvent({type:j.eventLogger.FACET_SHOW_MORE_CLOSE,});},onCancelClick:function(){var e=this.getModel("searchModel");e.eventLogger.logEvent({type:e.eventLogger.FACET_SHOW_MORE_CLOSE,});},setChartOnDisplayIndexForFacetListItem:function(i){var j=this;var m=0;try{m=j.chartOnDisplayIndexByFilterArray[i];}catch(e){m=0;}if(m===undefined){m=0;}j.chartOnDisplayIndex=m;},resetIcons:function(m,e,j){var n=this;var y=false;var z=m.getAttributeDataType(m.getProperty(e));if(n.bShowCharts&&(z==="string"||z==="text")){y=true;}var A=$(".sapUshellSearchFacetDialogTabBarButton");if(y){A.css("display","block");for(var i=0;i<A.length;i++){var E=A[i].id;var G=sap.ui.getCore().byId(E);var K=j.tabBarItems[j.chartOnDisplayIndex].getIcon();G.setIcon(K);var M=j.tabBarItems[j.chartOnDisplayIndex].getText();var N=sap.esh.search.ui.resources.i18n.getText("displayAs",[M]);G.setTooltip(N);}}else{A.css("display","none");}},onDetailPageSelectionChangeCharts:function(e){var m=this;var n=0;var y,z,A,E,G,K,M,N,O,Q;var R,j,U,W,i,X;if(e.getSource&&e.sId==="press"){y=e.getSource().getBindingContext();z=y.getModel();A=y.getObject();E=A.selected;G=!E;K=e.getSource();M=K.getBindingContext().sPath+"/selected";z.setProperty(M,G);N=K.getBindingContext().getObject();if(G){z.addFilter(N);}else{z.removeFilter(N);}O=M.replace(/\/items.+/,"");O+="/items";U=z.getProperty(O);n=0;for(i=0;i<U.length;i++){W=U[i];if(W.selected===true){n++;}}}else if(e.getSource&&(e.sId==="selectData"||e.sId==="deselectData")){y=e.getSource().getBindingContext();z=y.getModel();A=y.getObject();G=e.sId==="selectData";K=e.getSource();M=K.getBindingContext().sPath+"/items/";for(j=0;j<e.getParameters().data.length;j++){R=e.getParameters().data[j].data._context_row_number;M+=R+"/selected";z.setProperty(M,G);N=K.getBindingContext().getObject().items[R];if(G){z.addFilter(N);}else{z.removeFilter(N);}}O=M.replace(/\/items.+/,"");O+="/items";U=z.getProperty(O);n=0;for(i=0;i<U.length;i++){if(U[i].selected===true){n++;}}var Y=e.mParameters.data.length;if(!G&&Y>1){n=0;for(i=0;i<U.length;i++){U[i].selected=false;}}}else{A=e.dataObject;E=A.selected;G=!E;n=e.cnt;z=e.model;N=new F();N.facetAttribute=A.dimension;N.filterCondition=A.filterCondition;N.label=A.label;N.selected=A.selected;N.listed=A.selected;N.value=A.value;N.valueLabel=A.valueLabel;for(j=0;j<m.aItemsForBarChart.length;j++){var Z=m.aItemsForBarChart[j];if(Z.label===A.label){Z.selected=A.selected;}}if(E){m.getModel().addFilter(N);}else{m.getModel().removeFilter(N);}}Q=a.getFacetList();X=Q.getSelectedItem();if(!X){X=Q.getItems()[0];}X.setCounter(n);this.resetEnabledForFilterResetButton();},updateDetailPageCharts:function(i){var e=this;if(e.bShowCharts===false){return;}e.aItemsForBarChart=i;var j=b.getListContainersForDetailPage();var m=j[1];var n=m.getContent();if(n&&e.chartOnDisplayIndex===2){var y=n[2];var z=j[5];var A=j[2];A=0.9*A;if(y.directUpdate){var E={};E.relevantContainerHeight=A;E.oSearchFacetDialog=e;var M=new J();M.setData(i);$("#"+z.id).empty();y.directUpdate(i,z,M,E);}}var G,K;if(n&&e.chartOnDisplayIndex===1){G=n[2].getDomRef();if(G){K=$("#"+G.id);K.css("display","none");}}if(n&&e.chartOnDisplayIndex===2){G=n[1].getDomRef();if(G){K=$("#"+G.id);K.css("display","none");}}},controlChartVisibility:function(e,j,m){var n=this;var y,z,A,E;if(n.bShowCharts===false)return;var G=e.searchFacetDialogHelperCharts.getListContainersForDetailPage();var K=G[1];if(!K||!K.getContent)return;var M=K.getContent();for(var i=0;i<M.length;i++){y=M[i].getDomRef();if(!y)return;A=y.className;E=false;if(A.indexOf("largeChart")>-1){E=true;}z=$("#"+y.id);if(E&&i!==j){z.css("display","none");}else{z.css("display","block");}}if(e.bOldPieChart){if(E&&j===2&&m){var N=n.aItemsForBarChart;var O=n.getModel();n.updateDetailPageCharts(N,O);}if(E&&j===2){K.setVertical(false);}else{K.setVertical(true);}}var Q=G[6];var R=G[7];if(Q){if(j===0){Q.css("display","block");R.css("visibility","visible");}else{Q.css("display","none");R.css("visibility","hidden");}}},hideSelectively:function(e,i,j){var m=$("#"+e.srcControl.sId);var n=i.chartOnDisplayIndex;var y=i.searchFacetDialogHelperCharts.getListContainersForDetailPage();var z=y[1];if(y[0].firstChild.children.length!=3)return;if(n!==undefined){if(i.chartOnDisplayIndex!==j){m.css("display","none");}else{m.css("display","block");}}else{m.css("display","block");}if(n===2){if(!y[0].firstChild.children[2]||!y[0].firstChild.children[2].firstChild){i.controlChartVisibility(i,i.chartOnDisplayIndex,true);}if(i.bOldPieChart){z.setVertical(false);}}else{z.setVertical(true);}var A=y[6];if(A){var E=$("#"+A.sId);if(n===0){E.css("display","block");}else{E.css("display","none");}}},});});
