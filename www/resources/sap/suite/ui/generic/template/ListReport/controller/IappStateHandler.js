sap.ui.define(["sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/suite/ui/generic/template/listTemplates/listUtils","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/deepEqual","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/suite/ui/generic/template/js/placeholderHelper","sap/ui/Device","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper","sap/suite/ui/generic/template/genericUtilities/controlStateWrapperFactory","sap/suite/ui/generic/template/genericUtilities/testableHelper"],function(B,C,N,l,S,U,F,d,e,a,b,p,D,s,c,t){"use strict";var f="ListReport.controller.IappStateHandler";var o=new F(f);var L=o.getLogger();var g=o.Level;var h="sap.suite.ui.generic.template.customData",j="sap.suite.ui.generic.template.extensionData",k="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(O){if(O){for(var P in O){O[P]=null;}}}function m(M,v){if(sap.ui.support){var i=L.getLevel();if(i<g.INFO){L.setLevel(g.INFO);}}var r;if(typeof v==="string"){r=v;}else{r="";var u="";for(var K in v){r=r+u+K+": "+v[K];u="; ";}}L.info(M,r,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");}function q(r,u,T){var v;var w=new Promise(function(i){v=i;});var x=u.byId("page");var y=c.getControlStateWrapper(x);y.attachStateChanged(function(){b1(P());});var z;if(r.oMultipleViewsHandler.getMode()!=="multi"&&r.oSmartTable){z=c.getControlStateWrapper(r.oSmartTable);z.attachStateChanged(function(){b1(P());});}var A=T.oServices.oApplication.getNavigationHandler();var E=u.getOwnerComponent().getSmartVariantManagement();var G=false;var H=T.oComponentUtils.getSettings();var R;var J=Promise.resolve();var K=false;r.oSmartFilterbar.setSuppressSelection(true);var M=true;var O=(function(){var i;return function(){i=i||r.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function P(){var i=T.oComponentUtils.getTemplatePrivateModel();return i.getProperty("/generic/bDataAreShownInTable");}function Q(){var D1={};var E1=[];var F1=O();for(var i=0;i<F1.length;i++){var G1=F1[i];if(r.oSmartFilterbar.isVisibleInFilterBarByName(G1)){E1.push(G1);}}var H1={suppressDataSelection:!P(),visibleCustomFields:E1,variantDirty:u.byId('template::PageVariant')&&u.byId('template::PageVariant').currentVariantGetModified()};D1[k]=H1;if(T.oComponentUtils.isDraftEnabled()){var I1=T.oComponentUtils.getTemplatePrivateModel();H1.editStateFilter=I1.getProperty("/listReport/vDraftState");var J1=I1.getProperty("/listReport/activeObjectEnabled");H1.activeStateFilter=J1;}var K1=r.oMultipleViewsHandler.getSelectedKeyPropertyName();if(K1){var L1=r.oMultipleViewsHandler.getContentForIappState();if(L1){H1[K1]=L1.state;}}if(r.oWorklistData.bWorkListEnabled){var M1=r.oWorklistData.oSearchField?r.oWorklistData.oSearchField.getValue():"";var N1={"searchString":M1};H1.Worklist=N1;}var O1={};D1[h]=O1;u.getCustomAppStateDataExtension(O1);var P1;var Q1=true;var R1=function(S1,T1){if(!(S1 instanceof C)){throw new b(f,"State must always be set with respect to a ControllerExtension");}if(!Q1){throw new b(f,"State must always be provided synchronously");}if(T1){P1=P1||Object.create(null);var U1=S1.getMetadata().getNamespace();P1[U1]=T1;}};u.templateBaseExtension.provideExtensionAppStateData(R1);Q1=false;if(P1){D1[j]=P1;}return D1;}function V(){var D1=r.oSmartFilterbar.getUiState();var E1=new S(JSON.stringify(D1.getSelectionVariant()));var F1=u.getVisibleSelectionsWithDefaults();for(var i=0;i<F1.length;i++){if(!E1.getValue(F1[i])){E1.addSelectOption(F1[i],"I","EQ","");}}var G1=u.byId('template::PageVariant');if(G1&&G1.currentVariantGetModified()&&E1.getID()){E1.setID("");}if(r.oWorklistData.bWorkListEnabled){var H1=r.oWorklistData.oSearchField?r.oWorklistData.oSearchField.getValue():"";E1.addSelectOption("Worklist.SearchField","I","EQ",H1);}var I1={};if(z){I1[r.oSmartTable.getId()]=z.getState();}I1[x.getId()]=y.getState();return{version:sap.ui.version,selectionVariant:E1.toJSONString(),customData:Q(),semanticDates:D1.getSemanticDates(),controlStates:I1};}function W(D1,E1){var F1=T.oComponentUtils.getTemplatePrivateModel();if(D1&&T.oComponentUtils.isDraftEnabled()){F1.setProperty("/listReport/vDraftState",D1.editStateFilter||"0");F1.setProperty("/listReport/activeObjectEnabled",!!D1.activeStateFilter);r.oMultipleViewsHandler.restoreActiveButtonState(D1);}var G1=D1&&D1.visibleCustomFields;if(G1&&G1.length>0){var H1=r.oSmartFilterbar.getAllFilterItems();for(var i=0;i<H1.length;i++){var I1=H1[i];var J1=I1.getName();if(G1.indexOf(J1)!==-1){I1.setVisibleInFilterBar(true);}}}a1(E1&&!(D1&&D1.suppressDataSelection));if(P()&&!r.oWorklistData.bWorkListEnabled){r.oSmartFilterbar.search();u1();}var K1=r.oMultipleViewsHandler.getSelectedKeyPropertyName();if(K1&&D1[K1]){r.oMultipleViewsHandler.restoreFromIappState(D1[K1]);}}function X(i){if(E){var D1=i['sap-ui-fe-variant-id'];if(D1&&D1[0]){r.oSmartFilterbar.getSmartVariant().setCurrentVariantId(D1[0]);}}else{var E1=i['sap-ui-fe-variant-id'],F1=i['sap-ui-fe-filterbar-variant-id'],G1=i['sap-ui-fe-chart-variant-id'],H1=i['sap-ui-fe-table-variant-id'];Y(F1&&F1[0],G1&&G1[0],H1&&H1[0],E1&&E1[0]);}}function Y(i,D1,E1,F1){if(i||F1){r.oSmartFilterbar.getSmartVariant().setCurrentVariantId(i||F1);}if(r.oSmartTable&&(E1||F1)){r.oSmartTable.attachAfterVariantInitialise(function(G1){r.oSmartTable.setCurrentVariantId(E1||F1);});r.oSmartTable.setCurrentVariantId(E1||F1);}r.oMultipleViewsHandler.setControlVariant(D1,E1,F1);}function Z(i){u.restoreCustomAppStateDataExtension(i||{});}function $(i){if(!i){return;}var D1=true;var E1=function(F1){if(!(F1 instanceof C)){throw new b(f,"State must always be retrieved with respect to a ControllerExtension");}var G1=F1.getMetadata().getNamespace();if(!D1){throw new b(f,"State must always be restored synchronously");}return i[G1];};u.templateBaseExtension.restoreExtensionAppStateData(E1);D1=false;}function _(i,D1){i=i||{};if(i.hasOwnProperty(h)&&i.hasOwnProperty(k)){$(i[j]);Z(i[h]);W(i[k],D1);}else{if(i._editStateFilter!==undefined){W({editStateFilter:i._editStateFilter});delete i._editStateFilter;}Z(i);}r.oSmartFilterbar.fireFilterChange();if(i[k]){if(i[k].variantDirty===undefined){i[k].variantDirty=true;}u.byId('template::PageVariant')&&u.byId('template::PageVariant').currentVariantSetModified(i[k].variantDirty);}}function a1(i){var D1=T.oComponentUtils.getTemplatePrivateModel();D1.setProperty("/generic/bDataAreShownInTable",i||r.oSmartFilterbar.getLiveMode());}function b1(i){m("changeIappState called",{bDataAreShown:i,bDataAreShownInTable:P(),bIgnoreFilterChange:G});if(G||r.oSmartFilterbar.isDialogOpen()||M){return;}a1(i);T.oComponentUtils.stateChanged();}function c1(i){var D1=r.oSmartFilterbar.determineMandatoryFilterItems(),E1;for(var F1=0;F1<D1.length;F1++){if(D1[F1].getName().indexOf("P_DisplayCurrency")!==-1){if(i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){E1=i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(E1){i.oSelectionVariant.addParameter("P_DisplayCurrency",E1);}}break;}}}function d1(){var i=r.oSmartFilterbar.determineMandatoryFilterItems();var D1=r.oSmartFilterbar.getFiltersWithValues();return i.every(function(E1){return D1.includes(E1);});}function e1(i){var D1=(typeof i.semanticDates==="string"?JSON.parse(i.semanticDates):i.semanticDates)||{};if(!r.oWorklistData.bWorkListEnabled){A1(i.oSelectionVariant||"",i.selectionVariant||"",true,D1,false);}if(!E&&i.tableVariantId){r.oSmartTable.setCurrentVariantId(i.tableVariantId);}i.customData=i.customData||{};if(r.oWorklistData.bWorkListEnabled){var E1=i.customData[k]&&i.customData[k].Worklist?i.customData[k].Worklist:{};r.oWorklistHandler.restoreWorklistStateFromIappState(E1);}B1(P());_(i.customData,true);j1(i.controlStates);}function f1(i,D1){X(D1);if(i.presentationVariant!==undefined){T.oCommonUtils.setControlSortOrder(r,i.presentationVariant);}if((i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(i.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){c1(i);}var E1={selectionVariant:i.oSelectionVariant,urlParameters:D1,selectedQuickVariantSelectionKey:"",semanticDates:(typeof i.semanticDates==="string"?JSON.parse(i.semanticDates):i.semanticDates)||{}};if(!r.oWorklistData.bWorkListEnabled){u.modifyStartupExtension(E1);if(r.oSmartFilterbar.isCurrentVariantStandard()){s.setSemanticDateRangeDefaultValue(H,r.oSmartFilterbar,E1.semanticDates,E1.urlParameters||{});}A1(E1.selectionVariant,i.selectionVariant||"",true,E1.semanticDates,false);}if(!E&&i.tableVariantId){r.oSmartTable.setCurrentVariantId(i.tableVariantId);}i.customData=i.customData||{};if(r.oWorklistData.bWorkListEnabled){var F1=i.customData[k]&&i.customData[k].Worklist?i.customData[k].Worklist:{};r.oWorklistHandler.restoreWorklistStateFromIappState(F1);}Z();r.oMultipleViewsHandler.handleStartUpObject(E1);var G1=true;if(!r.oWorklistData.bWorkListEnabled){if(!r.oSmartFilterbar.getLiveMode()&&!r.oSmartFilterbar.isCurrentVariantStandard()){G1=r.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();}a1(G1);if(G1){r.oSmartFilterbar.search();if(!D.system.desktop){u1();}}B1(G1);}b1(G1);}function g1(i){X(i);var D1={selectionVariant:"",urlParameters:i,selectedQuickVariantSelectionKey:"",semanticDates:{}};var E1=r.oSmartFilterbar.getUiState();var F1=new S(JSON.stringify(E1.getSelectionVariant()));w1(F1);var G1=JSON.parse(JSON.stringify(F1));var H1=E1.getSemanticDates();D1.selectionVariant=F1;D1.semanticDates=H1;u.modifyStartupExtension(D1);if(!(d(JSON.parse(JSON.stringify(D1.selectionVariant)),G1)&&d(D1.semanticDates,H1))){A1(D1.selectionVariant,"",true,D1.semanticDates,true);}Z();r.oMultipleViewsHandler.handleStartUpObject(D1);var I1=true;if(r.oWorklistData.bWorkListEnabled){if(r.oSmartFilterbar.isCurrentVariantStandard()){r.oWorklistHandler.restoreWorklistStateFromIappState();}}else{if(r.oSmartFilterbar.isCurrentVariantStandard()){s.setSemanticDateRangeDefaultValue(H,r.oSmartFilterbar,D1.semanticDates||{},D1.urlParameters);r.oSmartFilterbar.getSmartVariant().setExecuteOnStandard(C1(false));var J1=r.oSmartFilterbar.getSmartVariant().getExecuteOnStandard();if(J1||H.variantManagementHidden){var K1=C1(true);I1=K1===undefined?J1:K1;}else{I1=false;}}else{I1=r.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();}a1(I1);if(I1){r.oSmartFilterbar.search();if(!D.system.desktop){u1();}}B1(I1);}u.byId('template::PageVariant')&&u.byId('template::PageVariant').currentVariantSetModified(false);b1(I1);}function h1(i,D1){X(D1);var E1={selectionVariant:i.oSelectionVariant,urlParameters:D1,selectedQuickVariantSelectionKey:"",semanticDates:(typeof i.semanticDates==="string"?JSON.parse(i.semanticDates):i.semanticDates)||{}};if(i.presentationVariant!==undefined){T.oCommonUtils.setControlSortOrder(r,i.presentationVariant);}var F1=r.oSmartFilterbar.getUiState();var G1=new S(JSON.stringify(F1.getSelectionVariant()));var H1=JSON.parse(JSON.stringify(G1));var I1=F1.getSemanticDates();if((i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(i.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){c1(i);}if(!r.oWorklistData.bWorkListEnabled){if(r.oSmartFilterbar.isCurrentVariantStandard()){u.modifyStartupExtension(E1);s.setSemanticDateRangeDefaultValue(H,r.oSmartFilterbar,E1.semanticDates,E1.urlParameters);A1(l.getMergedVariants([G1,E1.selectionVariant]),i.selectionVariant,true,E1.semanticDates,false);}else{w1(G1);E1.selectionVariant=G1;E1.semanticDates=I1;u.modifyStartupExtension(E1);if(!(d(JSON.parse(JSON.stringify(E1.selectionVariant)),H1)&&d(E1.semanticDates,I1))){A1(E1.selectionVariant,i.selectionVariant,true,E1.semanticDates,false);}}}if(!E&&i.tableVariantId){r.oSmartTable.setCurrentVariantId(i.tableVariantId);}i.customData=i.customData||{};if(r.oWorklistData.bWorkListEnabled){var J1=i.customData[k]&&i.customData[k].Worklist?i.customData[k].Worklist:{};r.oWorklistHandler.restoreWorklistStateFromIappState(J1);}Z();r.oMultipleViewsHandler.handleStartUpObject(E1);var K1=true;if(!r.oWorklistData.bWorkListEnabled){if(r.oSmartFilterbar.isCurrentVariantStandard()){r.oSmartFilterbar.getSmartVariant().setExecuteOnStandard(C1(false));var L1=r.oSmartFilterbar.getSmartVariant().getExecuteOnStandard();if(L1||H.variantManagementHidden){var M1=C1(true);K1=M1===undefined?L1:M1;}else{K1=false;}}else{K1=r.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();}a1(K1);if(K1){r.oSmartFilterbar.search();if(!D.system.desktop){u1();}}B1(K1);}u.byId('template::PageVariant')&&u.byId('template::PageVariant').currentVariantSetModified(false);b1(K1);}function i1(i,D1,E1){m("fnAdaptToAppState called",{sNavType:E1});r.oSmartFilterbar.setSuppressSelection(false);M=false;switch(E1){case sap.ui.generic.app.navigation.service.NavType.iAppState:e1(i);break;case sap.ui.generic.app.navigation.service.NavType.initial:g1(D1);break;case sap.ui.generic.app.navigation.service.NavType.xAppState:case sap.ui.generic.app.navigation.service.NavType.URLParams:if(i.bNavSelVarHasDefaultsOnly){h1(i,D1);}else{f1(i,D1);}break;default:i1.apply(this,arguments);}}function j1(i){if(z){z.setState(i&&i[r.oSmartTable.getId()]);}y.setState(i&&i[x.getId()]);}function k1(r){if(!r){return w.then(l1);}var i=e({oDefaultedSelectionVariant:new S(),oSelectionVariant:new S(r&&r.selectionVariant)},r);w.then(function(){i1(i,{},a(r)?sap.ui.generic.app.navigation.service.NavType.initial:sap.ui.generic.app.navigation.service.NavType.iAppState);});return w;}function l1(){var i=new Promise(function(D1){try{var E1=A.parseNavigation();E1.done(function(G1,H1,I1){if(I1!==sap.ui.generic.app.navigation.service.NavType.iAppState){i1(G1,H1,I1);}D1();});E1.fail(function(G1,H1,I1){L.warning(G1.getErrorCode()+"app state could not be parsed - continuing with empty state");i1({},H1,sap.ui.generic.app.navigation.service.NavType.initial);D1();});}catch(F1){i1({},{},sap.ui.generic.app.navigation.service.NavType.initial);D1();}});return i;}function m1(){G=true;K=u.byId('template::PageVariant')&&u.byId('template::PageVariant').currentVariantGetModified();var i=V();i.customData['sap.suite.ui.generic.template.genericData'].variantDirty=false;r.oSmartFilterbar.setCustomFilterData(i.customData);G=false;}function n1(){b1(P());}function o1(i){var D1=i.getParameter("context");var E1=r.oSmartFilterbar.getFilterData(true);if(E1._CUSTOM!==undefined){if(r.oWorklistData.bWorkListEnabled){var F1=E1._CUSTOM[k]["Worklist"];r.oSmartFilterbar.setSuppressSelection(false);r.oWorklistData.oSearchField.setValue(F1.searchString);r.oWorklistData.oSearchField.fireSearch();}else{_(E1._CUSTOM);}}else{var G1=Q();n(G1[h]);n(G1[k]);_(G1);}if(I.indexOf(D1)<0){a1(i.getParameter("executeOnSelect"));u1();b1(P());}if(D1==="RESET"&&K){J.then(b1.bind(null,false));}}function p1(){J=new Promise(function(i){R=i;});}function q1(){R();}function r1(){if(!E){b1(P());}}function s1(){if(!E){b1(P());}}function t1(){r.oSmartFilterbar.attachFiltersDialogClosed(T.oComponentUtils.stateChanged);}function u1(){var i=u.getOwnerComponent().getModel("_templPriv");i.setProperty("/listReport/isHeaderExpanded",!P()||!d1());}function v1(i,D1,E1,F1){var G1=new U({selectionVariant:i,semanticDates:F1});r.oSmartFilterbar.setUiState(G1,{replace:D1,strictMode:E1});}function w1(i){i.removeSelectOption(h);i.removeSelectOption(k);}function x1(D1,E1,F1){if(D1&&(E1!==""||F1)){var G1=D1.getParameterNames().concat(D1.getSelectOptionsPropertyNames());for(var i=0;i<G1.length;i++){r.oSmartFilterbar.addFieldToAdvancedArea(G1[i]);}}}function y1(i,D1,E1){if(i.getParameter(D1)&&!i.getParameter(E1)){i.addParameter(E1,i.getParameter(D1));}if(i.getSelectOption(D1)&&!i.getSelectOption(E1)){var F1=i.getSelectOption(D1);F1.forEach(function(G1){i.addSelectOption(E1,G1.Sign,G1.Option,G1.Low,G1.High);});}}function z1(i){var D1=u.getOwnerComponent().getModel().getMetaModel();var E1=u.getOwnerComponent().getEntitySet();var F1=D1.getODataEntityType(D1.getODataEntitySet(E1).entityType);F1.property.forEach(function(G1){if(G1["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var H1=G1["com.sap.vocabularies.Common.v1.EditableFieldFor"].PropertyPath||G1["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var I1=G1.name;y1(i,H1,I1);y1(i,I1,H1);}});}function A1(i,D1,E1,F1,G1){z1(i);if(E1){r.oSmartFilterbar.clearVariantSelection();}x1(i,D1,G1);v1(i.toJSONObject(),E1,false,F1);}function B1(i){if(!i||!d1()){p.resetPlaceHolders(T);}}function C1(i){var D1;if(r.bLoadListAndFirstEntryOnStartup){D1=true;}else{var E1=r.oMultipleViewsHandler.getOriginalEnableAutoBinding();var F1=H.dataLoadSettings&&H.dataLoadSettings.loadDataOnAppLaunch;if(F1===""||F1===undefined&&(E1!==null&&E1!==undefined)){D1=E1&&d1();}else{if(i){if(F1==="ifAnyFilterExist"||F1===undefined||F1===""){D1=r.oSmartFilterbar.getFiltersWithValues().length>0&&d1();}else if(H.variantManagementHidden){if(F1==="never"){D1=false;}else if(F1==="always"){D1=d1();}}}else{D1=F1==="never"?false:d1();}}}return D1;}C1=t.testableStatic(C1,"IappStateHandler_getInitialLoadBehaviourSettings");return{areDataShownInTable:P,setDataShownInTable:a1,changeIappState:b1,onFiltersDialogBeforeOpen:p1,onFiltersDialogClosed:q1,onSmartFilterBarInitialise:t1,onSmartFilterBarInitialized:v,onBeforeSFBVariantFetch:m1,onAfterSFBVariantSave:n1,onAfterSFBVariantLoad:o1,onAfterTableVariantSave:r1,onAfterApplyTableVariant:s1,applyState:k1,getCurrentAppState:V,setFiltersUsingUIState:v1};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(i,r,T){e(this,q(i,r,T));}});});
