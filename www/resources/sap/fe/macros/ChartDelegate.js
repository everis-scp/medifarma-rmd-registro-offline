/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/library","sap/ui/mdc/ChartDelegate","sap/fe/macros/ODataMetaModelUtil","sap/base/util/merge","sap/fe/macros/chart/ChartUtils","sap/ui/base/SyncPromise","sap/base/Log","sap/fe/core/CommonUtils","sap/fe/macros/ResourceModel"],function(M,B,a,m,C,S,L,b,R){"use strict";var A="@Org.OData.Aggregation.V1";function f(H){this.name=H[0];this.label=H[1]||this.name;this.textProperty=H[2];this.type=a.getType(H[3]);if(H[4]||H[5]){var d=H[4],F=H[5];if(F){switch(F){case"year":this.timeUnit="fiscalyear";break;case"yearPeriod":this.timeUnit="fiscalyearperiod";break;default:this.timeUnit=undefined;break;}}if(d&&!this.timeUnit){switch(d){case"yearMonth":this.timeUnit="yearmonth";break;case"date":this.timeUnit="yearmonthday";break;case"yearQuarter":this.timeUnit="yearquarter";break;case"yearWeek":this.timeUnit="yearweek";break;default:this.timeUnit=undefined;break;}}}this.criticality=H[6];return this;}function h(k,d,o,e){var g=o&&o.GroupableProperties;var l=o&&o.AggregatableProperties;var G,n;if(g&&g.length){for(var i=0;i<g.length;i++){if(g[i].$PropertyPath===e[2]){G=true;break;}}}if(l&&l.length){for(var j=0;j<l.length;j++){if(l[j].Property.$PropertyPath===e[2]){n=true;break;}}}if(!g||(g&&!g.length)){G=e[0];}if(!l||(l&&!l.length)){n=e[1];}var H={},p={},I;p.inChart=G||n||false;if(p.inChart){p.chartItems=[];if(G){H.kind=M.ChartItemType.Dimension;H.role=M.ChartItemRoleType.category;I=Object.assign({},H);p.chartItems.push(I);}if(n){H.kind=M.ChartItemType.Measure;H.role=M.ChartItemRoleType.axis1;H.contextDefiningProperties=e[3]||[];p.name=e[2]||"";if(Object.keys(k).indexOf(p.name)>-1){for(var q in k[p.name]){I=Object.assign({},H);I.aggregationMethod=q;I.default=undefined;p.chartItems.push(I);}}else if(Object.keys(d).indexOf(p.name)>-1){for(var t in d){if(t===p.name){I=m({},d[t],{propertyPath:t,kind:M.ChartItemType.Measure,role:M.ChartItemRoleType.axis1,sortable:d[t].sortable});p.chartItems.push(I);break;}}}}}var u=this.getModel();return Promise.all([u.requestObject("@sapui.name",this),u.requestObject("@com.sap.vocabularies.Common.v1.Label",this),u.requestObject("@com.sap.vocabularies.Common.v1.Text/$Path",this),u.requestObject("$Type",this),a.fetchCalendarTag(u,this),a.fetchFiscalTag(u,this),a.fetchCriticality(u,this)]).then(f.bind(p));}function r(e,p,o,d,g){var k,P,j=[],I=[],l,n=[],q=[],D=[],t=[],u,K={},E=d.entitySetAnnotations,v=d.entityTypeAnnotations,w=d.applySupported;var x=a.getAllCustomAggregates(E);if(Object.keys(x).length>=1){t=g.getItems();for(var y in t){if(t[y].isA("sap.ui.mdc.chart.DimensionItem")){D.push(t[y].getKey());}else if(t[y].isA("sap.ui.mdc.chart.MeasureItem")){q.push(t[y].getKey());}}if(q.filter(function(i){return D.indexOf(i)!=-1;}).length>=1){L.error("Dimension and Measure has the sameProperty Configured");}}var T=a.getAllAggregatableProperties(v);for(var z in T){k=T[z].propertyPath;K[k]=K[k]||{};K[k][T[z].aggregationMethod]={name:T[z].name,label:T[z].label};}var F=a.getSortRestrictionsInfo(E["@Org.OData.Capabilities.V1.SortRestrictions"]);function G(P){var N=P.name||"",H=P.textProperty||"";var J=false;if(P.inChart&&N.indexOf("/")>-1){L.error("$expand is not yet supported. Property: "+N+" from an association cannot be used");return;}if(P.inChart&&H.indexOf("/")>-1){L.error("$expand is not yet supported. Text Property: "+H+" from an association cannot be used");J=true;}n.push(P);a.addSortInfoForProperty(P,F);if(P.inChart){for(var i=0;i<P.chartItems.length;i++){var O=P.chartItems[i];if(!O.custom){O.propertyPath=P.name;O.type=P.type;O.timeUnit=P.timeUnit;O.criticality=P.criticality;if(O.kind==M.ChartItemType.Measure){if(K[O.propertyPath]&&K[O.propertyPath][O.aggregationMethod]){O.name=K[O.propertyPath][O.aggregationMethod].name;O.label=K[O.propertyPath][O.aggregationMethod].label;}else{O.name=O.aggregationMethod+O.propertyPath;O.label=P.label+" ("+O.aggregationMethod+")";}O.customAggregate=false;O.sortable=P.sortable;O.sortDirection=P.sortDirection;}else{O.name=P.name;O.textProperty=!J?P.textProperty:undefined;O.label=P.label;O.sortable=P.sortable;O.sortDirection=P.sortDirection;O.allowedExpressions=P.allowedExpressions;}}I.push(O);}}}for(k in e){if(k[0]!=="$"){P=e[k];if(P&&P.$kind){if(P.$kind=="Property"){l=p+k+A;j.push(Promise.all([o.requestObject(l+".Groupable"),o.requestObject(l+".Aggregatable"),o.requestObject("@sapui.name",o.getMetaContext(p+k)),o.requestObject(l+".ContextDefiningProperties")]).then(h.bind(o.getMetaContext(p+k),K,x,w)).then(G));}}}}return Promise.all(j).then(function(){return[u,n,I];});}var c=Object.assign({},B);c.retrieveAggregationItem=function(d,o){var e;var g={className:"",settings:{key:o.name,label:o.label||o.name,type:o.type}};switch(o.kind){case M.ChartItemType.Dimension:g.className="sap.ui.mdc.chart.DimensionItem";e={textProperty:o.textProperty,timeUnit:o.timeUnit,displayText:true,criticality:o.criticality};break;case M.ChartItemType.Measure:g.className="sap.ui.mdc.chart.MeasureItem";if(o.custom){e={};}else{e={propertyPath:o.propertyPath,aggregationMethod:o.aggregationMethod};}break;}g.settings=Object.assign(g.settings,e);return g;};c.fetchProperties=function(o){return c.retrieveAllMetadata(o).then(function(d){return d.properties;});};c.retrieveAllMetadata=function(o){var d=c.getModel(o);function e(g){var D=o.getDelegate(),p=D.payload.contextPath,i=g&&g.getMetaModel();if(p.endsWith("/")){throw new Error("The leading path for metadata calculation is the entity set not the path");}var j=p,t=p+"/";function k(n){var q={sortable:n[0],attributes:n[1],properties:n[2]};return q;}var l=[i.requestObject(t),i.requestObject(j),i.requestObject(j+A+".ApplySupported")];return Promise.all(l).then(function(T){var E=T[0];var n=T[2];var q=[a.fetchAllAnnotations(i,t),a.fetchAllAnnotations(i,j)];return Promise.all(q).then(function(u){var v={entityTypeAnnotations:u[0],entitySetAnnotations:u[1],applySupported:n};return r(E,t,i,v,o);});}).then(k);}return d.then(e);};c.getModel=function(o){var v=o.getDelegate().model,d=o.getModel(v);if(d){return S.resolve(d);}return new S(function(e,g){function i(){var d=o.getModel(v);if(d){o.detachModelContextChange(i,o);return e(d);}}o.attachModelContextChange(i,o);});};function s(o,d){var n="",e=C.getAllFilterInfo(o),g=d.path.substr(1);if(o.getFilter()){if(e.search||(e.filters&&e.filters.length)){n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}else{n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT";}}else{if(e.search||(e.filters&&e.filters.length)){n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}else{n="M_OP_TABLE_AND_CHART_OP_NO_FILTERS_NO_DATA_TEXT";}}if(n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"||n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT"){return o.getModel("sap.fe.i18n").getResourceBundle().then(function(i){o.setNoDataText(b.getTranslatedText(n,i,null,g));}).catch(function(i){L.error(i);});}else{if(R){o.setNoDataText(R.getText(n));}}}c.updateBindingInfo=function(o,d,e){s(o,d);e=e||o.getBindingInfo("data");var i=o.getAggregation("_chart");if(i){var F;if(C.getChartSelectionsExist(o)){F=C.getAllFilterInfo(o);}}F=F?F:C.getFilterBarFilterInfo(o);if(F.bindingPath){e.path=F.bindingPath;}e.filters=F.filters;};return c;},false);
