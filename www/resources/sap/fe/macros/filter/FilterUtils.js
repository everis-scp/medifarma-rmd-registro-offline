/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/util/FilterUtil","sap/ui/fl/Utils","sap/ui/core/Core","sap/fe/macros/CommonHelper","sap/fe/core/CommonUtils","sap/fe/core/helpers/ModelHelper","sap/ui/model/Filter","sap/fe/macros/DelegateUtil","sap/fe/core/converters/templates/ListReportConverter","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/MetaModelConverter","sap/base/util/merge","sap/ui/model/json/JSONModel","sap/ui/mdc/field/ConditionsType","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/condition/ConditionConverter","sap/ui/model/odata/v4/ODataUtils","sap/base/Log"],function(F,a,C,b,c,M,d,D,L,e,f,m,J,g,S,h,O,j){"use strict";var o={getFilter:function(i){var k=o.getFilterInfo(i).filters;return k.length?new d(o.getFilterInfo(i).filters,false):undefined;},getConvertedFilterFields:function(i,E){var s=D.getCustomData(i,"entityType"),k=M.getEntitySetPath(s),l=E&&M.getEntitySetPath(E),t=l||k,T=t?t.slice(1):t,n="selectionFields"+(!t||k===t?"":"For"+T),p=D.getCustomData(i,n);if(!p&&(!t||!(i.data instanceof Function))){return[];}else if(!p){var v=a.getViewForControl(i);var q=i.getModel().getMetaModel();var A=c.getAppComponent(v);var V=f.getInvolvedDataModelObjects(q.createBindingContext("/"+T));var r=e.createConverterContextForMacro(V.startingEntitySet.name,q,A&&A.getDiagnostics(),m,V.contextLocation,v&&v.getViewData());p=L.getSelectionFields(r);if(i.isA("sap.ui.mdc.FilterBar")&&l!==k){var P=r.getConverterContextFor(k);var u=P.getEntityTypeAnnotation("@com.sap.vocabularies.UI.v1.SelectionFields").annotation||[];var w={};p.forEach(function(x){w[x.conditionPath]=true;});u.forEach(function(x){var y=x.value;if(!w[y]){var z=L.getFilterField(y,r,V.startingEntitySet.entityType);if(z){p.push(z);}}});}D.setCustomData(i,n,p);}return b.parseCustomData(p);},getBindingPathForParameters:function(I,k,l,p){var B,P=[];for(var i=0;i<p.length;i++){var s=p[i];if(k[s]&&k[s].length>0){var n=m({},k[s][0]);var q=F.getPropertyByKey(l,s);var r=h.toType(n,q.typeConfig,I.getTypeUtil());var E=q.typeConfig.className;P.push(s+"="+encodeURIComponent(O.formatLiteral(r.values[0],E)));}}var t=I.data("entityType");var u=t.substring(0,t.length-1);var v=u.slice(0,u.lastIndexOf("/"));var T=u.substring(u.lastIndexOf("/")+1);B=v+"("+P.toString()+")/"+T;return B;},getFilterInfo:function(I,p,k){var l=I,s,B,n=[],q=(p&&p.ignoredProperties)||[],P=p&&p.propertiesMetadata,t=p&&p.targetControl,T=t?t.data("entityType"):undefined;if(typeof I==="string"){l=C.byId(I);}if(l){s=l.getSearch&&q.indexOf("search")===-1?l.getSearch():null;var r=k||l.getConditions(),u=l.getPropertyInfoSet?l.getPropertyInfoSet():null;var v=l.data("parameters")||[];if(v.length>0){B=o.getBindingPathForParameters(l,r,u,v);}if(r){if(T&&l.data("entityType")!==T){var w=l.getModel().getMetaModel();var x=l.getControlDelegate().fetchPropertiesForEntity(T,w,l);P=x;var E={};for(var i=0;i<x.length;i++){var y=x[i];E[y.name]=true;}u.forEach(function(A){var G=A.name;if(!E[G]){q.push(G);}});}else if(!P){P=u;}var z=F.getFilterInfo(l,r,P,q.concat(v)).filters;n=z?[z]:[];}}return{filters:n,search:s||undefined,bindingPath:B};},getNotApplicableFiltersForTable:function(i,t){var T=t.data("entityType"),n=[],k=i.getConditions(),l=i.getModel().getMetaModel(),I=T===i.data("entityType"),p=D.getCustomData(t,"enableAnalytics")==="true";if(k&&(!I||p)){var q=I?[]:i.getControlDelegate().fetchPropertiesForEntity(T,l,i),r=q.reduce(function(v,w){v[w.name]=w;return v;},{}),s=b.parseCustomData(D.getCustomData(t,"aggregates")||{}),A={};Object.keys(s).forEach(function(v){var w=s[v];A[w.relativePath]=w;});for(var P in k){var u=k[P];if(Array.isArray(u)&&u.length>0&&((!r[P]&&!I)||A[P])){n.push(P.replace(/\+|\*/g,""));}}}if(p&&i.getSearch()){n.push("$search");}return n;},attachConditionHandling:function(i){var k=new J(),E={filterControl:i,filterModel:k},t=this;i.setModel(k,"filterValues");return i.initialized().then(function(){var l=i._getConditionModel();l.attachPropertyChange(E,t._handleConditionModelChange,t);k.attachPropertyChange(E,t._handleFilterModelChange,t);});},detachConditionHandling:function(i){var k=i.getModel("filterValues"),l=i._getConditionModel();l.detachPropertyChange(this._handleConditionModelChange,this);k.detachPropertyChange(this._handleFilterModelChange,this);k.destroy();},setFilterValues:function(i,s,k,v){var l={};if(v===undefined){v=k;}else{l.operators=[k];}if(typeof v==="object"&&v.operator){l.operators=[v.operator];v=v.values;}var n=new g(l),p={},q={};v=Array.isArray(v)?v:[v];p[s]=[];if(k){q[s]=v.filter(function(V){return V!==undefined&&V!==null;}).reduce(function(A,V){return A.concat(n.parseValue(V.toString(),"any"));},[]);}return S.applyExternalState(i,{filter:p}).then(S.applyExternalState.bind(S,i,{filter:q}));},conditionToModelPath:function(s){return s.replace(/\//g,"\\");},modelToConditionPath:function(s){return s.replace(/\\/g,"/");},_handleConditionModelChange:function(E,i){var s=this.modelToConditionPath(E.getParameter("path").substring(12)),k=new g({maxConditions:-1}),l=i.filterModel,v=E.getParameter("value"),V=k.formatValue(v,"any");l.setProperty("/"+this.conditionToModelPath(s),V);},_handleFilterModelChange:function(E,i){var p=E.getParameter("context").getPath().substring(1).replace(/\\/g,"/"),v=E.getParameter("value");this.setFilterValues(i.filterControl,p,v);}};return o;});
