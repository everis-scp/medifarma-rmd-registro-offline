/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/model/odata/v4/AnnotationHelper","sap/fe/macros/CommonHelper","sap/ui/core/format/NumberFormat","sap/fe/macros/ResourceModel","sap/fe/macros/ODataMetaModelUtil","sap/fe/core/templating/FilterHelper","sap/fe/core/templating/CriticalityFormatters","sap/fe/macros/field/FieldTemplating","sap/fe/macros/visualfilters/VisualFilterUtils"],function(L,O,C,N,R,a,F,b,c,V){"use strict";var I={getChartDisplayedValue:function(v,o,i){return("{parts:[{path:'"+v+"',type:'sap.ui.model.odata.type.Decimal', constraints:{'nullable':false}}"+(o&&o.ScaleFactor?",{value:'"+o.ScaleFactor.$Decimal+"'}":",{path:'internal>scalefactorNumber/"+i+"'}")+"], formatter:'.formatters.scaleVisualFilterValue'}");},getChartValue:function(v){return"{path:'"+v+"',type:'sap.ui.model.odata.type.Decimal', constraints:{'nullable':false}}";},getChart:function(m){var M=m.getModel();var p=M.getObject(m.getPath());var v=p.Visualizations;for(var i=0;i<v.length;i++){if(v[i].$AnnotationPath.indexOf("com.sap.vocabularies.UI.v1.Chart")>-1){var s=O.getNavigationPath(m.getPath());return M.createBindingContext(s+"/"+v[i].$AnnotationPath);}}return undefined;},getChartLabel:function(){return arguments[2];},getAggregationBinding:function(i,o,d,t,D,s,e,f,A,u){var g=o.Dimensions[0].$PropertyPath;var m=o.Measures[0].$PropertyPath,B,h,j=[],k,U,T;var l=(d.$kind=="EntitySet"?"/":"")+i.getModel(1).getObject(i.getPath(1)+"@sapui.name");var v=I.getUoM(i,o,d,undefined,f,A);if(e&&e.getObject()){var n=i.getInterface(1).getPath(),M=i.getInterface(1).getModel(),p=M.getObject(n+"/");var q=F.getFiltersConditionsFromSelectionVariant(p,e.getObject(),V.getCustomConditions.bind(V));for(var P in q){var r=q[P];r.forEach(function(w){j.push(w);});}}if(f){if(u){k=v&&v.$Path?"{ 'unit' : '"+v.$Path+"' }":"{}";U="";}else{k="{}";U=v&&v.$Path?", '"+v.$Path+"' : {}":"";}}else if(A&&A.AggregatableProperty&&A.AggregatableProperty.value&&A.AggregationMethod){k="{ 'name' : '"+A.AggregatableProperty.value+"', 'with' : '"+A.AggregationMethod+"'}";U=v&&v.$Path?", '"+v.$Path+"' : {}":"";}T=t?"' : { 'additionally' : ['"+t.$Path+"'] }":"' : { }";h=JSON.stringify(j);B="{path: '"+l+"', suspended : true, 'filters' : "+h+",'parameters' : {"+I.getSortOrder(o,D,s)+", '$$aggregation' : {'aggregate' : {'"+m+"' : "+k+"},'group' : {'"+g+T+U+"} } }"+I.getMaxItems(o)+",'events': {'dataReceived':'.handlers.onVisualFilterDataReceived'}}";return B;},getSortOrder:function(o,d,s){if(o.ChartType.$EnumMember==="com.sap.vocabularies.UI.v1.ChartType/Donut"||o.ChartType.$EnumMember==="com.sap.vocabularies.UI.v1.ChartType/Bar"){if(s&&s.length&&s[0].Property.$PropertyPath===o.Measures[0].$PropertyPath){return"'$orderby' : '"+s[0].Property.$PropertyPath+(s[0].Descending?" desc'":"'");}else{return"'$orderby' : '"+o.Measures[0].$PropertyPath+" desc'";}}else{if(d==="Edm.Date"||d==="Edm.Time"||d==="Edm.DateTimeOffset"){return"'$orderby' : '"+o.Dimensions[0].$PropertyPath+"'";}else{if(s&&s.length&&s[0].Property.$PropertyPath===o.Dimensions[0].$PropertyPath){return"'$orderby' : '"+s[0].Property.$PropertyPath+(s[0].Descending?" desc'":"'");}else{return"'$orderby' : '"+o.Dimensions[0].$PropertyPath+"'";}}}},getMaxItems:function(o){if(o.ChartType.$EnumMember==="com.sap.vocabularies.UI.v1.ChartType/Bar"){return",'startIndex' : 0,'length' : 3";}else if(o.ChartType.$EnumMember==="com.sap.vocabularies.UI.v1.ChartType/Line"){return",'startIndex' : 0,'length' : 6";}else{return"";}},getColorBinding:function(i,d,D){var m=i.getModel(0);var o=i.getPath(1);var v=m.getObject(o+"$PropertyPath@com.sap.vocabularies.UI.v1.ValueCriticality");d=d.targetObject;if(d.Criticality){return b.buildExpressionForCriticalityColorMicroChart(d);}else if(d.CriticalityCalculation){var e=d.CriticalityCalculation.ImprovementDirection&&d.CriticalityCalculation.ImprovementDirection.$EnumMember;var f=O.value(d.Value,{context:i.getInterface(0)});var g=O.value(d.CriticalityCalculation.DeviationRangeLowValue,{context:i.getInterface(0)});var t=O.value(d.CriticalityCalculation.ToleranceRangeLowValue,{context:i.getInterface(0)});var A=O.value(d.CriticalityCalculation.AcceptanceRangeLowValue,{context:i.getInterface(0)});var h=O.value(d.CriticalityCalculation.AcceptanceRangeHighValue,{context:i.getInterface(0)});var T=O.value(d.CriticalityCalculation.ToleranceRangeHighValue,{context:i.getInterface(0)});var j=O.value(d.CriticalityCalculation.DeviationRangeHighValue,{context:i.getInterface(0)});return C.getCriticalityCalculationBinding(e,f,g,t,A,h,T,j);}else if(v.length){return C.getValueCriticality(D.$PropertyPath,v);}else{return undefined;}},getScaleUoMTitle:function(i,o,d,v,e,A,s,f){var m=i.getModel(0);var S=m.getObject(i.getPath(0)+"/MeasureAttributes/0/DataPoint/$AnnotationPath/ValueFormat/ScaleFactor/$Decimal");var g=N.getIntegerInstance({style:"short",showScale:false,shortRefNumber:S});var h=g.getScale();var u=I.getUoM(i,o,d,undefined,e,A);var E;u=u&&(u.$Path?"${internal>uom/"+v+"}":"'"+u+"'");h=h?"'"+h+"'":"${internal>scalefactor/"+v+"}";E=h&&u?"' "+(s?s:"|")+" ' + "+h+" + ' ' + "+u:"' "+(s?s:"|")+" ' +  "+(h||u);return f?E:"{= "+E+"}";},getMeasureDimensionTitle:function(i,o,d,e,A){var m=i.getModel(0);var M;var s=m.getObject(i.getPath(0)+"/Measures/0/$PropertyPath");var D=m.getObject(i.getPath(0)+"/Dimensions/0/$PropertyPath");var f=I.getLabel(m,i,"Dimensions");if(!e&&A){M=A.annotations&&A.annotations.Common&&A.annotations.Common.Label;if(M===undefined){M=M=I.getLabel(m,i,"Measures");}}else{M=I.getLabel(m,i,"Measures");}if(M===undefined){M=s;}if(f===undefined){f=D;}return(R&&R.getText("M_INTERACTIVE_CHART_HELPER_VISUALFILTER_MEASURE_DIMENSION_TITLE",[M,f]));},getLabel:function(m,i,p){var l=m.getObject(i.getPath(0)+"/"+p+"/0/$PropertyPath@com.sap.vocabularies.Common.v1.Label");return l;},getToolTip:function(i,o,d,v,e,A){var m=I.getMeasureDimensionTitle(i,o,d,e,A);var s=R.getText("M_INTERACTIVE_CHART_HELPER_VISUALFILTER_TOOLTIP_SEPERATOR");var S=I.getScaleUoMTitle(i,o,d,v,e,A,s,true);return"{= '"+m+(S?"' + "+S:"'")+"}";},getUoM:function(i,o,d,e,f,A){var m=i.getModel(0);var v=m.getObject(i.getPath(0)+"/Measures/0/$PropertyPath@Org.OData.Measures.V1.ISOCurrency");var u=m.getObject(i.getPath(0)+"/Measures/0/$PropertyPath@Org.OData.Measures.V1.Unit");var M=m.getObject(i.getPath(0)+"/Measures/0/$PropertyPath");var s;if(!f&&A){s=A.AggregatableProperty&&A.AggregatableProperty.value;}else{s=M;}var _=function(U,g){var h=g&&g.split("V1.")[1];var j={};if(U){j[h]=U;return e&&U.$Path?JSON.stringify(j):U;}else if(s){U=i.getModel(1).getObject(i.getPath(1)+"/"+s+g);j[h]=U;return U&&e&&U.$Path?JSON.stringify(j):U;}};return _(v,"@Org.OData.Measures.V1.ISOCurrency")||_(u,"@Org.OData.Measures.V1.Unit");},getScaleFactor:function(v){if(v&&v.ScaleFactor){return v.ScaleFactor.$Decimal;}return undefined;},getI18nMeasureHidden:function(m){var M=m&&m.$PropertyPath;return R.getText("M_VISUAL_FILTER_HIDDEN_MEASURE",M);},getHiddenMeasure:function(i,o,d,e,A){var m=i.getModel(0);var M=m.getObject(i.getPath(0)+"/Measures/0/$PropertyPath");var s;if(!e&&A){s=A.AggregatableProperty&&A.AggregatableProperty.value;}else{s=M;}var h=m.getObject(i.getPath(0)+"/Measures/0/$PropertyPath@com.sap.vocabularies.UI.v1.Hidden");if(h){h=true;}else if(A&&A.annotations&&A.annotations.UI&&A.annotations.UI.Hidden){h=true;}else if(s&&i.getModel(1).getObject(i.getPath(1)+"/"+s+"@com.sap.vocabularies.UI.v1.Hidden")){h=true;}return h;},getUoMVisiblity:function(i,o,d,e,A){var s=o&&o["ChartType"]&&o["ChartType"]["$EnumMember"];var m=I.getHiddenMeasure(i,o,d,e,A);if(m){return false;}else if(!(s==="com.sap.vocabularies.UI.v1.ChartType/Bar"||s==="com.sap.vocabularies.UI.v1.ChartType/Line")){return false;}else{return true;}},getInParameterFiltersBinding:function(i){if(i.length>0){var p=[],P="";i.forEach(function(o){if(o.localDataProperty){p.push("{path:'$filters>/conditions/"+o.localDataProperty+"'}");}});if(p.length>0){P=p.join();return("{parts:["+P+"], formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.getFiltersFromConditions'}");}else{return undefined;}}else{return undefined;}}};I.getColorBinding.requiresIContext=true;I.getAggregationBinding.requiresIContext=true;I.getUoM.requiresIContext=true;I.getScaleUoMTitle.requiresIContext=true;I.getToolTip.requiresIContext=true;I.getHiddenMeasure.requiresIContext=true;I.getMeasureDimensionTitle.requiresIContext=true;I.getUoMVisiblity.requiresIContext=true;return I;},true);
