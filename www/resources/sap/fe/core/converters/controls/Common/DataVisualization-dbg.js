/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["./Table", "./Chart", "sap/fe/core/converters/helpers/IssueManager", "../../ManifestSettings"], function (Table, Chart, IssueManager, ManifestSettings) {
  "use strict";

  var _exports = {};
  var TemplateType = ManifestSettings.TemplateType;
  var IssueCategory = IssueManager.IssueCategory;
  var IssueSeverity = IssueManager.IssueSeverity;
  var IssueType = IssueManager.IssueType;
  var createChartVisualization = Chart.createChartVisualization;
  var createTableVisualization = Table.createTableVisualization;
  var createDefaultTableVisualization = Table.createDefaultTableVisualization;

  var getVisualizationsFromPresentationVariant = function (presentationVariantAnnotation, visualizationPath, converterContext, viewConfiguration) {
    var visualizationAnnotations = [];
    var visualizations = presentationVariantAnnotation.Visualizations || [];
    var baseVisualizationPath = visualizationPath.split("@")[0];

    if (visualizations) {
      // Only allow one line item / chart
      var hasLineItem = false;
      var hasChart = false;
      var hasVisualization = false; // used to allow only first visualization in OP

      visualizations.forEach(function (visualization) {
        switch (visualization.$target.term) {
          case "com.sap.vocabularies.UI.v1.LineItem":
            if (!hasLineItem) {
              if (!(converterContext.getTemplateType() === TemplateType.ObjectPage && hasVisualization)) {
                visualizationAnnotations.push({
                  visualization: visualization.$target,
                  annotationPath: "".concat(baseVisualizationPath).concat(visualization.value),
                  converterContext: converterContext
                });
                hasLineItem = true;
                hasVisualization = true;
              }
            }

            break;

          case "com.sap.vocabularies.UI.v1.Chart":
            if (!hasChart && (viewConfiguration && converterContext.getManifestWrapper().hasMultipleVisualizations(viewConfiguration) && converterContext.getTemplateType() === TemplateType.ListReport || converterContext.getTemplateType() === TemplateType.AnalyticalListPage && !converterContext.getManifestWrapper().getViewConfiguration() || converterContext.getTemplateType() === TemplateType.ObjectPage && !hasVisualization)) {
              visualizationAnnotations.push({
                visualization: visualization.$target,
                annotationPath: "".concat(baseVisualizationPath).concat(visualization.value),
                converterContext: converterContext
              });
              hasChart = true;
              hasVisualization = true;
            }

            break;

          default:
            break;
        }
      });
    }

    return visualizationAnnotations;
  };

  function getSelectionPresentationVariant(entityType, annotationPath, converterContext) {
    if (annotationPath) {
      var resolvedTarget = converterContext.getEntityTypeAnnotation(annotationPath);
      var selectionPresentationVariant = resolvedTarget.annotation;

      if (selectionPresentationVariant) {
        if (selectionPresentationVariant.term === "com.sap.vocabularies.UI.v1.SelectionPresentationVariant") {
          return selectionPresentationVariant;
        }
      } else {
        throw new Error("Annotation Path for the SPV mentioned in the manifest is not found, Please add the SPV in the annotation");
      }
    } else {
      var _entityType$annotatio, _entityType$annotatio2;

      return (_entityType$annotatio = entityType.annotations) === null || _entityType$annotatio === void 0 ? void 0 : (_entityType$annotatio2 = _entityType$annotatio.UI) === null || _entityType$annotatio2 === void 0 ? void 0 : _entityType$annotatio2.SelectionPresentationVariant;
    }
  }

  _exports.getSelectionPresentationVariant = getSelectionPresentationVariant;

  function isSelectionPresentationCompliant(SelectionPresentationVariant, bIsALP) {
    var presentationVariant = SelectionPresentationVariant && SelectionPresentationVariant.PresentationVariant;

    if (presentationVariant) {
      return isPresentationCompliant(presentationVariant, bIsALP);
    } else {
      throw new Error("Presentation Variant is not present in the SPV annotation");
    }
  }

  _exports.isSelectionPresentationCompliant = isSelectionPresentationCompliant;

  function isPresentationCompliant(presentationVariant, bIsALP) {
    var bHasTable = false,
        bHasChart = false;

    if (bIsALP) {
      if (presentationVariant && presentationVariant.Visualizations) {
        var aVisualizations = presentationVariant.Visualizations;
        aVisualizations.map(function (oVisualization) {
          if (oVisualization.$target.term === "com.sap.vocabularies.UI.v1.LineItem") {
            bHasTable = true;
          }

          if (oVisualization.$target.term === "com.sap.vocabularies.UI.v1.Chart") {
            bHasChart = true;
          }
        });
      }

      return bHasChart && bHasTable;
    } else {
      return presentationVariant && presentationVariant.Visualizations && !!presentationVariant.Visualizations.find(function (visualization) {
        return visualization.$target.term === "com.sap.vocabularies.UI.v1.LineItem";
      });
    }
  }

  _exports.isPresentationCompliant = isPresentationCompliant;

  function getDefaultLineItem(entityType) {
    var _entityType$annotatio3;

    return (_entityType$annotatio3 = entityType.annotations.UI) === null || _entityType$annotatio3 === void 0 ? void 0 : _entityType$annotatio3.LineItem;
  }

  _exports.getDefaultLineItem = getDefaultLineItem;

  function getDefaultChart(entityType) {
    var _entityType$annotatio4;

    return (_entityType$annotatio4 = entityType.annotations.UI) === null || _entityType$annotatio4 === void 0 ? void 0 : _entityType$annotatio4.Chart;
  }

  _exports.getDefaultChart = getDefaultChart;

  function getDefaultPresentationVariant(entityType) {
    var _entityType$annotatio5, _entityType$annotatio6;

    return (_entityType$annotatio5 = entityType.annotations) === null || _entityType$annotatio5 === void 0 ? void 0 : (_entityType$annotatio6 = _entityType$annotatio5.UI) === null || _entityType$annotatio6 === void 0 ? void 0 : _entityType$annotatio6.PresentationVariant;
  }

  _exports.getDefaultPresentationVariant = getDefaultPresentationVariant;

  function getDefaultSelectionVariant(entityType) {
    var _entityType$annotatio7, _entityType$annotatio8;

    return (_entityType$annotatio7 = entityType.annotations) === null || _entityType$annotatio7 === void 0 ? void 0 : (_entityType$annotatio8 = _entityType$annotatio7.UI) === null || _entityType$annotatio8 === void 0 ? void 0 : _entityType$annotatio8.SelectionVariant;
  }

  _exports.getDefaultSelectionVariant = getDefaultSelectionVariant;

  function getSelectionVariant(entityType, converterContext) {
    var annotationPath = converterContext.getManifestWrapper().getDefaultTemplateAnnotationPath();
    var selectionPresentationVariant = getSelectionPresentationVariant(entityType, annotationPath, converterContext);
    var selectionVariant;

    if (selectionPresentationVariant) {
      var _selectionVariant = selectionPresentationVariant.SelectionVariant;

      if (_selectionVariant) {
        return _selectionVariant;
      }
    } else {
      selectionVariant = getDefaultSelectionVariant(entityType);
      return selectionVariant;
    }
  }

  _exports.getSelectionVariant = getSelectionVariant;

  function getDataVisualizationConfiguration(visualizationPath, isCondensedTableLayoutCompliant, converterContext, viewConfiguration, doNotCheckApplySupported) {
    var resolvedTarget = converterContext.getEntityTypeAnnotation(visualizationPath);
    var visualization = resolvedTarget.annotation;
    converterContext = resolvedTarget.converterContext;
    var visualizationAnnotations = [];
    var presentationVariantAnnotation;
    var presentationPath = "";
    var chartVisualization, tableVisualization;
    var sTerm = visualization === null || visualization === void 0 ? void 0 : visualization.term;

    if (sTerm) {
      switch (sTerm) {
        case "com.sap.vocabularies.UI.v1.LineItem":
        case "com.sap.vocabularies.UI.v1.Chart":
          visualizationAnnotations.push({
            visualization: visualization,
            annotationPath: visualizationPath,
            converterContext: converterContext
          });
          break;

        case "com.sap.vocabularies.UI.v1.PresentationVariant":
          presentationVariantAnnotation = visualization;
          visualizationAnnotations = visualizationAnnotations.concat(getVisualizationsFromPresentationVariant(visualization, visualizationPath, converterContext, viewConfiguration));
          break;

        case "com.sap.vocabularies.UI.v1.SelectionPresentationVariant":
          presentationVariantAnnotation = visualization.PresentationVariant; // Presentation can be inline or outside the SelectionPresentationVariant

          presentationPath = presentationVariantAnnotation.fullyQualifiedName;

          if (!isPresentationCompliant(presentationVariantAnnotation)) {
            var entityType = converterContext.getEntityType();
            var defaultLineItemAnnotation = getDefaultLineItem(entityType);

            if (defaultLineItemAnnotation) {
              visualizationAnnotations.push({
                visualization: defaultLineItemAnnotation,
                annotationPath: converterContext.getRelativeAnnotationPath(defaultLineItemAnnotation.fullyQualifiedName, entityType),
                converterContext: converterContext
              });
            }
          } else {
            visualizationAnnotations = visualizationAnnotations.concat(getVisualizationsFromPresentationVariant(presentationVariantAnnotation, visualizationPath, converterContext, viewConfiguration));
          }

          break;

        default:
          break;
      }

      visualizationAnnotations.map(function (visualizationAnnotation) {
        var visualization = visualizationAnnotation.visualization,
            annotationPath = visualizationAnnotation.annotationPath,
            converterContext = visualizationAnnotation.converterContext;

        switch (visualization.term) {
          case "com.sap.vocabularies.UI.v1.Chart":
            chartVisualization = createChartVisualization(visualization, annotationPath, converterContext, doNotCheckApplySupported);
            break;

          case "com.sap.vocabularies.UI.v1.LineItem":
          default:
            tableVisualization = createTableVisualization(visualization, annotationPath, converterContext, presentationVariantAnnotation, isCondensedTableLayoutCompliant, viewConfiguration);
            break;
        }
      });
    } else {
      tableVisualization = createDefaultTableVisualization(converterContext);
      converterContext.getDiagnostics().addIssue(IssueCategory.Annotation, IssueSeverity.Medium, IssueType.MISSING_LINEITEM);
    }

    var aVisualizations = [];
    var sPath = sTerm === "com.sap.vocabularies.UI.v1.SelectionPresentationVariant" ? presentationPath : visualization && visualization.fullyQualifiedName;

    if (sPath === undefined) {
      sPath = "/";
    }

    if (chartVisualization) {
      aVisualizations.push(chartVisualization);
    }

    if (tableVisualization) {
      aVisualizations.push(tableVisualization);
    }

    return {
      visualizations: aVisualizations,
      annotationPath: converterContext.getEntitySetBasedAnnotationPath(sPath)
    };
  }

  _exports.getDataVisualizationConfiguration = getDataVisualizationConfiguration;
  return _exports;
}, false);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkRhdGFWaXN1YWxpemF0aW9uLnRzIl0sIm5hbWVzIjpbImdldFZpc3VhbGl6YXRpb25zRnJvbVByZXNlbnRhdGlvblZhcmlhbnQiLCJwcmVzZW50YXRpb25WYXJpYW50QW5ub3RhdGlvbiIsInZpc3VhbGl6YXRpb25QYXRoIiwiY29udmVydGVyQ29udGV4dCIsInZpZXdDb25maWd1cmF0aW9uIiwidmlzdWFsaXphdGlvbkFubm90YXRpb25zIiwidmlzdWFsaXphdGlvbnMiLCJWaXN1YWxpemF0aW9ucyIsImJhc2VWaXN1YWxpemF0aW9uUGF0aCIsInNwbGl0IiwiaGFzTGluZUl0ZW0iLCJoYXNDaGFydCIsImhhc1Zpc3VhbGl6YXRpb24iLCJmb3JFYWNoIiwidmlzdWFsaXphdGlvbiIsIiR0YXJnZXQiLCJ0ZXJtIiwiZ2V0VGVtcGxhdGVUeXBlIiwiVGVtcGxhdGVUeXBlIiwiT2JqZWN0UGFnZSIsInB1c2giLCJhbm5vdGF0aW9uUGF0aCIsInZhbHVlIiwiZ2V0TWFuaWZlc3RXcmFwcGVyIiwiaGFzTXVsdGlwbGVWaXN1YWxpemF0aW9ucyIsIkxpc3RSZXBvcnQiLCJBbmFseXRpY2FsTGlzdFBhZ2UiLCJnZXRWaWV3Q29uZmlndXJhdGlvbiIsImdldFNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnQiLCJlbnRpdHlUeXBlIiwicmVzb2x2ZWRUYXJnZXQiLCJnZXRFbnRpdHlUeXBlQW5ub3RhdGlvbiIsInNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnQiLCJhbm5vdGF0aW9uIiwiRXJyb3IiLCJhbm5vdGF0aW9ucyIsIlVJIiwiU2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudCIsImlzU2VsZWN0aW9uUHJlc2VudGF0aW9uQ29tcGxpYW50IiwiYklzQUxQIiwicHJlc2VudGF0aW9uVmFyaWFudCIsIlByZXNlbnRhdGlvblZhcmlhbnQiLCJpc1ByZXNlbnRhdGlvbkNvbXBsaWFudCIsImJIYXNUYWJsZSIsImJIYXNDaGFydCIsImFWaXN1YWxpemF0aW9ucyIsIm1hcCIsIm9WaXN1YWxpemF0aW9uIiwiZmluZCIsImdldERlZmF1bHRMaW5lSXRlbSIsIkxpbmVJdGVtIiwiZ2V0RGVmYXVsdENoYXJ0IiwiQ2hhcnQiLCJnZXREZWZhdWx0UHJlc2VudGF0aW9uVmFyaWFudCIsImdldERlZmF1bHRTZWxlY3Rpb25WYXJpYW50IiwiU2VsZWN0aW9uVmFyaWFudCIsImdldFNlbGVjdGlvblZhcmlhbnQiLCJnZXREZWZhdWx0VGVtcGxhdGVBbm5vdGF0aW9uUGF0aCIsInNlbGVjdGlvblZhcmlhbnQiLCJnZXREYXRhVmlzdWFsaXphdGlvbkNvbmZpZ3VyYXRpb24iLCJpc0NvbmRlbnNlZFRhYmxlTGF5b3V0Q29tcGxpYW50IiwiZG9Ob3RDaGVja0FwcGx5U3VwcG9ydGVkIiwicHJlc2VudGF0aW9uUGF0aCIsImNoYXJ0VmlzdWFsaXphdGlvbiIsInRhYmxlVmlzdWFsaXphdGlvbiIsInNUZXJtIiwiY29uY2F0IiwiZnVsbHlRdWFsaWZpZWROYW1lIiwiZ2V0RW50aXR5VHlwZSIsImRlZmF1bHRMaW5lSXRlbUFubm90YXRpb24iLCJnZXRSZWxhdGl2ZUFubm90YXRpb25QYXRoIiwidmlzdWFsaXphdGlvbkFubm90YXRpb24iLCJjcmVhdGVDaGFydFZpc3VhbGl6YXRpb24iLCJjcmVhdGVUYWJsZVZpc3VhbGl6YXRpb24iLCJjcmVhdGVEZWZhdWx0VGFibGVWaXN1YWxpemF0aW9uIiwiZ2V0RGlhZ25vc3RpY3MiLCJhZGRJc3N1ZSIsIklzc3VlQ2F0ZWdvcnkiLCJBbm5vdGF0aW9uIiwiSXNzdWVTZXZlcml0eSIsIk1lZGl1bSIsIklzc3VlVHlwZSIsIk1JU1NJTkdfTElORUlURU0iLCJzUGF0aCIsInVuZGVmaW5lZCIsImdldEVudGl0eVNldEJhc2VkQW5ub3RhdGlvblBhdGgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUF1Q0EsTUFBTUEsd0NBQXdDLEdBQUcsVUFDaERDLDZCQURnRCxFQUVoREMsaUJBRmdELEVBR2hEQyxnQkFIZ0QsRUFJaERDLGlC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e1xuXHRDaGFydCxcblx0Q2hhcnREZWZpbml0aW9uVHlwZVR5cGVzLFxuXHRFbnRpdHlUeXBlLFxuXHRMaW5lSXRlbSxcblx0UHJlc2VudGF0aW9uVmFyaWFudFR5cGVUeXBlcyxcblx0U2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudFR5cGVUeXBlcyxcblx0U2VsZWN0aW9uVmFyaWFudFR5cGVUeXBlcyxcblx0VUlBbm5vdGF0aW9uVGVybXNcbn0gZnJvbSBcIkBzYXAtdXgvdm9jYWJ1bGFyaWVzLXR5cGVzXCI7XG5cbmltcG9ydCB7IGNyZWF0ZURlZmF1bHRUYWJsZVZpc3VhbGl6YXRpb24sIGNyZWF0ZVRhYmxlVmlzdWFsaXphdGlvbiwgVGFibGVWaXN1YWxpemF0aW9uIH0gZnJvbSBcIi4vVGFibGVcIjtcbmltcG9ydCB7IENoYXJ0VmlzdWFsaXphdGlvbiwgY3JlYXRlQ2hhcnRWaXN1YWxpemF0aW9uIH0gZnJvbSBcIi4vQ2hhcnRcIjtcbmltcG9ydCB7IElzc3VlVHlwZSwgSXNzdWVTZXZlcml0eSwgSXNzdWVDYXRlZ29yeSB9IGZyb20gXCJzYXAvZmUvY29yZS9jb252ZXJ0ZXJzL2hlbHBlcnMvSXNzdWVNYW5hZ2VyXCI7XG5pbXBvcnQgQ29udmVydGVyQ29udGV4dCBmcm9tIFwiLi4vLi4vQ29udmVydGVyQ29udGV4dFwiO1xuaW1wb3J0IHsgVGVtcGxhdGVUeXBlLCBWaWV3UGF0aENvbmZpZ3VyYXRpb24gfSBmcm9tIFwiLi4vLi4vTWFuaWZlc3RTZXR0aW5nc1wiO1xuXG5leHBvcnQgdHlwZSBEYXRhVmlzdWFsaXphdGlvbkFubm90YXRpb25zID1cblx0fCBMaW5lSXRlbVxuXHR8IENoYXJ0XG5cdHwgUHJlc2VudGF0aW9uVmFyaWFudFR5cGVUeXBlc1xuXHR8IFNlbGVjdGlvblZhcmlhbnRUeXBlVHlwZXNcblx0fCBTZWxlY3Rpb25QcmVzZW50YXRpb25WYXJpYW50VHlwZVR5cGVzO1xuLy8gfCBDaGFydERlZmluaXRpb25UeXBlVHlwZXM7XG5cbmV4cG9ydCB0eXBlIEFjdHVhbFZpc3VhbGl6YXRpb25Bbm5vdGF0aW9ucyA9IExpbmVJdGVtIHwgQ2hhcnREZWZpbml0aW9uVHlwZVR5cGVzO1xuXG50eXBlIFZpc3VhbGl6YXRpb25BbmRQYXRoID0ge1xuXHR2aXN1YWxpemF0aW9uOiBBY3R1YWxWaXN1YWxpemF0aW9uQW5ub3RhdGlvbnM7XG5cdGFubm90YXRpb25QYXRoOiBzdHJpbmc7XG5cdHNlbGVjdGlvblZhcmlhbnRQYXRoPzogc3RyaW5nO1xuXHRjb252ZXJ0ZXJDb250ZXh0OiBDb252ZXJ0ZXJDb250ZXh0O1xufTtcblxuZXhwb3J0IHR5cGUgRGF0YVZpc3VhbGl6YXRpb25EZWZpbml0aW9uID0ge1xuXHR2aXN1YWxpemF0aW9uczogKFRhYmxlVmlzdWFsaXphdGlvbiB8IENoYXJ0VmlzdWFsaXphdGlvbilbXTtcblx0YW5ub3RhdGlvblBhdGg6IHN0cmluZztcbn07XG5cbmNvbnN0IGdldFZpc3VhbGl6YXRpb25zRnJvbVByZXNlbnRhdGlvblZhcmlhbnQgPSBmdW5jdGlvbihcblx0cHJlc2VudGF0aW9uVmFyaWFudEFubm90YXRpb246IFByZXNlbnRhdGlvblZhcmlhbnRUeXBlVHlwZXMsXG5cdHZpc3VhbGl6YXRpb25QYXRoOiBzdHJpbmcsXG5cdGNvbnZlcnRlckNvbnRleHQ6IENvbnZlcnRlckNvbnRleHQsXG5cdHZpZXdDb25maWd1cmF0aW9uPzogVmlld1BhdGhDb25maWd1cmF0aW9uXG4pOiBWaXN1YWxpemF0aW9uQW5kUGF0aFtdIHtcblx0Y29uc3QgdmlzdWFsaXphdGlvbkFubm90YXRpb25zOiBWaXN1YWxpemF0aW9uQW5kUGF0aFtdID0gW107XG5cdGNvbnN0IHZpc3VhbGl6YXRpb25zID0gcHJlc2VudGF0aW9uVmFyaWFudEFubm90YXRpb24uVmlzdWFsaXphdGlvbnMgfHwgW107XG5cdGNvbnN0IGJhc2VWaXN1YWxpemF0aW9uUGF0aCA9IHZpc3VhbGl6YXRpb25QYXRoLnNwbGl0KFwiQFwiKVswXTtcblx0aWYgKHZpc3VhbGl6YXRpb25zKSB7XG5cdFx0Ly8gT25seSBhbGxvdyBvbmUgbGluZSBpdGVtIC8gY2hhcnRcblx0XHRsZXQgaGFzTGluZUl0ZW0gPSBmYWxzZTtcblx0XHRsZXQgaGFzQ2hhcnQgPSBmYWxzZTtcblx0XHRsZXQgaGFzVmlzdWFsaXphdGlvbiA9IGZhbHNlOyAvLyB1c2VkIHRvIGFsbG93IG9ubHkgZmlyc3QgdmlzdWFsaXphdGlvbiBpbiBPUFxuXHRcdHZpc3VhbGl6YXRpb25zLmZvckVhY2godmlzdWFsaXphdGlvbiA9PiB7XG5cdFx0XHRzd2l0Y2ggKHZpc3VhbGl6YXRpb24uJHRhcmdldC50ZXJtKSB7XG5cdFx0XHRcdGNhc2UgVUlBbm5vdGF0aW9uVGVybXMuTGluZUl0ZW06XG5cdFx0XHRcdFx0aWYgKCFoYXNMaW5lSXRlbSkge1xuXHRcdFx0XHRcdFx0aWYgKCEoY29udmVydGVyQ29udGV4dC5nZXRUZW1wbGF0ZVR5cGUoKSA9PT0gVGVtcGxhdGVUeXBlLk9iamVjdFBhZ2UgJiYgaGFzVmlzdWFsaXphdGlvbikpIHtcblx0XHRcdFx0XHRcdFx0dmlzdWFsaXphdGlvbkFubm90YXRpb25zLnB1c2goe1xuXHRcdFx0XHRcdFx0XHRcdHZpc3VhbGl6YXRpb246IHZpc3VhbGl6YXRpb24uJHRhcmdldCBhcyBBY3R1YWxWaXN1YWxpemF0aW9uQW5ub3RhdGlvbnMsXG5cdFx0XHRcdFx0XHRcdFx0YW5ub3RhdGlvblBhdGg6IGAke2Jhc2VWaXN1YWxpemF0aW9uUGF0aH0ke3Zpc3VhbGl6YXRpb24udmFsdWV9YCxcblx0XHRcdFx0XHRcdFx0XHRjb252ZXJ0ZXJDb250ZXh0OiBjb252ZXJ0ZXJDb250ZXh0XG5cdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0XHRoYXNMaW5lSXRlbSA9IHRydWU7XG5cdFx0XHRcdFx0XHRcdGhhc1Zpc3VhbGl6YXRpb24gPSB0cnVlO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0Y2FzZSBVSUFubm90YXRpb25UZXJtcy5DaGFydDpcblx0XHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0XHQhaGFzQ2hhcnQgJiZcblx0XHRcdFx0XHRcdCgodmlld0NvbmZpZ3VyYXRpb24gJiZcblx0XHRcdFx0XHRcdFx0Y29udmVydGVyQ29udGV4dC5nZXRNYW5pZmVzdFdyYXBwZXIoKS5oYXNNdWx0aXBsZVZpc3VhbGl6YXRpb25zKHZpZXdDb25maWd1cmF0aW9uKSAmJlxuXHRcdFx0XHRcdFx0XHRjb252ZXJ0ZXJDb250ZXh0LmdldFRlbXBsYXRlVHlwZSgpID09PSBUZW1wbGF0ZVR5cGUuTGlzdFJlcG9ydCkgfHxcblx0XHRcdFx0XHRcdFx0KGNvbnZlcnRlckNvbnRleHQuZ2V0VGVtcGxhdGVUeXBlKCkgPT09IFRlbXBsYXRlVHlwZS5BbmFseXRpY2FsTGlzdFBhZ2UgJiZcblx0XHRcdFx0XHRcdFx0XHQhY29udmVydGVyQ29udGV4dC5nZXRNYW5pZmVzdFdyYXBwZXIoKS5nZXRWaWV3Q29uZmlndXJhdGlvbigpKSB8fFxuXHRcdFx0XHRcdFx0XHQoY29udmVydGVyQ29udGV4dC5nZXRUZW1wbGF0ZVR5cGUoKSA9PT0gVGVtcGxhdGVUeXBlLk9iamVjdFBhZ2UgJiYgIWhhc1Zpc3VhbGl6YXRpb24pKVxuXHRcdFx0XHRcdCkge1xuXHRcdFx0XHRcdFx0dmlzdWFsaXphdGlvbkFubm90YXRpb25zLnB1c2goe1xuXHRcdFx0XHRcdFx0XHR2aXN1YWxpemF0aW9uOiB2aXN1YWxpemF0aW9uLiR0YXJnZXQgYXMgQWN0dWFsVmlzdWFsaXphdGlvbkFubm90YXRpb25zLFxuXHRcdFx0XHRcdFx0XHRhbm5vdGF0aW9uUGF0aDogYCR7YmFzZVZpc3VhbGl6YXRpb25QYXRofSR7dmlzdWFsaXphdGlvbi52YWx1ZX1gLFxuXHRcdFx0XHRcdFx0XHRjb252ZXJ0ZXJDb250ZXh0OiBjb252ZXJ0ZXJDb250ZXh0XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdGhhc0NoYXJ0ID0gdHJ1ZTtcblx0XHRcdFx0XHRcdGhhc1Zpc3VhbGl6YXRpb24gPSB0cnVlO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXHRyZXR1cm4gdmlzdWFsaXphdGlvbkFubm90YXRpb25zO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnQoXG5cdGVudGl0eVR5cGU6IEVudGl0eVR5cGUsXG5cdGFubm90YXRpb25QYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG5cdGNvbnZlcnRlckNvbnRleHQ6IENvbnZlcnRlckNvbnRleHRcbik6IGFueSB7XG5cdGlmIChhbm5vdGF0aW9uUGF0aCkge1xuXHRcdGNvbnN0IHJlc29sdmVkVGFyZ2V0ID0gY29udmVydGVyQ29udGV4dC5nZXRFbnRpdHlUeXBlQW5ub3RhdGlvbihhbm5vdGF0aW9uUGF0aCk7XG5cdFx0Y29uc3Qgc2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudCA9IHJlc29sdmVkVGFyZ2V0LmFubm90YXRpb24gYXMgU2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudFR5cGVUeXBlcztcblx0XHRpZiAoc2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudCkge1xuXHRcdFx0aWYgKHNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnQudGVybSA9PT0gVUlBbm5vdGF0aW9uVGVybXMuU2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudCkge1xuXHRcdFx0XHRyZXR1cm4gc2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudDtcblx0XHRcdH1cblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiQW5ub3RhdGlvbiBQYXRoIGZvciB0aGUgU1BWIG1lbnRpb25lZCBpbiB0aGUgbWFuaWZlc3QgaXMgbm90IGZvdW5kLCBQbGVhc2UgYWRkIHRoZSBTUFYgaW4gdGhlIGFubm90YXRpb25cIik7XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdHJldHVybiBlbnRpdHlUeXBlLmFubm90YXRpb25zPy5VST8uU2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudDtcblx0fVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNTZWxlY3Rpb25QcmVzZW50YXRpb25Db21wbGlhbnQoXG5cdFNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnQ6IFNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnRUeXBlVHlwZXMsXG5cdGJJc0FMUDogQm9vbGVhblxuKTogQm9vbGVhbiB8IHVuZGVmaW5lZCB7XG5cdGNvbnN0IHByZXNlbnRhdGlvblZhcmlhbnQgPSBTZWxlY3Rpb25QcmVzZW50YXRpb25WYXJpYW50ICYmIFNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnQuUHJlc2VudGF0aW9uVmFyaWFudDtcblx0aWYgKHByZXNlbnRhdGlvblZhcmlhbnQpIHtcblx0XHRyZXR1cm4gaXNQcmVzZW50YXRpb25Db21wbGlhbnQocHJlc2VudGF0aW9uVmFyaWFudCwgYklzQUxQKTtcblx0fSBlbHNlIHtcblx0XHR0aHJvdyBuZXcgRXJyb3IoXCJQcmVzZW50YXRpb24gVmFyaWFudCBpcyBub3QgcHJlc2VudCBpbiB0aGUgU1BWIGFubm90YXRpb25cIik7XG5cdH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzUHJlc2VudGF0aW9uQ29tcGxpYW50KHByZXNlbnRhdGlvblZhcmlhbnQ6IFByZXNlbnRhdGlvblZhcmlhbnRUeXBlVHlwZXMsIGJJc0FMUD86IEJvb2xlYW4pOiBCb29sZWFuIHtcblx0bGV0IGJIYXNUYWJsZSA9IGZhbHNlLFxuXHRcdGJIYXNDaGFydCA9IGZhbHNlO1xuXHRpZiAoYklzQUxQKSB7XG5cdFx0aWYgKHByZXNlbnRhdGlvblZhcmlhbnQgJiYgcHJlc2VudGF0aW9uVmFyaWFudC5WaXN1YWxpemF0aW9ucykge1xuXHRcdFx0Y29uc3QgYVZpc3VhbGl6YXRpb25zID0gcHJlc2VudGF0aW9uVmFyaWFudC5WaXN1YWxpemF0aW9ucztcblx0XHRcdGFWaXN1YWxpemF0aW9ucy5tYXAob1Zpc3VhbGl6YXRpb24gPT4ge1xuXHRcdFx0XHRpZiAob1Zpc3VhbGl6YXRpb24uJHRhcmdldC50ZXJtID09PSBVSUFubm90YXRpb25UZXJtcy5MaW5lSXRlbSkge1xuXHRcdFx0XHRcdGJIYXNUYWJsZSA9IHRydWU7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKG9WaXN1YWxpemF0aW9uLiR0YXJnZXQudGVybSA9PT0gVUlBbm5vdGF0aW9uVGVybXMuQ2hhcnQpIHtcblx0XHRcdFx0XHRiSGFzQ2hhcnQgPSB0cnVlO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9XG5cdFx0cmV0dXJuIGJIYXNDaGFydCAmJiBiSGFzVGFibGU7XG5cdH0gZWxzZSB7XG5cdFx0cmV0dXJuIChcblx0XHRcdHByZXNlbnRhdGlvblZhcmlhbnQgJiZcblx0XHRcdHByZXNlbnRhdGlvblZhcmlhbnQuVmlzdWFsaXphdGlvbnMgJiZcblx0XHRcdCEhcHJlc2VudGF0aW9uVmFyaWFudC5WaXN1YWxpemF0aW9ucy5maW5kKHZpc3VhbGl6YXRpb24gPT4ge1xuXHRcdFx0XHRyZXR1cm4gdmlzdWFsaXphdGlvbi4kdGFyZ2V0LnRlcm0gPT09IFVJQW5ub3RhdGlvblRlcm1zLkxpbmVJdGVtO1xuXHRcdFx0fSlcblx0XHQpO1xuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWZhdWx0TGluZUl0ZW0oZW50aXR5VHlwZTogRW50aXR5VHlwZSk6IExpbmVJdGVtIHwgdW5kZWZpbmVkIHtcblx0cmV0dXJuIGVudGl0eVR5cGUuYW5ub3RhdGlvbnMuVUk/LkxpbmVJdGVtO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdldERlZmF1bHRDaGFydChlbnRpdHlUeXBlOiBFbnRpdHlUeXBlKTogQ2hhcnQgfCB1bmRlZmluZWQge1xuXHRyZXR1cm4gZW50aXR5VHlwZS5hbm5vdGF0aW9ucy5VST8uQ2hhcnQ7XG59XG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVmYXVsdFByZXNlbnRhdGlvblZhcmlhbnQoZW50aXR5VHlwZTogRW50aXR5VHlwZSk6IFByZXNlbnRhdGlvblZhcmlhbnRUeXBlVHlwZXMgfCB1bmRlZmluZWQge1xuXHRyZXR1cm4gZW50aXR5VHlwZS5hbm5vdGF0aW9ucz8uVUk/LlByZXNlbnRhdGlvblZhcmlhbnQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWZhdWx0U2VsZWN0aW9uVmFyaWFudChlbnRpdHlUeXBlOiBFbnRpdHlUeXBlKTogU2VsZWN0aW9uVmFyaWFudFR5cGVUeXBlcyB8IHVuZGVmaW5lZCB7XG5cdHJldHVybiBlbnRpdHlUeXBlLmFubm90YXRpb25zPy5VST8uU2VsZWN0aW9uVmFyaWFudDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNlbGVjdGlvblZhcmlhbnQoZW50aXR5VHlwZTogRW50aXR5VHlwZSwgY29udmVydGVyQ29udGV4dDogQ29udmVydGVyQ29udGV4dCk6IFNlbGVjdGlvblZhcmlhbnRUeXBlVHlwZXMgfCB1bmRlZmluZWQge1xuXHRjb25zdCBhbm5vdGF0aW9uUGF0aCA9IGNvbnZlcnRlckNvbnRleHQuZ2V0TWFuaWZlc3RXcmFwcGVyKCkuZ2V0RGVmYXVsdFRlbXBsYXRlQW5ub3RhdGlvblBhdGgoKTtcblx0Y29uc3Qgc2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudCA9IGdldFNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnQoZW50aXR5VHlwZSwgYW5ub3RhdGlvblBhdGgsIGNvbnZlcnRlckNvbnRleHQpO1xuXHRsZXQgc2VsZWN0aW9uVmFyaWFudDtcblx0aWYgKHNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnQpIHtcblx0XHRjb25zdCBzZWxlY3Rpb25WYXJpYW50ID0gc2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudC5TZWxlY3Rpb25WYXJpYW50O1xuXHRcdGlmIChzZWxlY3Rpb25WYXJpYW50KSB7XG5cdFx0XHRyZXR1cm4gc2VsZWN0aW9uVmFyaWFudDtcblx0XHR9XG5cdH0gZWxzZSB7XG5cdFx0c2VsZWN0aW9uVmFyaWFudCA9IGdldERlZmF1bHRTZWxlY3Rpb25WYXJpYW50KGVudGl0eVR5cGUpO1xuXHRcdHJldHVybiBzZWxlY3Rpb25WYXJpYW50O1xuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREYXRhVmlzdWFsaXphdGlvbkNvbmZpZ3VyYXRpb24oXG5cdHZpc3VhbGl6YXRpb25QYXRoOiBzdHJpbmcsXG5cdGlzQ29uZGVuc2VkVGFibGVMYXlvdXRDb21wbGlhbnQ6IGJvb2xlYW4sXG5cdGNvbnZlcnRlckNvbnRleHQ6IENvbnZlcnRlckNvbnRleHQsXG5cdHZpZXdDb25maWd1cmF0aW9uPzogVmlld1BhdGhDb25maWd1cmF0aW9uLFxuXHRkb05vdENoZWNrQXBwbHlTdXBwb3J0ZWQ/OiBib29sZWFuXG4pOiBEYXRhVmlzdWFsaXphdGlvbkRlZmluaXRpb24ge1xuXHRjb25zdCByZXNvbHZlZFRhcmdldCA9IGNvbnZlcnRlckNvbnRleHQuZ2V0RW50aXR5VHlwZUFubm90YXRpb24odmlzdWFsaXphdGlvblBhdGgpO1xuXHRjb25zdCB2aXN1YWxpemF0aW9uID0gcmVzb2x2ZWRUYXJnZXQuYW5ub3RhdGlvbiBhcyBEYXRhVmlzdWFsaXphdGlvbkFubm90YXRpb25zO1xuXHRjb252ZXJ0ZXJDb250ZXh0ID0gcmVzb2x2ZWRUYXJnZXQuY29udmVydGVyQ29udGV4dDtcblx0bGV0IHZpc3VhbGl6YXRpb25Bbm5vdGF0aW9uczogVmlzdWFsaXphdGlvbkFuZFBhdGhbXSA9IFtdO1xuXHRsZXQgcHJlc2VudGF0aW9uVmFyaWFudEFubm90YXRpb246IFByZXNlbnRhdGlvblZhcmlhbnRUeXBlVHlwZXM7XG5cdGxldCBwcmVzZW50YXRpb25QYXRoOiBzdHJpbmcgPSBcIlwiO1xuXHRsZXQgY2hhcnRWaXN1YWxpemF0aW9uLCB0YWJsZVZpc3VhbGl6YXRpb247XG5cdGNvbnN0IHNUZXJtID0gdmlzdWFsaXphdGlvbj8udGVybTtcblx0aWYgKHNUZXJtKSB7XG5cdFx0c3dpdGNoIChzVGVybSkge1xuXHRcdFx0Y2FzZSBVSUFubm90YXRpb25UZXJtcy5MaW5lSXRlbTpcblx0XHRcdGNhc2UgVUlBbm5vdGF0aW9uVGVybXMuQ2hhcnQ6XG5cdFx0XHRcdHZpc3VhbGl6YXRpb25Bbm5vdGF0aW9ucy5wdXNoKHtcblx0XHRcdFx0XHR2aXN1YWxpemF0aW9uOiB2aXN1YWxpemF0aW9uIGFzIEFjdHVhbFZpc3VhbGl6YXRpb25Bbm5vdGF0aW9ucyxcblx0XHRcdFx0XHRhbm5vdGF0aW9uUGF0aDogdmlzdWFsaXphdGlvblBhdGgsXG5cdFx0XHRcdFx0Y29udmVydGVyQ29udGV4dDogY29udmVydGVyQ29udGV4dFxuXHRcdFx0XHR9KTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIFVJQW5ub3RhdGlvblRlcm1zLlByZXNlbnRhdGlvblZhcmlhbnQ6XG5cdFx0XHRcdHByZXNlbnRhdGlvblZhcmlhbnRBbm5vdGF0aW9uID0gdmlzdWFsaXphdGlvbiBhcyBQcmVzZW50YXRpb25WYXJpYW50VHlwZVR5cGVzO1xuXHRcdFx0XHR2aXN1YWxpemF0aW9uQW5ub3RhdGlvbnMgPSB2aXN1YWxpemF0aW9uQW5ub3RhdGlvbnMuY29uY2F0KFxuXHRcdFx0XHRcdGdldFZpc3VhbGl6YXRpb25zRnJvbVByZXNlbnRhdGlvblZhcmlhbnQoXG5cdFx0XHRcdFx0XHR2aXN1YWxpemF0aW9uIGFzIFByZXNlbnRhdGlvblZhcmlhbnRUeXBlVHlwZXMsXG5cdFx0XHRcdFx0XHR2aXN1YWxpemF0aW9uUGF0aCxcblx0XHRcdFx0XHRcdGNvbnZlcnRlckNvbnRleHQsXG5cdFx0XHRcdFx0XHR2aWV3Q29uZmlndXJhdGlvblxuXHRcdFx0XHRcdClcblx0XHRcdFx0KTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIFVJQW5ub3RhdGlvblRlcm1zLlNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnQ6XG5cdFx0XHRcdHByZXNlbnRhdGlvblZhcmlhbnRBbm5vdGF0aW9uID0gKHZpc3VhbGl6YXRpb24gYXMgU2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudFR5cGVUeXBlcykuUHJlc2VudGF0aW9uVmFyaWFudDtcblx0XHRcdFx0Ly8gUHJlc2VudGF0aW9uIGNhbiBiZSBpbmxpbmUgb3Igb3V0c2lkZSB0aGUgU2VsZWN0aW9uUHJlc2VudGF0aW9uVmFyaWFudFxuXHRcdFx0XHRwcmVzZW50YXRpb25QYXRoID0gcHJlc2VudGF0aW9uVmFyaWFudEFubm90YXRpb24uZnVsbHlRdWFsaWZpZWROYW1lO1xuXG5cdFx0XHRcdGlmICghaXNQcmVzZW50YXRpb25Db21wbGlhbnQocHJlc2VudGF0aW9uVmFyaWFudEFubm90YXRpb24pKSB7XG5cdFx0XHRcdFx0Y29uc3QgZW50aXR5VHlwZSA9IGNvbnZlcnRlckNvbnRleHQuZ2V0RW50aXR5VHlwZSgpO1xuXHRcdFx0XHRcdGNvbnN0IGRlZmF1bHRMaW5lSXRlbUFubm90YXRpb24gPSBnZXREZWZhdWx0TGluZUl0ZW0oZW50aXR5VHlwZSkgYXMgTGluZUl0ZW07XG5cdFx0XHRcdFx0aWYgKGRlZmF1bHRMaW5lSXRlbUFubm90YXRpb24pIHtcblx0XHRcdFx0XHRcdHZpc3VhbGl6YXRpb25Bbm5vdGF0aW9ucy5wdXNoKHtcblx0XHRcdFx0XHRcdFx0dmlzdWFsaXphdGlvbjogZGVmYXVsdExpbmVJdGVtQW5ub3RhdGlvbixcblx0XHRcdFx0XHRcdFx0YW5ub3RhdGlvblBhdGg6IGNvbnZlcnRlckNvbnRleHQuZ2V0UmVsYXRpdmVBbm5vdGF0aW9uUGF0aChcblx0XHRcdFx0XHRcdFx0XHRkZWZhdWx0TGluZUl0ZW1Bbm5vdGF0aW9uLmZ1bGx5UXVhbGlmaWVkTmFtZSxcblx0XHRcdFx0XHRcdFx0XHRlbnRpdHlUeXBlXG5cdFx0XHRcdFx0XHRcdCksXG5cdFx0XHRcdFx0XHRcdGNvbnZlcnRlckNvbnRleHQ6IGNvbnZlcnRlckNvbnRleHRcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR2aXN1YWxpemF0aW9uQW5ub3RhdGlvbnMgPSB2aXN1YWxpemF0aW9uQW5ub3RhdGlvbnMuY29uY2F0KFxuXHRcdFx0XHRcdFx0Z2V0VmlzdWFsaXphdGlvbnNGcm9tUHJlc2VudGF0aW9uVmFyaWFudChcblx0XHRcdFx0XHRcdFx0cHJlc2VudGF0aW9uVmFyaWFudEFubm90YXRpb24sXG5cdFx0XHRcdFx0XHRcdHZpc3VhbGl6YXRpb25QYXRoLFxuXHRcdFx0XHRcdFx0XHRjb252ZXJ0ZXJDb250ZXh0LFxuXHRcdFx0XHRcdFx0XHR2aWV3Q29uZmlndXJhdGlvblxuXHRcdFx0XHRcdFx0KVxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdH1cblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRicmVhaztcblx0XHR9XG5cdFx0dmlzdWFsaXphdGlvbkFubm90YXRpb25zLm1hcCh2aXN1YWxpemF0aW9uQW5ub3RhdGlvbiA9PiB7XG5cdFx0XHRjb25zdCB7IHZpc3VhbGl6YXRpb24sIGFubm90YXRpb25QYXRoLCBjb252ZXJ0ZXJDb250ZXh0IH0gPSB2aXN1YWxpemF0aW9uQW5ub3RhdGlvbjtcblx0XHRcdHN3aXRjaCAodmlzdWFsaXphdGlvbi50ZXJtKSB7XG5cdFx0XHRcdGNhc2UgVUlBbm5vdGF0aW9uVGVybXMuQ2hhcnQ6XG5cdFx0XHRcdFx0Y2hhcnRWaXN1YWxpemF0aW9uID0gY3JlYXRlQ2hhcnRWaXN1YWxpemF0aW9uKFxuXHRcdFx0XHRcdFx0dmlzdWFsaXphdGlvbiBhcyBDaGFydERlZmluaXRpb25UeXBlVHlwZXMsXG5cdFx0XHRcdFx0XHRhbm5vdGF0aW9uUGF0aCxcblx0XHRcdFx0XHRcdGNvbnZlcnRlckNvbnRleHQsXG5cdFx0XHRcdFx0XHRkb05vdENoZWNrQXBwbHlTdXBwb3J0ZWRcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlIFVJQW5ub3RhdGlvblRlcm1zLkxpbmVJdGVtOlxuXHRcdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRcdHRhYmxlVmlzdWFsaXphdGlvbiA9IGNyZWF0ZVRhYmxlVmlzdWFsaXphdGlvbihcblx0XHRcdFx0XHRcdHZpc3VhbGl6YXRpb24gYXMgTGluZUl0ZW0sXG5cdFx0XHRcdFx0XHRhbm5vdGF0aW9uUGF0aCxcblx0XHRcdFx0XHRcdGNvbnZlcnRlckNvbnRleHQsXG5cdFx0XHRcdFx0XHRwcmVzZW50YXRpb25WYXJpYW50QW5ub3RhdGlvbixcblx0XHRcdFx0XHRcdGlzQ29uZGVuc2VkVGFibGVMYXlvdXRDb21wbGlhbnQsXG5cdFx0XHRcdFx0XHR2aWV3Q29uZmlndXJhdGlvblxuXHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH0gZWxzZSB7XG5cdFx0dGFibGVWaXN1YWxpemF0aW9uID0gY3JlYXRlRGVmYXVsdFRhYmxlVmlzdWFsaXphdGlvbihjb252ZXJ0ZXJDb250ZXh0KTtcblx0XHRjb252ZXJ0ZXJDb250ZXh0LmdldERpYWdub3N0aWNzKCkuYWRkSXNzdWUoSXNzdWVDYXRlZ29yeS5Bbm5vdGF0aW9uLCBJc3N1ZVNldmVyaXR5Lk1lZGl1bSwgSXNzdWVUeXBlLk1JU1NJTkdfTElORUlURU0pO1xuXHR9XG5cdGNvbnN0IGFWaXN1YWxpemF0aW9uczogYW55ID0gW107XG5cdGxldCBzUGF0aCA9XG5cdFx0c1Rlcm0gPT09IFVJQW5ub3RhdGlvblRlcm1zLlNlbGVjdGlvblByZXNlbnRhdGlvblZhcmlhbnQgPyBwcmVzZW50YXRpb25QYXRoIDogdmlzdWFsaXphdGlvbiAmJiB2aXN1YWxpemF0aW9uLmZ1bGx5UXVhbGlmaWVkTmFtZTtcblx0aWYgKHNQYXRoID09PSB1bmRlZmluZWQpIHtcblx0XHRzUGF0aCA9IFwiL1wiO1xuXHR9XG5cdGlmIChjaGFydFZpc3VhbGl6YXRpb24pIHtcblx0XHRhVmlzdWFsaXphdGlvbnMucHVzaChjaGFydFZpc3VhbGl6YXRpb24pO1xuXHR9XG5cdGlmICh0YWJsZVZpc3VhbGl6YXRpb24pIHtcblx0XHRhVmlzdWFsaXphdGlvbnMucHVzaCh0YWJsZVZpc3VhbGl6YXRpb24pO1xuXHR9XG5cdHJldHVybiB7XG5cdFx0dmlzdWFsaXphdGlvbnM6IGFWaXN1YWxpemF0aW9ucyxcblx0XHRhbm5vdGF0aW9uUGF0aDogY29udmVydGVyQ29udGV4dC5nZXRFbnRpdHlTZXRCYXNlZEFubm90YXRpb25QYXRoKHNQYXRoKVxuXHR9O1xufVxuIl19