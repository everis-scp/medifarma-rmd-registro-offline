/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/fe/core/controllerextensions/ControllerExtensionMetadata","sap/ui/core/mvc/OverrideExecution","sap/ui/core/Component","sap/fe/core/CommonUtils","sap/fe/core/BusyLocker","sap/fe/core/helpers/SemanticKeyHelper","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/Log","sap/fe/core/actions/messageHandling","sap/m/MessageBox","sap/fe/core/helpers/EditState","sap/fe/core/controllerextensions/MessageHandler","sap/fe/core/helpers/ModelHelper"],function(C,a,O,b,c,B,S,F,d,L,m,M,E,e,f){"use strict";function g(s,i){var k=s.substring(s.indexOf("(")+1,s.length-1).split(","),l;if(i.length!=k.length){return null;}if(i.length===1){var K=k[0];if(K.indexOf("'")===0&&K.lastIndexOf("'")===K.length-1){K=decodeURIComponent(K.substring(1,K.length-1));}l=[new F(i[0].$PropertyPath,d.EQ,K)];}else{var n={};k.forEach(function(q){var P=q.split("="),K=P[1];if(K.indexOf("'")===0&&K.lastIndexOf("'")===K.length-1){K=decodeURIComponent(K.substring(1,K.length-1));}n[P[0]]=K;});var o=false;l=i.map(function(q){var r=q.$PropertyPath,v=n[r];if(v!==undefined){return new F(r,d.EQ,v);}else{o=true;return"XX";}});if(o){return null;}}var D=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});l.push(D);var p=new F(l,true);return p;}function h(s,o,i){var k=o.getMetaModel(),l=k.getMetaContext(s).getPath();if(!i||i.length===0){return Promise.resolve(null);}var n=g(s,i);if(n===null){return Promise.resolve(null);}var p=o.bindList("/"+l,undefined,undefined,n,{"$$groupId":"$auto.Heroes"});return p.requestContexts(0,2).then(function(q){if(q&&q.length){return q[0].getPath();}else{return null;}});}function j(p,o){var i=/^[\/]?(\w+)\([^\/]+\)$/.exec(p);if(!i){return false;}var s="/"+i[1];var D=o.getObject(s+"@com.sap.vocabularies.Common.v1.DraftRoot");var k=o.getObject(s+"@com.sap.vocabularies.Common.v1.DraftNode");return D||k?true:false;}return C.extend("sap.fe.core.controllerextensions.InternalRouting",{metadata:{methods:{"navigateToTarget":{"public":true,"final":false},"byId":{"public":false},"getView":{"public":false},"onRouteMatched":{"public":true,"final":false,overrideExecution:O.After},"onRouteMatchedFinished":{"public":true,"final":false,overrideExecution:O.After},"onBeforeBinding":{"public":true,"final":false,overrideExecution:O.After},"onAfterBinding":{"public":true,"final":false,overrideExecution:O.After},"navigateToContext":{"public":true,"final":true},"navigateBackFromContext":{"public":true,"final":true},"navigateForwardToContext":{"public":true,"final":true},"navigateBackFromTransientState":{"public":true,"final":true},"navigateToMessagePage":{"public":true,"final":true},"enterFullScreen":{"public":true,"final":false,overrideExecution:sap.ui.core.mvc.OverrideExecution.Before},"exitFullScreen":{"public":true,"final":false,overrideExecution:sap.ui.core.mvc.OverrideExecution.Before},"closeColumn":{"public":true,"final":false,overrideExecution:sap.ui.core.mvc.OverrideExecution.Before},"isCurrentStateImpactedBy":{"public":true,"final":true}}},onRouteMatched:function(){},onRouteMatchedFinished:function(){},onBeforeBinding:function(o,p){var r=this.base.getView().getController().routing;if(r&&r.onBeforeBinding){r.onBeforeBinding(o,p);}},onAfterBinding:function(o,p){this._oAppComponent.getRootViewController().onContextBoundToView(o);var r=this.base.getView().getController().routing;if(r&&r.onAfterBinding){r.onAfterBinding(o,p);}},navigateToTarget:function(o,n,s){var N=this._oPageComponent&&this._oPageComponent.getNavigationConfiguration&&this._oPageComponent.getNavigationConfiguration(n);if(N){var D=N.detail;var r=D.route;var p=D.parameters;this._oRoutingService.navigateTo(o,r,p,true,s);}else{this._oRoutingService.navigateTo(o,null,null,true);}this._oView.getViewData();},navigateToContext:function(o,p){var t=this;var i={};p=p||{};if(o.isA("sap.ui.model.odata.v4.ODataListBinding")){if(p.asyncContext){this._oRouterProxy.activateRouteMatchSynchronization();p.asyncContext.then(function(o){t.navigateToContext(o,{checkNoHashChange:p.checkNoHashChange,editable:p.editable,bPersistOPScroll:p.bPersistOPScroll,updateFCLLevel:p.updateFCLLevel});}).catch(function(k){L.error("Error with the async context",k);});}else if(!p.bDeferredContext){throw"navigation to a list binding is not yet supported";}}if(p.callExtension){i.sourceBindingContext=o.getObject();i.bindingContext=o;if(p.oEvent){i.oEvent=p.oEvent;}if(this.base.getView().getController().routing.onBeforeNavigation(i)){return Promise.resolve();}}p.FCLLevel=this._getFCLLevel();return this._oRoutingService.navigateToContext(o,p,this._oView.getViewData(),this._oTargetInformation);},navigateBackFromContext:function(o,p){p=p||{};p.updateFCLLevel=-1;return this.navigateToContext(o,p);},navigateForwardToContext:function(o,p){if(this._oView.getBindingContext("internal").getProperty("messageFooterContainsErrors")===true){return Promise.resolve();}p=p||{};p.updateFCLLevel=1;return this.navigateToContext(o,p,true);},navigateBackFromTransientState:function(){var H=this._oRouterProxy.getHash();if(H.indexOf("(...)")!==-1){this._oRouterProxy.navBack();}},navigateToMessagePage:function(s,p){p=p||{};if(this._oRouterProxy.getHash().indexOf("i-action=create")>-1){this._oRouterProxy.navToHash(this._oRoutingService.getDefaultCreateHash());}else{p.FCLLevel=this._getFCLLevel();this._oAppComponent.getRootViewController().displayMessagePage(s,p);}},isCurrentStateImpactedBy:function(o){return this._oRoutingService.isCurrentStateImpactedBy(o);},_onRouteMatched:function(o){var t=o.getParameter("routeInformation")&&o.getParameter("routeInformation").targets;if(!t||t.indexOf(this._oTargetInformation.targetName)===-1){return;}var T;if(this._oPageComponent&&this._oPageComponent.getBindingContextPattern){T=this._oPageComponent.getBindingContextPattern();}T=T||this._oTargetInformation.contextPattern;if(T===null||T===undefined){T=o.getParameter("routePattern");}T=T.replace(":?query:","");var A=o.getParameters().arguments,D=false,n=o.getParameter("navigationInfo");for(var k in A){var v=A[k];if(v==="..."&&T.indexOf("{"+k+"}")>=0){D=true;n.bTargetEditable=true;}T=T.replace("{"+k+"}",v);}if(A["?query"]&&A["?query"].hasOwnProperty("i-action")){n.bActionCreate=true;}if(T&&T[0]!=="/"){T="/"+T;}this.onRouteMatched();var i;if(D){i=this._bindDeferred(T,n);}else{i=this._bindPage(T,n);}var l=this;i.finally(function(){l.onRouteMatchedFinished();});this._oAppComponent.getRootViewController().updateUIStateForView(this._oView,this._getFCLLevel());},_bindDeferred:function(t,n){this.onBeforeBinding(null,{editable:n.bTargetEditable});if(n.bDeferredContext||!n.oAsyncContext){if(this._oPageComponent&&this._oPageComponent.createDeferredContext){this._oPageComponent.createDeferredContext(t,n.bActionCreate);}}if(this._getBindingContext()&&this._getBindingContext().hasPendingChanges()){this._getBindingContext().getBinding().resetChanges();}this._setBindingContext(null);this.onAfterBinding(null);return Promise.resolve();},_bindPage:function(t,n){var i=this;if(t===""){return Promise.resolve(this._bindPageToContext(null,n));}else{return this._resolveSemanticPath(t).then(function(T){i._bindPageToPath(T,n);}).catch(function(o){var r=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");i.navigateToMessagePage(r.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:r.getText("C_COMMON_SAPFE_ERROR"),description:o.message});});}},_resolveSemanticPath:function(p){var o=this._oView.getModel(),i=o.getMetaModel(),l=this._oRoutingService.getLastSemanticMapping(),s=this._oRouter.getHashChanger().getHash().split("?")[0],t=this;if(s&&s.lastIndexOf("/")===s.length-1){s=s.substring(0,s.length-1);}var r=s&&s.substr(0,s.indexOf("("));if(r.indexOf("/")===0){r=r.substring(1);}var A=j(s,i),k=A&&S.getSemanticKeys(i,r);if(!k){return Promise.resolve(p);}else if(l&&l.semanticPath===p){return Promise.resolve(l.technicalPath);}else{return h(s,o,k).then(function(T){if(T&&T!==p){t._oRoutingService.setLastSemanticMapping({technicalPath:T,semanticPath:p});return T;}else{return p;}});}},_bindPageToPath:function(t,n){var o=this._getBindingContext(),s=o&&o.getPath(),u=n.useContext;if(s!==t||(u&&u.getPath()===t)){var T;if(u&&u.getPath()===t){T=u;}else{T=this._createBindingContext(t);}if(T!==o){this._bindPageToContext(T,n);}}else if(!n.bReasonIsIappState&&E.isEditStateDirty()){this._refreshBindingContext(o);}},_bindPageToContext:function(o,n){var t=this;if(!o){this.onBeforeBinding(null);this.onAfterBinding(null);}else{var p=o.getBinding();if(!o.getBinding()||o.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){o=this._createBindingContext(o.getPath());if(E.isEditStateDirty()){setTimeout(function(){t._refreshBindingContext(o);},0);}}this.onBeforeBinding(o,{editable:n.bTargetEditable,listBinding:p,bPersistOPScroll:n.bPersistOPScroll,bDraftNavigation:n.bDraftNavigation});this._setBindingContext(o);this.onAfterBinding(o);}},_createBindingContext:function(p){var P=this._oPageComponent,s=P&&P.getEntitySet&&P.getEntitySet(),i=(P&&P.getContextPath&&P.getContextPath())||(s&&"/"+s),o=this._oView.getModel(),k=o.getMetaModel(),t=this,l={$$patchWithoutSideEffects:true,$$groupId:"$auto.Heroes",$$updateGroupId:"$auto"};if(s){var n=k.getProperty(i+"/@com.sap.vocabularies.Common.v1.Messages/$Path");if(n){l.$select=n;}}var D=k.getObject(i+"@com.sap.vocabularies.Common.v1.DraftRoot");var q=k.getObject(i+"@com.sap.vocabularies.Common.v1.DraftNode");if(D||q){if(l.$select===undefined){l.$select="HasActiveEntity,HasDraftEntity,IsActiveEntity";}else{l.$select+=",HasActiveEntity,HasDraftEntity,IsActiveEntity";}}var H=o.bindContext(p,undefined,l);H.attachEventOnce("dataRequested",function(){B.lock(t._oView);});H.attachEventOnce("dataReceived",function(r){var u=r&&r.getParameter("error");B.unlock(t._oView);if(u){sap.ui.getCore().getLibraryResourceBundle("sap.fe.core",true).then(function(R){var v=new e();v.removeTransitionMessages();t.navigateToMessagePage(R.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:R.getText("SAPFE_ERROR"),description:u});}).catch(function(v){L.error("Error while getting the core resource bundle",v);});}});return H.getBoundContext();},_refreshBindingContext:function(o){var p=this._oPageComponent,s=this._oAppComponent.getSideEffectsService(),r=o.getPath(),k=p&&p.getEntitySet&&p.getEntitySet(),l=(p&&p.getContextPath&&p.getContextPath())||(k&&"/"+k),n=this._oView.getModel().getMetaModel(),q,N=[],P=[],t={TargetProperties:[],TargetEntities:[]};function u(v){var D,R=((v.getContext()&&v.getContext().getPath())||"").replace(r,""),w=(R?R.slice(1)+"/":R)+v.getPath();if(v.isA("sap.ui.model.odata.v4.ODataContextBinding")){D=v.getDependentBindings();if(D){for(var i=0;i<D.length;i++){u(D[i]);}}else if(N.indexOf(w)===-1){N.push(w);}}else if(v.isA("sap.ui.model.odata.v4.ODataListBinding")){if(N.indexOf(w)===-1){N.push(w);}}else if(v.isA("sap.ui.model.odata.v4.ODataPropertyBinding")){if(P.indexOf(w)===-1){P.push(w);}}}if(l){q=n.getProperty(l+"/@com.sap.vocabularies.Common.v1.Messages/$Path");}u(o.getBinding());var i;for(i=0;i<N.length;i++){t.TargetEntities.push({$NavigationPropertyPath:N[i]});}t.TargetProperties=P;if(q){t.TargetProperties.push({$PropertyPath:q});}s.requestSideEffects(t.TargetEntities.concat(t.TargetProperties),o);},_getBindingContext:function(){if(this._oPageComponent){return this._oPageComponent.getBindingContext();}else{return this._oView.getBindingContext();}},_setBindingContext:function(o){if(this._oPageComponent){this._oPageComponent.setBindingContext(o);}else{this._oView.setBindingContext(o);}},_getFCLLevel:function(){return this._oTargetInformation.FCLLevel;},overflowToolbarButtonHover:function(){this.sCurrentFocusedControlId=sap.ui.getCore().getCurrentFocusedControlId();},enterFullScreen:function(){var s=this.base.getView();var o=s.getBindingContext(),n=s.getModel("fclhelper").getProperty("/actionButtonsInfo/fullScreen");var r=this._oRouterProxy;var i=this.sCurrentFocusedControlId;this.base._routing.navigateToContext(o,{sLayout:n}).then(function(){var l=r.getLastHistoryEntry();l.oLastFocusControl=Object.assign({},l.oLastFocusControl,{controlId:i,focusInfo:{id:i}});}).catch(function(){L.warning("cannot set focus on last focused control");});},exitFullScreen:function(){var s=this.base.getView();var o=s.getBindingContext(),n=s.getModel("fclhelper").getProperty("/actionButtonsInfo/exitFullScreen");var r=this._oRouterProxy;var i=this.sCurrentFocusedControlId;this.base._routing.navigateToContext(o,{sLayout:n}).then(function(){var l=r.getLastHistoryEntry();l.oLastFocusControl=Object.assign({},l.oLastFocusControl,{controlId:i,focusInfo:{id:i}});}).catch(function(){L.warning("cannot set focus on last focused control");});},closeColumn:function(){var s=this.base.getView();var v=s.getViewData();var o=s.getBindingContext();var i=this.base;var k=o.getModel().getMetaModel();if(v&&v.viewLevel===1&&f.isDraftSupported(k,o.getPath())){c.fnProcessDataLossOrDraftDiscardConfirmation(function(){i._routing.navigateBackFromContext(o,{noPreservationCache:true});},Function.prototype,o,s.getController(),false);}else{i._routing.navigateBackFromContext(o,{noPreservationCache:true});}},override:{onExit:function(){this._oRoutingService&&this._oRoutingService.detachRouteMatched(this._fnRouteMatchedBound);},onInit:function(){var t=this;this._oView=this.base.getView();this._oAppComponent=c.getAppComponent(this._oView);this._oPageComponent=b.getOwnerComponentFor(this._oView);this._oRouter=this._oAppComponent.getRouter();this._oRouterProxy=this._oAppComponent.getRouterProxy();if(!this._oAppComponent||!this._oPageComponent){throw new Error("Failed to initialize controler extension 'sap.fe.core.controllerextesions.InternalRouting");}if(this._oAppComponent===this._oPageComponent){this._oPageComponent=null;}this._oAppComponent.getService("routingService").then(function(r){t._oRoutingService=r;t._fnRouteMatchedBound=t._onRouteMatched.bind(t);t._oRoutingService.attachRouteMatched(t._fnRouteMatchedBound);t._oTargetInformation=r.getTargetInformationFor(t._oPageComponent||t._oView);}).catch(function(){throw new Error("This controller extension cannot work without a 'routingService' on the main AppComponent");});}}},a);});
