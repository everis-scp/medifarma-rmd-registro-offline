/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2021 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/fe/core/controllerextensions/ControllerExtensionMetadata","../helpers/ClassSupport","sap/ui/model/json/JSONModel","sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/formatters/TableFormatterTypes","sap/ui/core/format/NumberFormat","sap/ui/core/Locale","sap/ui/model/Filter"],function(C,a,b,J,L,c,T,N,d,F){"use strict";var _,f,g,h,j;var k={};var M=T.MessageType;var O=b.Override;var U=b.UI5Class;function l(i,e){if(!(i instanceof e)){throw new TypeError("Cannot call a class as a function");}}function m(e,p){for(var i=0;i<p.length;i++){var o=p[i];o.enumerable=o.enumerable||false;o.configurable=true;if("value"in o)o.writable=true;Object.defineProperty(e,o.key,o);}}function n(e,p,i){if(p)m(e.prototype,p);if(i)m(e,i);return e;}function q(e,i){if(typeof i!=="function"&&i!==null){throw new TypeError("Super expression must either be null or a function");}e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,writable:true,configurable:true}});if(i)r(e,i);}function r(o,p){r=Object.setPrototypeOf||function r(o,p){o.__proto__=p;return o;};return r(o,p);}function s(e){return function(){var S=w(e),i;if(v()){var o=w(this).constructor;i=Reflect.construct(S,arguments,o);}else{i=S.apply(this,arguments);}return t(this,i);};}function t(e,i){if(i&&(typeof i==="object"||typeof i==="function")){return i;}return u(e);}function u(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return e;}function v(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}function w(o){w=Object.setPrototypeOf?Object.getPrototypeOf:function w(o){return o.__proto__||Object.getPrototypeOf(o);};return w(o);}function x(e,p,i,o,E){var G={};Object.keys(o).forEach(function(H){G[H]=o[H];});G.enumerable=!!G.enumerable;G.configurable=!!G.configurable;if('value'in G||G.initializer){G.writable=true;}G=i.slice().reverse().reduce(function(G,H){return H(e,p,G)||G;},G);if(E&&G.initializer!==void 0){G.value=G.initializer?G.initializer.call(E):void 0;G.initializer=undefined;}if(G.initializer===void 0){Object.defineProperty(e,p,G);G=null;}return G;}function y(e){var i;switch(e){case 1:i=M.Error;break;case 2:i=M.Warning;break;case 3:i=M.Success;break;case 5:i=M.Information;break;default:i=M.None;}return i;}function z(e,i){var o;if(i[0]!==undefined&&i[0]!==null&&e<i[0]){o=M.Error;}else if(i[1]!==undefined&&i[1]!==null&&e<i[1]){o=M.Warning;}else if(i[2]!==undefined&&i[2]!==null&&e<i[2]){o=M.None;}else if(i[5]!==undefined&&i[5]!==null&&e>i[5]){o=M.Error;}else if(i[4]!==undefined&&i[4]!==null&&e>i[4]){o=M.Warning;}else if(i[3]!==undefined&&i[3]!==null&&e>i[3]){o=M.None;}else{o=M.Success;}return o;}function A(e,i){var o;if(i[2]!==undefined&&i[2]!==null&&e>i[2]){o=M.Error;}else if(i[1]!==undefined&&i[1]!==null&&e>i[1]){o=M.Warning;}else if(i[0]!==undefined&&i[0]!==null&&e>i[0]){o=M.None;}else{o=M.Success;}return o;}function B(e,i){var o;if(i[0]!==undefined&&i[0]!==null&&e<i[0]){o=M.Error;}else if(i[1]!==undefined&&i[1]!==null&&e<i[1]){o=M.Warning;}else if(i[2]!==undefined&&i[2]!==null&&e<i[2]){o=M.None;}else{o=M.Success;}return o;}function D(e){if(e.ranges.length===0){return undefined;}else if(e.ranges.length===1){return new F(e.propertyPath,e.ranges[0].operator,e.ranges[0].rangeLow,e.ranges[0].rangeHigh);}else{var R=e.ranges.map(function(i){return new F(e.propertyPath,i.operator,i.rangeLow,i.rangeHigh);});return new F({filters:R,and:false});}}k.createFilterFromDefinition=D;var K=(_=U("sap.fe.core.controllerextensions.KPIManagement",a),f=O(),g=O(),_(h=(j=function(e){q(K,e);var i=s(K);function K(){l(this,K);return i.apply(this,arguments);}n(K,[{key:"onInit",value:function E(){var o=this;this.aKPIDefinitions=this.getKPIData();if(this.aKPIDefinitions&&this.aKPIDefinitions.length){var V=this.getView();this.oAppComponent=c.getAppComponent(V);var p=new J();V.setModel(p,"kpiModel");this.aKPIDefinitions.forEach(function(G){var H={"sap.app":{id:"sap.fe",type:"card"},"sap.ui":{technology:"UI5"},"sap.card":{type:"Analytical",data:{json:{}},header:{type:"Numeric",mainIndicator:{number:"{mainValue}",unit:"{mainUnit}"},title:"{cardTitle}"},content:{plotArea:{"dataLabel":{"visible":false},"categoryAxisText":{"visible":false},"valueAxisText":{"visible":false}},title:{text:"{chartTitle}",visible:true,alignment:"Left"},measureAxis:"valueAxis",dimensionAxis:"categoryAxis",data:{path:"/chartData"}}}};p.setProperty("/"+G.id,{manifest:H});o.loadKPITagData(G).catch(function(I){L.error(I);});});}}},{key:"onExit",value:function p(){var o=this.getView().getModel("kpiModel");if(o){o.destroy();}}},{key:"getKPIData",value:function E(){var V=this.getView(),o=V.getContent()[0].data("KPIData");if(o){var p=typeof o==="string"?JSON.parse(o):o;if("customData"in p){return p["customData"];}else{return p;}}else{return undefined;}}},{key:"loadKPITagData",value:function R(o){var p,E;var G=this.oAppComponent.getModel();var H=this.getView().getModel("kpiModel");var I=G.bindList("/"+o.entitySet);var P={};if((p=o.datapoint.unit)===null||p===void 0?void 0:p.isPath){P[o.datapoint.propertyPath]={unit:o.datapoint.unit.value};}else{P[o.datapoint.propertyPath]={};}if(o.datapoint.criticalityPath){P[o.datapoint.criticalityPath]={};}I.setAggregation({aggregate:P});if((E=o.selectionVariantFilterDefinitions)===null||E===void 0?void 0:E.length){var Q=o.selectionVariantFilterDefinitions.map(D);I.filter(Q);}return I.requestContexts(0,1).then(function(S){if(S.length){var V,W;var X=new d(sap.ui.getCore().getConfiguration().getLanguage());var Y=((V=o.datapoint.unit)===null||V===void 0?void 0:V.isPath)?S[0].getProperty(o.datapoint.unit.value):(W=o.datapoint.unit)===null||W===void 0?void 0:W.value;if(o.datapoint.unit&&!Y){H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValue","*");H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValueUnscaled","*");H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainUnit",undefined);H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainCriticality",M.None);}else{var Z;var $=((Z=o.datapoint.unit)===null||Z===void 0?void 0:Z.isCurrency)===false&&Y==="%";var a1=Number.parseFloat(S[0].getProperty(o.datapoint.propertyPath));var b1=N.getFloatInstance({style:$?undefined:"short",minFractionDigits:0,maxFractionDigits:1,showScale:!$},X).format(a1);H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValue",b1);var c1=N.getFloatInstance({maxFractionDigits:2,showScale:false,groupingEnabled:true},X).format(a1);H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainValueUnscaled",c1);if(o.datapoint.unit&&Y){if(o.datapoint.unit.isCurrency){H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainUnit",Y);}else{var d1=N.getUnitInstance({showNumber:false},X).format(a1,Y);H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainUnit",d1);}}if(o.datapoint.criticalityValue){H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainCriticality",o.datapoint.criticalityValue);}else if(o.datapoint.criticalityPath){var e1=y(S[0].getProperty(o.datapoint.criticalityPath));H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainCriticality",e1);}else if(o.datapoint.criticalityCalculationThresholds&&o.datapoint.criticalityCalculationMode){var f1;switch(o.datapoint.criticalityCalculationMode){case"UI.ImprovementDirectionType/Target":f1=z(a1,o.datapoint.criticalityCalculationThresholds);break;case"UI.ImprovementDirectionType/Minimize":f1=A(a1,o.datapoint.criticalityCalculationThresholds);break;case"UI.ImprovementDirectionType/Maximize":default:f1=B(a1,o.datapoint.criticalityCalculationThresholds);break;}H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainCriticality",f1);}else{H.setProperty("/"+o.id+"/manifest/sap.card/data/json/mainCriticality",M.None);}}}});}}]);return K;}(C),(x(j.prototype,"onInit",[f],Object.getOwnPropertyDescriptor(j.prototype,"onInit"),j.prototype),x(j.prototype,"onExit",[g],Object.getOwnPropertyDescriptor(j.prototype,"onExit"),j.prototype)),j))||h);return K;},false);
