// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/container/ApplicationContainer","sap/ushell/components/applicationIntegration/application/PostMessageAPI","sap/ushell/utils","sap/ui/thirdparty/jquery","sap/ushell/components/applicationIntegration/eventDelegation/tunnels","sap/ui/thirdparty/URI","sap/ushell/library","sap/base/Log","sap/base/util/ObjectPath"],function(A,P,u,q,t,U,a,L,O){"use strict";var o,B,T={},b={},f={},c=0,d=A.getMetadata().getJSONKeys(),g=a.UI5ComponentType;function h(){var i=this;this.handleMessageEvent=function(C,m,M){var j=m.data;if(typeof j==="string"){try{j=i.parse(m.data);}catch(e){L.debug("Message received from origin '"+m.origin+"' cannot be parsed: "+e,j,"sap.ushell.components.container.ApplicationContainer");return;}}if(j.action==="pro54_setGlobalDirty"&&localStorage.getItem(C.globalDirtyStorageKey)===sap.ushell.Container.DirtyState.PENDING){if(!A.prototype._isTrustedPostMessageSource(C,m)){L.warning("Received message from untrusted origin: "+m.origin,j,"sap.ushell.components.container.ApplicationContainer");return;}L.debug("getGlobalDirty() pro54_setGlobalDirty SetItem key:"+C.globalDirtyStorageKey+" value: "+j.parameters.globalDirty,null,"sap.ushell.components.container.ApplicationContainer");u.localStorageSetItem(C.globalDirtyStorageKey,j.parameters.globalDirty,true);}else{i.handleServiceMessageEvent(C,m,j,M);}};this.handleServiceMessageEvent=function(C,m,M,j){var p=O.get("sap-ushell-config.services.PostMessage.config")||O.create("sap-ushell-config.services.PostMessage.config"),s=M&&M.service,S=t.getPairedServiceCall(s),k,l,n,r,I=false,v=P.getAPIs(),w;L.debug("Received post message request from origin '"+m.origin+"': "+JSON.stringify(M),null,"sap.ushell.components.container.ApplicationContainer");if(S){x(S);return;}if(M.type!=="request"||!s){return;}for(var E in v){if(v.hasOwnProperty(E)){if(s.indexOf(E)!==-1){l=v[E];n=E;I=true;break;}}}if(I===false){j.bApiRegistered=false;return;}w=(s.indexOf("user.postapi.")===0);k=s.split(".")[3];if(p&&p.enabled===false){L.warning("Received message for "+k+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,"sap.ushell.components.container.ApplicationContainer");return;}if(!A.prototype._isTrustedPostMessageSource(C,m)){L.warning("Received message from untrusted origin '"+m.origin+"': "+JSON.stringify(m.data),null,"sap.ushell.components.container.ApplicationContainer");return;}function x(e,w){var H;if(w===true){H={oMessage:m,oMessageData:M};}else{H={matchesLocalSid:G,getLocalSystemInSidForma:F,storeSapSystemData:D,executeSetBackNavigationService:z,sendResponseMessage:y,oMessage:m,oMessageData:M,oContainer:C};}try{e(H).done(function(R){y("success",{result:R});}).fail(function(K){y("error",{message:K});});}catch(J){y("error",{message:J.message});}}function y(e,H){var R=i.stringify({type:"response",service:M.service,request_id:M.request_id,status:e,body:H});L.debug("Sending post message response to origin ' "+m.origin+"': "+R,null,"sap.ushell.components.container.ApplicationContainer");if(typeof m.source!=="object"||m.source===null){L.debug("Cannot send response message to origin ' "+m.origin,"`source` member of request message is not an object","sap.ushell.components.container.ApplicationContainer");return;}m.source.postMessage(R,m.origin);}function z(m,M){var e=new q.Deferred(),H;if(M.body&&M.body.callbackMessage&&M.body.callbackMessage.service){H=A.prototype._backButtonPressedCallback.bind(null,m.source,M.body.callbackMessage.service,m.origin);}e.resolve(C.getShellUIService().setBackNavigation(H));return e.promise();}function D(H,J){var K,N,Q,R=[H.id];if(arguments.length>1){R.unshift(J);}try{Q=JSON.stringify(H);}catch(e){L.error("Cannot stringify and store expanded system data: "+e);}if(Q){N=u.getLocalStorage();K=u.generateLocalStorageKey("sap-system-data",R);N.setItem(K,Q);}}function F(){var e=sap.ushell.Container.getLogonSystem();var H=e.getName();var J=e.getClient();return"sid("+H+"."+J+")";}function G(e){return F().toLowerCase()===e.toLowerCase();}r=l.oServiceCalls[M.service.replace(n+".","")];if(r&&r.executeServiceCallFn){x(r.executeServiceCallFn,w);}else{y("error",{message:"Unknown service name: '"+M.service+"'"});}};this.init=function(e){B=e;this.registerShellCommunicationHandler({"sap.ushell.PostMessage":{oServiceCalls:{"callTunnelFunction":{executeServiceCallFn:function(s){var j=s.oMessageData.body.content,k=i.restoreArray(j.arguments),r;r=T[j.UUID].fnCallback.apply(this,k);return new q.Deferred().resolve(r).promise();}}},oRequestCalls:{"callTunnelFunction":{isActiveOnly:true,distributionType:["URL"]}}}});};this.restoreArray=function(e){var j=[],k=0;while(e[k]){j.push(e[k]);k++;}return j;};this._createWaitForRendererCreatedPromise=function(){var p,r;r=sap.ushell.Container.getRenderer();if(r){L.debug("Shell controller._createWaitForRendererCreatedPromise: shell renderer already created, return empty array.");return[];}p=new Promise(function(e,j){var k;k=function(){L.info("Shell controller: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(k);};r=sap.ushell.Container.getRenderer();if(r){L.debug("Shell controller: resolving component waitFor promise immediately (shell renderer already created");e();}else{sap.ushell.Container.attachRendererCreatedEvent(k);}});return[p];};this.createComponent=function(r,p){return sap.ushell.Container.getService("Ui5ComponentLoader").createComponent(r,p,this._createWaitForRendererCreatedPromise(),g.Application);};this.stripURL=function(s){var n=s.indexOf("?"),e=s.indexOf("#"),j;if(n>=0){j=s.substr(0,n);}else if(e>=0){j=s.substr(0,e);}else{j=s;}return j;};this.createApplicationContainer=function(s,r){var e={};this._cleanTargetResolution(r,e);o=new A("application"+s,r);this._restoreTargetResolution(r,e);if(r.appCapabilities){o.setProperty("frameworkId",r.appCapabilities.appFrameworkId,true);}o.setHandleMessageEvent(this.handleMessageEvent);B.setAppCapabilities(o,r);return o;};this.active=function(e){if(e){if(e.active){e.active();}}};this.restore=function(e){var D;if(e.app){sap.ui.getCore().getEventBus().publish("sap.ushell","appKeepAliveActivate",e.appTarget);if(e.app.getUrl){D=e.app.getUrl();o=B.get(this.stripURL(D));if(o){B.restoreApp(o.sApplication);}}if(e.app.isKeepAliveSupported&&e.app.isKeepAliveSupported()===true){e.app.activate();}else{if(e.app.restore){e.app.restore();}if(e.app.getRouter&&e.app.getRouter()&&e.app.getRouter().initialize){e.app.getRouter().initialize();}if(e.app.setInitialConfiguration){e.app.setInitialConfiguration();}}o=e.app;}};this.store=function(e){var D;if(e.app){sap.ui.getCore().getEventBus().publish("sap.ushell","appKeepAliveDeactivate",e.appTarget);if(e.app.getUrl){D=e.app.getUrl();o=B.get(this.stripURL(D));if(o){B.storeApp(o.sApplication);}}if(e.app.isKeepAliveSupported&&e.app.isKeepAliveSupported()===true){e.app.deactivate();}else{if(e.app.suspend){e.app.suspend();}if(e.app.getRouter&&e.app.getRouter()){e.app.getRouter().stop();}}}};this.destroy=function(e){var D,o,j=false;if(e){if(e.getUrl){D=e.getUrl();o=B.get(this.stripURL(D));if(B.isStatefulContainerSupported(o)){j=true;B.destroyApp(o.sApplication);}}if(e.destroy&&j===false){e.destroy();}}};this.setActiveAppContainer=function(C){o=C;};this.getActiveAppContainer=function(){return o;};}h.prototype._cleanTargetResolution=function(r,e){var k;if(r){for(k in r){if(d[k]===undefined){e[k]=r[k];delete r[k];}}}};h.prototype._restoreTargetResolution=function(r,e){var k;if(r){for(k in e){r[k]=e[k];}}};h.prototype.stringify=function(D){var e=function(C){c++;T[c]={fnCallback:C};return{type:"tunnel",UUID:c};},i=[],r=JSON.stringify(D,function(k,v){if(v!==null){if(typeof v==="object"||typeof v==="function"){if(i.indexOf(v)!==-1){return;}i.push(v);}}if(typeof v==="function"){var n=b[v];if(n){return{type:"reversetunnel",UUID:n};}return e(v);}return v;});return r;};h.prototype.parse=function(D){var e=this;return JSON.parse(D,function(k,v){if(v&&v.type==="reversetunnel"){return T[v.UUID].fnCallback;}else if(v&&v.type==="tunnel"){var i;if(f[v.UUID]){i=f[v.UUID];}else{var j=e.getActiveAppContainer();i=function(){e.postMessageToIframeApp(j,"sap.ushell.PostMessage","callTunnelFunction",{"content":{UUID:v.UUID,arguments:arguments}},true);};i.getUUID=function(){return v.UUID;};b[i]=v.UUID;f[v.UUID]=i;}return i;}return v;});};h.prototype.getResponseHandler=function(s,i){return P.getResponseHandler(s,i);};h.prototype.isActiveOnly=function(s,i){return P.isActiveOnly(s,i);};h.prototype.isAppTypeSupported=function(C,s,i){var e=P._getPostMesageInterface(s,i);return this.isAppTypeSupportedByPolicy(C,e);};h.prototype.isAppTypeSupportedByPolicy=function(C,p){if(C&&C.getAdditionalInformation&&C.getAdditionalInformation().startsWith("SAPUI5.Component=")){return false;}var e=p;if(!e||!e.distributionType){return false;}if(e.distributionType.indexOf("all")>=0){return true;}if(e.distributionType.indexOf("URL")>=0){return false;}if(C.getApplicationType&&e.distributionType.indexOf(C.getApplicationType())>=0){return true;}return false;};h.prototype.postMessageToIframeApp=function(C,s,i,m,w){var S=s+"."+i,M=this.createPostMessageRequest(S,m);return this.postMessageToIframe(M,C,w);};h.prototype.createPostMessageRequest=function(s,m){var r=Date.now().toString();return{"type":"request","request_id":r,"service":s,"body":m};};h.prototype.postMessageToIframe=function(m,C,w){var i=this,r=m.request_id,I=C._getIFrame();return new Promise(function(n,N){function p(E){var l;try{l=i.parse(E.data,i);if(r!==l.request_id){return;}if(l.status==="success"){n(l);}else{N(l);}window.removeEventListener("message",p);}catch(e){n();L.warning("Obtained bad response from framework in response to message "+m.request_id);L.debug("Underlying framework returned invalid response data: '"+E.data+"'");}}var M=i.stringify(m);L.debug("Sending postMessage "+M+" to application container '"+C.getId()+"'");var j,k;if(!I){n();}else if(w){window.addEventListener("message",p,false);j=new U(C._getIFrameUrl(I));k=j.protocol()+"://"+j.host();I.contentWindow.postMessage(M,k);}else{j=new U(C._getIFrameUrl(I));k=j.protocol()+"://"+j.host();I.contentWindow.postMessage(M,k);n();}});};h.prototype.registerShellCommunicationHandler=function(C){P.registerShellCommunicationHandler(C);};h.prototype._getPostMesageInterface=function(s,i){return P._getPostMesageInterface(s,i);};return new h();},true);
