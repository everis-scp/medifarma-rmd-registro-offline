// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/ObjectPath","sap/base/util/uid","sap/base/util/UriParameters","sap/ui/Device","sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI","sap/ushell/utils/clone","sap/ushell/utils/objectOperations","sap/ushell/utils/type"],function(L,O,U,b,D,q,c,u,d,f){"use strict";var g={};g.isArray=f.isArray;g.isPlainObject=f.isPlainObject;g.isDefined=f.isDefined;g.clone=u;g.getMember=d.getMember;g.updateProperties=d.updateProperties;g.getNestedObjectProperty=d.getNestedObjectProperty;g.removeDuplicatedActions=function(a){if(Array.isArray(a)){var F=a.reduce(function(r,i){if(r.indexOf(i)<0){r.push(i);}return r;},[]);return F;}return a;};g.storeSapSystemData=function(s,S){var k,l,a,h=[s.id];if(arguments.length>1){h.unshift(S);}try{a=JSON.stringify(s);}catch(e){L.error("Cannot stringify and store expanded system data: "+e);}if(a){l=g.getLocalStorage();k=g.generateLocalStorageKey("sap-system-data",h);l.setItem(k,a);}};g.getLocalSystemInSidFormat=function(){var s=sap.ushell.Container.getLogonSystem(),S=s.getName(),a=s.getClient();return"sid("+S+"."+a+")";};g.matchesLocalSid=function(s){return g.getLocalSystemInSidFormat().toLowerCase()===s.toLowerCase();};g.storeSapSystemToLocalStorage=function(a){var p=(a||{}).params;if(!p||!p.hasOwnProperty("sap-system")){return;}if(g.isPlainObject(p["sap-system"])){var s=p["sap-system"],S=p["sap-system-src"];if(typeof S==="string"){g.storeSapSystemData(s,S);p["sap-system-src"]=S;}else{g.storeSapSystemData(s);}p["sap-system"]=s.id;}else if(g.matchesLocalSid(p["sap-system"])){delete p["sap-system"];}};g.setPerformanceMark=function(m,C){if(performance&&performance.mark){if(!C){C={};}if(C.bUseUniqueMark){if(C.bUseLastMark){performance.clearMarks(m);}else if(performance.getEntriesByName(m,"mark").length>0){return;}}performance.mark(m);}};g.setPerformanceMeasure=function(m,s,e){if(performance&&performance.measure&&s&&e){performance.measure(m,s,e);}};g.Error=function(m,C){this.name="sap.ushell.utils.Error";this.message=m;L.error(m,null,C);};g.Error.prototype=new Error();g.localStorageSetItem=function(k,v,l){var E;try{localStorage.setItem(k,v);if(l){E=document.createEvent("StorageEvent");E.initStorageEvent("storage",false,false,k,"",v,"",localStorage);dispatchEvent(E);}}catch(e){L.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.utils");}};g.getLocalStorage=function(){return window.localStorage;};g.getLocalStorageItem=function(k){return window.localStorage.getItem(k);};g.generateUniqueId=function(t){var s,e,i;if(Array.isArray(t)){e=t;i=function(G){return e.indexOf(G)===-1;};}else{i=t;}do{s=g._getUid();}while(!i(s));return s;};g._getUid=function(){return U();};g.reload=function(){location.reload();};g.calculateOrigin=function(o){var a;if(o.origin){return o.origin;}if(o.protocol&&o.hostname){return o.protocol+"//"+o.hostname+(o.port?":"+o.port:"");}if(o.href){a=new c(o.href);return a.protocol()+"://"+a.hostname()+(a.port()?":"+a.port():"");}return undefined;};g.getPrivateEpcm=function(){if(window.external&&window.external&&typeof window.external.getPrivateEpcm!=="undefined"){return window.external.getPrivateEpcm();}return undefined;};g.hasNativeNavigationCapability=function(){return g.isFeatureBitEnabled(1);};g.hasNativeLogoutCapability=function(){return g.isFeatureBitEnabled(2);};g.hasNavigationModeCapability=function(){return g.isFeatureBitEnabled(4);};g.hasFLPReadyNotificationCapability=function(){return g.isFeatureBitEnabled(8);};g.hasFLPReady2NotificationCapability=function(){return g.isFeatureBitEnabled(16);};g.isFeatureBitEnabled=function(F){var s="0",p;p=g.getPrivateEpcm();if(p){try{s=p.getNwbcFeatureBits();L.debug("Detected epcm getNwbcFeatureBits returned feature bits: "+s);}catch(e){L.error("failed to get feature bit vector via call getNwbcFeatureBits on private epcm object",e.stack,"sap.ushell.utils");}}return(parseInt(s,16)&F)>0;};g.isApplicationTypeEmbeddedInIframe=function(a){return a==="NWBC"||a==="TR"||a==="WCF";};g.appendUserIdToUrl=function(p,s){var a=sap.ushell.Container.getService("UserInfo").getUser().getId(),S=s.indexOf("?")>=0?"&":"?";return s+S+p+"="+a;};g.appendSapShellParam=function(s,a){var e=a==="TR"?"":"-NWBC",v=g.getUi5Version();if(v){s+=s.indexOf("?")>=0?"&":"?";s+="sap-shell="+encodeURIComponent("FLP"+v+e);}return s;};g.getUi5Version=function(){var v,m;try{v=sap.ui.getVersionInfo().version;}catch(e){L.error("sap ui version could not be determined, using sap.ui.version (core version) as fallback "+e);v=window.sap&&sap.ui&&sap.ui.version;}m=/\d+\.\d+\.\d+/.exec(v);if(m&&m[0]){v=m[0];}else{v=undefined;}return v;};g.isNativeWebGuiNavigation=function(r){var a=O.get("applicationType",r);var n=O.get("appCapabilities.nativeNWBCNavigation",r);if(this.hasNativeNavigationCapability()&&(a==="TR"||n)){return true;}return false;};g.Map=function(){this.entries={};};g.Map.prototype.put=function(k,v){var o=this.get(k);this.entries[k]=v;return o;};g.Map.prototype.containsKey=function(k){if(typeof k!=="string"){throw new g.Error("Not a string key: "+k,"sap.ushell.utils.Map");}return Object.prototype.hasOwnProperty.call(this.entries,k);};g.Map.prototype.get=function(k){if(this.containsKey(k)){return this.entries[k];}};g.Map.prototype.keys=function(){return Object.keys(this.entries);};g.Map.prototype.remove=function(k){delete this.entries[k];};g.Map.prototype.toString=function(){var r=["sap.ushell.utils.Map("];r.push(JSON.stringify(this.entries));r.push(")");return r.join("");};g.getParameterValueBoolean=function(p,P){var o=b.fromQuery(P||window.location.search),a=o.getAll(p),t=["true","x"],F=["false",""],v;if(!a||a.length===0){return undefined;}v=a[0].toLowerCase();if(t.indexOf(v)>=0){return true;}if(F.indexOf(v)>=0){return false;}return undefined;};g.call=function(s,F,a){var m;if(a){setTimeout(function(){g.call(s,F,false);},0);return;}try{s();}catch(e){m=e.message||e.toString();L.error("Call to success handler failed: "+m,e.stack,"sap.ushell.utils");if(F){F(m);}}};g.handleTilesVisibility=function(){g.getVisibleTiles();};g.refreshTiles=function(){sap.ui.getCore().getEventBus().publish("launchpad","refreshTiles");};g.setTilesNoVisibility=function(){sap.ui.getCore().getEventBus().publish("launchpad","setTilesNoVisibility");};g.getBasicHash=function(h){if(!g.validHash(h)){L.debug("Utils ; getBasicHash ; Got invalid hash");return false;}var o=sap.ushell.Container.getService("URLParsing"),s=o.parseShellHash(h);return s?s.semanticObject+"-"+s.action:h;};g.validHash=function(h){return(h&&h.constructor===String&&q.trim(h)!=="");};g.getFormFactor=function(){var s=sap.ui.Device.system;if(s.desktop){return s.SYSTEMTYPE.DESKTOP;}if(s.tablet){return s.SYSTEMTYPE.TABLET;}if(s.phone){return s.SYSTEMTYPE.PHONE;}};g.getVisibleTiles=function(){var n=document.body.clientHeight,C=sap.ui.getCore().byId("dashboardGroups"),N=sap.ui.getCore().byId("viewPortContainer"),a,t,e,h,i,j,T,k,l,m,o,s=q("#shell-hdr").height(),p=[],G,I,v=[],E=sap.ui.getCore().getEventBus(),r,w,x,y;if(window.document.hidden){E.publish("launchpad","onHiddenTab");}if(C&&C.getGroups()&&N){G=q(C.getDomRef());I=G?G.is(":visible"):false;r=C.getGroups();for(a=0;a<r.length;a=a+1){h=r[a];i=h.getTiles();j=h.getLinks();w=[i,j];for(e=0;e<w.length;e++){x=w[e];if(x){for(t=0;t<x.length;t++){T=x[t];if(!I||window.document.hidden){p.push(T);}else{k=q(T.getDomRef());l=k.offset();if(l){m=k.offset().top;o=m+k.height();y=h.getVisible()&&(o>s-300)&&(m<n+300);if(y){v.push({oTile:g.getTileModel(T),iGroup:a,bIsExtanded:!(o>s)||!(m<n)});}else if(v.length>0){E.publish("launchpad","visibleTilesChanged",v);return p;}p.push(T);}}}}}}}if(v.length>0){E.publish("launchpad","visibleTilesChanged",v);}return p;};g.getTileModel=function(a){var e;if(a.isA("sap.ui.integration.widgets.Card")){e=a.getBindingContext("ushellCardModel");}else{e=a.getBindingContext();}return e.getObject()?e.getObject():null;};g.getTileObject=function(a){var e;if(a.isA("sap.ui.integration.widgets.Card")){e=a.getBindingContext("ushellCardModel");}else{e=a.getBindingContext();}return e.getObject()?e.getObject().object:null;};g.recalculateBottomSpace=function(){var j=q("#dashboardGroups").find(".sapUshellTileContainer:visible"),l=j.last(),h=q(".sapUshellShellHead > header").height(),a=l.parent().height(),e=parseInt(l.find(".sapUshellContainerTitle").css("margin-top"),10),i=parseInt(q(".sapUshellDashboardGroupsContainer").css("padding-bottom"),10),n;if(j.length===1){n=0;}else{n=q(window).height()-h-a-e-i;n=(n<0)?0:n;}q(".sapUshellDashboardGroupsContainer").css("margin-bottom",n+"px");};g.calcVisibilityModes=function(G,p){var i=true,I=true,l=G.pendingLinks&&G.pendingLinks.length?G.pendingLinks:G.links,h=g.groupHasVisibleTiles(G.tiles,l);if(!h&&(!p||(G.isGroupLocked)||(G.isDefaultGroup)||D.system.phone||(D.system.tablet&&!D.system.desktop))){i=false;}if(!h&&!p){I=false;}return[i,I];};g.groupHasVisibleTiles=function(a,e){var v=false,t,h,i=!a?[]:a,l=!e?[]:e;i=i.concat(l);if(!i.length){return false;}for(t=0;t<i.length;t=t+1){h=i[t];if(h.isTileIntentSupported){v=true;break;}}return v;};g.invokeUnfoldingArrayArguments=function(F,A){var t=this,e,o,p,r,h;if(!Array.isArray(A[0])){return F.apply(this,A);}e=A[0];if(e.length===0){return new q.Deferred().resolve([]).promise();}o=new q.Deferred();p=[];r=[];h=new q.Deferred().resolve();e.forEach(function(n,i){if(!Array.isArray(n)){var E="Expected Array as nTh Argument of multivalue invocation: "+"first Argument must be array of array of arguments: single valued f(p1,p2), f(p1_2,p2_2), f(p1_3,p2_3) : "+"multivalued : f([[p1,p2],[p1_2,p2_2],[p1_3,p2_3]]";L.error(E);throw new Error(E);}var j=F.apply(t,n),k=new q.Deferred();j.done(function(){var a=Array.prototype.slice.call(arguments);r[i]=a;k.resolve();}).fail(k.reject.bind(k));p.push(k.promise());h=q.when(h,k);});q.when.apply(q,p).done(function(){o.resolve(r);}).fail(function(){o.reject("failure");});return o.promise();};g._getCurrentDate=function(){return new Date();};g._convertToUTC=function(a){return Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds());};g.formatDate=function(C){var i,n,t,a,h,m;i=g._convertToUTC(new Date(C));n=g._convertToUTC(g._getCurrentDate());t=n-i;a=parseInt(t/(1000*60*60*24),10);if(a>0){if(a===1){return sap.ushell.resources.i18n.getText("time_day",a);}return sap.ushell.resources.i18n.getText("time_days",a);}h=parseInt(t/(1000*60*60),10);if(h>0){if(h===1){return sap.ushell.resources.i18n.getText("time_hour",h);}return sap.ushell.resources.i18n.getText("time_hours",h);}m=parseInt(t/(1000*60),10);if(m>0){if(m===1){return sap.ushell.resources.i18n.getText("time_minute",m);}return sap.ushell.resources.i18n.getText("time_minutes",m);}return sap.ushell.resources.i18n.getText("just_now");};g.toExternalWithParameters=function(s,a,p){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(C){var t={},P={},i,T,e;t.target={semanticObject:s,action:a};if(p&&p.length>0){P={};for(i=0;i<p.length;i++){T=p[i].Key;e=p[i].Value;P[T]=e;}t.params=P;}C.toExternal(t);});};g.moveElementInsideOfArray=function(a,n,e){if(!g.isArray(a)||n===undefined||e===undefined){throw"Incorrect input parameters passed";}if(n>=a.length||e>=a.length||e<0||n<0){throw"Index out of bounds";}var E=a.splice(n,1)[0];a.splice(e,0,E);return a;};g.shallowMergeObject=function(t){return Array.prototype.slice.call(arguments,1,arguments.length).map(function(s){return{sourceObject:s,properties:Object.keys(s)};}).reduce(function(r,s){s.properties.forEach(function(p){r[p]=s.sourceObject[p];});return r;},t);};g.getLocationHref=function(){return window.location.href;};g.generateLocalStorageKey=function(p,i){var n=i.length;if(n===0){throw new Error("At least one id should be provided when generating the local storage key");}var s="$";if(n===2){s="#";}else if(n>2){s="@"+n+"@";}return p+s+i.join(":");};g.urlParametersToString=function(p,e,h){var j,a,k,i,l,s="";e=e||"&";h=h||"=";j="";a=null;l=[];for(a in p){if(p.hasOwnProperty(a)){l.push(a);}}l.sort();for(k=0;k<l.length;k=k+1){a=l[k];if(Array.isArray(p[a])){for(i=0;i<p[a].length;i=i+1){s+=j+encodeURIComponent(a)+h+encodeURIComponent(p[a][i]);j=e;}}else{s+=j+encodeURIComponent(a)+h+encodeURIComponent(p[a]);j=e;}}return s;};g.isRootIntent=function(i){if(typeof i!=="string"){throw new Error("The given intent must be a string");}var r="renderers.fiori2.componentData.config.rootIntent";var C=O.get(r,window["sap-ushell-config"])||"#Shell-home";var R=C.replace("#","");var I=i.replace("#","");return I===""||I===R;};g.isFlpHomeIntent=function(i){if(!i){i=window.location.hash;if(!i){i=O.get("renderers.fiori2.componentData.config.rootIntent",window["sap-ushell-config"])||"Shell-home";}}else if(typeof i!=="string"){throw new Error("The given intent must be a string");}var I=i.replace("#","");return I.indexOf("Shell-home")===0||I.indexOf("Launchpad-openFLPPage")===0;};return g;},true);
