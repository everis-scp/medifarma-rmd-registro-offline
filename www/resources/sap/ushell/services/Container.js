// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/System","sap/ushell/Ui5ServiceFactory","sap/ushell/Ui5NativeServiceFactory","sap/ui/base/EventProvider","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/core/Control","sap/ui/performance/Measurement","sap/ui/thirdparty/URI","sap/ui/util/Mobile","sap/base/util/uid","sap/base/assert","sap/base/Log","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery"],function(u,S,U,a,E,b,C,M,c,d,f,g,L,O,q){"use strict";var h="sap.ushell.services.Container",j="sap.ushell.Container.dirtyState.",o={},k,p,F,A=[];function l(){close();}function r(){document.location="about:blank";}function m(P){if(p&&p[P]){return p[P];}return"sap.ushell.adapters."+P;}function n(e){return(k.services&&k.services[e])||{};}function s(N,e,P,i){var w=n(N).adapter||{},x=w.module||m(e.getPlatform())+"."+N+"Adapter";function y(){return new(O.get(x))(e,P,{config:w.config||{}});}if(i){return new Promise(function(z,B){var D=x.replace(/\./g,"/");sap.ui.require([D],function(){try{z(y());}catch(G){B(G);}},B);});}q.sap.require(x);return y();}function t(w){var x=new E(),y=false,R=[],z={},B="sap.ushell.Container."+w.getSystem().getPlatform()+".remoteSystem.",D={},G,H,I=u.getLocalStorage(),J=new u.Map(),K=new u.Map(),N="sap.ushell.Container."+w.getSystem().getPlatform()+".sessionTermination",P=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelLogon();}};this.createRenderer=function(e,i){var V,W,X;M.start("FLP:Container.InitLoading","Initial Loading","FLP");u.setPerformanceMark("FLP - renderer created");e=e||k.defaultRenderer;if(!e){throw new Error("Missing renderer name");}X=(k.renderers&&k.renderers[e])||{};W=X.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);if(X.componentData&&X.componentData.config){V={config:X.componentData.config};}function Y(){var Z=new(O.get(W))({componentData:V}),$=Z instanceof sap.ui.core.UIComponent?new sap.ui.core.ComponentContainer({component:Z,height:"100%",width:"100%"}):Z;if(!($ instanceof C)){throw new Error("Unsupported renderer type for name "+e);}$.placeAt=function(a1,b1){var c1=a1,d1="canvas",e1=document.body;if(a1===e1.id){c1=document.createElement("div");c1.setAttribute("id",d1);c1.classList.add("sapUShellFullHeight");switch(b1){case"first":if(e1.firstChild){e1.insertBefore(c1,e1.firstChild);break;}case"only":e1.innerHTML="";default:e1.appendChild(c1);}a1=d1;b1="";}C.prototype.placeAt.call(this,a1,b1);};z[e]=Z;x.fireEvent("rendererCreated",{renderer:Z});return $;}if(i){return new Promise(function(Z,$){var a1=W.replace(/\./g,"/");sap.ui.require([a1],function(){try{Z(Y());}catch(b1){$(b1);}});});}q.sap.require(W);return Y();};this.getRenderer=function(e){var i,V;e=e||k.defaultRenderer;if(e){i=z[e];}else{V=Object.keys(z);if(V.length===1){i=z[V[0]];}else{L.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",null,h);}}if(i&&i.isA("sap.ui.core.ComponentContainer")){return i.getComponentInstance();}return i;};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var i,V=new q.Deferred(),W=f(),X,Y=0,Z=this.DirtyState.CLEAN;function $(){if(Y===0||Z===P.DirtyState.DIRTY){V.resolve(Z);L.debug("getGlobalDirty() Resolving: "+Z,null,"sap.ushell.Container");}}function a1(b1){if(b1.key.indexOf(j)===0&&b1.newValue!==P.DirtyState.INITIAL&&b1.newValue!==P.DirtyState.PENDING){L.debug("getGlobalDirty() Receiving event key: "+b1.key+" value: "+b1.newValue,null,"sap.ushell.Container");if(b1.newValue===P.DirtyState.DIRTY||b1.newValue===P.DirtyState.MAYBE_DIRTY){Z=b1.newValue;}Y-=1;$();}}try{I.setItem(W,"CHECK");I.removeItem(W);}catch(e){L.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return V.resolve(this.DirtyState.MAYBE_DIRTY).promise();}if(G){throw new Error("getGlobalDirty already called!");}G=V;window.addEventListener("storage",a1);V.always(function(){window.removeEventListener("storage",a1);G=undefined;});for(i=I.length-1;i>=0;i-=1){X=I.key(i);if(X.indexOf(j)===0){if(I.getItem(X)==="PENDING"){I.removeItem(X);L.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+X,null,"sap.ushell.Container");}else{Y+=1;u.localStorageSetItem(X,this.DirtyState.PENDING,true);L.debug("getGlobalDirty() Requesting status for: "+X,null,"sap.ushell.Container");}}}$();setTimeout(function(){if(V.state()!=="resolved"){V.resolve("MAYBE_DIRTY");L.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container");}},Y*2000);return V.promise();};this.getLogonSystem=function(){return w.getSystem();};this.getUser=function(){return w.getUser();};this.getDirtyFlag=function(){var e=y;var V=sap.ushell.Container.getService("ShellNavigation").getNavigationContext();for(var i=0;i<R.length;i++){e=e||R[i](V);}return e;};this.setDirtyFlag=function(i){y=i;};this.sessionKeepAlive=function(){if(w.sessionKeepAlive){w.sessionKeepAlive();}};this.registerDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function");}R.push(e);};this.deregisterDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function");}var V=-1;for(var i=R.length-1;i>=0;i--){if(R[i]===e){V=i;break;}}if(V===-1){return;}R.splice(V,1);};this.getService=function(e,i,V){return P._getService.apply(P,arguments);};this.getServiceAsync=function(e,i){return P._getService(e,i,true);};this._getService=function(e,i,V){var W={},X,Y,Z,$,a1,b1;function c1(g1){var h1=new q.Deferred();if(!g1){throw new Error("Missing system");}h1.resolve(s(e,g1,i));sap.ushell.Container.addRemoteSystem(g1);return h1.promise();}if(!e){throw new Error("Missing service name");}if(e.indexOf(".")>=0){throw new Error("Unsupported service name");}a1=n(e);X=a1.module||"sap.ushell.services."+e;Y=X+"/"+(i||"");b1={config:a1.config||{}};function d1(g1,$){W.createAdapter=c1;return new g1($,W,i,b1);}function e1(Z,V){var g1;if(J.containsKey(Y)){g1=J.get(Y);}else if(Z.hasNoAdapter){g1=new Z(W,i,b1);}else{$=s(e,w.getSystem(),i,V);if(V){return $.then(function(h1){var g1=d1(Z,h1);J.put(Y,g1);return g1;});}g1=d1(Z,$);}J.put(Y,g1);return V?Promise.resolve(g1):g1;}if(!J.containsKey(Y)){if(V){if(!K.containsKey(Y)){var f1=new Promise(function(g1,h1){sap.ui.require([X.replace(/[.]/g,"/")],function(i1){g1(e1(i1,true));},h1);});K.put(Y,f1);return f1;}return K.get(Y);}L.warning("Deprecated API call of 'sap.ushell.Container.getService'. Please use 'getServiceAsync' instead",null,"sap.ushell.services.Container");Z=sap.ui.requireSync(X.replace(/[.]/g,"/"));return e1(Z);}if(V){return Promise.resolve(J.get(Y));}return J.get(Y);};function Q(){var V,W,i,X;for(i=I.length-1;i>=0;i-=1){X=I.key(i);if(X.indexOf(B)===0){try{V=X.substring(B.length);W=JSON.parse(I.getItem(X));D[V]=new S(W);}catch(e){I.removeItem(X);}}}return D;}function T(){if(typeof OData==="undefined"){return;}function e(i,V,W){L.warning(i,null,"sap.ushell.Container");if(W){setTimeout(W.bind(null,i),5000);}return{abort:function(){return;}};}OData.read=function(i,V,W){return e("OData.read('"+(i&&i.Uri?i.requestUri:i)+"') disabled during logout processing",V,W);};OData.request=function(i,V,W){return e("OData.request('"+(i?i.requestUri:"")+"') disabled during logout processing",V,W);};}this.addRemoteSystem=function(e){var i=e.getAlias(),V=D[i];if(this._isLocalSystem(e)){return;}if(V){if(V.toString()===e.toString()){return;}L.warning("Replacing "+V+" by "+e,null,"sap.ushell.Container");}else{L.debug("Added "+e,null,"sap.ushell.Container");}D[i]=e;u.localStorageSetItem(B+i,e);};this._isLocalSystem=function(e){var i=e.getAlias();if(i&&i.toUpperCase()==="LOCAL"){return true;}var V=new c(u.getLocationHref()),W=this.getLogonSystem().getClient()||"";if(e.getBaseUrl()===V.origin()&&e.getClient()===W){return true;}return false;};this.addRemoteSystemForServiceUrl=function(e){var i,V={baseUrl:";o="};if(!e||e.charAt(0)!=="/"||e.indexOf("//")===0){return;}i=/^[^?]*;o=([^\/;?]*)/.exec(e);if(i&&i.length>=2){V.alias=i[1];}e=e.replace(/;[^\/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){V.platform="hana";V.alias=V.alias||"hana";}else if(/^\/sap\/opu\//.test(e)){V.platform="abap";}if(V.alias&&V.platform){this.addRemoteSystem(new S(V));}};this.attachLogoutEvent=function(e,V){var W=false;if(V===true){g(typeof(e)==="function","Container.attachLogoutEvent: fnFunction must be a function");for(var i=0;i<A.length;i++){if(A[i]===e){W=true;break;}}if(!W){A.push(e);}}else{x.attachEvent("Logout",e);}};this.detachLogoutEvent=function(e){x.detachEvent("Logout",e);for(var i=0;i<A.length;i++){if(A[i]===e){A.splice(i,1);break;}}};this.attachRendererCreatedEvent=function(e){x.attachEvent("rendererCreated",e);};this.detachRendererCreatedEvent=function(e){x.detachEvent("rendererCreated",e);};this.defaultLogout=function(){var V=new q.Deferred();function W(){w.logout(true).always(function(){I.removeItem(N);V.resolve();});}function X(){var e=new q.Deferred(),Z=e.promise(),$=[];if(A.length>0){for(var i=0;i<A.length;i++){$.push(A[i]());}Promise.all($).then(e.resolve);setTimeout(e.resolve,4000);}else{e.resolve();}Z.done(function(){if(x.fireEvent("Logout",true)){W();}else{setTimeout(W,1000);}});}function Y(){var D,i=[];if(H){window.removeEventListener("storage",H);}u.localStorageSetItem(N,"pending");P._suppressOData();D=P._getRemoteSystems();Object.keys(D).forEach(function(Z){try{i.push(s("Container",D[Z]).logout(false));}catch(e){L.warning("Could not create adapter for "+Z,e.toString(),"sap.ushell.Container");}I.removeItem(B+Z);});q.when.apply(q,i).done(X);}if(typeof w.addFurtherRemoteSystems==="function"){w.addFurtherRemoteSystems().always(Y);}else{Y();}return V.promise();};this.logout=this.defaultLogout;this.registerLogout=function(e){this.logout=e;};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.logonFrameProvider=e;}};this.setXhrLogonTimeout=function(e,i){if(this.oFrameLogonManager){this.oFrameLogonManager.setTimeout(e,i);}};this.getFLPConfig=function(){var P=this,e=new Promise(function(i,V){var W={URL:P.getFLPUrl()};if(o.CDMPromise){o.CDMPromise.then(function(X){X.getSiteWithoutPersonalization().then(function(Y){W.scopeId=Y.site.identification.id;i(W);});});}else{i(W);}});return e;};this.getFLPUrl=function(i){var e=u.getLocationHref(),V=e.indexOf(this.getService("URLParsing").getShellHash(e));if(V===-1||i===true){return e;}return e.substr(0,V-1);};this.getFLPUrlAsync=function(i){return new q.Deferred().resolve(P.getFLPUrl(i)).promise();};this.inAppRuntime=function(){return false;};this.runningInIframe=this.inAppRuntime;this._getAdapter=function(){return w;};this._closeWindow=l;this._redirectWindow=r;this._getRemoteSystems=Q;this._suppressOData=T;sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,i,V){P.addRemoteSystemForServiceUrl(V);});if(typeof w.logoutRedirect==="function"){H=function(e){function i(){P._closeWindow();P._redirectWindow();}if(sap.ushell.Container!==P){return;}if(e.key.indexOf(B)===0&&e.newValue&&e.newValue!==I.getItem(e.key)){u.localStorageSetItem(e.key,e.newValue);}if(e.key===N){if(e.newValue==="pending"){P._suppressOData();if(x.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}}};window.addEventListener("storage",H);}this._getFunctionsForUnitTest=function(){return{createAdapter:s};};}function v(e,i){e.forEach(function(w){var x=U.createServiceFactory(w,i);b.register("sap.ushell.ui5service."+w,x);});}function _(e){e.forEach(function(i){var w=a.createServiceFactory(i);b.register("sap.ushell.ui5service."+i,w);});}sap.ushell.bootstrap=function(P,e){var i,D=new q.Deferred();d.init();if(sap.ushell.Container!==undefined){i=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+F);L.error(i,i.stack,h);throw i;}F=(new Error()).stack;k=q.extend({},true,window["sap-ushell-config"]||{});p=e;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"]);}v(["Personalization","URLParsing","CrossApplicationNavigation"],true);v(["Configuration"],false);_(["CardNavigation","CardUserRecents","CardUserFrequents"]);var w=new S({alias:"",platform:k.platform||P});s("Container",w,null,true).then(function(x){x.load().then(function(){function y(){var G,H;var I=window["sap-ushell-config"];if(!I||!I.services){return false;}G=I.services.PluginManager;H=G&&G.config;return H&&H.loadPluginsFromSite;}sap.ushell.Container=new t(x);var z=[sap.ushell.Container.getServiceAsync("PluginManager")];if(y()){o.CDMPromise=sap.ushell.Container.getServiceAsync("CommonDataModel");z.push(o.CDMPromise);}Promise.all(z).then(function(G){var H=G[0],I=G[1];var J=I?I.getPlugins():q.when({});J.then(function(K){var N=q.extend(true,{},k.bootstrapPlugins,K);H.registerPlugins(N);});}).then(function(){if(u.hasFLPReady2NotificationCapability()){sap.ui.require(["sap/ushell/NWBCInterface"],function(N){u.getPrivateEpcm().doEventFlpReady2(N);});}else if(u.hasFLPReadyNotificationCapability()){u.getPrivateEpcm().doEventFlpReady();}sap.ui.require(["sap/ushell/Config"],function(G){if(G.last("/core/darkMode/enabled")){sap.ushell.Container.getService("DarkModeSupport").setup();}if(G.last("/core/shellHeader/newDesignSwitchVisible")){var H=sap.ushell.Container.getUser().getTheme(sap.ushell.User.prototype.constants.themeFormat.ORIGINAL_THEME);if(H===sap.ushell.User.prototype.constants.NEW_DESIGN){G.emit("/core/shellHeader/newDesignSwitchActive",true);}}});});var B=[];if(k.preloadServices!==undefined&&Array.isArray(k.preloadServices)){k.preloadServices.forEach(function(G){B.push(sap.ushell.Container.getServiceAsync(G));});L.error("Ushell Config's preloadServices should not be used!");}Promise.all(B).then(function(){D.resolve();});});});return D.promise();};});
