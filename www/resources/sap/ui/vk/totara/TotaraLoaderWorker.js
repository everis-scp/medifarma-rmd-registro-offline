(function(){"use strict";var t=new Map();function H(){var a,b;var d;var o;var e=[];var m=4;var f=0;function h(a){var p=new Promise(function(i,j){var x=new XMLHttpRequest();x.onload=function(){if(this.status>=200&&this.status<300){i(x.response);if(x.getAllResponseHeaders().includes("tile-width")){var k=x.getResponseHeader("tile-width");var n=new RegExp("[^\/]+$");var q=x.responseURL.match(n);t.set(q[0],k);}}else{j({status:this.status,statusText:x.statusText});}};x.onerror=function(){j({status:this.status,statusText:x.statusText});};x.open("GET",a,true);if(d){x.setRequestHeader("Authorization",d);}x.setRequestHeader("X-CorrelationID",b);x.responseType="arraybuffer";x.send();});return p;}this.getUrl=function(){return a;};this.close=function(){};this.send=function(i,j,k){if(!i){return;}e.push({message:i,context:j,onResponse:k||this.onResponse});if(f<m){_();}};function _(){if(!e.length){return;}var i=e.shift();f++;h(encodeURI(a+i.message)).then(function(j){if(i.onResponse){i.onResponse(j);}f--;_();}).catch(function(j){if(o){o({errorText:"Could not connect to server: "+a,error:j.status,reason:j.message?j.message:j,context:i.context});}f--;_();});}this.init=function(s,i,j){return new Promise(function(k,n){a=s;b=j;if(i!=null){i(s).then(function(p){if(p!=null){d=p.token_type+" "+p.access_token;}else{d=null;}k({});}).catch(function(p){return n(p);});}else{k({});}});};this.setOnErrorCallback=function(i){o=i;};this.onResponse=null;}function W(){var a;var b=this;var d;var o;function i(){if(d&&d.readyState===1){return true;}return false;}function f(e,p,q){if(o){o({errorText:e,error:q,context:p});}}this.setOnErrorCallback=function(e){o=e;};this.getUrl=function(){return a;};this.close=function(){if(d){d.close();d=null;}};this.send=function(p,q){if(!p){return;}if(!i()){f("websocket connection lost",q,4);}else{try{d.send(p);}catch(e){f(e,q);}}};var h=0;function k(){var e=60000;if(d==null){clearTimeout(h);return;}if(d.readyState==1){d.send("");}h=setTimeout(k,e);}function j(){if(h){clearTimeout(h);h=0;}}var m=false;var n=function(e){var p=JSON.stringify(e);var q="setStreamingToken"+("["+p.length+"]")+p;return q;};this.init=function(s,p){return new Promise(function(q,v){if(s){a=s;}else{s=a;}d=new WebSocket(s);d.binaryType="arraybuffer";d.onopen=function(){m=true;if(p!=null){p(s).then(function(e){if(e!=null){var w=n({"token":e.access_token});d.send(w);}k();q({});}).catch(function(e){return v(e);});}else{k();q({});}};d.onclose=function(){j();};d.onmessage=function(e){var w=e.data;if(b.onResponse){b.onResponse(w);}};d.onerror=function(e){if(!m){v("error connecting to "+s);}else{f(e);}};});};this.onResponse=null;}function g(a){var b=a.split(",");if(b.length<0||b.length>2){throw"invalid content length";}var j=0;var d=0;try{j=parseInt(b[0],10);if(b.length===2){d=parseInt(b[1],10);}}catch(e){throw"invalid content length";}return{jsonContentLength:j,binaryContentLength:d};}function c(a){var b="[".charCodeAt(0);var d="]".charCodeAt(0);var f=[];var s=0;var h=0;var i;var j;var k;var m=new Uint8Array(a);while(h<a.byteLength){h=m.indexOf(b,s);if(h===-1){break;}var n=u(a,s,h).replace(/\n|\r|\s/g,"");s=h+1;h=m.indexOf(d,s);if(h===-1){throw"No matching [] for command length. abort";}i=g(u(a,s,h));s=h+1;h=s+i.jsonContentLength;j=u(a,s,h);try{j=JSON.parse(j);}catch(e){var o=n+": "+e;throw o;}if(i.binaryContentLength){s=h;h=s+i.binaryContentLength;k=a.slice(s,h);}else{k=undefined;}s=h;var p={name:n,jsonContent:j};if(k){p.binaryContent=new Uint8Array(k);}f.push(p);}return f;}function u(a,s,b){var d="";var M=1000;try{while(s<b){var f=Math.min(M,b-s);var h=new Uint8Array(a,s,f);d+=String.fromCharCode.apply(null,h);s+=f;}}catch(e){return"";}return decodeURIComponent(escape(d));}function L(){this.resolveFunctions=[];this.rejectFunctions=[];this.init=function(d,h,e){this._connection=d;this._connectionHTTP=h;this._sceneBuilderId=e;if(!d){throw"no connection provided for loader!";}this._connection.onResponse=function(f){var i=c(f);p(i);};this._connection.send("getVersion[2]{}");};var a=this;function b(v){a.protocolVersion=v.split(".").map(function(s){return parseInt(s,10);});}function p(d){var e;var v,i;var n=false;for(i=0;i<d.length;i++){e=d[i];if(e.name==="setView"){if(!e.jsonContent.viewId){n=true;}}else if(e.name==="setViewNode"){v=e.jsonContent.viewId;}else if(e.name==="notifyFinishedView"||e.name==="notifyFinishedTree"){break;}}if(v&&n){for(i=0;i<d.length;i++){e=d[i];if(e.name==="setView"){e.jsonContent.viewId=v;break;}}}for(i=0;i<d.length;i++){e=d[i];if(e.name==="protocol"){b(e.jsonContent.version);}if(e.name==="setImage"&&t.get(e.jsonContent.id)){e.jsonContent.tileWidth=t.get(e.jsonContent.id);}if(e.binaryContent){self.postMessage({name:e.name,jsonContent:e.jsonContent,binaryContent:e.binaryContent},[e.binaryContent.buffer]);}else{self.postMessage({name:e.name,jsonContent:e.jsonContent});}}}this.getConnection=function(){return this._connection;};this._sendGetImage=function(d){var e;if(this.protocolVersion&&(this.protocolVersion[0]>1||this.protocolVersion[1]>0)){if(d.materialId){e="scenes/"+d.sceneId+"/materials/"+d.materialId+"/images/"+d.imageId;}else if(d.viewId){e="scenes/"+d.sceneId+"/views/"+d.viewId+"/thumbnail";}}e=e||("images/"+d.imageId);this._connectionHTTP.send(e,d,function(f){p([{name:"setImage",jsonContent:{sceneId:d.sceneId,id:d.imageId},binaryContent:new Uint8Array(f)}]);});};this._sendGetGeometries=function(d){var e=d.geometryIds;var f="geometry?";for(var i=0;i<e.length;i++){f+=(i>0?"&id=":"id=")+e[i];}this._connectionHTTP.send(f,d,function(h){var j=new DataView(h);var k=j.getUint16(2,true),o=0;var m=[];while(k-->0){var n={sceneId:d.sceneId,id:j.getUint32(o+4,true).toString(),box:[j.getFloat32(o+14,true),j.getFloat32(o+18,true),j.getFloat32(o+22,true),j.getFloat32(o+26,true),j.getFloat32(o+30,true),j.getFloat32(o+34,true)]};var q=j.getUint16(o+12,true);o+=38;if(q!==3){n.flags=j.getUint16(o,true);n.quality=j.getFloat32(o+4,true);n.pointCount=j.getUint16(o+8,true);n.elementCount=j.getUint16(o+10,true);o+=14;}var s=j.getUint32(o,true);var v=new Uint8Array(h,o+4,s);o+=s;m.push({name:"setGeometry",jsonContent:n,binaryContent:v.slice()});}p(m);});};this._sendGetGeomMeshes=function(d){var e="scenes/"+d.sceneId+"/meshes?ids=";var m=d.meshIds;for(var i=0;i<m.length;i++){e+=(i>0?",":"")+m[i];}this._connectionHTTP.send(e,d,function(f){var h=c(f);h.forEach(function(s){s.jsonContent.sceneId=d.sceneId;});p(h);});};this.send=function(d){if(this._connectionHTTP){switch(d.method){case"getImage":this._sendGetImage(d);return;case"getGeometry":this._sendGetGeometries(d);return;case"getMesh":if(d.meshIds){this._sendGetGeomMeshes(d);return;}break;default:break;}}if(this._connection){this._connection.send(d.command);}};this.setSceneBuilderId=function(i){this._sceneBuilderId=i;};this.getSceneBuilderId=function(){return this._sceneBuilderId;};this.authorizationHandler=function(d){var a=this;return new Promise(function(e,f){var h={name:"getAuthorization",jsonContent:{"url":d},sceneId:a.sceneId};a.resolveFunctions.push(e);a.rejectFunctions.push(f);self.postMessage(h);});}.bind(this);}var l=new L();var r=function(e){self.postMessage({name:"notifyError",jsonContent:e});};self.onmessage=function(e){var d=e.data;switch(d.method){case"initializeConnection":{if(!d.url){break;}if(d.sceneId){l.sceneId=d.sceneId;}var a="";if(d.url[d.url.length-1]!=="/"){d.url+="/";}if(d.url.toLowerCase().startsWith("ws")){a=d.url+"streaming?";}else if(d.url.toLowerCase().startsWith("http")){a=d.url+"streaming-http?request=";}else{a=(d.useSecureConnection?"wss://":"ws://")+d.url+"streaming?";}var b=d.cid;var f=l.getConnection();if(!f||f.getUrl()!==a){if(f){f.close();}var h;var i=null;if(d.url.toLowerCase().startsWith("ws")){h=new W();}else if(d.url.toLowerCase().startsWith("http")){h=new H();i=d.url;}else{h=new W();i=(d.useSecureConnection?"https://":"http://")+d.url;}h.setOnErrorCallback(function(m){r(m);});h.init(a,l.authorizationHandler,b).then(function(){var m=function(h,n){l.init(h,n,d.sceneBuilderId);if(d.command){l.send(d);}};if(i){var n=new H();n.init(i,l.authorizationHandler,b).then(function(){m(h,n);}).catch(function(o){r(o);});}else{m(h,null);}}).catch(function(m){r(m);});}else if(d.command){l.send(d);}break;}case"setAuthorization":{var j=l.resolveFunctions.shift();var k=l.rejectFunctions.shift();if(d.error==null){j(d.authorizationToken);}else{k(d.error);}break;}case"close":{self.close();break;}default:{if(d.command){l.send(d);}break;}}};self.postMessage({ready:true});})();
