/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","./ExplodeAxis","./ExplodeDirection","./ExplodeItemGroup","./ExplodeType","./ExplodeToolHandler","./ExplodeToolGizmo","../AnimationPlayback","../AnimationTrackType","../AnimationTrackValueType","sap/ui/base/ManagedObjectObserver"],function(T,E,a,b,c,d,e,A,f,g,M){"use strict";var h=T.extend("sap.ui.vk.tools.ExplodeTool",{metadata:{properties:{type:{type:"sap.ui.vk.tools.ExplodeType",defaultValue:c.Linear},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float",defaultValue:0.0},anchor:{type:"float[]",defaultValue:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}},aggregations:{items:{type:"sap.ui.vk.tools.ExplodeItemGroup",multiple:true}},associations:{selectedItem:{type:"sap.ui.vk.tools.ExplodeItemGroup",multiple:false}},events:{magnitudeChanging:{parameters:{type:{type:"sap.ui.vk.tools.ExplodeType"},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float"}}},magnitudeChanged:{parameters:{type:{type:"sap.ui.vk.tools.ExplodeType"},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float"}}},itemSequenceChangePressed:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},moveUp:{type:"boolean"}}},itemPositionAdjusting:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},magnitudeAdjustmentMultiplier:{type:"float"}}},itemPositionAdjusted:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},magnitudeAdjustmentMultiplier:{type:"float"}}}}},constructor:function(i,s){T.apply(this,arguments);this._viewport=null;this._handler=new d(this);this._gizmo=null;}});h.prototype.init=function(){if(T.prototype.init){T.prototype.init.call(this);}this.setFootprint(["sap.ui.vk.threejs.Viewport"]);this.setAggregation("gizmo",new e());this._groupObserver=new M(this._onGroupChanged.bind(this));this._groupsObserver=new M(this._onGroupsChanged.bind(this));this._groupsObserver.observe(this,{aggregations:["items"]});};h.prototype.destroy=function(){h._cleanAssociatedLoaders();this._groupsObserver.disconnect();this._groupsObserver=null;this._groupObserver.disconnect();this._groupObserver=null;};h.prototype.setActive=function(v,i,j){T.prototype.setActive.call(this,v,i,j);if(this._viewport){if(v){this._gizmo=this.getGizmo();this._gizmo.show(this._viewport,this);this._addLocoHandler();}else{this._removeLocoHandler();if(this._gizmo){this._gizmo.hide();this._gizmo=null;}}}return this;};h.prototype.queueCommand=function(i){if(this._addLocoHandler()){if(this.isViewportType("sap.ui.vk.threejs.Viewport")){i();}}return this;};h.prototype.setAxis=function(v){this.setProperty("axis",v,true);if(this._gizmo){this._gizmo._updateAxis();}};h.prototype.setDirection=function(v){this.setProperty("direction",v,true);if(this._gizmo){this._gizmo._updateAxis();}};h.prototype.setAnchor=function(v){this.setProperty("anchor",v,true);if(this._gizmo){this._gizmo._updateAxis();}};h.prototype.pickAnchorFromNodesList=function(n){if(!Array.isArray(n)){n=[n];}var i=function(j){var k=new THREE.Box3();j._expandBoundingBox(k,false,true,true);return k.getSize(new THREE.Vector3()).manhattanLength();};var t=n.reduce(function(m,j){var s=i(j);if(s>i(m)){m=j;}return m;});this.setAnchor(t.matrixWorld.elements.slice());};h.prototype.setMagnitude=function(v){this.setProperty("magnitude",v,true);if(this._gizmo){this._gizmo._setMagnitude(v);}};h.prototype.setSelectedItem=function(v){this.setAssociation("selectedItem",v);if(this._gizmo){this._gizmo._handleSelectedItemChanged();}};h.prototype._onGroupsChanged=function(i){this._groupObserver.disconnect();this.getItems().forEach(function(j){this._groupObserver.observe(j,{aggregations:["items"]});}.bind(this));if(this._gizmo){this._gizmo._handleGroupsChanged(i);}};h.prototype._onGroupChanged=function(i){if(this._gizmo){this._gizmo._handleGroupsChanged(i);}};h.prototype.reset=function(){};h.prototype._activateView=function(i){var s=this._viewport.getScene();var v=s.getViewStateManager();var j=s.getViews()[i];v.activateView(j);var k=this._viewport._viewStateManager.getAnimationPlayer();if(k){setTimeout(function(){k.play();},100);}};h.prototype._createView=function(i,n,j,o,k){var s=this._viewport.getScene();var v=s.getViewStateManager();var l=s.createView({name:n});var t=[];if(i){var m=i.getNodeInfos();m.forEach(function(w){var x={target:w.target,transform:w.transform?w.transform.slice():null,meshId:w.meshId,materialId:w.materialId,visible:w.visible,opacity:w.opacity};t.push(x);});}else{var p=v.getNodeHierarchy();var q=function(w){if(w.visible){t.push({target:w,visible:w.visible});}p.enumerateChildren(w,q,false,true);};p.enumerateChildren(null,q,false,true);}l.setNodeInfos(t);var r={name:n,nodes:[]};if(i){r.sourceId=i.getId();var u=this._viewport._viewStateManager.getAnimationPlayer();if(u){r.time=u.getTime();}}t=[];this._gizmo._nodes.forEach(function(w){var x=w.node;var y=x.matrix.elements;var z=[w.local.x,w.local.y,w.local.z];if(k){var B=k.get(w.node);if(B!=null){z=B;}}var C=[y[0],y[4],y[8],z[0],y[1],y[5],y[9],z[1],y[2],y[6],y[10],z[2]];r.nodes.push({sid:s.nodeRefToPersistentId(x),transform:C});t.push({target:x,transform:C});});l.updateNodeInfos(t);if(j){j.views.push(r);}return l;};h.prototype._compareGroup=function(t,j){var k=this.getItems();for(var i=0;i<k.length;i++){var l=k[i];if(l==t){return false;}else if(l==j){return true;}}};h.prototype.generateRequestData=function(o){var p=o?o.viewPrefix:null;if(!p){p="";}var r={views:[]};var i=1.0;var s=this._viewport.getScene();var j=this._viewport.getCurrentView();var n=new Map();var k=new Map();if(o&&o.animation&&o.animation.enabled){this.getItems().forEach(function(x){x.getItems().forEach(function(y){var z=y.getNodeRef();var B=z.matrix.elements;var C={x:B[12],y:B[13],z:B[14]};k.set(z.uuid,C);});});this._gizmo._nodes.forEach(function(x){var y=x.node;y.matrix.elements[12]=x.local.x;y.matrix.elements[13]=x.local.y;y.matrix.elements[14]=x.local.z;y.position.setFromMatrixPosition(y.matrix);y.updateMatrixWorld(true);n.set(y,[x.local.x,x.local.y,x.local.z]);});}var v=this._createView(j,p+"Explode View",r,n);var l=r.views[r.views.length-1];if(o&&o.animation&&o.animation.enabled){var m=1;var q=new Map();var t=null;r.tracks=[];r.sequences=[];var u=[];this.getItems().forEach(function(x){l=r.views[r.views.length-1];if(o.animation.separateAnimations||o.animation.separateViews||m==1){t=s.createSequence(v.getId()+"_seq"+m,{name:"Explode "+m,duration:i});var y=new A({sequence:t});if(u.length>0){r.sequences.push({nodes:u});u=[];}v.addPlayback(y);v.resetPlaybacksStartTimes();if(!l.playbacks){l.playbacks=[];}l.playbacks.push({start:0,sequence:r.sequences.length});}var z=s.createTrack(null,{trackValueType:g.Vector3,isAbsoluteValue:false});this._gizmo._nodes.forEach(function(B){if(B.group==x){var C=k.get(B.node.uuid);if(z.getKeysCount()==0){var D=[C.x-B.local.x,C.y-B.local.y,C.z-B.local.z];z.insertKey(0,[0,0,0]);z.insertKey(i,D);r.tracks.push({time:[0,i],vector3:[0,0,0,D[0],D[1],D[2]]});}t.setNodeAnimation(B.node,f.Translate,z);u.push({sid:s.nodeRefToPersistentId(B.node),rtranslate:{track:r.tracks.length-1}});q.set(B.node,[C.x,C.y,C.z]);}});m++;if(o.animation.separateViews&&m<=this.getItems().length){v=this._createView(j,p+"Explode View "+m,r,n,q);}}.bind(this));if(u.length>0){r.sequences.push({nodes:u});}}else{var w=[];l.nodes=[];this.getItems().forEach(function(x){x.getItems().forEach(function(y){var z=y.getNodeRef();var B=z.matrix.elements;var C=[B[0],B[4],B[8],B[12],B[1],B[5],B[9],B[13],B[2],B[6],B[10],B[14]];w.push({target:z,transform:C});l.nodes.push({sid:s.nodeRefToPersistentId(z),transform:C});});});v.updateNodeInfos(w);}return r;};return h;});
