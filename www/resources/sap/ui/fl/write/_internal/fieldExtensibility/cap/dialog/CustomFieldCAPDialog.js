/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/core/Fragment","sap/m/MessageToast","sap/ui/fl/write/_internal/fieldExtensibility/cap/editor/getEditorConfig","sap/base/util/ObjectPath","sap/base/util/deepClone","sap/ui/model/resource/ResourceModel"],function(M,F,a,g,O,d,R){"use strict";var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");function s(D,i,c){var e=D.getContent()[0];e.setJson(d(i));e.setConfig(g(c));return e;}function p(o){if(!o){return{};}var j=d(o);var r=O.get(["@assert.range"],j);if(j.type==="cds.String"&&Array.isArray(r)){O.set(["enum"],r.reduce(function(e,b){e[b]={};return e;},{}),j);O.set(["@assert.range"],true,j);}if(j.annotations){j=Object.assign({},j,j.annotations);delete j.annotations;}return j;}var C=M.extend("sap.ui.fl.write._internal.fieldExtensibility.cap.dialog.CustomFieldCAPDialog",{metadata:{library:"sap.ui.fl",properties:{_dialog:{type:"sap.m.Dialog",visibility:"hidden"}}}});C.prototype.open=function(e,r){var i={name:"NewField",type:"cds.String",entityType:e.boundEntitySet.$Type};var D=this.getProperty("_dialog");if(D){this._oEditor.setJson(d(i));D.open();}else{F.load({name:"sap.ui.fl.write._internal.fieldExtensibility.cap.dialog.CustomFieldCAPDialog",controller:this}).then(function(A){A.setModel(new R({bundle:t}),"i18n");A.addStyleClass(r);this.setProperty("_dialog",A);this._oJson=d(i);this._oEditor=s(A,this._oJson,{entityTypes:e.entityTypes});this._oEditor.attachJsonChange(function(E){this._oJson=p(E.getParameter("json"));}.bind(this));A.open();}.bind(this));}};C.prototype.exit=function(){var D=this.getProperty("_dialog");if(D){D.destroy();}if(this.oEditor){this.oEditor.destroy();}};C.prototype.onSave=function(){var P={definition:JSON.stringify(this._oJson)};var A=new Promise(function(r,b){var x=new XMLHttpRequest();x.open("POST","http://localhost:4004/extensibility/addField");x.setRequestHeader("Content-Type","application/json");x.onload=function(){if(x.status>=200&&x.status<400){r(x.response);}else{b({status:x.status,message:x.statusText});}};x.send(JSON.stringify(P));});A.then(function(){a.show(t.getText("CAP_ADD_FIELD_SUCCESS"));});this.getProperty("_dialog").close();};C.prototype.onCancel=function(){this.getProperty("_dialog").close();};return C;});
