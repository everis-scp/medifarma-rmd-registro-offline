/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/changeHandler/Base","sap/ui/mdc/p13n/Engine","sap/base/Log"],function(F,E,L){"use strict";var I={_bSupressFlickering:true,beforeAddItem:function(D,d,c,p){return D.addItem.call(D,d,c,p);},afterRemoveItem:function(D,i,c,p){return D.removeItem.call(D,i,c,p);},findItem:function(m,d,n){return Promise.resolve();},beforeApply:function(c,C,i){return;},afterApply:function(c,C,i){return;},determineAggregation:function(m,c){var d;return Promise.resolve().then(m.getControlMetadata.bind(m,c)).then(function(M){d=M.getDefaultAggregation().name;return m.getAggregation(c,d);}).then(function(D){return{name:d,items:D};});},_getExistingAggregationItem:function(c,p,C){var m=p.modifier;return Promise.resolve().then(this.determineAggregation.bind(this,m,C)).then(function(a){var A=a.items;if(A){return this.findItem(m,A,c.name);}}.bind(this));},_getDelegate:function(d,s,f){sap.ui.require([d],s,f);},_getOperationText:function(i){return i?"reverted ":"applied ";},_getChangeTypeText:function(a){return a?"add":"remove";},_delayInvalidate:function(c){if(c&&c.isInvalidateSuppressed&&!c.isInvalidateSuppressed()){c.iSuppressInvalidate=1;E.getInstance().waitForChanges(c).then(function(){c.iSuppressInvalidate=0;c.invalidate();});}},_applyAdd:function(c,C,p,i){this.beforeApply(c.getChangeType(),C,i);if(this._bSupressFlickering){this._delayInvalidate(C);}return new Promise(function(r,a){var m=p.modifier,o=i?c.getRevertData():c.getContent();var d=o.name;var b;var D;var A;return Promise.resolve().then(this.determineAggregation.bind(this,m,C)).then(function(R){A=R;D=A.items;b=o.index>-1?o.index:D.length;return this._getExistingAggregationItem(o,p,C);}.bind(this)).then(function(e){return new Promise(function(f,g){if(e){f(e);}else{Promise.resolve().then(m.getProperty.bind(m,C,"delegate")).then(function(h){this._getDelegate(h.name,function(j){this.beforeAddItem(j,d,C,p,o).then(function(k){if(k){f(k);}else{g();}});}.bind(this),g);}.bind(this));}}.bind(this)).then(function(e){if(!e){a(new Error("No item in"+A.name+"  created. Change to "+this._getChangeTypeText(!i)+"cannot be "+this._getOperationText(i)+"at this moment"));}return Promise.resolve().then(function(){if(D.indexOf(e)<0){return m.insertAggregation(C,A.name,e,b);}else{L.warning("Specified change is already existing");}}).then(function(){if(i){c.resetRevertData();}else{c.setRevertData({name:o.name,index:b});}this.afterApply(c.getChangeType(),C,i);r();}.bind(this));}.bind(this)).catch(function(){a(new Error("Change to "+this._getChangeTypeText(!i)+"cannot be"+this._getOperationText(i)+"at this moment"));}.bind(this));}.bind(this)).catch(function(e){a(e);});}.bind(this));},_applyRemove:function(c,C,p,i){this.beforeApply(c.getChangeType(),C,i);if(this._bSupressFlickering){this._delayInvalidate(C);}return new Promise(function(r,a){var m=p.modifier,o=i?c.getRevertData():c.getContent();var A;var b;var d;return Promise.resolve().then(this.determineAggregation.bind(this,m,C)).then(function(D){A=D;return this._getExistingAggregationItem(o,p,C);}.bind(this)).then(function(R){d=R;if(!d){if(i){a(new Error("No item found in "+A.name+". Change to "+this._getChangeTypeText(i)+"cannot be "+this._getOperationText(i)+"at this moment"));return Promise.reject();}else{L.warning("Specified change is already existing");}return-1;}return m.findIndexInParentAggregation(d);}.bind(this)).then(function(f){b=f;return m.removeAggregation(C,A.name,d);}).then(function(){if(i){c.resetRevertData();}else{c.setRevertData({name:o.name,index:b});}return m.getProperty(C,"delegate");}).then(function(D){return this._getDelegate(D.name,function(e){this.afterRemoveItem(e,d,C,p).then(function(f){if(f&&d){m.destroy(d);}this.afterApply(c.getChangeType(),C,i);r();}.bind(this));}.bind(this),a);}.bind(this)).catch(function(e){a(e);});}.bind(this));},_applyMove:function(c,C,p,i){this.beforeApply(c.getChangeType(),C,i);if(this._bSupressFlickering){this._delayInvalidate(C);}return new Promise(function(r,a){var m=p.modifier;var o=i?c.getRevertData():c.getContent();var b;var A;var O;return this._getExistingAggregationItem(o,p,C).then(function(R){b=R;return this.determineAggregation(m,C);}.bind(this)).then(function(R){A=R;if(!b){a(new Error("No corresponding item found in "+A.name+" found. Change to move item cannot be "+this._getOperationText(i)+"at this moment"));return Promise.reject();}return m.findIndexInParentAggregation(b);}.bind(this)).then(function(R){O=R;if(C.moveColumn){C.moveColumn(b,o.index);}else{return Promise.resolve().then(m.removeAggregation.bind(m,C,A.name,b)).then(m.insertAggregation.bind(m,C,A.name,b,o.index));}}).then(function(){if(i){c.resetRevertData();}else{c.setRevertData({id:m.getId(b),name:o.name,index:O});}this.afterApply(c.getChangeType(),C,i);r();}.bind(this)).catch(function(e){a(e);});}.bind(this));},_removeIndexFromChange:function(c){delete c.getContent().index;},createChangeHandler:function(a,c,r){return{"changeHandler":{applyChange:function(C,o,p){return a(C,o,p);},completeChangeContent:function(C,m,p){c(C,m,p);},revertChange:function(C,o,p){return r(C,o,p,true);}},"layers":{"USER":true}};},createAddChangeHandler:function(){var a=this._applyAdd.bind(this);var c=function(){};var r=this._applyRemove.bind(this);return this.createChangeHandler(a,c,r);},createRemoveChangeHandler:function(){var a=this._applyRemove.bind(this);var c=this._removeIndexFromChange.bind(this);var r=this._applyAdd.bind(this);return this.createChangeHandler(a,c,r);},createMoveChangeHandler:function(){var a=this._applyMove.bind(this);var c=function(){};var r=a;return this.createChangeHandler(a,c,r);}};return I;});
