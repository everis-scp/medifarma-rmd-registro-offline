/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/core/format/NumberFormat","sap/fe/core/CommonUtils","sap/fe/macros/CommonHelper","sap/fe/macros/filter/FilterUtils","sap/base/Log","sap/fe/macros/DelegateUtil","sap/fe/core/helpers/ModelHelper","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/ConverterContext","sap/base/util/merge","sap/fe/core/helpers/BindingExpression"],function(F,N,C,a,b,L,D,M,c,d,m,B){"use strict";function g(T,S){var E=T.data("entityType"),v=C.getAppComponent(T).getMetaModel(),x=v.getObject(E+"@"+S),y=[],P=[],z="";if(x){z=x.Text;for(var i in x.SelectOptions){var A=x.SelectOptions[i];if(A&&A.PropertyName){var H=A.PropertyName.$PropertyPath;var R=[];for(var j in A.Ranges){var I=A.Ranges[j];R.push(new F(H,I.Option.$EnumMember.split("/").pop(),I.Low,I.High));}if(R.length>0){if(!P.includes(H)){P.push(H);}y.push(new F({filters:R,and:false}));}}}}return{properties:P,filters:y,text:z};}function e(T){var i=[],j=T.data("hiddenFilters");if(j&&Array.isArray(j.paths)){j.paths.forEach(function(P){var S=g(T,P.annotationPath);i=i.concat(S.filters);});}return i;}function f(T){var i=[],Q=D.getCustomData(T,"quickFilterKey");if(Q){i=i.concat(g(T,Q).filters);}return i;}function h(T){return f(T).concat(e(T));}function k(T,E,H){var i=T.data("rowsBindingInfo");if(i){if(!i.events){i.events={};}if(!i.events[E]){i.events[E]=H;}else{var O=i.events[E];i.events[E]=function(){H.apply(this,arguments);O.apply(this,arguments);};}}}function l(T,P,i){var j=T.data("rowsBindingInfo"),v=T.getModel(),x,y,z=i.batchGroupId||"",A=o(T),E=Array.isArray(i.additionalFilters)?i.additionalFilters:[],H=A.bindingPath?A.bindingPath:j.path;E=E.concat(A.filters).concat(p(T));y=new F({filters:E,and:true});x=v.bindList((P?P.getPath()+"/":"")+H,T.getBindingContext(),null,y,{$count:true,$$groupId:z||"$auto",$search:A.search});return x.requestContexts(0,1).then(function(I){var J=I&&I.length?I[0].getBinding().getLength():0;x.destroy();return J;});}function n(i){var j=N.getIntegerInstance({groupingEnabled:true});return j.format(i);}function o(T){var i=D.getCustomData(T,"enableAnalytics"),I=[];function j(T){var A=a.parseCustomData(D.getCustomData(T,"aggregates")||{});return Object.keys(A).map(function(x){return A[x].relativePath;});}if(i==="true"||i===true){I=I.concat(["search"]).concat(j(T));}var v=b.getFilterInfo(T.getFilter(),{ignoredProperties:I,targetControl:T});return v;}function p(T){var P=T.getP13nMode();if(P&&P.indexOf("Filter")>-1){var i=(D.getCustomData(T,"sap_fe_TableDelegate_propertyInfoMap")||[]).filter(function(v){return v&&!(v.filterable===false);}),j=b.getFilterInfo(T,{propertiesMetadata:i});if(j&&j.filters){return j.filters;}}return[];}function q(T){var i=o(T);return{filters:i.filters.concat(h(T),p(T)),search:i.search,bindingPath:i.bindingPath};}function w(T){return _(T).promise;}function r(T){var i=_(T);if(i.resolve){i.resolve(T);T.data("boundPromiseResolve",null);}}function _(T){if(!T.data("boundPromise")){var R;T.data("boundPromise",new Promise(function(i){R=i;}));if(T.isBound()){R(T);}else{T.data("boundPromiseResolve",R);}}return{promise:T.data("boundPromise"),resolve:T.data("boundPromiseResolve")};}function u(i,j,v){i.filters=v;if(j.search){i.parameters.$search=j.search;}else{i.parameters.$search=undefined;}}function G(v,T){var V=v.getView();var I=V.getBindingContext("internal");if(I){var E=D.getCustomData(T,"targetCollectionPath");if(E){var x=v.getOwnerComponent();var A=sap.ui.core.Component.getOwnerComponentFor(x);var y=A.getMetaModel();var S=C.getShellServices(A);var z=S.hrefForExternal();var H=D.getCustomData(T,"columns");var J=[];var K=[];var P,O,Q,R=[];var U;var W=[];if(z&&z.indexOf("?")!==-1){z=z.split("?")[0];}for(var i=0;i<H.customData.length;i++){O=H.customData[i].annotationPath;if(O){Q=y.getObject(O);if(Q&&Q.$kind==="Property"){P=H.customData[i].annotationPath;}else if(Q&&Q.$Type==="com.sap.vocabularies.UI.v1.DataField"){P=E+"/"+y.getObject(O+"/Value/$Path");}}if(P){if(!(y.getObject(P+"@com.sap.vocabularies.Common.v1.SemanticObject")===undefined)){if(R.indexOf(P)===-1){R.push(P);W.push(C.getSemanticObjectPromise(A,V,y,P));}}}P=undefined;}if(W.length===0){return Promise.resolve();}else{Promise.all(W).then(function(X){var Y=[],Z;var $=X.filter(function(a1){if(a1.semanticObject&&typeof a1.semanticObject.semanticObject==="object"){Z=B.compileBinding(B.bindingExpression(a1.semanticObject.semanticObject.$Path));a1.semanticObject.semanticObject=Z;a1.semanticObjectForGetLinks[0].semanticObject=Z;return true;}else if(a1){return a1.semanticObject!==undefined;}else{return false;}});for(var j=0;j<$.length;j++){U=$[j];if(U&&U.semanticObject&&!(U.semanticObject.semanticObject.indexOf("{")===0)){J.push(U.semanticObjectForGetLinks);K.push({semanticObject:U.semanticObject&&U.semanticObject.semanticObject,unavailableActions:U.unavailableActions,path:$[j].semanticObjectPath});Y.push(S.getLinksWithCache([U.semanticObjectForGetLinks]));}}return C.updateSemanticTargets(Y,K,I,z);}).catch(function(j){L.error("fnGetSemanticTargetsFromTable: Cannot get Semantic Objects",j);});}}}}function s(T){T.clearSelection();var i=T.getBindingContext("internal");if(i){i.setProperty("deleteEnabled",false);i.setProperty("numberOfSelectedContexts",0);i.setProperty("selectedContexts",[]);i.setProperty("deletableContexts",[]);}}var t={addEventToBindingInfo:k,getCountFormatted:n,getHiddenFilters:e,getFiltersInfoForSV:g,getTableFilters:h,getListBindingForCount:l,getFilterInfo:o,getP13nFilters:p,getAllFilterInfo:q,whenBound:w,onTableBound:r,getSemanticTargetsFromTable:G,updateBindingInfo:u,clearSelection:s};return t;});
