// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/isPlainObject","sap/base/util/ObjectPath","sap/base/util/extend","sap/ushell/ApplicationType","sap/ushell/Config","sap/ushell/navigationMode","sap/ushell/services/_ClientSideTargetResolution/Formatter","sap/ushell/services/_ClientSideTargetResolution/InboundIndex","sap/ushell/services/_ClientSideTargetResolution/InboundProvider","sap/ushell/services/_ClientSideTargetResolution/ParameterMapping","sap/ushell/services/_ClientSideTargetResolution/PrelaunchOperations","sap/ushell/services/_ClientSideTargetResolution/Search","sap/ushell/services/_ClientSideTargetResolution/StagedLogger","sap/ushell/services/_ClientSideTargetResolution/SystemContext","sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ushell/services/_ClientSideTargetResolution/VirtualInbounds","sap/ushell/services/_ClientSideTargetResolution/XAppStateProcessing","sap/ushell/services/AppConfiguration","sap/ushell/TechnicalParameters","sap/ushell/utils"],function(L,i,O,E,A,C,N,_,a,b,c,d,f,g,h,j,k,l,m,T,U){"use strict";function n(o,e,p,s){this._init.apply(this,arguments);}n.prototype._init=function(o,e,p,s){this._iLogId=0;if(!this._implementsServiceInterface(o)){L.error("Cannot get Inbounds","ClientSideTargetResolutionAdapter should implement getInbounds method","sap.ushell.services.ClientSideTargetResolution");return;}this._oInboundProvider=new b(o.getInbounds.bind(o));this._oHaveEasyAccessSystemsDeferreds={userMenu:null,sapMenu:null};this._oServiceConfiguration=s;this._oAdapter=o;sap.ushell.Container.getServiceAsync("URLParsing").then(function(q){this._oURLParsing=q;}.bind(this));};n.prototype._implementsServiceInterface=function(o){if(typeof o.getInbounds==="function"){return true;}return false;};n.prototype._getURLParsing=function(){if(!this._oURLParsing){L.error("ClientSideTargetResolution.js: sap.ushell.Container.getService() - sync call triggered.");this._oURLParsing=sap.ushell.Container.getService("URLParsing");}return this._oURLParsing;};n.prototype._extractInboundFilter=function(o){if(!this._oAdapter.hasSegmentedAccess){return undefined;}if(typeof o!=="string"){return undefined;}var F=o.indexOf("#")===0?o:"#"+o;var s=this._getURLParsing().parseShellHash(F);if(!s||!s.semanticObject||!s.action){return undefined;}return[{semanticObject:s.semanticObject,action:s.action}];};n.prototype.resolveHashFragment=function(H){var t=this,D=new jQuery.Deferred(),B=this._oAdapter.resolveHashFragmentFallback&&this._oAdapter.resolveHashFragmentFallback.bind(this._oAdapter),s=this._extractInboundFilter(H);this._oInboundProvider.getInbounds(s).then(function(I){t._resolveHashFragment(H,B,I).done(function(o){return D.resolve(o);}).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};n.prototype.resolveTileIntent=function(H){var t=this,D=new jQuery.Deferred(),s=this._extractInboundFilter(H);this._oInboundProvider.getInbounds(s).then(function(I){t._resolveTileIntent(H,undefined,I).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};n.prototype.resolveTileIntentInContext=function(I,H){var o,D=new jQuery.Deferred();o=a.createIndex(I.concat(k.getInbounds()));this._resolveTileIntent(H,undefined,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));return D.promise();};n.prototype._resolveHashFragment=function(H,B,I){var u=this._getURLParsing(),t=this,D=new jQuery.Deferred(),F=H.indexOf("#")===0?H:"#"+H,s=u.parseShellHash(F);if(s===undefined){L.error("Could not parse shell hash '"+H+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return D.reject().promise();}s.formFactor=U.getFormFactor();this._getMatchingInbounds(s,I,{bExcludeTileInbounds:true}).fail(function(e){L.error("Could not resolve "+H,"_getMatchingInbounds promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");D.reject(e);}).done(function(M){var e;if(M.length===0){L.warning("Could not resolve "+H,"rejecting promise","sap.ushell.services.ClientSideTargetResolution");D.reject("Could not resolve navigation target");return;}M=t._applySapNavigationScopeFilter(M,s);e=M[0];if(L.getLevel()>=L.Level.DEBUG){var p=function(K,v){return(this[K]===undefined)?"<undefined>":v;};var r=function(o,v){return(o==="_original")?undefined:p.call(this,o,v);};var q=JSON.stringify(e,r,"   ");L.debug("The following target will now be resolved",q,"sap.ushell.services.ClientSideTargetResolution");}t._resolveSingleMatchingTarget(e,B,F).done(function(o){D.resolve(o);}).fail(D.reject.bind(D));});return D.promise();};n.prototype._applySapNavigationScopeFilter=function(M,s){var S=s&&s.params&&s.params["sap-navigation-scope-filter"];if(!S){return M;}var F=M.filter(function(o){var e=O.get("inbound.signature.parameters",o);var p=e&&e["sap-navigation-scope"];if(p){return S[0]===p.defaultValue.value;}return undefined;});return F.length>0?F:M;};n.prototype._resolveSingleMatchingTarget=function(M,B,F){var t=this,D=new jQuery.Deferred(),u=this._getURLParsing(),I=u.parseShellHash(F),s=[I.semanticObject,I.action].join("-"),e=(M.inbound.resolutionResult||{}).applicationType;var o;if(this._oAdapter.resolveSystemAlias){o=this._oAdapter.resolveSystemAlias.bind(this._oAdapter);}var H=!!M.inbound.templateContext;var p=A.getEasyAccessMenuResolver(s,e);if(p&&!H){p(I,M,o,A.WDA.enableWdaCompatibilityMode).then(function(R){var q=N.compute(O.get("inbound.resolutionResult.applicationType",M),(M.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0],(M.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0],(m.getCurrentApplication()||{}).applicationType,C.last("/core/navigation/enableInPlaceForClassicUIs"));U.shallowMergeObject(R,q);R.inboundPermanentKey=M.inbound.permanentKey||M.inbound.id;D.resolve(R);},function(q){D.reject(q);});return D.promise();}var r=this._getReservedParameters(M);c.mapParameterNamesAndRemoveObjects(M);sap.ushell.Container.getServiceAsync("AppState").then(function(q){l.mixAppStateIntoResolutionResultAndRename(M,q).done(function(M){var R=function(){return t._constructFallbackResolutionResult.call(t,M,B,F);};if(A[e]){R=A[e].generateResolutionResult;}delete M.intentParamsPlusAllDefaults["sap-tag"];delete M.mappedIntentParamsPlusSimpleDefaults["sap-tag"];M.mappedDefaultedParamNames=M.mappedDefaultedParamNames.filter(function(P){return P!=="sap-tag";});var v=O.get("inbound.resolutionResult.url",M);d.executePrelaunchOperations(M,r["sap-prelaunch-operations"]).then(function(){return R(M,v,o);}).then(function(w){w.reservedParameters=r;w.inboundPermanentKey=M.inbound.permanentKey||M.inbound.id;return w;}).then(function(w){L.debug("Intent was resolved to the following target",JSON.stringify(M.resolutionResult,null,3),"sap.ushell.services.ClientSideTargetResolution");U.shallowMergeObject(M.resolutionResult,w);D.resolve(M.resolutionResult);},function(w){if(typeof w==="string"&&w.indexOf("fallback:")>=0){t._constructFallbackResolutionResult.call(this,M,B,F).then(function(x){U.shallowMergeObject(M.resolutionResult,x);D.resolve(M.resolutionResult);},D.reject.bind(D));}else{D.reject(w);}});});});return D.promise();};n.prototype._getReservedParameters=function(M){var r=T.getParameters({injectFrom:"startupParameter"}).map(function(p){return p.name;});var R=j.extractParameters(r,M.intentParamsPlusAllDefaults);T.getParameters({injectFrom:"inboundParameter"}).forEach(function(p){var P=p.name;var s=M.inbound&&M.inbound.signature&&M.inbound.signature.parameters;if(s&&Object.keys(s).length>0){var o=s[P];var I=o&&o.defaultValue&&o.defaultValue.hasOwnProperty("value");var e=o&&o.filter&&o.filter.hasOwnProperty("value");if(o&&(e||I)){if(I){R[P]=o.defaultValue.value;}else{R[P]=o.filter.value;}}else{delete R[P];}delete M.intentParamsPlusAllDefaults[P];var q=M.defaultedParamNames.indexOf(P);if(q>=0){M.defaultedParamNames.splice(q,1);}}});return R;};n.prototype._resolveTileIntent=function(H,B,I){var u=this._getURLParsing(),t=this,D=new jQuery.Deferred(),F=H.indexOf("#")===0?H:"#"+H,s=u.parseShellHash(F);if(s===undefined){L.error("Could not parse shell hash '"+H+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return D.reject("Cannot parse shell hash").promise();}s.formFactor=U.getFormFactor();this._getMatchingInbounds(s,I,{bExcludeTileInbounds:false}).fail(function(e){L.error("Could not resolve "+H,"_getMatchingInbounds promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");D.reject(e);}).done(function(M){var o;if(M.length===0){L.warning("Could not resolve "+H,"no matching targets were found","sap.ushell.services.ClientSideTargetResolution");D.reject("No matching targets found");return;}o=M[0];t._resolveSingleMatchingTileIntent(o,B,F).done(D.resolve.bind(D)).fail(D.reject.bind(D));});return D.promise();};n.prototype._resolveSingleMatchingTileIntent=function(M,B,F){var D=new jQuery.Deferred(),s=(M.inbound.resolutionResult||{}).applicationType,t=this;var e;if(this._oAdapter.resolveSystemAlias){e=this._oAdapter.resolveSystemAlias.bind(this._oAdapter);}c.mapParameterNamesAndRemoveObjects(M);sap.ushell.Container.getServiceAsync("AppState").then(function(o){l.mixAppStateIntoResolutionResultAndRename(M,o).done(function(M){var r=function(){return t._constructFallbackResolutionResult.call(t,M,B,F);};if(A[s]){r=A[s].generateResolutionResult;}delete M.intentParamsPlusAllDefaults["sap-tag"];delete M.mappedIntentParamsPlusSimpleDefaults["sap-tag"];M.mappedDefaultedParamNames=M.mappedDefaultedParamNames.filter(function(P){return P!=="sap-tag";});var p=O.get("inbound.resolutionResult.url",M);r(M,p,e).then(function(R){U.shallowMergeObject(M.resolutionResult,R);var q=E({},M.inbound.tileResolutionResult);q.startupParameters=M.effectiveParameters;q.navigationMode=M.resolutionResult.navigationMode;if(!q.navigationMode){q.navigationMode=N.getNavigationMode(M.resolutionResult);}D.resolve(q);L.debug("Tile Intent was resolved to the following target",JSON.stringify(q,null,3),"sap.ushell.services.ClientSideTargetResolution");},function(q){D.reject(q);});});});return D.promise();};n.prototype._constructFallbackResolutionResult=function(M,B,F){var e={},D;Object.keys(M.intentParamsPlusAllDefaults).forEach(function(p){if(Array.isArray(M.intentParamsPlusAllDefaults[p])){e[p]=M.intentParamsPlusAllDefaults[p];}});D=M.mappedDefaultedParamNames||M.defaultedParamNames;if(D.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(D)];}if(typeof B!=="function"){L.error("Cannot resolve hash fragment",F+" has matched an inbound that cannot be resolved client side and no resolveHashFragmentFallback method was implemented in ClientSideTargetResolutionAdapter","sap.ushell.services.ClientSideTargetResolution");return Promise.reject("Cannot resolve hash fragment: no fallback provided.");}L.warning("Cannot resolve hash fragment client side",F+" has matched an inbound that cannot be resolved client side. Using fallback logic","sap.ushell.services.ClientSideTargetResolution");return new Promise(function(r,R){B(F,E({},M.inbound),e).done(function(o){var p={};["applicationType","additionalInformation","url","applicationDependencies","text"].forEach(function(P){if(o.hasOwnProperty(P)){p[P]=o[P];}});r(p);}).fail(R.bind(null));});};n.prototype.getDistinctSemanticObjects=function(){var D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(I){var s={};I.getAllInbounds().forEach(function(o){if(typeof o.semanticObject==="string"&&o.semanticObject!=="*"&&!o.hideIntentLink&&o.semanticObject.length>0){s[o.semanticObject]=true;}});D.resolve(Object.keys(s).sort());},function(){D.reject.apply(D,arguments);});return D.promise();};n.prototype.getLinks=function(o){var e,t=this,s,p,I,D=new jQuery.Deferred(),q;if(arguments.length===1&&i(arguments[0])){e=arguments[0];q=E({},e);["action","semanticObject"].forEach(function(r){if(e.hasOwnProperty(r)){q[r]=e[r];}});if(q.appStateKey){q.params=q.params||{};q.params["sap-xapp-state"]=[q.appStateKey];delete q.appStateKey;}}else if(arguments.length<=3){L.warning("Passing positional arguments to getLinks is deprecated","Please use nominal arguments instead","sap.ushell.services.ClientSideTargetResolution");s=arguments[0];p=arguments[1];I=arguments[2];q={semanticObject:s,params:p,ignoreFormFactor:I};}else{return D.reject("invalid arguments for getLinks").promise();}this._oInboundProvider.getInbounds().then(function(r){t._getLinks(q,r).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};n.prototype._validateGetSemanticObjectLinksArgs=function(o){var s=o.semanticObject,e=o.action,I=!o.hasOwnProperty("action");if(typeof s!=="undefined"||I){if(typeof s!=="string"){L.error("invalid input for _getLinks","the semantic object must be a string, got "+Object.prototype.toString.call(s)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(I&&s.match(/^\s+$/)){L.error("invalid input for _getLinks","the semantic object must be a non-empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(!I&&s.length===0){L.error("invalid input for _getLinks","the semantic object must not be an empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}}if(typeof e!=="undefined"){if(typeof e!=="string"){L.error("invalid input for _getLinks","the action must be a string, got "+Object.prototype.toString.call(e)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}if(e.length===0){L.error("invalid input for _getLinks","the action must not be an empty string, got '"+e+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}}return undefined;};n.prototype._getLinks=function(o,I){var s=o.semanticObject,e=o.action,p=o.params,w=!!o.withAtLeastOneUsedParam,t=!!o.treatTechHintAsFilter,q=o.ignoreFormFactor,S=o.hasOwnProperty("sortResultsBy")?o.sortResultsBy:"intent";if(o.hasOwnProperty("sortResultOnTexts")){L.warning("the parameter 'sortResultOnTexts' was experimental and is no longer supported","getLinks results will be sorted by '"+S+"'","sap.ushell.services.ClientSideTargetResolution");}var r={bExcludeTileInbounds:true};var u=this._validateGetSemanticObjectLinksArgs(o);if(o.tags){r.tags=o.tags;}if(u){return new jQuery.Deferred().reject(u).promise();}if(s==="*"){return jQuery.when([]);}function v(x,P){var B=x.paramsToString(P);return B?"?"+B:"";}var x=this._getURLParsing(),D=new jQuery.Deferred(),F=U.getFormFactor(),y=x.parseParameters(v(x,p)),z={semanticObject:(s===""?undefined:s),action:e,formFactor:(q?undefined:F),params:y};if(t){z.treatTechHintAsFilter=true;}this._getMatchingInbounds(z,I,r).done(function(M){var B={},R=M.map(function(J){var K=s||J.inbound.semanticObject,P="#"+K+"-"+J.inbound.action,Q;if(K==="*"){return undefined;}if(J.inbound.action==="*"){return undefined;}if(J.inbound&&J.inbound.hasOwnProperty("hideIntentLink")&&J.inbound.hideIntentLink===true){return undefined;}if(!B.hasOwnProperty(P)){B[P]={matchingInbound:J.inbound,count:1};if(J.inbound.signature.additionalParameters==="ignored"){Q=j.filterObjectKeys(y,function(Z){return(Z.indexOf("sap-")===0)||J.inbound.signature.parameters.hasOwnProperty(Z);},false);}else{Q=y;}if(w){var V=Object.keys(Q).some(function(Z){return Z.indexOf("sap-")!==0;});if(!V){B[P].hideReason="getLinks called with 'withAtLeastOneUsedParam = true', but the inbound had no business parameters defined.";return undefined;}}var W=j.inboundSignatureMeetsParameterOptions(J.inbound.signature.parameters,o.paramsOptions||[]);if(!W){B[P].hideReason="inbound signature does not meet the requested parameter filter options";return undefined;}var X={intent:P+v(x,Q),text:J.inbound.title};if(J.inbound.icon){X.icon=J.inbound.icon;}if(J.inbound.subTitle){X.subTitle=J.inbound.subTitle;}if(J.inbound.shortTitle){X.shortTitle=J.inbound.shortTitle;}var Y=O.get("inbound.signature.parameters.sap-tag.defaultValue.value",J);if(Y){X.tags=[Y];}return X;}B[P].count++;return undefined;}).filter(function(J){return typeof J==="object";});if(S!=="priority"){R.sort(function(J,K){return J[S]<K[S]?-1:1;});}if(R.length===0){L.debug("_getLinks returned no results");}else if(L.getLevel()>=L.Level.DEBUG){if(L.getLevel()>=L.Level.TRACE){var G=[];var H=[];R.forEach(function(J){var K=J.intent.split("?")[0];if(B[K].hideReason){H.push(["-",K+"("+B[K].hideReason+")\n"," text:",J.text+"\n"," full intent:",J.intent].join(" "));}else{G.push(["-",K,B[K].count>1?"("+(B[K].count-1)+" others matched)\n":"\n","text:",J.text+"\n","full intent:",J.intent].join(" "));}});L.debug("_getLinks filtered to the following unique intents:","\n"+G.join("\n"),"sap.ushell.services.ClientSideTargetResolution");L.debug("_getLinks would have also returned the following unique intents, but something prevented this:",H.join("\n"),"sap.ushell.services.ClientSideTargetResolution");}else{L.debug("_getLinks filtered to unique intents.","Reporting histogram: \n - "+Object.keys(B).join("\n - "),"sap.ushell.services.ClientSideTargetResolution");}}D.resolve(R);}).fail(D.reject.bind(D));return D.promise();};n.prototype._getMatchingInbounds=function(s,I,o){var t=this,e,p,q,r,S,u,P,D=new jQuery.Deferred();if(o){e=o.tags;u=o.bExcludeTileInbounds;}if(L.getLevel()>=L.Level.DEBUG){q=++t._iLogId;}g.begin(function(){function v(M){var x=M.action||(typeof M.action==="undefined"?"<any>":"<invalid-value>");var y=M.semanticObject||(typeof M.semanticObject==="undefined"?"<any>":"<invalid-value>");return t._getURLParsing().constructShellHash({semanticObject:y,action:x,params:M.params});}var w=v(s);return{logId:q,title:"Matching Intent '"+w+"' to inbounds (form factor: "+(s.formFactor||"<any>")+")",moduleName:"sap.ushell.services.ClientSideTargetResolution",stages:["STAGE1: Find matching inbounds","STAGE2: Resolve references","STAGE3: Rematch with references","STAGE4: Sort matched targets"]};});S=s.semanticObject;p=s.action;this._oShellHash=s;r=e?I.getSegmentByTags(e):I.getSegment(S,p);if(u){P=r.filter(function(v){return!v.tileResolutionResult||!v.tileResolutionResult.isCustomTile;});}else{P=r;}var G=null;if(this._oAdapter.getContentProviderDataOriginsLookup){G=this._oAdapter.getContentProviderDataOriginsLookup.bind(this._oAdapter);}f.match(s,P,{},G,L.getLevel()>=L.Level.DEBUG).then(function(v){g.log(function(){return{logId:q,stage:1,prefix:"\u2718",lines:Object.keys(v.noMatchReasons||{}).map(function(y){return y+" "+v.noMatchReasons[y];})};});g.log(function(){var y=v.matchResults.map(function(z){return _.formatInbound(z.inbound);});return{logId:q,stage:1,prefix:y.length>0?"\u2705":"\u2718",lines:y.length>0?y:["No inbound was matched"]};});var M={};var w=false;var x=Object.keys(v.missingReferences);x.forEach(function(y){var z=Object.keys(v.missingReferences[y]);w=w||z.length>0;M[y]=z;});x=x.filter(function(y){if(M[y].length>0){return true;}delete M[y];return false;});if(!w){g.log(function(){return{logId:q,stage:2,prefix:"\u2705",line:"No need to resolve references"};});return new jQuery.Deferred().resolve({matchResults:v.matchResults,referencesToInclude:null}).promise();}x.forEach(function(y){g.log(function(){return{logId:q,stage:2,line:"@ Must resolve the following references with contentProviderId = \""+y+"\":",prefix:"\u2022",lines:M[y]};});});var R=new jQuery.Deferred();sap.ushell.Container.getServiceAsync("ReferenceResolver").then(function(y){var z=x.map(function(B){return this.getSystemContext(B);}.bind(this));return Promise.all(z).then(function(B){var F=x.map(function(H,J){return new Promise(function(K,Q){y.resolveReferences(M[H],B[J]).done(K).fail(Q);});});return Promise.all(F);});}.bind(this)).then(function(y){var z={matchResults:v.matchResults,referencesToInclude:{}};x.forEach(function(B,F){var H=y[F];z.referencesToInclude[B]=H;if(Object.keys(H).length>0){g.log(function(){return{logId:q,stage:2,line:"\u2705 resolved references with contentProviderId = \""+B+"\" to the following values:",prefix:"\u2022",lines:Object.keys(H).map(function(J){return J+": '"+H[J]+"'";})};});}});R.resolve(z);}).catch(function(y){g.log(function(){return{logId:q,stage:2,prefix:"\u274c",line:"Failed to resolve references: "+y};});D.resolve([]);});return R.promise();}.bind(this)).then(function(v){var M,w,R=v.referencesToInclude;if(!R){g.log(function(){return{logId:q,stage:3,line:"rematch was skipped (no references to resolve)",prefix:"\u2705"};});return new jQuery.Deferred().resolve(v).promise();}w=v.matchResults;M=w.map(function(x){return x.inbound;});return f.match(s,M,R,G,0).then(function(F){g.log(function(){var w=F.matchResults||[];if(w.length>=1){return{logId:q,stage:3,line:"The following inbounds re-matched:",lines:w.map(function(x){return _.formatInbound(x.inbound);}),prefix:"\u2705"};}return{logId:q,stage:3,line:"No inbounds re-matched",prefix:"-"};});return F;});}).then(function(F){var M=F.matchResults||[];if(M.length<=1){g.log(function(){return{logId:q,stage:4,line:"Nothing to sort"};});D.resolve(M);return;}var v=f.sortMatchingResultsDeterministic(F.matchResults||[]);g.log(function(){var w=v.map(function(x){return _.formatInbound(x.inbound||{})+(x.matchesVirtualInbound?" (virtual)":"")+"\n[ Sort Criteria ] "+"\n * 1 * sap-priority: '"+x["sap-priority"]+"'"+"\n * 2 * Sort string: '"+x.priorityString+"\n * 3 * Deterministic blob: '"+f.serializeMatchingResult(x)+"'";});return{logId:q,stage:4,line:"Sorted inbounds as follows:",lines:w,prefix:".",number:true};});D.resolve(v);});return D.promise().then(function(M){g.end(function(){return{logId:q};});return M;});};n.prototype._isIntentSupportedOne=function(I,o){var D=new jQuery.Deferred(),s=this._getURLParsing().parseShellHash(I);if(I==="#"){D.resolve(true);return D.promise();}if(s===undefined){return D.reject("Could not parse shell hash '"+I+"'").promise();}s.formFactor=U.getFormFactor();this._getMatchingInbounds(s,o,{bExcludeTileInbounds:true}).done(function(t){D.resolve(t.length>0);}).fail(function(){D.reject();});return D.promise();};n.prototype.isIntentSupported=function(I){var t=this,D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(o){t._isIntentSupported(I,o).done(D.resolve.bind(D)).fail(D.reject.bind(D));},function(){D.reject.apply(D,arguments);});return D.promise();};n.prototype._isIntentSupported=function(I,o){var t=this,D=new jQuery.Deferred(),s={};D.resolve();function e(p,S){s[p]={supported:S};}var r=[];I.forEach(function(p){var q=t._isIntentSupportedOne(p,o);q.fail(function(u){r.push(u);});q.done(function(u){e(p,u);});D=jQuery.when(D,q);});var R=new jQuery.Deferred();D.done(function(){R.resolve(s);}).fail(function(){R.reject("One or more input intents contain errors: "+r.join(", "));});return R.promise();};n.prototype.getUserDefaultParameterNames=function(s){var t=this,D=new jQuery.Deferred();this._oInboundProvider.getInbounds().then(function(I){t._getUserDefaultParameterNames(I.getAllInbounds(),s).then(function(r){D.resolve(r);},function(e){D.reject("Cannot get user default parameters from inbounds: "+e);});},function(){D.reject.apply(D,arguments);});return D.promise();};n.prototype._getUserDefaultParameterNames=function(I,s){var r={simple:{},extended:{}};I=I.filter(function(o){if(o.contentProviderId===undefined&&s.id===""){return true;}return o.contentProviderId===s.id;});return sap.ushell.Container.getServiceAsync("ReferenceResolver").then(function(R){I.forEach(function(t){var S=t.signature&&t.signature.parameters||[];Object.keys(S).forEach(function(p){var P=S[p],e,o,q;if(P){if(P.filter&&P.filter.format==="reference"){q=P.filter.value;}else if(P.defaultValue&&P.defaultValue.format==="reference"){q=P.defaultValue.value;}if(typeof q==="string"){e=R.extractUserDefaultReferenceName(q);if(typeof e==="string"){r.simple[e]={};}o=R.extractExtendedUserDefaultReferenceName(q);if(typeof o==="string"){r.extended[o]={};}}}});});return r;});};n.prototype.getEasyAccessSystems=function(M){var r={},o,v,D;M=M||"sapMenu";if(this._oHaveEasyAccessSystemsDeferreds[M]){return this._oHaveEasyAccessSystemsDeferreds[M].promise();}this._oHaveEasyAccessSystemsDeferreds[M]=new jQuery.Deferred();D=this._oHaveEasyAccessSystemsDeferreds[M];function e(I,s,v){if(!I){return false;}var p=[I.semanticObject,I.action].join("-");return v[M][p]&&I.deviceTypes&&s!==undefined&&I.deviceTypes[s];}o=A.getEasyAccessMenuDefinitions().reduce(function(R,p){var s=p.easyAccessMenu.intent.split("-")[1];R[s]={appType:p.type,priority:p.easyAccessMenu.systemSelectionPriority};return R;},{});v={userMenu:A.getEasyAccessMenuDefinitions().reduce(function(u,p){var s=p.easyAccessMenu.intent;u[s]=p.easyAccessMenu.showSystemSelectionInUserMenu;return u;},{}),sapMenu:A.getEasyAccessMenuDefinitions().reduce(function(s,p){var q=p.easyAccessMenu.intent;s[q]=p.easyAccessMenu.showSystemSelectionInSapMenu;return s;},{})};this._oInboundProvider.getInbounds().then(function(I){var p={};I.getAllInbounds().filter(function(q){return e(q,U.getFormFactor(),v);}).forEach(function(q){var s;if(i(q.signature.parameters["sap-system"])&&q.signature.parameters["sap-system"].hasOwnProperty("filter")){s=O.get("signature.parameters.sap-system.filter.value",q);}if(typeof s==="string"){var t=o[q.action].priority;var u=o[q.action].appType;if(!r[s]){p[s]=-1;r[s]={appType:{}};}if(p[s]<t){r[s].text=q.title;p[s]=t;}r[s].appType[u]=true;}else{L.warning("Cannot extract sap-system from easy access menu inbound: "+_.formatInbound(q),"This parameter is supposed to be a string. Got '"+s+"' instead.","sap.ushell.services.ClientSideTargetResolution");}});D.resolve(r);},function(){D.reject.apply(D,arguments);});return D.promise();};n.prototype.getSystemContext=function(s){var S=s===undefined?"":s;return new Promise(function(r,e){var o;this._oAdapter.resolveSystemAlias(S).done(function(R){o=h.createSystemContextFromSystemAlias(R);r(o);}).fail(function(p){e(p);});}.bind(this));};n.hasNoAdapter=false;return n;},true);
