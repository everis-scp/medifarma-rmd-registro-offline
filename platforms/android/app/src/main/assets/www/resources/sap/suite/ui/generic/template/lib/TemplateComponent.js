sap.ui.define(["sap/ui/core/CustomizingConfiguration","sap/ui/core/library","sap/ui/core/Component","sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/Device","sap/suite/ui/generic/template/lib/reuseComponentHelper","sap/ui/core/CustomData","sap/suite/ui/generic/template/lib/StableIdDefinition","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/js/AnnotationHelper","sap/base/util/extend","sap/base/util/deepExtend","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/FeError"],function(C,c,a,U,J,R,D,r,b,S,d,F,A,e,f,g,h){"use strict";var s="lib.TemplateComponent";var l=new F(s).getLogger();var V=c.mvc.ViewType;function j(O){var i=O&&typeof O==="string"?O:(O&&a.getOwnerIdFor(O));var z=i&&a.get(i);if(z instanceof T){z=z.getAppComponent();}return z;}var G=C.getViewExtension;C.getViewExtension=function(i,z,O){var B=j(O),H=B&&B.getId(),I=G.call(C,i,z,H);return I;};var k=C.getControllerExtension;C.getControllerExtension=function(i,O){var z=j(O),B=z&&z.getId(),H=k.call(C,i,B);return H;};function E(z){var I=new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"});var B=[];var M=z.getAppComponent().getModel("i18n|"+z.getMetadata().getComponentName()+"|"+z.getEntitySet());if(M){B.push(M);}var H=z.getModel("i18n");if(H){B.push(H);}var K=z.getModel("@i18n");if(K){B.push(K);}var L=true;for(var N="i18n";L;){N=N+"||Parent";L=z.getModel(N);if(L){B.push(L);}}for(var i=B.length-1;i>=0;i--){I.enhance(B[i].getResourceBundle());}z.setModel(I,"i18n");}function m(i,M){var z=i.getAppComponent().getManifestEntry("sap.ui5");var B=z.extends&&z.extends.extensions&&z.extends.extensions["sap.ui.controllerExtensions"];var H=i.getTemplateName();var I=B&&B[H]&&B[H]["sap.ui.generic.app"];var K=i.getEntitySet();var L=I&&I[K]&&I[K].Actions;var N={};var O=n(i);if(L){if(O){o(N,L,O);}else{p(N,L);}}else{var Q=I&&I[K]&&I[K]["Sections"];for(var W in Q){L=Q[W]["Actions"];if(L){p(N,L);}}}i.getModel("_templPriv").setProperty("/generic/listCommons/breakoutActionsEnabled",N);}function n(i){var z;var B=i.getAppComponent().getConfig();var H=B&&B.pages[0]&&B.pages[0].component&&B.pages[0].component.settings;if(H&&H.quickVariantSelectionX){z=H.quickVariantSelectionX.variants;}return z;}function o(B,z,H){var I;for(var K in z){I=true;if(z[K].requiresSelection){I=false;}for(var i in H){var L=z[K].id;var M=H[i];var N=A.getSuffixFromIconTabFilterKey(M);if(N){L=L.concat(N);}B[L]={enabled:I};}}}function p(B,i){var z;for(var H in i){z=true;if(i[H].requiresSelection){z=false;}B[i[H].id]={enabled:z};}}function q(i){if(i.getAppComponent().getMetadata().getComponentName()===""||i.getTemplateName()===""||i.getEntitySet()===""){}return i.getAppComponent().getMetadata().getComponentName()+"::"+i.getTemplateName()+"::"+i.getEntitySet();}function t(i,z){if(i.level===0){return[];}var B=z[i.parentRoute];var H=t(B,z);H.push(B);return H;}function u(i,z,M,B){var H=z.oComponent;var I=z.oAppComponent;var K=z.oTemplateContract.mRoutingTree[z.route];var L=H.getEntitySet();var N=z.utils.isDraftEnabled();var O=I.getTransactionController().getDraftController();var Q=O.getDraftContext();var W=I.getModel();var X=function(L){return Q.isDraftEnabled(L);};var Y=e({},K.page.component.settings);delete Y.appComponent;delete Y.entitySet;delete Y.navigationProperty;Y.subPages=K.page.pages;Y.routeConfig=z.routeConfig;return new J({entitySet:L,entityType:i,treeNode:K,treeNodeAncestors:t(K,z.oTemplateContract.mRoutingTree),routingSpec:z.routingSpec,"sap-ui-debug":window["sap-ui-debug"],isDraftEnabled:N,checkIsDraftEnabled:X,settings:Y,manifest:I.getInternalManifest(),metaModel:M,templateSpecific:B&&B(M,Y,D,L,Q,W),appComponentName:I.getMetadata().getComponentName(),stableId:{definition:S,aParameter:[],getStableId:d.getStableId},variables:[]});}function v(i,z){var B=i.oComponent,H=i.createViewController,I=i.methods&&i.methods.getTemplateSpecificParameters,M=i.oAppComponent.getModel(),K,L,N,O,Q,W=i.routingSpec&&i.routingSpec.noOData;if(W){K=new J({entitySet:{},entityType:{}});O=K.createBindingContext("/entitySet");Q=K.createBindingContext("/entityType");}else{K=M&&M.getMetaModel();L=M&&B.getEntitySet();var X=L&&K.getODataEntitySet(L);N=X&&X.entityType;if(!N){return{loaded:function(){return Promise.reject(new h(s,"Unknown entityset "+L));}};}O=K.createBindingContext(K.getODataEntitySet(L,true));Q=K.createBindingContext(K.getODataEntityType(N,true));}E(B);m(B,M);var Y=q(B);var Z=sap.ui.getCore().byId(Y);if(Z){l.warning("View with ID: "+Y+" already exists - old view is getting destroyed now!");try{Z.destroy();}catch($){l.warning("Error destroying view: "+$);}Z=null;}var _=new J(D);_.setDefaultBindingMode("OneWay");i.oParameterModel=u(N,i,K,I);B.runAsOwner(function(){var a1=i.preprocessorsData;var b1={async:true,preprocessors:{xml:{bindingContexts:{entitySet:O,entityType:Q},models:{device:_,appSettings:i.oTemplateContract.appSettings,entitySet:K,entityType:K,parameter:i.oParameterModel},preprocessorsData:a1}},id:Y,type:V.XML,viewName:B.getTemplateName(),height:"100%",cache:{keys:z,additionalData:[a1]}};if(B.getDesigntimePath||B.getFlexibilityPath){var c1={key:"sap-ui-custom-settings",value:{}};if(B.getDesigntimePath){c1.value["sap.ui.dt"]={"designtime":B.getDesigntimePath()};}if(B.getFlexibilityPath){c1.value["sap.ui.fl"]={"flexibility":B.getFlexibilityPath()};}b1.customData=[new b(c1)];}b1.controller=H();Z=sap.ui.view(b1);});return Z;}function w(i,z,B){var H=i.oController.extensionAPI;var I=e({},H);if(H.getNavigationController){var N=e({},H.getNavigationController());var K=N.navigateInternal;N.navigateInternal=function(L,M){var O=M&&M.routeName;if(O){i.utils.navigateRoute(O,L,z,M&&M.replaceInHistory);}else{K(L,M);}};I.getNavigationController=function(){return N;};}I.getCommunicationObject=function(L){return L===1?B.communicationObject:i.utils.getCommunicationObject(L);};(i.methods.enhanceExtensionAPI4Reuse||Function.prototype)(I,B);return I;}function P(i,z,B,H,I){H.extensionAPI=w(i,B,H);r.transferEmbeddedComponentProxy(i,z,B,H,I);var K=i.oController.byId(H.containerId);var L=K&&K.getSettings();var M=I.getMetadata().getAllProperties();for(var N in L){if((N==="uiMode"||N==="semanticObject"||N.startsWith("st"))&&!M[N]){delete L[N];}}I.applySettings(L);K.setComponent(I);}function x(i,z,B){return B.componentUsage?i.createComponent({usage:B.componentUsage,id:z}):i.runAsOwner(function(){return a.create({name:B.componentName,id:z});});}function y(i){var z=i.oTemplateContract.mRoutingTree[i.route];i.reuseComponentsReady=new Promise(function(B,H){var I=Object.create(null);var K=B.bind(null,I);var L=function(M,N){l.error("Failed to load reuse component for key "+M,N instanceof Error?N.message:"","sap.suite.ui.generic.template.lib.TemplateComponent");};i.viewRegistered.then(function(){var M=[];for(var N in z.embeddedComponents){var O=z.embeddedComponents[N];var Q=O.sectionId&&i.oController.byId(O.sectionId);if(Q&&Q.isStashed()){delete z.embeddedComponents[N];}else{var W=i.oController.createId(O.containerId+"Content");var X=x(i.oAppComponent,W,O);M.push(X);X.catch(L.bind(null,N));X.then(P.bind(null,i,I,N,O));}}Promise.all(M).then(K,function(Y){var Z=i.oAppComponent.getNavigationController();Z.navigateToMessagePage({text:i.oTemplateContract.getText("ST_ERROR"),description:Y instanceof Error?Y.message:""});H();});});});z.willBeDisplayed.then(i.oTemplateContract.oBusyHelper.setBusy.bind(null,i.reuseComponentsReady));}var T=U.extend("sap.suite.ui.generic.template.lib.TemplateComponent",{metadata:{properties:{templateName:{type:"string",defaultValue:null},entitySet:{type:"string",defaultValue:null},navigationProperty:{type:"string",defaultValue:null},appComponent:{type:"object",defaultValue:null},isRefreshRequired:{type:"boolean",defaultValue:false},isLeaf:{type:"boolean"}},library:"sap.suite.ui.generic.template"},init:function(){(U.prototype.init||Function.prototype).apply(this);var i=new J({editable:false,enabled:false});this.setModel(i,"ui");var z=this.getComponentData();var B=z.registryEntry;var H=B.oTemplateContract.mRoutingTree[B.route];var I=Object.create(null);for(var K in H.embeddedComponents){I[K]={hidden:!!H.embeddedComponents[K].definition.hiddenByDefault};}var L=new J({generic:{isActive:false,listCommons:{},viewLevel:B.viewLevel,controlProperties:{},supportedIntents:{},embeddedComponents:I}});L.setDefaultBindingMode("TwoWay");this.setModel(L,"_templPriv");y(B);},getExtensionComponent:function(){return this.getAppComponent();},getManifestEntry:function(K){var i=U.prototype.getManifestEntry.apply(this,arguments);if(/^\/sap\.ui5\/componentUsages(\/.+)?$/.test(K)){i=f({},i,U.prototype.getManifestEntry.apply(this.getAppComponent(),arguments));}return i;},getComponentContainer:function(){return this.oContainer;},onBeforeRendering:function(i){if(i){var z=i.oComponent.getComponentContainer();var B=i.oAppComponent;var M=!i.createViewStarted&&z&&z.getModel();if(M){var H=g.getCacheKeyPartsAsyc(M);i.createViewStarted=true;v(i,H).loaded().then(function(I){if(i.utils.isDraftEnabled()){var K=i.utils.getRootExpand();if(K){var L=i.oComponent.getEntitySet();g.writeToLocalStorageAsync(B.getId(),L,H,K);}}i.oComponent.setAggregation("rootControl",I);i.fnViewRegisteredResolve();z.invalidate();},function(I){i.fnViewRegisteredResolve(I||{});});}}},getRouter:function(){if(this.getAppComponent()){return this.getAppComponent().getRouter();}return U.prototype.getRouter.apply(this,arguments);}});return T;});
