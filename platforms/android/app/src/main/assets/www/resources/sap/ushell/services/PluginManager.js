// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_PluginManager/Extensions","sap/base/Log","sap/ushell/EventHub","sap/ui/thirdparty/jquery","sap/base/util/UriParameters","sap/ushell/utils","sap/ushell/components/applicationIntegration/application/PostMessageAPIInterface","sap/ushell/library"],function(g,L,E,q,U,u,P,a){"use strict";var S="sap.ushell.services.PluginManager",b="sap-ushell-plugin-type",c="RendererExtensions",d="sap.ushell.components.shell.defaults",s=[c,"UserDefaults","UserImage","ContentProvider","AppWarmup"],f=a.UI5ComponentType;function h(C,p,o){var t=this,i=[],j=false,l;this._oPluginCollection={};this._oCategoryLoadingProgress={};this._mInitializedComponentPromise={};this._sPluginAgentsNames="";this._oConfig=(o&&o.config)||{};if(this._oConfig.isBlueBox===undefined){this._oConfig.isBlueBox=false;}s.forEach(function(e){t._oPluginCollection[e]={};t._oCategoryLoadingProgress[e]=new q.Deferred();});this._handlePluginCreation=function(e,k,m,n){var t=this,r=(t._oPluginCollection[e])[k];u.setPerformanceMark("FLP -- PluginManager.loadPlugin["+e+"]["+k+"]");try{if(r.hasOwnProperty("component")){if(t._mInitializedComponentPromise.hasOwnProperty(r.component)){t._mInitializedComponentPromise[r.component].then(function(){t._instantiateComponent(r,m,n);},function(){t._instantiateComponent(r,m,n);});}else{t._mInitializedComponentPromise[r.component]=t._instantiateComponent(r,m,n);}}else{L.error("Invalid plugin configuration. The plugin "+k+" must contain a <component> key",S);}}catch(v){L.error("Error while loading bootstrap plugin: "+r.component||"",S);if(m){m.reject(v);}}};this._getFileNameForXhrAuth=function(){return"Component-preload.js";};this._handleXhrAuthentication=function(A,e){var x;if(A&&["true",true,"X"].indexOf(A["sap-ushell-xhr-authentication"])>-1){if(!e){L.error(["Illegal state: configuration parameter 'sap-ushell-xhr-authentication-timeout' set, but no component URL specified.","XHR authentication request will not be sent. Please check the target mapping definitions for plug-ins","and the application index."].join(" "),undefined,S);return q.when();}if(A.hasOwnProperty("sap-ushell-xhr-authentication-timeout")){x=parseInt(A["sap-ushell-xhr-authentication-timeout"],10);if(isNaN(x)){L.error(["Invalid value for configuration parameter 'sap-ushell-xhr-authentication-timeout' for plug-in component with URL '",e,"': '",A["sap-ushell-xhr-authentication-timeout"],"' is not a number. Timeout will be ignored."].join(""),undefined,S);}else{sap.ushell.Container.setXhrLogonTimeout(e,x);}}return q.ajax(e+"/"+this._getFileNameForXhrAuth());}return q.when();};this._instantiateComponent=function(e,k,m){var D=new q.Deferred(),n=JSON.parse(JSON.stringify(e)),A={ui5ComponentName:n.component,url:n.url,getExtensions:g.bind(null,e.component)};function r(v){return function(w){v=v||"Cannot create UI5 plugin component: (componentId/appdescrId :"+A.ui5ComponentName+")\n"+w+" properties "+JSON.stringify(A)+"\n This indicates a plugin misconfiguration, see e.g. Note 2316443.";w=w||"";L.error(v,w.stack,S);if(k){k.reject.apply(this,arguments);}D.reject.apply(this,arguments);};}n.name=n.component;delete n.component;A.applicationDependencies=n;if(n.config){A.applicationConfiguration=n.config;delete n.config;}A.loadDefaultDependencies=false;if(m!==undefined){A.oPostMessageInterface=m;}sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(v){this._handleXhrAuthentication(A.applicationConfiguration,n.url).done(function(){v.createComponent(A,{},[],f.Plugin).done(function(w){if(e.config&&e.config["sap-component-agents"]){i.push({componentName:e.component,url:e.url,agents:e.config["sap-component-agents"],pluginComp:w});}if(k){k.resolve(w);}D.resolve.apply(this,arguments);}).fail(r());}).fail(r("XHR logon for FLP plugin failed"));}.bind(this)).catch(r());return D.promise();};this.getSupportedPluginCategories=function(){return JSON.parse(JSON.stringify(s));};this.getRegisteredPlugins=function(){return JSON.parse(JSON.stringify(this._oPluginCollection));};this.registerPlugins=function(k){var t=this,m,n,r,v=[],w,x;if(!k){return;}if(this._oConfig.isBlueBox===true){w=new U(window.location.href).get("sap-plugins");if(w&&w.length>0){w=","+w+",";}else{w=undefined;}}else{E.emit("pluginConfiguration",k);}Object.keys(k).sort().forEach(function(y){m=k[y]||{};n=m.config||{};r=n[b]||"";if(m.enabled===false){return;}if(!t._isFormFactorSupported(m)){L.info("Plugin '"+y+"' filtered from result: form factor not supported");return;}if(t._oConfig.isBlueBox===true){if(m.config&&m.config["sap-plugin-agent"]===true){x=(m.config["sap-plugin-agent-id"]||y);if(!t.isPluginAgentSupported(x)){if(w){if(w.indexOf(","+x+",")<0){return;}}else{return;}}}}if(m.enabled===undefined){m.enabled=true;}if(m.hasOwnProperty("module")){L.error("Plugin "+y+" cannot get registered, because the module mechanism for plugins is not valid anymore. Plugins need to be defined as SAPUI5 components.",S);q.sap.require(m.module);return;}if(n&&n.hasOwnProperty(b)){if(s&&Array.prototype.indexOf.call(s,r)!==-1){if(v.indexOf(r)===-1){v.push(r);}t._oPluginCollection[r][y]=JSON.parse(JSON.stringify(m));}else{L.warning("Plugin "+y+" will not be inserted into the plugin collection of the PluginManager, because of unsupported category "+r,S);}}else{t._oPluginCollection[c][y]=JSON.parse(JSON.stringify(m));if(v.indexOf(c)===-1){v.push(c);}}});try{if(t._oConfig.isBlueBox!==true){t._buildNamesOfPluginsWithAgents();}}catch(e){L.error("failed to build plugin agents names list",(e.message||e.toString()),"sap.ushell.services.PluginManager");}v.forEach(function(y){if(t._oCategoryLoadingProgress.hasOwnProperty(y)&&t._oCategoryLoadingProgress[y].state()==="resolved"){t.loadPlugins(y);}});};this._isFormFactorSupported=function(e){var D=e.deviceTypes,k=u.getFormFactor();if(D&&D[k]===false){return false;}return true;};this.getPluginLoadingPromise=function(e){if(this._oCategoryLoadingProgress.hasOwnProperty(e)){return this._oCategoryLoadingProgress[e].promise();}};this.registerAgentLifeCycleManager=function(e){l=e;if(j){l(i);}};this.loadPlugins=function(e){var t=this,k,m,n,r;u.setPerformanceMark("FLP -- PluginManager.startLoadPlugins["+e+"]");if(e===c){r=P.getInterface();}if(s&&Array.prototype.indexOf.call(s,e)!==-1){if(t._oCategoryLoadingProgress[e].pluginLoadingTriggered===undefined){t._oCategoryLoadingProgress[e].pluginLoadingTriggered=true;}if(Object.keys(t._oPluginCollection[e]).length>0){k=[];n=Object.keys(t._oPluginCollection[e]);if(new U(window.location.href).get("sap-ushell-xx-pluginmode")==="discard"&&(e==="RendererExtensions"||e==="AppWarmup")){n=n.filter(function(I){return(t._oPluginCollection[e][I].component===d);});}n.forEach(function(v){var w=t._oPluginCollection[e][v];if(!w.loaded){w.loaded=true;m=new q.Deferred();k.push(m.promise());t._handlePluginCreation(e,v,m,r);}});if(k.length>0){q.when.apply(undefined,k).done(function(){u.setPerformanceMark("FLP -- PluginManager.endLoadPlugins["+e+"]");if(l){l(i);}j=true;t._oCategoryLoadingProgress[e].resolve();}).fail(t._oCategoryLoadingProgress[e].reject.bind());}}else{t._oCategoryLoadingProgress[e].resolve();}}else{L.error("Plugins with category "+e+" cannot be loaded by the PluginManager",S);t._oCategoryLoadingProgress[e].reject("Plugins with category "+e+" cannot be loaded by the PluginManager");}return t._oCategoryLoadingProgress[e].promise();};this._buildNamesOfPluginsWithAgents=function(){var t=this,n="",e;Object.keys(t._oPluginCollection).forEach(function(k){Object.keys(t._oPluginCollection[k]).forEach(function(m){e=t._oPluginCollection[k][m];if(e&&e.enabled&&e.enabled===true){if(e.config&&e.config["sap-plugin-agent"]===true){n+=(e.config["sap-plugin-agent-id"]||m)+",";}}});});if(n.endsWith(",")){n=n.slice(0,-1);}this._sPluginAgentsNames=n;};this._getNamesOfPluginsWithAgents=function(){return this._sPluginAgentsNames;};}h.hasNoAdapter=true;return h;},true);
