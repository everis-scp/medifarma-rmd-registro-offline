/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/macros/table/Utils","sap/fe/core/CommonUtils","sap/fe/core/helpers/ModelHelper","sap/fe/macros/DelegateUtil","sap/ui/model/Filter","sap/base/Log","sap/ui/mdc/odata/v4/TypeUtil","sap/fe/macros/FilterBarDelegate","sap/fe/core/helpers/ExcelFormatHelper","sap/fe/macros/table/TableHelper","sap/fe/macros/ResourceModel","sap/base/util/deepClone","sap/ui/mdc/odata/v4/TableDelegate"],function(J,C,T,a,M,D,F,L,b,c,E,d,R,e,f){"use strict";var g="sap_fe_TableDelegate_propertyInfoMap";var h=a.FilterRestrictions;function _(p){return p&&p.metadataPath.includes("@com.sap.vocabularies.UI.v1.LineItem");}function i(t,k,u){if(t instanceof window.Element){return;}var l=u?g+"_add":g;D.setCustomData(t,l,k);}function j(t,u){if(t instanceof window.Element){return null;}var k=u?g+"_add":g;return D.getCustomData(t,k);}var O=Object.assign({},f,{getColumnsFor:function(t){return C.parseCustomData(D.getCustomData(t,"columns"));},_getAggregatedPropertyMap:function(t){return C.parseCustomData(D.getCustomData(t,"aggregates")||{});},_fetchPropertyInfo:function(m,o,t,A,u){var s=o.annotationPath,k=m.getObject(o.annotationPath),n=m.createBindingContext(s),v=a.getPropertyDataType(n),l=!!o.propertyInfos&&o.propertyInfos.length>1,p=this._getExportDataType(v,l),q=v&&v==="Edm.Date"?E.getExcelDatefromJSDate():undefined,r=v&&v==="Edm.DateTimeOffset"?E.getExcelDateTimefromJSDateTime():undefined,w=v&&v==="Edm.TimeOfDay"?E.getExcelTimefromJSTime():undefined,x=q?"YYYY-MM-DD":undefined,y=null,z=C.isPropertyFilterable(o.relativePath,{context:n},k),B=v&&v.indexOf("Edm.")!==0,G=D.isTypeFilterable(v)?b.getTypeConfig(v):undefined,H=o.isDataPointFakeTargetProperty?R.getText("TargetValue"):D.getLocalizedText(o.label,A||t),I=D.getCustomData(t,"enableAnalytics")==="true",K=I?this._getAggregatedPropertyMap(t):{},N=n.getObject()||{},P={type:p,inputFormat:x,format:q||r||w,scale:N.$Scale||(N.Value&&n.getProperty("Value/$Path/$Scale")),delimiter:v&&v==="Edm.Int64"?true:false,trueValue:v&&v==="Edm.Boolean"?"Yes":undefined,falseValue:v&&v==="Edm.Boolean"?"No":undefined};if(o.exportSettings&&o.exportSettings.template){P.template=o.exportSettings.template;}if(o.exportSettings&&o.exportSettings.label){var Q=o.exportSettings.label?D.getLocalizedText(o.exportSettings.label,t):undefined;if(Q!==undefined&&!sap.ui.getCore().getConfiguration().getRTL()){H=Q+" - "+H;}else{H=H+" - "+Q;}}var S={name:o.name,metadataPath:s,groupLabel:o.groupLabel,group:o.group,label:H,description:y||H,maxLength:n.$MaxLength,precision:n.$Precision,scale:n.$Scale,type:v,typeConfig:G,visible:o.availability!=="Hidden"&&!B,exportSettings:P,unit:o.unit};if(o.propertyInfos&&o.propertyInfos.length){S.propertyInfos=o.propertyInfos;S.exportSettings.wrap=o.exportSettings.wrap;if(u&&o.additionalPropertyInfos&&o.additionalPropertyInfos.length){S.propertyInfos=S.propertyInfos.concat(o.additionalPropertyInfos);}}else{S.path=o.relativePath;S.sortable=o.sortable&&!o.relativePath.includes("/");S.filterable=!o.isDataPointFakeTargetProperty&&z&&!o.relativePath.includes("/")&&(!I||!K[S.name]);S.key=o.isKey;S.groupable=o.isGroupable;S.text=o.textArrangement&&o.textArrangement.textProperty;}return S;},_getExportDataType:function(s,k){var l;if(k){l="String";}else if(s){switch(s){case"Edm.Decimal":case"Edm.Int32":case"Edm.Int64":case"Edm.Double":case"Edm.Byte":l="Number";break;case"Edm.DateOfTime":case"Edm.Date":l="Date";break;case"Edm.DateTimeOffset":l="DateTime";break;case"Edm.TimeOfDay":l="Time";break;case"Edm.Boolean":l="Boolean";break;default:l="String";}}return l;},_fetchCustomPropertyInfo:function(o,t,A){var l=D.getLocalizedText(o.header,A||t);var p={name:o.name,groupLabel:null,group:null,label:l,description:l,maxLength:undefined,precision:undefined,scale:undefined,type:"Edm.String",visible:o.availability!=="Hidden",exportSettings:{template:o.exportSettings.template}};if(o.propertyInfos&&o.propertyInfos.length){p.propertyInfos=o.propertyInfos;p.exportSettings.wrap=o.exportSettings.wrap;}else{p.path=o.name;p.sortable=false;p.filterable=false;}return p;},_fetchPropertiesForEntity:function(t,s,m,A,u){var B=M.getEntitySetPath(s),k=[],o=a.getFilterRestrictionsByPath(B,m),n=o[h.NON_FILTERABLE_PROPERTIES],l=o[h.ALLOWED_EXPRESSIONS],p=this;return Promise.resolve(p.getColumnsFor(t)).then(function(q){if(!q){return Promise.resolve([]);}var P;q.forEach(function(r){switch(r.type){case"Annotation":P=p._fetchPropertyInfo(m,r,t,A,u);if(P&&n.indexOf(P.name)===-1){if(l[P.name]){P.filterExpression=a.getSpecificAllowedExpression(l[P.name]);}else{P.filterExpression="auto";}P.maxConditions=D.isMultiValue(P)?-1:1;}break;case"Slot":case"Default":P=p._fetchCustomPropertyInfo(r,t,A);break;default:throw new Error("unhandled switch case "+r.type);}k.push(P);});k.forEach(function(P){var U=P.path&&P.exportSettings?P.exportSettings.unitProperty:undefined;if(U){var r=k.find(function(v){return v.path===U;});if(r){P.unit=r.name;}}});return k;});},_getCachedOrFetchPropertiesForEntity:function(t,s,m,A,u){var k=j(t,u);if(k){return Promise.resolve(k);}return this._fetchPropertiesForEntity(t,s,m,A,u).then(function(k){i(t,k,u);return k;});},_setTableNoDataText:function(t,B){var n="",o=T.getAllFilterInfo(t),s=B.path.substr(1);var k=function(){if(t.data("hiddenFilters")||t.data("quickFilterKey")){return"M_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER_MULTI_VIEW";}else{return"T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}};if(t.getFilter()){if(o.search||(o.filters&&o.filters.length)){n=k();}else{n="T_OP_TABLE_AND_CHART_NO_DATA_TEXT";}}else{if(o.search||(o.filters&&o.filters.length)){n=k();}else{n="M_OP_TABLE_AND_CHART_OP_NO_FILTERS_NO_DATA_TEXT";}}if(n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"||n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT"){return t.getModel("sap.fe.i18n").getResourceBundle().then(function(r){t.setNoDataText(a.getTranslatedText(n,r,null,s));}).catch(function(l){L.error(l);});}else{if(R){t.setNoDataText(R.getText(n));}}},handleTableDataReceived:function(t,I){var B=t&&t.getRowBinding(),k=I.getProperty("dataReceivedAttached");if(!k){B.attachDataReceived(function(){d.handleTableDeleteEnablementForSideEffects(t,I);I.setProperty("selectedContexts",[]);var s=t.getSelectedContexts();I.setProperty("selectedContexts",s);I.setProperty("numberOfSelectedContexts",s.length);});I.setProperty("dataReceivedAttached",true);}},rebindTable:function(t,B){if(!t.data("tableHidden")){T.clearSelection(t);f.rebindTable.apply(this,[t,B]);T.onTableBound(t);this._setTableNoDataText(t,B);T.whenBound(t).then(this.handleTableDataReceived(t,t.getBindingContext("internal"))).catch(function(o){L.error("Error while waiting for the table to be bound",o);});}},fetchProperties:function(t){var k=this;return D.fetchModel(t).then(function(m){if(!m){return[];}return k._getCachedOrFetchPropertiesForEntity(t,D.getCustomData(t,"entityType"),m.getMetaModel());});},updateBindingInfo:function(t,m,B){f.updateBindingInfo.apply(this,[t,m,B]);if(!t.data("tableHidden")){this._internalUpdateBindingInfo(t,m,B);this._setTableNoDataText(t,B);}},_internalUpdateBindingInfo:function(t,m,B){Object.assign(B,e(D.getCustomData(t,"rowsBindingInfo")));if(t.getRowBinding()){B.suspended=false;}var o;var k=T.getAllFilterInfo(t);if(k.filters.length>0){o=new F({filters:k.filters,and:true});}if(k.bindingPath){B.path=k.bindingPath;}T.updateBindingInfo(B,k,o);},_templateCustomColumnFragment:function(o,v,m){var k=new J(o),p={bindingContexts:{"column":k.createBindingContext("/")},models:{"column":k}};return D.templateControlFragment("sap.fe.macros.table.CustomColumn",p,{view:v},m).then(function(I){k.destroy();return I;});},_getVHRelevantFields:function(m,s,B){var k=[],o=m.getObject(s),t=this;if(o.$kind&&o.$kind==="Property"){o=m.getObject(s+"@com.sap.vocabularies.UI.v1.DataFieldDefault");s=s+"@com.sap.vocabularies.UI.v1.DataFieldDefault";}switch(o.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":if(m.getObject(s+"/Target/$AnnotationPath").includes("com.sap.vocabularies.UI.v1.FieldGroup")){m.getObject(s+"/Target/$AnnotationPath/Data").forEach(function(v,I){k=k.concat(t._getVHRelevantFields(m,s+"/Target/$AnnotationPath/Data/"+I));});}break;case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataField":k.push(m.getObject(s+"/Value/$Path"));break;case"com.sap.vocabularies.UI.v1.DataFieldForAction":case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":break;default:if(s.indexOf(B)===0){k.push(s.substring(B.length+1));break;}k.push(C.getNavigationPath(s,true));break;}return k;},removeItem:function(p,t,P){var k=true;var m=P.modifier;var s=m.getProperty(p,"dataProperty");if(s.indexOf("InlineXML")!==-1){m.insertAggregation(t,"dependents",p);k=false;}return Promise.resolve(k);},addItem:function(p,t,P){var m=P.appComponent&&P.appComponent.getModel().getMetaModel(),o=P.modifier,s=o.getId(t),k,G,l,n,q,r,u,v,V,w,x=this.getColumnsFor(t),y=this;q=x.find(function(B){return B.name===p;});if(!q){L.error(p+" not found while adding column");return Promise.resolve(null);}if(q.type==="Default"){return this._templateCustomColumnFragment(q,P.view,o);}if(q.type==="Slot"){var z=o.getAggregation(t,"dependents");var A;z.forEach(function(B){var H=o.getProperty(B,"dataProperty");if(p===H){A=B;}});if(A){return Promise.resolve(A);}}if(!m){return Promise.resolve(null);}k=D.getCustomData(t,"metaPath",o);w=D.getCustomData(t,"entityType",o);G=D.getCustomData(t,"requestGroupId",o)||undefined;n=m.createBindingContext(k);return this._getCachedOrFetchPropertiesForEntity(t,w,m,P.appComponent).then(function(B){u=B.find(function(K){return K.name===p;});r=m.createBindingContext(u.metadataPath);V=y._getVHRelevantFields(m,u.metadataPath,k);v={sBindingPath:k,sValueHelpType:"TableValueHelp",oControl:t,oMetaModel:m,oModifier:o,oPropertyInfo:u};l=Promise.all(V.map(function(K){var N=Object.assign({},v,{sPropertyName:K});return Promise.all([D.isValueHelpRequired(N),D.doesValueHelpExist(N)]).then(function(Q){var S=Q[0],U=Q[1];if(S&&!U){return H("sap.fe.macros.table.ValueHelp");}return Promise.resolve();});}));function H(K){var N=new J({id:s,requestGroupId:G}),Q={bindingContexts:{"this":N.createBindingContext("/"),"dataField":r},models:{"this":N,"dataField":m,metaModel:m}};return D.templateControlFragment(K,Q,{},o).then(function(S){if(S){o.insertAggregation(t,"dependents",S,0);}}).catch(function(S){L.error("ValueHelp not loaded : "+S.message);return Promise.resolve(null);}).finally(function(){N.destroy();});}function I(u,K){var N=_(u)?"sap.fe.macros.table.Column":"sap.fe.macros.table.ColumnProperty",Q=D.getCustomData(t,"displayModePropertyBinding",o);var S;if(Q!==undefined){Q=typeof Q==="boolean"?Q:Q==="true";S=Q?"Display":"Editable";}var U=new J({readOnly:Q,columnEditMode:S,tableType:D.getCustomData(t,"tableType",o),onChange:D.getCustomData(t,"onChange",o),id:s,navigationPropertyPath:p,columnInfo:q,collection:{sPath:k,oModel:m},creationMode:D.getCustomData(t,"creationMode",o)}),W={bindingContexts:{"entitySet":n,"collection":n,"dataField":r,"this":U.createBindingContext("/"),"column":U.createBindingContext("/columnInfo")},models:{"this":U,"entitySet":m,"collection":m,"dataField":m,metaModel:m,"column":U}};return D.templateControlFragment(N,W,{view:K},o).finally(function(){U.destroy();});}return l.then(I.bind(this,u,P.view));});},getFilterDelegate:function(){return Object.assign({},c,{addItem:function(p,P){if(p.indexOf("Property::")===0){p=p.replace("Property::","");}return c.addItem(p,P);}});},getTypeUtil:function(p){return b;}});return O;},false);
