/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../getResourceBundle","../thirdparty/three","./Gizmo","./AxisColours","./ExplodeAxis","./ExplodeDirection","../AnimationTrackType","sap/base/assert","sap/base/Log"],function(g,t,G,A,E,c,e,f,L){"use strict";var h=G.extend("sap.ui.vk.tools.ExplodeToolGizmo",{metadata:{library:"sap.ui.vk"}});var j=96;var T=48;var H={PositiveX:0,PositiveY:1,PositiveZ:2,NegativeX:3,NegativeY:4,NegativeZ:5,ResetAdjustment:6,AdjustUp:7,AdjustDown:8,MoveUp:9,MoveDown:10};h.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._createEditingForm(g().getText("TOOL_UNITS_MM"),84);this._moveDelta=new THREE.Vector3();this._axisDirection=new THREE.Vector3();this._axisColor=0;this._magnitude=0;this._viewport=null;this._tool=null;this._groups=[];this._nodes=[];this._groupsMap=new Map();this._sceneGizmo=new THREE.Scene();var i=new THREE.AmbientLight(0xFFFFFF,0.5);i.layers.enableAll();this._sceneGizmo.add(i);var k=new THREE.DirectionalLight(0xFFFFFF,0.5);k.position.set(1,3,2);k.layers.enableAll();this._sceneGizmo.add(k);this._gizmo=new THREE.Group();this._touchAreas=new THREE.Group();this._touchAreas2=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._matViewProj=new THREE.Matrix4();var l=new THREE.MeshLambertMaterial({color:0x0080FF,transparent:true,opacity:0.2});function n(a,b,w,x){var y=1,z=4,B=24;var C=new THREE.MeshLambertMaterial({color:w});var D=new THREE.CylinderBufferGeometry(y,y,a-B,4);var F=new THREE.Vector3(b.y,b.z,b.x);var o=new THREE.Vector3(b.z,b.x,b.y);var m=b.x<0||b.y<0||b.z<0?new THREE.Matrix4().makeBasis(o,b,F):new THREE.Matrix4().makeBasis(F,b,o);m.setPosition(b.clone().multiplyScalar((a-B)*0.5));D.applyMatrix4(m);var I=new THREE.Mesh(D,C);I.matrixAutoUpdate=false;I.userData.color=w;var J=new THREE.CylinderBufferGeometry(0,z,B,12,1);m.setPosition(b.clone().multiplyScalar(a-B*0.5));J.applyMatrix4(m);var K=new THREE.Mesh(J,C);K.matrixAutoUpdate=false;I.add(K);if(x){var M=new THREE.CylinderGeometry(T*0.5,T*0.5,a-T+B*0.5,12,1);m.setPosition(b.clone().multiplyScalar(T+M.parameters.height*0.5));M.applyMatrix4(m);var N=new THREE.CylinderGeometry(T*0.5,0,T,12,1);m.setPosition(b.clone().multiplyScalar(T*0.5));M.merge(N,m);x.add(new THREE.Mesh(M,l));}return I;}this._gizmo.add(n(j,new THREE.Vector3(1,0,0),A.x,this._touchAreas));this._gizmo.add(n(j,new THREE.Vector3(0,1,0),A.y,this._touchAreas));this._gizmo.add(n(j,new THREE.Vector3(0,0,1),A.z,this._touchAreas));this._gizmo.add(n(j,new THREE.Vector3(-1,0,0),A.x,this._touchAreas));this._gizmo.add(n(j,new THREE.Vector3(0,-1,0),A.y,this._touchAreas));this._gizmo.add(n(j,new THREE.Vector3(0,0,-1),A.z,this._touchAreas));this._axisTitles=this._createAxisTitles(undefined,undefined,false,true);this._sceneGizmo.add(this._axisTitles);var d=32;var o=d*1.75;this._groupGizmo=new THREE.Group();this._sceneGizmo.add(this._groupGizmo);var s=new THREE.Mesh(new THREE.IcosahedronBufferGeometry(8,1),new THREE.MeshLambertMaterial());this._groupGizmo.add(s);this._groupGizmo.add(n(d*1.5,new THREE.Vector3(0,1,0),0xFFFFFF));this._groupGizmo.add(n(d*1.5,new THREE.Vector3(0,-1,0),0xFFFFFF));var p=16;var q=new THREE.CylinderGeometry(0,6,p,16).applyMatrix4(new THREE.Matrix4().setPosition(0,o+p*0.5,0));q.merge(new THREE.CylinderGeometry(0,6,p,16),new THREE.Matrix4().setPosition(0,o+p*1.5,0));this._groupGizmo.add(new THREE.Mesh(new THREE.BufferGeometry().fromGeometry(q),new THREE.MeshLambertMaterial()));this._groupGizmo.add(new THREE.Mesh(new THREE.BufferGeometry().fromGeometry(q.rotateX(Math.PI)),new THREE.MeshLambertMaterial()));this._groupGizmo.add(new THREE.Mesh(new THREE.CylinderGeometry(16,16,d*6,12,1),new THREE.MeshBasicMaterial({color:0xFFFFFF,transparent:true,opacity:0.5,side:THREE.BackSide})));function r(a,b,m){var w=new THREE.IcosahedronGeometry(T*0.5,1);w.applyMatrix4(new THREE.Matrix4().setPosition(0,(a+b)*0.5,0));m.add(new THREE.Mesh(w,l));}r(d*-0.5,d*0.5,this._touchAreas2);r(d*0.5,d*1.5,this._touchAreas2);r(d*-1.5,d*-0.5,this._touchAreas2);r(o,o+d,this._touchAreas2);r(-o-d,-o,this._touchAreas2);function u(a){a.traverse(function(b){b.layers.enableAll();});}function v(a){a.children.forEach(function(b,m){b.traverse(function(w){w.layers.enable(Math.min(m,6)+1);});});}v(this._gizmo);v(this._axisTitles);v(this._touchAreas);u(this._groupGizmo);u(this._touchAreas2);};h.prototype.hasDomElement=function(){return false;};h.prototype.show=function(v,a){this._viewport=v;this._tool=a;this._nodes.length=0;this._handleGroupsChanged();};h.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._updateEditingForm(false);};h.prototype.getGizmoCount=function(){if(!this._groups.length){return 0;}return this._getActiveAxisIndex()>=0&&this._getSelectedItem()?2:1;};h.prototype.getTouchObject=function(i){if(i===0){this._updateGizmoObjectTransformation(this._touchAreas);return this._touchAreas;}else{this._updateGroupGizmoTransformation(this._touchAreas2);return this._touchAreas2;}};h.prototype._handleGroupsChanged=function(a){this._setMagnitude(0);var b=this._groupsMap;b.clear();this._groups=this._tool.getItems().slice();var n=this._nodes=[];this._groups.forEach(function(d){var k=d.getItems();for(var i=0;i<k.length;i++){var l=k[i].getNodeRef();b.set(l,d);n.push({node:l,group:d,local:new THREE.Vector3().setFromMatrixPosition(l.matrix),origin:new THREE.Vector3().setFromMatrixPosition(l.matrixWorld),matParentInv:l.parent?new THREE.Matrix4().getInverse(l.parent.matrixWorld):new THREE.Matrix4()});}});this._calculateGroupOffsets();this._setMagnitude(this._tool.getMagnitude());};h.prototype._getSelectedItem=function(){return sap.ui.getCore().byId(this._tool.getSelectedItem());};h.prototype._handleSelectedItemChanged=function(){var v=this._viewport._viewStateManager;var o=new Set();var s=this._getSelectedItem();if(s){s.getItems().forEach(function(i){o.add(i.getNodeRef());});}var u=[];v.enumerateOutlinedNodes(function(n){if(!o.has(n)){u.push(n);}});v.setOutliningStates(Array.from(o),u,false);};h.prototype.highlightHandle=function(a,b){this._handleIndex=a;this._gizmo.children.forEach(function(d,i){var k=a===i;var l=k?0xFFFF00:d.userData.color;d.material.color.setHex(l);this._axisTitles.children[i].material.color.setHex(l);}.bind(this));for(var i=0;i<5;i++){this._groupGizmo.children[i].material.color.setHex(i+6===a?0xFFFF00:this._axisColor);}};h.prototype._calculateGroupOffsets=function(){var d=new THREE.Vector3(Math.abs(this._axisDirection.x),Math.abs(this._axisDirection.y),Math.abs(this._axisDirection.z));var s=new THREE.Vector3();var l=0,a=0;this._groups.forEach(function(b,i){var k=b.getBoundingBox();k.getCenter(b._center);k.getSize(s);l=d.dot(s);if(i>0){a+=l*0.5;}b._offset=a;b._deltaOffset=l*0.5;a+=l*0.5;});a+=l*0.5;var o=a>0?1/a:1;this._groups.forEach(function(b){b._offset=1-b._offset*o;b._deltaOffset*=o;});};h.prototype._getActiveAxisIndex=function(){var a=this._tool.getAxis();var d=this._tool.getDirection();var i=a&&d?[E.X,E.Y,E.Z].indexOf(a):-1;if(i>=0&&d===c.Negative){i+=3;}return i;};h.prototype._updateAxis=function(){var a=this._getActiveAxisIndex();if(a>=0){this._updateGizmoObjectTransformation(this._gizmo);this._axisDirection.setFromMatrixColumn(this._gizmo.matrixWorld,a%3).normalize().multiplyScalar(a<3?1:-1);this._axisColor=this._gizmo.children[a].userData.color;for(var i=0;i<5;i++){this._groupGizmo.children[i].material.color.setHex(this._axisColor);}this._setMagnitude(0);this._calculateGroupOffsets();this._setMagnitude(this._tool.getMagnitude());this._viewport.setShouldRenderFrame();}};h.prototype._moveSelectedGroup=function(d){var s=this._getSelectedItem();var i=this._tool.getItems();var a=i.indexOf(s);if(a>=0&&a+d>=0&&a+d<i.length){this._tool.removeItem(s);this._tool.insertItem(s,a+d);}};h.prototype._setMagnitudeAdjustmentMultiplier=function(v){var s=this._getSelectedItem();if(s){s.setMagnitudeAdjustmentMultiplier(v);this._updatePositions();}};h.prototype._beginGesture=function(){this._moveDelta.setScalar(0);this._beginMagnitude=this._magnitude;switch(this._handleIndex){case H.ResetAdjustment:this._setMagnitudeAdjustmentMultiplier(0);break;case H.AdjustUp:case H.AdjustDown:var s=this._getSelectedItem();this._magnitudeAdjustmentMultiplier=s?s.getMagnitudeAdjustmentMultiplier():0;break;case H.MoveUp:this._moveSelectedGroup(-1);break;case H.MoveDown:this._moveSelectedGroup(+1);break;default:if(this._handleIndex<6&&(!this._tool.getAxis()||!this._tool.getDirection())){this._tool.setAxis([E.X,E.Y,E.Z][this._handleIndex%3]);this._tool.setDirection(this._handleIndex<3?c.Positive:c.Negative);}break;}};h.prototype._setMagnitude=function(m){m=Math.max(m,0);this._magnitude=m;this._groups.forEach(function(a){a._magnitude=m;});this._updatePositions();};h.prototype._setOffset=function(o){if(this._handleIndex<6){this._tool.setMagnitude(this._beginMagnitude+o);}else if(this._handleIndex===H.AdjustUp||this._handleIndex===H.AdjustDown){var s=this._getSelectedItem();if(s&&this._magnitude>0){this._setMagnitudeAdjustmentMultiplier(Math.min(Math.max(this._magnitudeAdjustmentMultiplier+o/(this._magnitude*s._deltaOffset),-1),1));}}};h.prototype._updatePositions=function(){var p=new THREE.Vector3();var a=this._axisDirection;this._nodes.forEach(function(n){var b=n.node;p.copy(a).multiplyScalar(n.group.getMagnitude()).add(n.origin);b.matrixWorld.setPosition(p);b.matrix.multiplyMatrices(n.matParentInv,b.matrixWorld);b.position.setFromMatrixPosition(b.matrix);b.updateMatrixWorld(true);});this._viewport.setShouldRenderFrame();};h.prototype._endGesture=function(){};h.prototype._getNodesProperties=function(){var n=[];this._nodes.forEach(function(a){var b=a.node;var p={};p.node=b;var d=this._getEffectiveParent(b);var i=new THREE.Matrix4();if(d===b.parent){var r=this._viewport._viewStateManager.getRelativeTransformation(b);p.offsetToRestInParent=r.translation.slice();if(b.parent){i=new THREE.Matrix4().extractRotation(b.parent.matrixWorld);}p.offsetToPreviousInParent=p.offsetToRestInParent.slice();var s;if(this._playback){s=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(b,e.Translate,this._playback);if(s){p.offsetToPreviousInParent[0]-=s[0];p.offsetToPreviousInParent[1]-=s[1];p.offsetToPreviousInParent[2]-=s[2];}}var k=this._viewport._viewStateManager.getRestTransformation(b);var l=[k.translation[0],k.translation[1],k.translation[2]];if(s){l[0]+=s[0];l[1]+=s[1];l[2]+=s[2];}var q=new THREE.Quaternion();var m=new THREE.Vector3();var o=new THREE.Vector3();b.matrix.decompose(o,q,m);var M=new THREE.Matrix4().makeTranslation(-l[0],-l[1],-l[2]);var u=new THREE.Matrix4().makeTranslation(-k.translation[0],-k.translation[1],-k.translation[2]);if(m.x===0.0||m.y===0.0||m.z===0.0){m.x=1;m.y=1;m.z=1;}var v=new THREE.Matrix4().makeScale(1/m.x,1/m.y,1/m.z);var w=new THREE.Matrix4().makeRotationFromQuaternion(q.inverse());var x=v.clone().multiply(w).multiply(M).multiply(b.matrix);x.decompose(o,q,m);p.offsetToPrevious=o.toArray();var y=v.multiply(w).multiply(u).multiply(b.matrix);y.decompose(o,q,m);p.offsetToRest=o.toArray();}else{if(b.userData.skipUpdateJointNode){this._viewport._viewStateManager._setJointNodeOffsets(b,e.Translate);}if(b.userData&&b.userData.offsetTranslation){p.offsetToRestInParent=b.userData.offsetTranslation.slice();}else{p.offsetToRestInParent=[0,0,0];}p.offsetToPreviousInParent=p.offsetToRestInParent.slice();if(b.userData.skipUpdateJointNode){b.userData.skipUpdateJointNode=false;this._viewport._viewStateManager._setJointNodeMatrix();b.userData.skipUpdateJointNode=true;}var z=this._viewport._viewStateManager.getRestTransformationUsingJoint(b);var B=new THREE.Vector3();var C=new THREE.Vector3(z.scale[0],z.scale[1],z.scale[2]);var D=new THREE.Quaternion(z.quaternion[0],z.quaternion[1],z.quaternion[2],z.quaternion[3]);if(b.userData.offsetScale){C.x*=b.userData.offsetScale[0];C.y*=b.userData.offsetScale[1];C.z*=b.userData.offsetScale[2];}if(b.userData.offsetQuaternion){var F=new THREE.Quaternion(b.userData.offsetQuaternion[0],b.userData.offsetQuaternion[1],b.userData.offsetQuaternion[2],b.userData.offsetQuaternion[3]);D.multiply(F);}var I=new THREE.Matrix4().makeRotationFromQuaternion(D);var J=new THREE.Matrix4().makeTranslation(z.translation[0],z.translation[1],z.translation[2]);var K=d.matrixWorld.clone().multiply(J).multiply(I).scale(C);var N=new THREE.Matrix4().getInverse(K).multiply(b.matrixWorld);N.decompose(B,D,C);p.offsetToPrevious=B.toArray();p.offsetToRest=B.toArray();}var O=this._viewport._viewStateManager.getTransformation(b);p.absolute=[O.translation[0],O.translation[1],O.translation[2]];var P=this._viewport._viewStateManager.getTransformationWorld(b);p.world=P.translation;var Q;if(this._nodeUserDataMap){Q=this._nodeUserDataMap.get(b);}if(Q&&Q.initialTranslation){p.restDifference=[O.translation[0]-Q.initialTranslation[0],O.translation[1]-Q.initialTranslation[1],O.translation[2]-Q.initialTranslation[2]];var R=new THREE.Vector3(p.restDifference[0],p.restDifference[1],p.restDifference[2]).applyMatrix4(i);p.restDifferenceInCoordinates=R.toArray();}n.push(p);}.bind(this));return n;};h.prototype.expandBoundingBox=function(b){if(this._viewport){this._expandBoundingBox(b,this._viewport.getCamera().getCameraRef(),true);}};h.prototype._updateGizmoObjectTransformation=function(o){o.matrix.fromArray(this._tool.getAnchor());o.matrix.decompose(o.position,o.quaternion,o.scale);var s=this._getGizmoScale(o.position);o.scale.setScalar(s);o.matrixAutoUpdate=true;o.updateMatrixWorld(true);return s;};h.prototype._updateGroupGizmoTransformation=function(o){var a=this._getActiveAxisIndex();var s=a>=0?this._getSelectedItem():null;o.visible=!!s;if(s){o.position.copy(this._axisDirection).multiplyScalar(s.getMagnitude()).add(s._center);o.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),this._axisDirection);o.scale.setScalar(this._getGizmoScale(o.position));o.updateMatrix();o.updateMatrixWorld();}};h.prototype._updateGizmoTransformation=function(i,a){this._updateGizmoObjectTransformation(this._gizmo);};h.prototype._getCameraLayersMask=function(){var m=0|0;var a=this._getActiveAxisIndex();m=1<<(a+1);if(a>=0&&this._getSelectedItem()){m|=1<<7;}return m;};h.prototype.render=function(){f(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._tool&&this._groups.length>0){var r=this._viewport.getRenderer(),a=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);r.clearDepth();var s=this._updateGizmoObjectTransformation(this._gizmo);this._updateAxisTitles(this._axisTitles,this._gizmo,a,j+18,s);this._updateGroupGizmoTransformation(this._groupGizmo);var m=a.layers.mask;a.layers.mask=this._getCameraLayersMask();r.render(this._sceneGizmo,a);a.layers.mask=m;}};return h;});
