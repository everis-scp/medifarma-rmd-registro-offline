/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/fe/navigation/SelectionVariant","sap/fe/core/helpers/ModelHelper","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/base/Log","sap/fe/core/CommonUtils"],function(C,O,S,M,X,a,F,J,L,b){"use strict";return C.extend("sap.fe.core.controllerextensions.InternalInternalBasedNavigation",{metadata:{methods:{navigate:{"final":true,"public":true},getEntitySet:{"final":false,"public":false},navigateOutbound:{"final":true,"public":true},navigateWithConfirmationDialog:{"final":true,"public":true},getNavigationMode:{"final":false,"public":true,overrideExecution:O.Instead},prepareContextForExternalNavigation:{"final":true,"public":true},removeSensitiveData:{"final":true,"public":true},prepareFiltersForExternalNavigation:{"final":true,"public":true}}},navigate:function(s,A,n){var t=this;var _=function(c){var N=n&&n.navigationContexts,d=N&&!Array.isArray(N)?[N]:N,v=n&&n.semanticObjectMapping,T={semanticObject:s,action:A};if(c){t._oView.setBindingContext(c);}if(s&&A){var e=[],o=new S();if(d&&d.length){d.map(function(j){if(j.isA&&j.isA("sap.ui.model.odata.v4.Context")){var k=j.getObject(),l=t._oMetaModel.getMetaPath(j.getPath());k=t.removeSensitiveData(k,l);var p=t.prepareContextForExternalNavigation(k,j);T["propertiesWithoutConflict"]=p.propertiesWithoutConflict;e.push(p.semanticAttributes);}else if(!(j&&Array.isArray(j.data))&&typeof j==="object"){e.push(t.removeSensitiveData(j.data,j.metaPath));}else if(j&&Array.isArray(j.data)){e=t.removeSensitiveData(j.data,j.metaPath);}});}if(e&&e.length){o=t._oNavigationService.mixAttributesAndSelectionVariant(e,o.toJSONString());}var f=t._oView.getModel(),E=t.getEntitySet(),g=E?t._oNavigationService.constructContextUrl(E,f):undefined;if(g){o.setFilterContextUrl(g);}t.base.getView().getController().intentBasedNavigation.adaptNavigationContext(o,T);if(v){t._applySemanticObjectMappings(o,v);}t._removeTechnicalParameters(o);var h=t.base.getView().getController()._intentBasedNavigation.getNavigationMode();var i=function(){sap.ui.require(["sap/m/MessageBox"],function(j){var r=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");j.show(r.getText("C_COMMON_HELPER_NAVIGATION_ERROR_MESSAGE"),{title:r.getText("C_COMMON_NAVIGATION_ERROR_TITLE")});});};t._oNavigationService.navigate(s,A,o.toJSONString(),null,i,null,h);}else{throw new Error("Semantic Object/action is not provided");}};var B=this.base.getView().getBindingContext();var m=B&&B.getModel().getMetaModel();if(this.getView().getViewData().converterType==="ObjectPage"&&m&&!M.isStickySessionSupported(m)){b.fnProcessDataLossOrDraftDiscardConfirmation(_.bind(this),Function.prototype,this.base.getView().getBindingContext(),this.base.getView().getController());}else{_();}},prepareContextForExternalNavigation:function(s,c){function _(t,u){for(var K in t){if(t[K]===null||typeof t[K]!=="object"){if(!d[K]){d[K]=[];}d[K].push(u);}else{var N=t[K];_(N,u+"/"+K);}}}var d={},e=c.getPath(),m=c.getModel().getMetaModel(),f=m.getMetaPath(e),g=f.split("/").filter(Boolean);_(s,f);var h=g[0],j=m.getObject("/"+h+"/@sapui.name"),p={};var k,l,n;for(var D in d){var o=d[D],w;if(o.length>1){for(var i=0;i<=o.length-1;i++){var P=o[i],q=P.replace(P===f?f:f+"/","");q=(q===""?q:q+"/")+D;var E=m.getObject(P+"/@sapui.name");if(E===j){k=q;}if(P===f){l=q;}n=q;s[(f+"/"+q).split("/").filter(function(v){return v!="";}).join(".")]=c.getProperty(q);}w=k||l||n;s[D]=c.getProperty(w);k=undefined;l=undefined;n=undefined;}else{var P=o[0],q=P.replace(P===f?f:f+"/","");q=(q===""?q:q+"/")+D;s[D]=c.getProperty(q);p[D]=(f+"/"+q).split("/").filter(function(v){return v!="";}).join(".");}}for(var r in s){if(s[r]!==null&&typeof s[r]==="object"){delete s[r];}}return{semanticAttributes:s,propertiesWithoutConflict:p};},prepareFiltersForExternalNavigation:function(f,r,p){function _(h,l){for(var k in h){if(h[k]){if(k.includes("/")){l=k;var j=k.split("/");k=j[j.length-1];}else{l=r;}if(!d[k]){d[k]=[];}d[k].push(l);}}}var d={};_(f,r);var o={};var m,c,s,w,P;for(var D in d){var e=d[D];if(e.length>1){for(var i=0;i<=e.length-1;i++){var g=e[i];if(g===r){s=r+"/"+D;P=D;m=D;if(p&&p.includes(D)){f["$Parameter."+D]=f[D];}}else{P=g;s=(r+"/"+g).replaceAll("*","");c=g;}f[s.split("/").filter(function(v){return v!="";}).join(".")]=f[P];delete f[g];}w=m||c;f[D]=f[w];}else{var g=e[0],s=g===r?r+"/"+D:(r+"/"+g).replaceAll("*","");o[D]=s.split("/").filter(function(v){return v!="";}).join(".");if(p&&p.includes(D)){f["$Parameter."+D]=f[D];}}}return{filterConditions:f,filterConditionsWithoutConflict:o};},getNavigationMode:function(){return"inplace";},navigateWithConfirmationDialog:function(s,A,n){var t=this;if(n.notApplicableContexts&&n.notApplicableContexts.length>=1){var o;var c={onClose:function(){o.close();},onContinue:function(){n.navigationContexts=n.applicableContexts;o.close();t.navigate(s,A,n);}};var f=function(){var h,j=n.notApplicableContexts.length,N=[];for(var i=0;i<n.notApplicableContexts.length;i++){h=n.notApplicableContexts[i].getObject();N.push(h);}var k=new J(N);var T=new J({total:j,label:n.label});o.setModel(k,"notApplicable");o.setModel(T,"totals");o.open();};var d="sap.fe.core.controls.ActionPartial";var D=a.loadTemplate(d,"fragment");var m=this._oView.getModel();var e=m.getMetaModel();var g=n.notApplicableContexts[0].getCanonicalPath();var E=g.substr(0,g.indexOf("("))+"/";Promise.resolve(X.process(D,{name:d},{bindingContexts:{entityType:e.createBindingContext(E)},models:{entityType:e,metaModel:e}})).then(function(h){return F.load({definition:h,controller:c});}).then(function(p){o=p;t.getView().addDependent(p);f();}).catch(function(){L.error("Error");});}else{t.navigate(s,A,n);}},_removeTechnicalParameters:function(s){s.removeSelectOption("@odata.context");s.removeSelectOption("@odata.metadataEtag");s.removeSelectOption("SAP__Messages");},getEntitySet:function(){return this._oView.getViewData().entitySet;},removeSensitiveData:function(A,m){var p=Object.keys(A);if(p.length){delete A["@odata.context"];delete A["@odata.metadataEtag"];delete A["SAP__Messages"];for(var j=0;j<p.length;j++){if(A[p[j]]&&typeof A[p[j]]==="object"){this.removeSensitiveData(A[p[j]],m+"/"+p[j]);}var P=p[j],c=this._oMetaModel.getObject(m+"/"+P+"@");if(c){if(c["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||c["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||c["@com.sap.vocabularies.Analytics.v1.Measure"]){delete A[P];}else if(c["@com.sap.vocabularies.Common.v1.FieldControl"]){var f=c["@com.sap.vocabularies.Common.v1.FieldControl"];if(f["$EnumMember"]&&f["$EnumMember"].split("/")[1]==="Inapplicable"){delete A[P];}else if(f["$Path"]&&this._isFieldControlPathInapplicable(f["$Path"],A)){delete A[P];}}}}}return A;},_isFieldControlPathInapplicable:function(f,A){var i=false,p=f.split("/");if(p.length>1){i=A[p[0]]&&A[p[0]].hasOwnProperty(p[1])&&A[p[0]][p[1]]===0;}else{i=A[f]===0;}return i;},_applySemanticObjectMappings:function(s,m){var o=typeof m==="string"?JSON.parse(m):m;for(var i=0;i<o.length;i++){var l=(o[i]["LocalProperty"]&&o[i]["LocalProperty"]["$PropertyPath"])||(o[i]["@com.sap.vocabularies.Common.v1.LocalProperty"]&&o[i]["@com.sap.vocabularies.Common.v1.LocalProperty"]["$Path"]);var c=o[i]["SemanticObjectProperty"]||o[i]["@com.sap.vocabularies.Common.v1.SemanticObjectProperty"];if(s.getSelectOption(l)){var d=s.getSelectOption(l);s.removeSelectOption(l);s.massAddSelectOption(c,d);}}return s;},navigateOutbound:function(o,n){var m=this.base.getAppComponent().getManifestEntry("sap.app"),c=m.crossNavigation&&m.crossNavigation.outbounds[o];if(!c){L.error("Outbound is not defined in manifest!!");return;}var s=c.semanticObject,A=c.action,d=c.parameters&&this._getOutboundParams(c.parameters);if(n){var N=[];Object.keys(n).forEach(function(k){if(Array.isArray(n[k])){var v=n[k];for(var i=0;i<v.length;i++){var p={};p[k]=v[i];N.push(p);}}else{var p={};p[k]=n[k];N.push(p);}});}if(N||d){n={navigationContexts:{data:N||d}};}this.base._intentBasedNavigation.navigate(s,A,n);},_getOutboundParams:function(o){var p={};if(o){var P=Object.keys(o)||[];if(P.length>0){P.forEach(function(k){var m=o[k];if(m.value&&m.value.value&&m.value.format==="plain"){if(!p[k]){p[k]=m.value.value;}}});}}return p;},override:{onInit:function(){this._oAppComponent=this.base.getAppComponent();this._oMetaModel=this._oAppComponent.getModel().getMetaModel();this._oNavigationService=this._oAppComponent.getNavigationService();this._oView=this.base.getView();}}});});
