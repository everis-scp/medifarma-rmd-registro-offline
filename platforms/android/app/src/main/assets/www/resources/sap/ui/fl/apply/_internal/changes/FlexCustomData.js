/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/base/Log","sap/ui/core/CustomData"],function(F,L){"use strict";var a={};a.sync={};a.appliedChangesCustomDataKey="sap.ui.fl.appliedChanges";a.failedChangesCustomDataKeyJs="sap.ui.fl.failedChanges.js";a.failedChangesCustomDataKeyXml="sap.ui.fl.failedChanges.xml";a.notApplicableChangesCustomDataKey="sap.ui.fl.notApplicableChanges";a.sync.getAppliedCustomDataValue=function(C,o){var m=c(C,a._getCustomDataKey(o,a.appliedChangesCustomDataKey));return m.customDataValue;};a.getAppliedCustomDataValue=function(C,o,m){return d(C,m,a._getCustomDataKey(o,a.appliedChangesCustomDataKey)).then(function(e){return e.customDataValue;});};a.sync.getParsedRevertDataFromCustomData=function(C,o){var s=a.sync.getAppliedCustomDataValue(C,o);try{return s&&JSON.parse(s);}catch(e){L.error("Could not parse revert data from custom data",s);return undefined;}};a.getParsedRevertDataFromCustomData=function(C,o,m){return a.getAppliedCustomDataValue(C,o,m).then(function(s){return s&&JSON.parse(s);});};a.sync.hasChangeApplyFinishedCustomData=function(C,o){var e=F.getAggregation(C,"customData")||[];var f=[a._getCustomDataKey(o,a.appliedChangesCustomDataKey),a._getCustomDataKey(o,a.failedChangesCustomDataKeyJs),a._getCustomDataKey(o,a.notApplicableChangesCustomDataKey)];return e.some(function(h){var k=F.getProperty(h,"key");if(f.indexOf(k)>-1){return!!F.getProperty(h,"value");}return false;});};a.hasChangeApplyFinishedCustomData=function(C,o,m){return Promise.resolve().then(m.getAggregation.bind(m,C,"customData")).then(function(e){e=e||[];var f=[a._getCustomDataKey(o,a.appliedChangesCustomDataKey),a._getCustomDataKey(o,a.failedChangesCustomDataKeyJs),a._getCustomDataKey(o,a.notApplicableChangesCustomDataKey)];return Promise.all(e.map(function(h){return Promise.resolve().then(m.getProperty.bind(m,h,"key")).then(function(k){if(f.indexOf(k)>-1){return m.getProperty(h,"value");}return undefined;}).then(function(v){return!!v;});})).then(function(v){return v.includes(true);});});};function g(s,C){var r=C.getRevertData();if(s&&r!==undefined){return JSON.stringify(r);}return"true";}a.sync.addAppliedCustomData=function(C,o,p,s){var e=g(s,o);var f=a._getCustomDataKey(o,a.appliedChangesCustomDataKey);return w(C,f,e,p);};a.addAppliedCustomData=function(C,o,p,s){var e=g(s,o);var f=a._getCustomDataKey(o,a.appliedChangesCustomDataKey);return b(C,f,e,p);};a.addFailedCustomData=function(C,o,p,i){var s=a._getCustomDataKey(o,i);return b(C,s,"true",p);};a.sync.destroyAppliedCustomData=function(C,o,m){var k=a._getCustomDataKey(o,a.appliedChangesCustomDataKey);var e=c(C,k);if(e.customData){m.destroy(e.customData);}};a.destroyAppliedCustomData=function(C,o,m){var k=a._getCustomDataKey(o,a.appliedChangesCustomDataKey);return d(C,m,k).then(function(e){if(e.customData){m.destroy(e.customData);}});};a.getCustomDataIdentifier=function(s,e,x){if(s){return a.appliedChangesCustomDataKey;}if(!e){return a.notApplicableChangesCustomDataKey;}if(x){return a.failedChangesCustomDataKeyXml;}return a.failedChangesCustomDataKeyJs;};a._getCustomDataKey=function(C,i){return i+"."+C.getId();};function w(C,k,v,p){var m=c(C,k);if(!m.customData){p.modifier.createAndAddCustomData(C,k,v,p.appComponent);}else{p.modifier.setProperty(m.customData,"value",v);}}function b(C,k,v,p){return d(C,p.modifier,k).then(function(m){if(!m.customData){return p.modifier.createAndAddCustomData(C,k,v,p.appComponent);}return p.modifier.setProperty(m.customData,"value",v);});}function c(C,s){var e=F.getAggregation(C,"customData")||[];var r={};e.some(function(o){var k=F.getProperty(o,"key");if(k===s){r.customData=o;r.customDataValue=F.getProperty(o,"value");return true;}return false;});return r;}function d(C,m,s){return Promise.resolve().then(m.getAggregation.bind(m,C,"customData")).then(function(e){e=e||[];var r={};return e.reduce(function(p,o){return p.then(m.getProperty.bind(m,o,"key")).then(function(k){if(k===s){r.customData=o;return m.getProperty(o,"value");}return undefined;}).then(function(f){if(f){r.customDataValue=f;}});},Promise.resolve()).then(function(){return r;});});}return a;},true);
