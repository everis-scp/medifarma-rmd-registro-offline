/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/util/RequestDataProvider","sap/base/Log"],function(R,L){"use strict";var S=31536000;function g(r){var u=r.url,d=r.data,U,p;if(r.method!=="GET"){return r.url;}U=new URL(u,window.location.href);for(p in d){U.searchParams.set(p,d[p]);}return U.href;}var C=R.extend("sap.ui.integration.util.CacheAndRequestDataProvider");C.prototype.init=function(){this._oRefreshWithoutCacheBound=this.refreshWithoutCache.bind(this);};C.prototype.destroy=function(){this._unsubscribeFromHostMessages();this._detachTimestampPress();R.prototype.destroy.apply(this,arguments);};C.prototype.onDataRequestComplete=function(){var i;if(this._iUpdateIntervalTimeout){clearTimeout(this._iUpdateIntervalTimeout);this._iUpdateIntervalTimeout=null;}if(!this._oSettings||!this._oSettings.updateInterval){return;}i=parseInt(this._oSettings.updateInterval);if(isNaN(i)){return;}this._iUpdateIntervalTimeout=setTimeout(function(){this.refreshWithoutCache();}.bind(this),i*1000);};C.prototype._request=function(r){var p,c=this.getCardInstance(),o=c.getCardHeader();this._sCurrentRequestFullUrl=g(r);this._subscribeToHostMessages();p=R.prototype._request.apply(this,arguments);p.then(function(v){var j=v[1],d=j.getResponseHeader("Date");if(d&&o){this._attachTimestampPress();o.setDataTimestamp((new Date(d)).toISOString());}}.bind(this));return p;};C.prototype.refreshWithoutCache=function(){var c=this.getCardInstance().getCardHeader();c.setDataTimestampUpdating(true);setTimeout(function(){this._bCacheOnly=false;this._bNoCache=true;this._triggerDataUpdate();}.bind(this),200);};C.prototype.refreshFromCache=function(){var c=this.getCardInstance().getCardHeader();c.setDataTimestampUpdating(true);setTimeout(function(){this._bCacheOnly=true;this._bNoCache=false;this._triggerDataUpdate();}.bind(this),200);};C.prototype._prepareHeaders=function(h,s){var c=this.getCardInstance(),H=c.getHostInstance(),n=Object.assign({},s),o=n.request.cache;if(!o){o={maxAge:0,staleWhileRevalidate:true};}if(!o.noStore){if(this._bCacheOnly){o.maxAge=S;o.staleWhileRevalidate=false;}else if(this._bNoCache){o.maxAge=0;o.staleWhileRevalidate=false;}}n.request.cache=o;if(H&&H.modifyRequestHeaders){return H.modifyRequestHeaders(Object.assign({},h),n,c);}return h;};C.prototype._subscribeToHostMessages=function(){var c=this.getCardInstance(),h=c.getHostInstance();if(this._bIsSubscribed){return;}if(!h){return;}h.attachMessage(this._handleHostMessage,this);this._bIsSubscribed=true;};C.prototype._unsubscribeFromHostMessages=function(){var c=this.getCardInstance(),h=c.getHostInstance();if(!h){return;}h.detachMessage(this._handleHostMessage,this);this._bIsSubscribed=false;};C.prototype._handleHostMessage=function(e){var d=e.getParameter("data");if(d.type!=="ui-integration-card-update"){return;}if(d.url!==this._sCurrentRequestFullUrl){return;}L.info("[CARDS CACHE] message ui-integration-card-update received for "+d.url);this.refreshFromCache();};C.prototype._attachTimestampPress=function(e){var c=this.getCardInstance(),h=c.getCardHeader();if(this._oHeaderDelegate){return;}if(!h){return;}this._oHeaderDelegate={onBeforeRendering:function(){var $=c.$().find(".sapFCardDataTimestamp");$.off("click",this._oRefreshWithoutCacheBound);}.bind(this),onAfterRendering:function(){var $=c.$().find(".sapFCardDataTimestamp");$.on("click",this._oRefreshWithoutCacheBound);}.bind(this)};h.addEventDelegate(this._oHeaderDelegate);};C.prototype._detachTimestampPress=function(e){var c=this.getCardInstance(),h=c.getCardHeader(),$=this.getCardInstance().$().find(".sapFCardDataTimestamp");$.off("click",this._oRefreshWithoutCacheBound);h.removeEventDelegate(this._oHeaderDelegate);this._oHeaderDelegate=null;};return C;});
