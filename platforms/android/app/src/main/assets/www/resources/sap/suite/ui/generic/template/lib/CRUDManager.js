sap.ui.define(["sap/ui/base/Object","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/model/Context","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper"],function(B,M,A,a,C,b,t,e,c,F,d,f,D){"use strict";var s="lib.CRUDManager";var r=Promise.reject();r.catch(Function.prototype);function g(o,k,v){var H=o.getHeaders();var i=e({},H);if(v===undefined){delete i[k];}else{i[k]=v;}o.setHeaders(i);}function m(o){return Object.keys(o).map(function(k){return o[k];});}function h(i){if(i){return i.map(function(k,l){return l;});}}function j(o,l,S,n,p){function q(i,k,V,W){if(V){a.handleError(i,o,S,V,W);}return(k||Function.prototype)(V);}var E;function u(i){return new Promise(function(k,V){var W=o.getOwnerComponent();var X=W.getBindingContext();var Y=W.getModel();Y.read(X.getPath(),{urlParameters:{"$expand":"DraftAdministrativeData"},success:function(Z){if(!Z.DraftAdministrativeData){if(i){return q(a.operations.editEntity,V,i);}return k({});}if(Z.DraftAdministrativeData.InProcessByUser){var $=Z.DraftAdministrativeData.InProcessByUserDescription||Z.DraftAdministrativeData.InProcessByUser;var _=Promise.resolve(i||l.getMainComponentUtils().then(function(a1){var b1=a1.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",$]);return new F(b1);}));return _.then(function(i){q(a.operations.editEntity,V,i,i);});}return k({draftAdministrativeData:Z.DraftAdministrativeData});},error:q.bind(null,a.operations.editEntity,V)});});}function v(){var i=o.getView().getModel().getMetaModel();var k=i.getODataEntityContainer();var V=k["Org.OData.Capabilities.V1.BatchSupport"];if(V&&V.ReferencesAcrossChangeSetsSupported&&V.ReferencesAcrossChangeSetsSupported.Bool){return V.ReferencesAcrossChangeSetsSupported.Bool==="true";}return false;}function w(){return new Promise(function(i){if(v()){l.getMainComponentUtils().then(function(k){i(k.getRootExpand());});}else{i(null);}});}function x(i,k,V){var W=i.bindingContext;if(V&&V.draftAdministrativeData){return Promise.resolve(V);}return w().then(function(X){return new Promise(function(Y,Z){S.oTransactionController.editEntity(W,!k,X).then(function($){var _;_=i.view;var a1=function(){W.getModel().invalidateEntry(W);_.detachEvent("modelContextChange",a1);};if(_){_.attachEvent("modelContextChange",a1);}return Y({context:$.context});},function($){if($&&$.response&&$.response.statusCode==="409"&&!k){a.removeTransientMessages();return u($).then(Y,Z);}else{q(a.operations.editEntity,Z,$,$);}});});});}E=function(i){var k=l.isDraftEnabled();var V,W;if(k){var X=l.getViewLevel();var Y;if(X>0){Y=l.getMainComponentDetails();var Z=S.oApplication.checkContextData(Y.bindingContext);if(!Z){S.oApplication.registerContext(Y.bindingContext,1,Y.entitySet,S.oApplication.getCurrentKeys(1));}W=l.getTargetKeyFromLevel(2);}if(!i){var $=S.oDraftController.getDraftContext();var _=$.hasPreserveChanges(Y.bindingContext);if(!_){V=u().then(x.bind(null,Y,true));}}V=V||x(Y,i,{});S.oApplication.editingStarted(Y.bindingContext,V);}else{var a1=o.getView().getBindingContext();V=Promise.resolve({context:a1});}var b1=Promise.all([V,W]);return b1.then(function(c1){var d1={};var e1=Object.keys(c1[0])[0];d1[e1]=c1[0][e1];d1.targetSiblingKey=c1[1];return d1;});};function y(i){if(p.isBusy()){return r;}var k=E(i);p.setBusy(k);return k;}function z(i,k,V){var W=new Promise(function(X,Y){var Z=function(){var a1=M.getEntitySetFromContext(V);var b1=S.oDraftController.getDraftContext();var c1=b1.isDraftRoot(a1);var d1=l.getViewLevel();var e1=d1>=2?n.getText("ITEM_DELETED"):n.getText("ST_GENERIC_OBJECT_DELETED");if(!i&&c1){e1=n.getText(k?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED");}a.showSuccessMessageIfRequired(e1,S);};var $=function(a1){if(a1.length===0){Z();X();}else{a.handleError(a.operations.deleteEntity,o,S,a1[0].oError,null);Y();}};var _=H({pathes:[V.getPath()],withWarningDialog:true});_.then($,Y);});return W;}function G(){var i=new Promise(function(k,V){var W=o.getView().getBindingContext();var X=S.oDraftController.isActiveEntity(W);var Y=S.oDraftController.hasActiveEntity(W);var Z=Y&&!X?S.oApplication.getDraftSiblingPromise(W):Promise.resolve();Z.then(function($){var _=z(X,Y,W);_.then(k,V);if(!X){var a1=function(){return{context:$};};var b1=_.then(a1);S.oApplication.cancellationStarted(W,b1,"deleteAction");}},V);});return i;}function P(k,V,W){var X={mFailed:Object.create(null),mSuccess:Object.create(null),mWarning:Object.create(null),aMessagesForUserDecision:[]};for(var i=0;i<k.length;i++){var Y=k[i];var Z=V[i];var $=a.parseError(Z);var _=parseInt($.httpStatusCode,10);var a1=Z&&Z.response&&Z.response.headers;if((_>=200&&_<300)||_===304){X.mSuccess[Y]=Z;}else if(_===412&&a1&&a1["preference-applied"]){X.mWarning[Y]=Z;}else{X.mFailed[Y]=Z;}}if(!c(X.mWarning)&&W){X.aMessagesForUserDecision=a.getTransientMessages();a.removeTransientMessages();}return X;}function H(i){var V=new Promise(function(W,X){var Y=Object.create(null);var Z=Object.create(null);var $=function(_,h1,i1){Z[_]={resolve:h1,reject:i1};};for(var k=0;k<i.pathes.length;k++){var _=i.pathes[k];Y[_]=new Promise($.bind(null,_));}S.oApplication.prepareDeletion(Y,i.suppressRefreshAllComponents);var a1=Object.create(null);var b1=Object.create(null);var c1;var d1=function(h1){if(!c(a1)){S.oApplication.markCurrentDraftAsModified();}for(var _ in Z){var i1=Z[_];i1[a1[_]?"resolve":"reject"]();}if(h1){return X();}var j1=i.pathes.map(function(_){return{sPath:_,oError:b1[_]||c1[_],isWarning:!!c1[_]};}).filter(function(k1){return!!k1.oError;});W(j1);};var e1=function(h1){if(h1.length>0){var i1=l.getCRUDActionHandler();var j1={messagesForUserDecison:h1};i1.handleCRUDScenario(4,f1.bind(null,Object.keys(c1),false,false),d1.bind(null,true),"Delete",j1);return;}d1();};var f1=function(h1,i1,g1){if(i.suppressRefreshAllComponents&&i.smartTable){n.refreshSmartTable(i.smartTable,"Changes");}var j1=function(l1){var m1=P(h1,l1,g1,i.onlyOneDraftPlusActive);b1=e(b1,m1.mFailed);a1=e(a1,m1.mSuccess);c1=m1.mWarning;e1(m1.aMessagesForUserDecision);};var k1=S.oTransactionController.deleteEntities(h1,{bIsStrict:i1}).then(j1,j1);p.setBusy(k1);};var g1=i.withWarningDialog&&(i.pathes.length===1||i.onlyOneDraftPlusActive);f1(i.pathes,true,g1);});return V;}function I(i){var k=S.oDraftController.hasActiveEntity(i);var V=k?S.oApplication.getDraftSiblingPromise(i):Promise.resolve();return V.then(function(W){var X=function(){return{context:W};};var Y=S.oTransactionController.deleteEntity(i);var Z=Y.then(X);S.oApplication.cancellationStarted(i,Z,"discardAction");return Y;});}function J(i){var k=S.oTransactionController.updateMultipleEntities(i);p.setBusy(k);return k;}function K(i,k,V){var W=k.getMessageModel();var X=W.bindList("/",null,null,[i]);var Y=X.getCurrentContexts().map(function(Z){return Z.getObject();});if(V){Y=Y.filter(function(Z){return!a.isMessageETagMessage(Z);});}return Y;}function L(i,k,V){if(p.isBusy()){k();return;}var W,X,Y=Object.create(null),X;W=sap.ui.getCore().getMessageManager();var Z=V?V:S.oTemplateCapabilities.oMessageButtonHelper&&S.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(false);X=K(Z,W,true);X=X.map(function(b1){Y[b1.getId()]=b1;return b1;});var $=o.getView().getModel();var _=function(){var b1=l.getCRUDActionHandler();b1.handleCRUDScenario(4,a1.bind(null,false),k,"Activate");};var a1=function(b1){if(b1){g($,"Prefer","handling=strict");}else{g($,"Prefer","handling=lenient");}var c1=S.oTransactionController.triggerSubmitChanges().then(function(d1){g($,"Prefer");W.removeMessages(X);i(d1.context);},function(d1){var e1=false;g($,"Prefer");var f1=[];var g1=K(Z,W,true);var h1=g1.map(function(i1){if(!Y[i1.getId()]){i1.persistent=false;i1.technical=false;e1=e1||i1.technicalDetails.statusCode==="412"&&i1.technicalDetails.headers["preference-applied"]==="handling=strict";f1.push(i1);}return i1;});if(f1.length){W.removeMessages(h1);W.addMessages(f1);if(e1&&b1){_();return;}if(!V){S.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();}}k();});p.setBusy(c1);};a1(true);}function N(i){var k=i;var V=new Promise(function(W,X){S.oApplication.performAfterSideEffectExecution(L.bind(null,W,X,k));});return V;}function O(i,k){if(p.isBusy()){return r;}var V=new Promise(function(W,X){var Y=i?i:o.getView().getBindingContext();var Z=k?k:S.oTemplateCapabilities.oMessageButtonHelper&&S.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(true);var $=sap.ui.getCore().getMessageManager();var _=false;var a1=function(){_=true;var b1=function(){var d1=K(Z,$);var e1=S.oDraftController.activateDraftEntity(Y,true);S.oApplication.activationStarted(Y,e1);e1.then(function(f1){W(f1);},function(f1){var g1=K(Z,$).filter(function(j1){return j1.type==="Error";});if(g1.length){var h1=g1[0];var i1=d1.some(function(j1){return h1===j1;});if(!i1){a.removeTransientMessages();}}a.handleError(a.operations.activateDraftEntity,o,S,f1,null);X();});p.setBusy(e1);};var c1=l.getCRUDActionHandler();c1.handleCRUDScenario(4,b1,X,"Activate");};S.oApplication.getDraftSiblingPromise(Y).then(function(b1){if(b1){o.getOwnerComponent().getModel().invalidateEntry(b1);}var c1=K(Z,$);var d1=v()?l.getRootExpand():null;var e1=S.oDraftController.activateDraftEntity(Y,false,d1);p.setBusy(e1);S.oApplication.activationStarted(Y,e1);e1.then(function(f1){$.removeMessages(c1);W(f1);},function(f1){var g1=K(Z,$);if(g1.length){var h1=g1[0];var i1=c1.some(function(j1){return h1===j1;});if(!i1){a.removeTransientMessages();}}if(!i){a.handleError(a.operations.activateDraftEntity,o,S,f1,null,{"412":a1});if(!_){X();}}});});});return V;}function Q(i){return new A(i);}function R(i,k,V,W){if(p.isBusy()){W();return;}var X=[];var Y=[];var Z=[];var $=false;var _;var a1=[];var b1=i.functionImportPath;var c1=i.contexts||[];var d1=i.sourceControl;if(c1.length===0&&d1){var e1=d1.getModel();var f1="/";var g1=d1.getEntitySet?d1.getEntitySet():d1.getParent().getEntitySet();var h1=f1.concat(g1);c1.push(new d(e1,h1));}var i1=i.label;var j1=i.operationGrouping;var k1=i.skipProperties;var l1=function(){if(c1[0]){var q1=c1[0].oModel;if(q1&&q1.hasPendingChanges()){q1.resetChanges();}}};var m1=function(q1){l1();W(q1);};var n1=function(q1,r1){if(q1.length>0){var s1=l.getCRUDActionHandler();var t1;if(c1.length===0){t1=p1.bind(null,false,false,c1);}else{var u1=c1.filter(function(v1,w1){return a1.includes(""+w1);});t1=p1.bind(null,false,false,u1);}var i={messagesForUserDecison:q1,actionName:i1};s1.handleCRUDScenario(4,t1,r1,"BOPFAction",i);return;}r1();};var o1=c1.length<=1;var p1=function(q1,o1,r1){if(!q1){l1();}var s1=Q({controller:o,contexts:r1,applicationController:S.oApplicationController,operationGrouping:j1});s1.call(b1,i1,l.isDraftEnabled(),k1,q1,_).then(function(v1){var w1={};w1.actionLabel=i1;p.setBusy(v1.executionPromise,null,w1);v1.executionPromise.then(t1,t1);},m1);var t1=function(v1){var w1=Array.isArray(v1)?v1:[v1];var x1=h(w1);var y1=w1.map(function(A1){var B1=A1.error||A1.response;if(B1){B1.actionContext=A1.actionContext;}return B1;});_=w1[0].userEnteredAdditionalParams;var z1=P(x1,y1,o1);Y=Y.concat(m(z1.mFailed));X=X.concat(m(z1.mSuccess));a1=Object.keys(z1.mWarning);Z=m(z1.mWarning);n1(z1.aMessagesForUserDecision,u1.bind(null,w1));};var u1=function(v1){var w1=Y.concat(X.concat(Z));if(w1.length>1){var x1=Z.length>0;var y1=Y.concat(Z);var z1=w1.length;var A1=y1.length;if(A1>0){var B1;if(z1===A1){B1=n.getText("ST_GENERIC_NOT_PROCESSED_RECORDS_PLURAL");}else{B1=n.getText("ST_GENERIC_NOT_PROCESSED_RECORDS",A1,z1);}if(x1){B1=B1+'\n';if(A1===1){B1=B1+n.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_SINGULAR");}else{B1=B1+n.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_PLURAL");}}p.getUnbusy().then(function(){if(Y.length>1){f.error(B1);}else{f.warning(B1);}});}}var C1,D1;$=$||s1.getExecutedSuccessfully();if($){var E1;if(X.length===1&&Z.length===0&&Y.length===0){C1=X[0];E1=v1[0].actionContext;}D1=C1&&C1.context;var F1;if(D1&&D1.getObject()){F1=S.oApplication.registerContext(D1);}if(D1&&D1!==E1&&D1.getPath()!=="/undefined"){S.oApplication.navigateToDetailContextIfPossible(D1,false,F1.bIsDraft?2*(1+F1.bIsCreate):1,F1);}var G1=n.getTableOrListBindingInfo(d1);var H1=G1&&G1.binding;if(H1&&H1.oEntityType){n.setEnabledToolbarButtons(d1);if(l.getViewLevel()===0){n.setEnabledFooterButtons(d1);}}V(w1);}else{l1();W(w1);}};};p1(true,o1,c1);}function T(i,k){var V=new Promise(function(W,X){S.oApplication.performAfterSideEffectExecution(R.bind(null,i,k,W,X));});return V;}function U(i,k){if(!i){throw new F(s,"Unknown Table");}var V="";var W="";var X;var Y=o.getOwnerComponent();var Z=Y.getAppComponent();if(Y.getMetadata().getName()==="sap.suite.ui.generic.template.ListReport.Component"){X=(Y.getCreationEntitySet&&Y.getCreationEntitySet())||(i.getEntitySet&&i.getEntitySet());}else{X=(Y.getCreationEntitySet&&Y.getCreationEntitySet())||Y.getEntitySet();}var $=o.getView();var _=$.getModel();var a1=$.getBindingContext();if(a1){W=n.getTableOrListBindingInfo(i).path;var b1=_.getMetaModel();var c1=b1.getODataEntitySet(X);var d1=b1.getODataEntityType(c1.entityType);var e1=b1.getODataAssociationSetEnd(d1,W);if(e1){X=e1.entitySet;}W="/"+W;V=Y.getComponentContainer().getElementBinding().getPath()+W;}else{V="/"+X;}return new Promise(function(f1,g1){var h1=b.getCacheKeyPartsAsyc(_);Promise.all(h1).then(function(i1){function j1(p1){S.oApplication.getBusyHelper().setBusy(p1);}var k1;if(v()){var l1=b.getCacheKey(Z.getId(),X,i1);k1=b.readFromLocalStorage(l1);}else{k1=null;}var m1=l.getSettings();var n1={sRootExpand:k1,oController:o,oApplicationController:S.oApplicationController,bUseNewActionForCreate:m1&&m1.useNewActionForCreate,fnSetBusy:j1};var o1=C.create(S.oDraftController,X,V,_,S.oApplication,k,n1);o1.catch(q.bind(null,a.operations.addEntry,function(p1){g1();if(p1){throw p1;}}));o1.then(function(p1){S.oApplication.markCurrentDraftAsModified();var i1=l.getCurrentKeys();i1.push(D.analyseContext(p1).key);var q1=i1.length-1;S.oApplication.registerContext(p1,q1,X,i1);f1(p1);});l.preloadComponent(X);});});}var q=t.testable(q,"handleError");var Q=t.testable(Q,"getActionUtil");return{editEntity:y,deleteEntity:G,deleteEntities:H,saveEntity:N,activateDraftEntity:O,discardDraft:I,callAction:T,addEntry:U,updateMultipleEntities:J};}return B.extend("sap.suite.ui.generic.template.lib.CRUDManager",{constructor:function(o,i,S,k,l){e(this,j(o,i,S,k,l));}});});
