// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/bootstrap/common/common.load.xhrlogon","sap/ushell/utils","./abap.bootstrap.utils","./abap.request.server.config","./abap.request.startup","./abap.request.pageset","./abap.xhr.handler","./abap.theme.handler","sap/ushell/EventHub","sap/ui/performance/trace/initTraces","sap/base/util/ObjectPath","sap/base/Log","sap/ushell/services/Container","sap/ui/Device","sap/ui2/srvc/utils"],function(x,u,a,r,s,p,X,t,E,i,O,L){"use strict";var b={};sap.ushell_abap.getShellType=function(){return u.hasNativeNavigationCapability()?"NWBC":"FLP";};sap.ushell_abap.bootstrap.addPostParametersToNavTargetResultUrl=function(P,U){if(P){U+=(U.indexOf("?")<0)?"?":"&";U+=P;}return U;};sap.ushell_abap.bootstrap.adjustNavTargetResult=function(R){if(R){var U=R.url,e,K={applicationType:R.applicationType,additionalInformation:R.applicationData},M,N,P,Q;if(R.text){K.text=R.text;}if((R.applicationType==="URL"||R.applicationType==="SAPUI5")){N=/^SAPUI5\.Component=(.*)/.exec(R.applicationData);M=N&&N[1];if(M||R.applicationDependencies){if(M){K.ui5ComponentName=M;}if(R.applicationDependencies){try{P=JSON.parse(R.applicationDependencies);Q=P.self;if(!K.ui5ComponentName&&Q.name){K.ui5ComponentName=Q.name;K.additionalInformation="SAPUI5.Component="+K.ui5ComponentName;}if(Q&&Q.url&&typeof Q.url==="string"){var T=sap.ui.require("sap/ui/thirdparty/URI");e=U&&new T(U);if(e){if(Q.url.toUpperCase().indexOf(e.path().toUpperCase())!==0){sap.ui2.srvc.log.debug("Component URL defined in target mapping "+"does not match the URL retrieved from application index. "+"The URL of the application index is used for further processing.","Target mapping URL: "+R.url+"\nApplication index URL: "+Q.url,"sap.ushell_abap.bootstrap.abap");}e.path(Q.url);U=e.toString();jQuery.sap.log.debug("ResolveLink result's component url has been replaced with the url specified "+"in Application Dependencies, which includes cache buster token");}else{U=Q.url;}}K.applicationDependencies=P;}catch(V){sap.ui2.srvc.log.error("Parsing of applicationDependencies attribute in resolveLink result failed for SAPUI5 component '"+M+"'",V,"sap.ushell_abap.bootstrap.abap");}}U=sap.ui2.srvc.addCacheBusterTokenUsingUshellConfig(U);}}K.url=U;return K;}};var c=new RegExp("^(#)?([A-Za-z0-9_]+)-([A-Za-z0-9_]+)"),S,o;function d(e){function K(e){if(!e){return false;}return e.indexOf("Shell-home")===0||e.indexOf("Launchpad-openFLPPage")===0||e.indexOf("Shell-appfinder")===0||e.indexOf("Shell-catalog")===0||e.indexOf("shell-catalog")===0||e.indexOf("Action-search")===0;}function M(){return window["sap-ushell_abap-bootstrap-abap-noInitialTarget"]!==undefined;}var N=e.match(c);var P=N&&N[2];var Q=N&&N[3];var R=e&&!K(e)&&!M()&&P&&Q;return R;}function g(){var e,K=a.getLocationHref(),M=K.indexOf("#");if(M<0){return"";}e=decodeURI(K.slice(M+1));return e;}function f(){var e=g(),K=e.indexOf("&/");return K<0?e:e.slice(0,K);}function h(e){var M=e.match(c);return M?{semanticObject:M[2],action:M[3]}:undefined;}function j(e){if(!e||e==="#"){return true;}return(e.indexOf("Shell-home")===0)||(e.indexOf("Launchpad-openFLPPage")===0)||(e.indexOf("Shell-appfinder")===0)||(e.indexOf("Shell-catalog")===0)||(e.indexOf("shell-catalog")===0);}function k(K){if(K===undefined){return undefined;}try{return JSON.parse(JSON.stringify(K));}catch(e){sap.ui2.srvc.log.error("Could not clone object",null,"sap.ushell_abap.bootstrap");return undefined;}}function l(T){return T.indexOf("sap_")===0;}function m(e,K){var M=sap.ui.getCore(),N=M.getConfiguration(),P=N.getFormatSettings();L.debug("setSapui5Settings()",JSON.stringify(e),"sap.ushell_abap.bootstrap.abap");if(e.language){N.setLanguage(e.language,e.ABAPLanguage);}if(e.legacyDateFormat){P.setLegacyDateFormat(e.legacyDateFormat);}if(e.legacyDateCalendarCustomizing){P.setLegacyDateCalendarCustomizing(e.legacyDateCalendarCustomizing);}if(e.legacyNumberFormat){P.setLegacyNumberFormat(e.legacyNumberFormat);}if(e.legacyTimeFormat){P.setLegacyTimeFormat(e.legacyTimeFormat);}if(typeof K==="object"){P.addCustomCurrencies(K);}}function n(e){(O.get("sap-ushell-config.services.Container.adapter.config")||O.create("sap-ushell-config.services.Container.adapter.config")).bootTheme=k(e);}function q(e){if(!e){sap.ui2.srvc.log.error("extractSystemThemeRoot: mandatory parameter oStartupServiceResult not supplied");}if(e.themeRoot){return e.themeRoot;}if(e.client){sap.ui2.srvc.log.warning("Theme root was not contained in startup service result. A fallback to /sap/public/bc/themes/~client-<client number> is used",null,"sap.ushell_abap.bootstrap");return"/sap/public/bc/themes/~client-"+e.client;}sap.ui2.srvc.log.error("extractSystemThemeRoot: Could not determine system theme root");}function v(e){var P,T;if(e&&e.userProfile&&e.userProfile.filter){P=e.userProfile.filter(function(K){return K.id==="THEME";});T=P.length?P[0]:{};if(T.value){return T.value;}}if(e&&e.theme){return e.theme;}return"";}function w(T,S){if(T&&l(T)){return"";}return S;}function y(e,S){var T;T=v(e);return{theme:T,root:w(T,S)};}function z(S){var T,e;T=a.getUrlParameterValue("sap-theme");if(T){if(T.indexOf("@")>0){e=T.split("@",2);return{theme:e[0],root:e[1]};}return{theme:T,root:w(T,S)};}return undefined;}function A(){var U=sap.ui2.srvc.getParameterMap()["sap-theme"]&&sap.ui2.srvc.getParameterMap()["sap-theme"][0];if(U){return U;}return undefined;}function B(e){var T=e;var K=e.indexOf("@");if(K>=0){var M=T.slice(K+1);return t.isThemeRootSafe(M);}return true;}function C(o,S){var U,e={},K,M=A();if(M&&B(M)){U=z(S);K=U;sap.ui2.srvc.log.debug("theme: URL theme = '"+K.theme+"' theme root = '"+K.root+"'",null,"sap.ushell_abap.bootstrap");if(K.root){sap.ui.getCore().setThemeRoot(K.theme,K.root.replace(/\/?$/,"/UI5/"));}}else if(o){K=o;sap.ui2.srvc.log.debug("theme: startup service theme = '"+K.theme+"' theme root = '"+K.root+"'",null,"sap.ushell_abap.bootstrap");if(K.root){sap.ui.getCore().applyTheme(K.theme,K.root+"/UI5/");}else{sap.ui.getCore().applyTheme(K.theme);}}else{e.theme=O.get("sap-ui-config.theme");if(e.theme){e.root=O.get("sap-ui-config.themeRoots."+e.theme||"");if(!e.root){e.root=w(e.theme,S);}K={theme:e.theme,root:e.root};sap.ui2.srvc.log.debug("theme: html file theme = '"+K.theme+"' theme root = '"+K.root+"'",null,"sap.ushell_abap.bootstrap");}else{K={theme:"",root:""};sap.ui2.srvc.log.error("Could not determine theme",null,"sap.ushell_abap.bootstrap");}}n(K);return K;}function D(e){var P=sap.ui2.srvc.getParameterMap(),R=a.getUrlParameterValue("sap-locale",P),U={},K;K=O.get("sap-ushell-config.services.SupportTicket.config")||O.create("sap-ushell-config.services.SupportTicket.config");if(K.enabled!==false){K.enabled=(e.isEmbReportingActive===true);}K=O.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config.services")||O.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config.services");K.targetMappings=e.services&&e.services.targetMappings;K=O.get("sap-ushell-config.services.LaunchPage.adapter.config.services")||O.create("sap-ushell-config.services.LaunchPage.adapter.config.services");K.targetMappings=e.services&&e.services.targetMappings;K.launchPage=e.services&&e.services.pbFioriHome;K=O.get("sap-ushell-config.services.VisualizationDataProvider.adapter")||O.create("sap-ushell-config.services.VisualizationDataProvider.adapter");K.module="sap.ushell_abap.adapters.abap.LaunchPageAdapter";K=O.get("sap-ushell-config.services.VisualizationDataProvider.adapter.config.services")||O.create("sap-ushell-config.services.VisualizationDataProvider.adapter.config.services");K.targetMappings=e.services&&e.services.targetMappings;K.launchPage=e.services&&e.services.pbFioriHome;K=O.get("sap-ushell-config.services.PageBuilding.adapter.config.services")||O.create("sap-ushell-config.services.PageBuilding.adapter.config.services");K.pageBuilding=e.services&&e.services.pbFioriHome;K=O.get("sap-ushell-config.services.Personalization.adapter.config.services")||O.create("sap-ushell-config.services.Personalization.adapter.config.services");K.personalization=e.services&&e.services.personalization;if(!R){U={language:e.languageBcp47||e.language,ABAPLanguage:e.language,legacyDateFormat:e.dateFormat,legacyDateCalendarCustomizing:e.tislcal,legacyNumberFormat:e.numberFormat===""?" ":e.numberFormat,legacyTimeFormat:e.timeFormat};}C(o,S);m(U,e.currencyFormats);}function F(e){var K=f(),M=g(),R=h(K),N=[R],P={},Q={},T;var U=O.get("sap-ushell-config.services.AppState.config")||O.create("sap-ushell-config.services.AppState.config");var V=O.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config")||O.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config");function W(Z,M){var $=M.match(Z);var a1=[];if(!$){return;}a1=($[2]).toString().split("=");Q[a1[0]]=a1[1];}function Y(Z,$,Q,a1,b1){if($&&$[b1]&&Q&&Q[a1]){Z[Q[a1]]=$[b1];}}if(d(K)){W(/(\?|&)(sap-xapp-state=[A-Z0-9]+)/,K);W(/(\?|&)(sap-intent-param=[A-Z0-9]+)/,K);W(/(\?|&)(sap-system=[A-Z0-9]+)/,K);W(/(\?|&|[/])(sap-iapp-state=[A-Z0-9]+)/,M);T=s.requestDirectStart(e,R,Q);U.initialAppStatesPromise=T.then(function(Z){Y(P,Z,Q,"sap-intent-param","iparState");Y(P,Z,Q,"sap-iapp-state","iappState");Y(P,Z,Q,"sap-xapp-state","xappState");U.initialAppStates=P;return Promise.resolve(P);});V.initialSegmentPromise=T.then(function(Z){if(Z.targetMappings){return Promise.resolve([N,Z.targetMappings,Z.systemAliases,Z.urlTemplates]);}return Promise.resolve(null);});}else{U.initialAppStatesPromise=Promise.resolve({});V.initialSegmentPromise=Promise.resolve(null);}}function G(){var P=new Promise(function(e,K){var R,M;M=function(){L.info("Direct application start: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(M);};E.once("ShellNavigationInitialized").do(function(){R=sap.ushell.Container.getRenderer();if(R){L.info("Direct application start: resolving component waitFor promise immediately (shell renderer already created).");e();}else{sap.ushell.Container.attachRendererCreatedEvent(M);}});});return P;}function H(M){var U=a.getUrlParameterValue("sap-ushell-reload"),e;if(U){if(U==="X"||U==="true"){e=true;}else{e=false;}}if(e!==undefined){(O.get("services.ShellNavigation.config",M)||O.create("services.ShellNavigation.config",M)).reload=e;}}function I(e,K,M){var N=f();i();D(e);K.forEach(function(P){a.mergeConfig(window["sap-ushell-config"],P,true);});H(window["sap-ushell-config"]);sap.ushell.bootstrap("abap",{abap:"sap.ushell_abap.adapters.abap",hana:"sap.ushell_abap.adapters.hana"}).done(function(){if(j(N)&&window["sap-ushell-config"].ushell&&window["sap-ushell-config"].ushell.spaces&&window["sap-ushell-config"].ushell.spaces.enabled){_(N);}var P=x.FrameLogonManager.getInstance();sap.ushell.Container.oFrameLogonManager=P;}).always(function(){if(d(N)){var R,P;window["sap-ushell-async-libs-promise-directstart"]=new Promise(function(Q,T){R=Q;P=T;});window["sap-ushell-async-libs-promise-directstart"].catch(function(Q){});sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(Q){Q.resolveHashFragment("#"+f()).done(function(T){var U=sap.ui.require("sap/ushell/services/AppConfiguration");U.setCurrentApplication(T);if(T&&T.ui5ComponentName){sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(V){V.createComponent(T,h(N),G(),"Application").done(function(W){R({resolvedHashFragment:W,dependenciesLoaded:true});}).fail(function(W){P(W);});});}else{R({resolvedHashFragment:T,dependenciesLoaded:false});}}).fail(function(T){P(T);});});}M();});}function _(e){if(e&&e.indexOf("Shell-appfinder")===0){return;}sap.ui.require(["sap/ushell/components/pages/controller/PagesAndSpaceId"],function(P){var K=P._getPageAndSpaceId(e);var M=sap.ushell.Container.getServiceAsync("PagePersistence");Promise.all([K,M]).then(function(R){var N=R[0];var Q=R[1];Q.getPage(N.pageId);}).catch(function(N){L.error(N);});});}function J(U){var e,R;X.initXhrLogon(window["sap-ushell-config"]);e=s.requestStartupConfig().then(function(K){var M=f();(O.get("sap-ushell-config.services.Container.adapter")||O.create("sap-ushell-config.services.Container.adapter")).config=K;var N=O.get("sap-ushell-config.services.LaunchPage.adapter.config")||O.create("sap-ushell-config.services.LaunchPage.adapter.config");var P=O.get("sap-ushell-config.services.ClientSideTargetResolution.adapter.config")||O.create("sap-ushell-config.services.ClientSideTargetResolution.adapter.config");if(O.get("sap-ushell-config.ushell.spaces.enabled")){O.set("sap-ushell-config.services.VisualizationDataProvider.adapter.config",N);O.set("sap-ushell-config.services.NavigationDataProvider.adapter.config",P);}F(K);S=q(K);o=y(K,S);if(!A()&&o){L.debug("theme: load theme from startup service via window",null,"sap.ushell_abap.bootstrap");}if(j(M)&&!O.get("sap-ushell-config.ushell.spaces.enabled")){p.requestPageSet(K);}var T=s.requestFullTM(K);P.navTargetDataPromise=T;N.compactTMPromise=T;return Promise.resolve(K);},function(M){L.error("start_up request failed: "+M,null,"sap.ushell_abap.bootstrap");return Promise.resolve({});});R=r().then(function(K){return Promise.resolve(K);},function(M){L.error("Could not load server configuration: "+M,null,"sap.ushell_abap.bootstrap.abap");return Promise.resolve([]);});Promise.all([e,R,U]).then(function(P){if(P[1]&&P[1].length>0){L.error("The usage of server side configuration files is deprecated.");}I.apply(null,P);});}b.start=J;b.bootstrap=I;b._getShellHash=f;b._getFullShellHash=g;b._createWaitForRendererCreatedPromise=G;b._loadPage=_;return b;});
