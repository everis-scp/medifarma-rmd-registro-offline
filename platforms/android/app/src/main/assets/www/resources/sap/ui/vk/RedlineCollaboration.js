/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Element","./Core","sap/ui/vk/tools/RedlineTool","./RedlineConversation","sap/ui/vk/uuidv4","sap/ui/vk/RedlineUpgradeManager"],function(E,v,R,a,u,b){"use strict";var c=E.extend("sap.ui.vk.RedlineCollaboration",{metadata:{library:"sap.ui.vk",aggregations:{conversations:{singularName:"conversation",type:"sap.ui.vk.RedlineConversation",multiple:true}},associations:{viewport:{type:"sap.ui.vk.Viewport",multiple:false},activeConversation:{type:"sap.ui.vk.RedlineConversation",multiple:false},activeComment:{type:"sap.ui.vk.RedlineComment",multiple:false}},events:{elementCreated:{parameters:{element:"object"}},elementClicked:{parameters:{elementId:"string"}},elementHovered:{parameters:{elementId:"string"}},conversationActivating:{parameters:{conversation:"sap.ui.vk.RedlineConversation"}},conversationActivated:{parameters:{conversation:"sap.ui.vk.RedlineConversation",viewportLocked:"boolean"}}}},constructor:function(i,p){E.apply(this,arguments);if(typeof i==="object"){p=i;i=undefined;}this._elementId=p&&p.elementId?p.elementId:u();}});c.prototype.init=function(){this._header=new Map();};c.prototype.exit=function(){if(this._tool){this._tool.destroy();}};c.prototype.getElementId=function(){return this._elementId;};c.prototype.setViewport=function(d){this.setAssociation("viewport",d);if(!this._tool){this._tool=new R();this._tool.attachElementCreated(this._onElementCreated,this);this._tool.attachElementClicked(this._onElementClicked,this);this._tool.attachElementHovered(this._onElementHovered,this);}else{this._tool.setActive(false,d);}d.addTool(this._tool);return this;};c.prototype._onElementHovered=function(e){this.fireElementHovered({elementId:e.getParameter("elementId")});};c.prototype._onElementCreated=function(e){var d=e.getParameter("element");if(this.getActiveConversation()){var f=sap.ui.getCore().byId(this.getActiveConversation());f.addContent(d);this._tool.destroyRedlineElements();f._activate(this._tool);}if(this.getActiveComment()){var g=sap.ui.getCore().byId(this.getActiveComment());g.addContent(d);}this.fireElementCreated({element:d});};c.prototype._onElementClicked=function(e){this.fireElementClicked({elementId:e.getParameter("elementId")});};c.prototype.setHeaderProperty=function(k,d){this._header.set(k,d);return this;};c.prototype.getHeaderProperty=function(k){return this._header.get(k);};c.prototype.removeHeaderProperty=function(k){this._header.delete(k);return this;};c.prototype.createConversation=function(n){var d=new a({conversationName:n});this.addConversation(d);this.setActiveConversation(d);return d;};c.prototype.setActiveConversation=function(d){var e=sap.ui.getCore().byId(this.getActiveConversation());if(e){e._deactivate();}this.setAssociation("activeConversation",d);var f=sap.ui.getCore().byId(this.getViewport());if(!d){this._tool.setActive(false,f);return this;}this.fireConversationActivating({conversation:d});this._tool.destroyRedlineElements();if(d.getViewInfo()){if(!this._tool.getActive()){this._tool.setActive(true,f);}var s=sap.ui.getCore().byId(f.getContentConnector()).getContent();var g=s.getViews();var h;for(var j=0;j<g.length;j++){if(g[j].getViewId()===d.getViewId()){h=g[j];}}if(h){v.getEventBus().subscribe("sap.ui.vk","readyForAnimation",this._readyForAnimation,this);var i=sap.ui.getCore().byId(f.getViewStateManager());var k=sap.ui.getCore().byId(i.getViewManager());k.setAutoPlayAnimation(false);k.activateView(h);}}else if(this._tool.getActive()){this._tool.setActive(false,f);}if(d.getContent()){d._activate(this._tool);}this.fireConversationActivated({conversation:d,viewportLocked:this._tool.getActive()});return this;};c.prototype._readyForAnimation=function(){var d=sap.ui.getCore().byId(this.getViewport());var e=sap.ui.getCore().byId(this.getActiveConversation());if(e){var f=sap.ui.getCore().byId(d.getViewStateManager()).getAnimationPlayer();f.setTime(e.getAnimationOffset());var g=e.getViewInfo();d.setViewInfo(g);}v.getEventBus().unsubscribe("sap.ui.vk","readyForAnimation",this._readyForAnimation,this);var h=sap.ui.getCore().byId(d.getViewStateManager());var i=sap.ui.getCore().byId(h.getViewManager());i.setAutoPlayAnimation(true);};c.prototype.createElement=function(r){var d=sap.ui.getCore().byId(this.getActiveConversation());var e=sap.ui.getCore().byId(this.getViewport());if(d&&!d.getViewInfo()){var q={camera:{matrices:true},visibility:true,selection:true};var f=e.getViewInfo(q);d.setViewId(e.getCurrentView().getViewId());d.setViewInfo(f);d.setAnimationOffset(sap.ui.getCore().byId(e.getViewStateManager()).getAnimationPlayer().getTime());}if(!this._tool.getActive()){this._tool.setActive(true,e);}this._tool.startAdding(r);return r;};c.prototype.deactivateRedlineDrawing=function(){if(this._tool){this._tool.stopAdding();}return this;};c.prototype.removeElement=function(r){var d=sap.ui.getCore().byId(this.getActiveConversation());if(d){d.removeContent(r);this._tool.destroyRedlineElements();d._activate(this._tool);}return this;};c.prototype._normalizeElementsArray=function(e){var n=[];var d=this.getActiveRedlineElements();if(Array.isArray(e)){for(var i=0;i<e.length;i++){if(e[i]instanceof sap.ui.vk.RedlineElement){n.push(e[i]);}else{for(var j=0;j<d.length;j++){if(e[i]===d[j].getElementId()){n.push(d[j]);}}}}}else if(e instanceof sap.ui.vk.RedlineElement){n.push(e);}else{for(var k=0;k<d.length;k++){if(e===d[k].getElementId()){n.push(d[k]);}}}return n;};c.prototype.setHighlight=function(e,d){if(!e){return this;}var n=this._normalizeElementsArray(e);for(var i=0;i<n.length;i++){var f=n[i];f.setHalo(true);if(d){f.setHaloColor(d);}else if(this._tool._haloColor){f.setHaloColor(this._tool._haloColor);}else{f.setHaloColor("rgba(255, 0, 0, 1)");}}var g=sap.ui.getCore().byId(this.getActiveConversation());if(g){this._tool.destroyRedlineElements();g._activate(this._tool);}return this;};c.prototype.setDefaultHighlightColor=function(d){if(d){this._tool._haloColor=d;}return this;};c.prototype.clearHighlight=function(e){if(!e){return this;}var n=this._normalizeElementsArray(e);for(var i=0;i<n.length;i++){n[i].setHalo(false);}var d=sap.ui.getCore().byId(this.getActiveConversation());if(d){this._tool.destroyRedlineElements();d._activate(this._tool);}return this;};c.prototype.addStyleClass=function(d){if(d&&this._tool){this._tool.getGizmo().addStyleClass(d);}return this;};c.prototype.removeStyleClass=function(d){if(d&&this._tool){this._tool.getGizmo().removeStyleClass(d);}return this;};c.prototype.toggleStyleClass=function(d){if(d&&this._tool){this._tool.getGizmo().toggleStyleClass(d);}return this;};c.prototype.freezeView=function(){var d=sap.ui.getCore().byId(this.getActiveConversation());var e=sap.ui.getCore().byId(this.getViewport());if(d&&!d.getViewInfo()){var q={camera:{matrices:true},visibility:true,selection:true};var r=e.getViewInfo(q);d.setViewId(e.getCurrentView().getViewId());d.setViewInfo(r);d.setAnimationOffset(sap.ui.getCore().byId(e.getViewStateManager()).getAnimationPlayer().getTime());}if(!this._tool.getActive()){this._tool.setActive(true,e);}return this;};c.prototype.unfreezeView=function(){var d=sap.ui.getCore().byId(this.getActiveConversation());if(d){var e=d.getComments();if(this._tool.getActive()&&this._tool.getRedlineElements().length===0&&(e.length===0||(e.length===1&&!e[0].getText()))){this._tool.setActive(false);d.setViewInfo(null);}}return this;};c.prototype.getActiveRedlineElements=function(){if(this._tool){var e=this._tool.getRedlineElements();return e;}};c.prototype._createConversationFromJSON=function(j){var d=new a();var e=d.importJSON(j);this.addConversation(d);return e;};c.prototype.importJSON=function(d){d=b.upgrade(d);var e=new Set();this.setActiveConversation(null);this.destroyConversations();this.setActiveComment(null);var h=Object.entries(d.header);for(var i=0;i<h.length;i++){this.setHeaderProperty(h[i][0],h[i][1]);}this._elementId=this.getHeaderProperty("elementId");var f=d.conversations;if(f){for(var j=0;j<f.length;j++){var g=this._createConversationFromJSON(f[j]);g.forEach(e.add,e);}}var l=this.getHeaderProperty("initialConversation");var m=this.getConversations();var n;if(m){for(var k=0;k<m.length;k++){if(m[k].getElementId()===l){n=m[k];break;}}}this.setActiveConversation(n);return e;};c.prototype.exportJSON=function(){var d="";if(this.getActiveConversation()){d=sap.ui.getCore().byId(this.getActiveConversation()).getElementId();}this.setHeaderProperty("initialConversation",d);if(!this.getHeaderProperty("elementId")){this.setHeaderProperty("elementId",this._elementId);}var h=Object.fromEntries(this._header);var j={schemaVersion:"1.0",header:h,conversations:this.getConversations().map(function(e){return e.exportJSON();})};return j;};c.prototype.destroy=function(){if(this._tool.getActive()){this._tool.setActive(false);}};return c;});
