/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/core/PageController","sap/fe/core/controllerextensions/SideEffects","sap/fe/core/controllerextensions/EditFlow","sap/fe/macros/field/FieldRuntime","sap/base/Log","sap/base/util/ObjectPath","sap/fe/navigation/SelectionVariant","sap/fe/core/CommonUtils","sap/ui/mdc/p13n/StateUtil","sap/fe/macros/table/Utils","sap/fe/macros/ResourceModel","sap/fe/core/controllerextensions/InternalRouting","sap/ui/Device","sap/fe/core/controllerextensions/IntentBasedNavigation","./overrides/IntentBasedNavigation","sap/fe/core/controllerextensions/InternalIntentBasedNavigation","sap/fe/macros/chart/ChartRuntime","sap/fe/templates/ListReport/ExtensionAPI","sap/fe/macros/filter/FilterUtils","sap/fe/macros/chart/ChartUtils","sap/fe/macros/visualfilters/VisualFilterUtils","sap/fe/macros/DelegateUtil","sap/ui/core/mvc/OverrideExecution","sap/fe/core/controllerextensions/ViewState","./overrides/ViewState","sap/fe/templates/RootContainer/overrides/EditFlow","sap/fe/core/helpers/EditState","sap/ui/model/json/JSONModel","sap/fe/core/library","sap/fe/core/helpers/SemanticDateOperators","sap/fe/core/controllerextensions/Share","./overrides/Share","sap/fe/macros/CommonHelper","sap/fe/core/controllerextensions/KPIManagement"],function(P,S,E,F,L,O,a,C,b,T,R,I,D,c,d,e,f,g,h,j,V,l,m,n,o,p,q,J,r,s,t,u,v,K){"use strict";var w=r.TemplateContentView,x=r.InitialLoadMode;return P.extend("sap.fe.templates.ListReport.ListReportController",{metadata:{methods:{getExtensionAPI:{"public":true,"final":true},onPageReady:{"public":false,"final":false,overrideExecution:m.After},onViewNeedsRefresh:{"public":true,"final":false,overrideExecution:m.After},onPendingFilters:{"public":true,"final":false,overrideExecution:m.After}}},_routing:I.override({onAfterBinding:function(i,k){this.getView().getController()._onAfterBinding(i,k);}}),_intentBasedNavigation:e.override({getEntitySet:function(){return this.base.getCurrentEntitySet();}}),sideEffects:S,intentBasedNavigation:c.override(d),share:t.override(u),editFlow:E.override(p),viewState:n.override(o),kpiManagement:K,getExtensionAPI:function(){if(!this.extensionAPI){this.extensionAPI=new g(this);}return this.extensionAPI;},onInit:function(){P.prototype.onInit.apply(this);var i=this;var k=this._getTables();var y=this.getView().getBindingContext("internal");if(i._isMultiMode()){var M=i._getMultiModeControl();y.setProperty("tabs",{selected:M.getSelectedKey()||M.getItems()[0].getKey()});k.forEach(function(A){var U=function(){i._updateCounts();};T.addEventToBindingInfo(A,"dataRequested",U);});}y.setProperty("hasPendingFilters",true);y.setProperty("appliedFilters","");y.setProperty("uom",{});y.setProperty("scalefactor",{});y.setProperty("scalefactorNumber",{});if(this._hasMultiVisualizations()){var z=this._getDefaultPath();if(!D.system.desktop&&z===w.Hybrid){z=w.Chart;}y.setProperty("alpContentView",z);}this.filterBarConditions={};this.getAppComponent().getRouterProxy().waitForRouteMatchBeforeNavigation();this._updateMultiTableHiddenStatus();h.attachConditionHandling(this._getFilterBarControl());},onExit:function(){h.detachConditionHandling(this._getFilterBarControl());delete this._sEntitySet;delete this.filterBarConditions;delete this._oListReportControl;delete this._bMultiMode;this.extensionAPI&&this.extensionAPI.destroy();delete this.extensionAPI;},_onAfterBinding:function(){var i=this._getTables();var k=this;if(q.isEditStateDirty()){var y=this._getTableBinding();if(y){if(!this.sUpdateTimer){this.sUpdateTimer=setTimeout(function(){y.refresh();delete k.sUpdateTimer;},0);}var U=function(){k._updateTableActions(i);y.detachDataReceived(U);};y.attachDataReceived(U);}q.setEditStateProcessed();}if(!this.sUpdateTimer){this._updateTableActions(i);}this.pageReady.waitFor(this.getAppComponent().getAppStateHandler().applyAppState());},onAfterRendering:function(i){var k=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(y){k.oResourceBundle=y;var z=k._getTables();var A=k.getView().getViewData().entitySet;var B=C.getTranslatedText("T_OP_TABLE_AND_CHART_NO_DATA_TEXT",k.oResourceBundle,undefined,A);z.forEach(function(H){H.setNoDataText(B);});if(k._hasMultiVisualizations()){var G=k.getChartControl();G.setNoDataText(B);}}).catch(function(y){L.error("Error while retrieving the resource bundle",y);});},onPageReady:function(i){var k=i.lastFocusedControl;var y=this.getView();if(k&&k.controlId&&k.focusInfo){var z=y.byId(k.controlId);if(z){z.applyFocusInfo(k.focusInfo);}}var A=this._getFilterBarControl();if(A&&!A.getShowMessages()){A.setShowMessages(true);A._setFocusOnFirstErroneousField();}},onViewNeedsRefresh:function(i){},onPendingFilters:function(){},getCurrentEntitySet:function(){if(!this._sEntitySet){var i=this._getCurrentTable();this._sEntitySet=i.data("targetCollectionPath").slice(1);}return this._sEntitySet;},_updateTableActions:function(i){var k=[];i.forEach(function(y){k=C.getIBNActions(y,k);T.getSemanticTargetsFromTable(this,y);var z=y.getBindingContext("internal"),A=JSON.parse(v.parseCustomData(l.getCustomData(y,"operationAvailableMap"))),B=y.getSelectedContexts();C.setActionEnablement(z,A,B);}.bind(this));C.updateDataFieldForIBNButtonsVisibility(k,this.getView());},_scrollTablesToRow:function(k){var y,z,A,B;if(this._getTables&&this._getTables().length>0){y=this._getTables();for(var i=0;i<y.length;i++){z=y[i];B=z.getRowBinding();if(B){var G;switch(z.data().tableType){case"GridTable":G=B.getContexts(0);break;case"ResponsiveTable":G=B.getCurrentContexts();break;default:}A=G.find(function(M){return M&&M.getPath().indexOf(k)!==-1;});}if(A){var H=A.iIndex;z.scrollToIndex(H);}}}},_getPageTitleInformation:function(){var i=this;return new Promise(function(k,y){var z={title:"",subtitle:"",intent:"",icon:""};z.title=i.getView().getContent()[0].data().ListReportTitle;z.subtitle=i.getView().getContent()[0].data().ListReportSubtitle;k(z);});},_getFilterBarControl:function(){return this.getView().byId(this._getFilterBarControlId());},_getSegmentedButton:function(i){return this.getView().byId(this._getSegmentedButtonId(i));},_getSegmentedButtonId:function(i){if(i==="Chart"){return this.getChartControl().data("segmentedButtonId");}else{return this._getCurrentTable().data("segmentedButtonId");}},_getFilterBarControlId:function(){return this.getView().getContent()[0].data("filterBarId");},_getChartControlId:function(){return this.getView().getContent()[0].data("singleChartId");},getChartControl:function(){return this.getView().byId(this._getChartControlId());},_getVisualFilterBarControl:function(){return this.getView().byId(this._getVisualFilterBarControlId());},_getVisualFilterBarControlId:function(){return this.getView().getContent()[0].data("visualFilterBarId");},_getMultiModeControl:function(){return this.getView().byId("fe::TabMultipleMode");},_getTableControlId:function(){return this.getView().getContent()[0].data("singleTableId");},_getCurrentTable:function(){if(!this._oListReportControl){var M=this._getMultiModeControl();if(M){this._oListReportControl=this.getView().byId(M.getSelectedKey()||M.getItems()[0].getKey());}else{this._oListReportControl=this.getView().byId(this._getTableControlId());}}return this._oListReportControl;},_getTableBinding:function(i){var k=i?this.getView().byId(i):this._getCurrentTable(),B=k&&k._getRowBinding();return B;},_getTables:function(){var i=this;if(this._isMultiMode()){var k=[];var y=this._getMultiModeControl();y.getItems().forEach(function(z){var A=i.getView().byId(z.getKey());if(A){k.push(A);}});return k;}return[this._getCurrentTable()];},_getDefaultPath:function(){var i=this.getView().getContent()[0].data("defaultPath");switch(i){case"primary":return w.Chart;case"secondary":return w.Table;case"both":default:return w.Hybrid;}},_isMultiMode:function(){if(!this._oListReportControl){this._bMultiMode=!!this._getMultiModeControl();}return this._bMultiMode;},_isMultiEntitySets:function(){return(this.getView().getContent()[0].data("isMultiEntitySets")==="true");},_hasMultiVisualizations:function(){return(this.getView().getContent()[0].data("hasMultiVisualizations")==="true");},_setShareModel:function(){var G=O.get("sap.ushell.Container.getUser");var i={bookmarkTitle:document.title,bookmarkCustomUrl:function(){var H=window.hasher.getHash();return H?"#"+H:window.location.href;},isShareInJamActive:!!G&&G().isJamActive()};var k=this.getOwnerComponent().getModel("_templPriv");k.setProperty("/listReport/share",i);},_updateMultiTableHiddenStatus:function(){var i=this._getCurrentTable();if(this._isMultiMode()&&i){var k=i.getId();var y=this._getTables();y.forEach(function(z){var A=z.getId();z.data("tableHidden",A!==k);});}},_updateMultiNotApplicableFields:function(i,k){var y={};var z={},A=this._getTables();A.forEach(function(B){var G=B.data("targetCollectionPath"),H=G.slice(1),M=B.getParent().getParent().getKey(),N=H+(B.data("enableAnalytics")==="true"?"Analytical":"Regular");if(!y[N]){y[N]=h.getNotApplicableFiltersForTable(k,B);}z[M]=y[N];});i.setProperty("tabs/ignoredFields",z);},_updateTableControl:function(){this._sEntitySet=undefined;this._oListReportControl=undefined;this._getCurrentTable();},_updateCounts:function(){this._updateMutliModeCounts();},_isCustomTab:function(){var M=this._getMultiModeControl();return M&&M.getSelectedKey().indexOf("::CustomTab::")>-1;},_updateMutliModeCounts:function(){var i=this;var B=[];var M=this._getMultiModeControl();if(M&&M.data("showCounts")==="true"&&!this._isCustomTab()){var y=this._getCurrentTable();var z=y.getId();var A=[];var G=M.getItems();G.forEach(function(k){var H=i.getView().byId(k.getKey());if(H&&(k.data("outdatedCounts")||H.getId()===z)){A.push({table:H,item:k});}});B=A.map(function(k){k.item.setCount("...");var H=k.table;var N=T.getFiltersInfoForSV(H,k.item.data("selectionVariant"));return T.getListBindingForCount(H,i.getView().getBindingContext(),{batchGroupId:H.getId()===z?H.data("batchGroupId"):"$auto",additionalFilters:N.filters});});Promise.all(B).then(function(H){for(var k in H){var N=A[k].item;N.setCount(T.getCountFormatted(H[k]));N.data("outdatedCounts",false);}}).catch(function(k){L.error("Error while retrieving the values for the icon tab bar",k);});}},_shouldAutoTriggerSearch:function(i){if(this.getView().getViewData().initialLoad===x.Auto&&(!i||i.getStandardVariantKey()===i.getCurrentVariantKey())){var k=this._getFilterBarControl(),y=k.getConditions();for(var z in y){if(!z.startsWith("$")&&Array.isArray(y[z])&&y[z].length){return true;}}}return false;},_updateTable:function(i){if(!i.isTableBound()||this.hasPendingChartChanges){i.rebindTable();this.hasPendingChartChanges=false;}},_updateChart:function(i){if(!i.isInnerChartBound()||this.hasPendingTableChanges){i.getControlDelegate().rebindChart(i,i.getBindingInfo("data"));this.hasPendingTableChanges=false;}},handlers:{onTabMultiModeChange:function(i){this._updateTableControl();this._updateMultiTableHiddenStatus();var k=this._getFilterBarControl();var y=this.getView().getBindingContext("internal");var z=this._getCurrentTable();var M=this._getMultiModeControl();y.setProperty("tabs/selected",M.getSelectedKey());if(k&&y.getProperty("hasPendingFilters")!==true){if(this._isCustomTab()){var A=k.getFilterConditions();this.onViewNeedsRefresh({filterConditions:A,currentTabId:M.getSelectedKey(),refreshCause:"tabChanged"});}else if(!z.getRowBinding()||z.data("outdatedRows")===true){z.rebindTable();z.data("outdatedRows",false);}}this.getExtensionAPI().updateAppState();},onFiltersChanged:function(i){var k=i.getSource(),y=this.getView().getBindingContext("internal");this.onPendingFilters();y.setProperty("appliedFilters",k.getAssignedFiltersText().filtersText);y.setProperty("hasPendingFilters",true);if(i.getParameter("conditionsBased")){this.getExtensionAPI().updateAppState();}},onVariantSelected:function(i){var k=this,y=i.getSource();setTimeout(function(){if(k._shouldAutoTriggerSearch(y)){return k._getFilterBarControl().triggerSearch();}else{k.getExtensionAPI().updateAppState();}},0);},onVariantSaved:function(i){var k=this;setTimeout(function(){k.getExtensionAPI().updateAppState();},1000);},onSearch:function(i){var k=this;var y=i.getSource();var z=this.getView().getBindingContext("internal");var M=this.getChartControl();z.setProperty("hasPendingFilters",false);if(this._isMultiMode()){var A=this._getTables(),B=this._getMultiModeControl();if(B&&B.data("showCounts")==="true"){var G=B.getItems();G.forEach(function(W){W.data("outdatedCounts",true);});}if(!this._isCustomTab()){var H=this._getCurrentTable().getId();this._updateMultiNotApplicableFields(z,y);A.forEach(function(W){W.data("outdatedRows",W.getId()!==H);});}else{var N=y.getFilterConditions();this.onViewNeedsRefresh({filterConditions:N,currentTabId:B.getSelectedKey(),refreshCause:"search"});}}if(M){M.getBindingContext("internal").setProperty("",{});var Q=M.getBindingContext("pageInternal");var U=Q.getProperty(Q.getPath()+"/alpContentView");if(U===w.Chart){this.hasPendingChartChanges=true;}if(U===w.Table){this.hasPendingTableChanges=true;}}b.retrieveExternalState(y).then(function(W){k.filterBarConditions=W.filter;}).catch(function(W){L.error("Error while retrieving the external state",W);});if(this.getView().getViewData().liveMode===false){this.getExtensionAPI().updateAppState();}},onChevronPressNavigateOutBound:function(i,k,y){var z=i.getAppComponent().getRoutingService().getOutbounds(),A=z[k];if(A&&A.semanticObject&&A.action){y=y&&y.isA&&y.isA("sap.ui.model.odata.v4.Context")?[y]:y;i._intentBasedNavigation.navigate(A.semanticObject,A.action,{navigationContexts:y});return Promise.resolve();}else{throw new Error("outbound target "+k+" not found in cross navigation definition of manifest");}},onChartSelectionChanged:function(i){var M=i.getSource(),k=this._getCurrentTable(),y=i.getParameter("dataContext"),z=this.getView().getBindingContext("internal");if(y&&y.data){f.fnUpdateChart(i);j.setChartFilters(M);}var A=z.getProperty(z.getPath()+"/alpContentView");if(A===w.Chart){this.hasPendingChartChanges=true;}else{k&&k.rebindTable();this.hasPendingChartChanges=false;}},onSegmentedButtonPressed:function(i){var k=i.mParameters.key?i.mParameters.key:null;var y=this.getView().getBindingContext("internal");y.setProperty("alpContentView",k);var z;var A=this.getChartControl();var B=this._getCurrentTable();var G={onAfterRendering:function(){var H=z.getItems();H.forEach(function(M){if(M.getKey()===k){M.focus();}});z.removeEventDelegate(G);}};z=k===w.Table?this._getSegmentedButton("Table"):this._getSegmentedButton("Chart");if(z!==i.getSource()){z.addEventDelegate(G);}switch(k){case w.Table:this._updateTable(B);break;case w.Chart:this._updateChart(A);break;case w.Hybrid:this._updateTable(B);this._updateChart(A);break;default:break;}this.getExtensionAPI().updateAppState();},onFiltersSegmentedButtonPressed:function(i){if(i.getParameter("key")==="Compact"){this._getFilterBarControl().setVisible(true);this.getView().byId(this.getView().getContent()[0].data("visualFilterBarId")).setVisible(false);}else{this._getFilterBarControl().setVisible(false);this.getView().byId(this.getView().getContent()[0].data("visualFilterBarId")).setVisible(true);}},onVisualFilterDataReceived:function(i){var k=this._getFilterBarControl();var y=V.getVisualFilterControl(k,i.getSource());var z=this.getView().getBindingContext("internal");var A=y.getId().split("fe::VisualFilter");var B="fe::VisualFilter"+A[1];var G=sap.ui.getCore().getLibraryResourceBundle("sap.fe.macros");var U=y.data("uom");V.updateChartScaleFactorTitle(y,this.getView());if(i.getParameter("error")){var H=G.getText("M_VISUAL_FILTERS_ERROR_DATA_TEXT");V.applyOverLay(H,B,this.getView());}else if(i.getParameter("data")){var M=i.getSource().getCurrentContexts();if(M&&M.length===0){V.setNoDataMessage(B,G,this.getView());}else{z.setProperty(B,{});}V.setMultiUOMMessage(M,y,B,G,this.getView());}if(U&&((U["ISOCurrency"]&&U["ISOCurrency"].$Path)||(U["Unit"]&&U["Unit"].$Path))){var N=i.getSource().getContexts();var Q=N&&N[0].getObject();V.applyUOMToTitle(y,Q,this.getView());}}},formatters:{setTabMessageStrip:function(i,k){var y="";if(Array.isArray(i)&&i.length>0&&k){var z=this._getFilterBarControl(),A=z.data("entityType"),M=this.getView().getModel().getMetaModel(),B=sap.ui.getCore().getLibraryResourceBundle("sap.fe.templates"),G=i.map(function(Q){if(Q==="$search"){var U=sap.ui.getCore().getLibraryResourceBundle("sap.fe.macros");return U?U.getText("M_FILTERBAR_SEARCH"):"";}var W=M.getObject(A+Q+"@com.sap.vocabularies.Common.v1.Label");return l.getLocalizedText(W,z);});if(B){var H="C_LR_MULTITABLES_"+(G.length===1?"SINGLE":"MULTI")+"_IGNORED_FILTER_"+(D.system.desktop?"LARGE":"SMALL"),N=l.getLocalizedText(k,z);y=B.getText(H,[G.join(", "),N]);}}return y;},scaleVisualFilterValue:function(i,k){if(k){var y=V.getFormattedNumber(i,k);return y;}else{return i;}}}});});
