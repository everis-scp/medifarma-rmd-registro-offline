sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject"],function(B,F,M,S,a,c,m,b,t,e,d,D,f){"use strict";var l=new b("lib.multipleViews.MultipleViewsHandler").getLogger();function g(C,T,o){var s=Object.create(null);var h=T.oComponentUtils.getTemplatePrivateModel();var p=o.pathInTemplatePrivateModel+"/items";var P=o.pathInTemplatePrivateModel+"/selectedKey";h.setProperty(o.pathInTemplatePrivateModel,Object.create(null));h.setProperty(p,Object.create(null));var I=new(o.smartControl?S:M)(C,T,o);h.setProperty(o.pathInTemplatePrivateModel+"/mode",I.getMode());var k=T.oServices.oApplication.getBusyHelper().getBusyDelay();var n=C.getOwnerComponent().getModel();var q;var r;var u;function U(){if(r){var i=o.getSearchValue&&o.getSearchValue();var j=i?{search:i}:{};for(var c1 in s){var d1=s[c1];var e1=d1.getPath();d1.numberOfUpdates++;d1.updateStartFunction(d1.numberOfUpdates);n.read(e1+"/$count",{urlParameters:j,filters:d1.getFiltersForCount(),groupId:"updateMultipleViewsItemsCounts",success:d1.updateSuccessFunction.bind(null,d1.numberOfUpdates),error:d1.errorFunction.bind(null,d1.numberOfUpdates)});}}}function R(i,j){var c1="";var d1=j["parameters"];if(!j||!j.entitySetName||!j.navPropertyName||d1.length<1){c1="/"+i.name;return c1;}var e1=o.smartFilterBar&&o.smartFilterBar.getAnalyticalParameters();if(e1&&e1.length>0){var f1=o.smartFilterBar&&o.smartFilterBar.getUiState({allFilters:false});var g1=f1?JSON.stringify(f1.getSelectionVariant()):"{}";var h1=new a(g1);var i1=[];d1.forEach(function(j1){e1.forEach(function(k1){if(k1&&(k1.name===j1)){var l1=k1.name;var m1=h1.getParameter(l1);if(k1.type==='Edm.DateTime'){m1=new Date(m1);m1=D.localToUtc(m1);m1=d(k1.control.getModel().formatValue(m1,k1.type));i1.push(l1+'='+m1);}else{i1.push(l1+'='+"'"+m1+"'");}}});});c1='/'+j.entitySetName+'('+i1.join(',')+')/'+j.navPropertyName;}else{c1="/"+i.name;l.error("SelectionParameters","There are no parameters to resolve");return c1;}return c1;}function G(i){var j;var c1=i.getEntitySet();var d1=C.getOwnerComponent();if(o.smartFilterBar&&o.smartFilterBar.getConsiderAnalyticalParameters&&o.smartFilterBar.getConsiderAnalyticalParameters()){var e1=n.getMetaModel();var f1=e1.getODataEntitySet(c1);var g1=d1.getAppComponent();var h1=m.getParametersByEntitySet(g1.getModel(),c1);j=R(f1,h1);return j;}var i1=i.getTableBindingPath?i.getTableBindingPath():i.getChartBindingPath();j=i1?i1:"/"+c1;var j1=d1.getComponentContainer();var k1=j1.getElementBinding();return k1?k1.getPath()+'/'+j:j;}function v(c1,d1){var e1=n.getMetaModel();var f1=c1.getEntitySet();var g1=e1.getODataEntitySet(f1);var h1=e1.getODataEntityType(g1.entityType);var i1=[],j1;var k1=d1.variantAnnotationPath;if(k1){var l1=h1[k1];if(!l1){return[];}if(!l1.SelectOptions&&l1.SelectionVariant){l1=l1.SelectionVariant;if(l1.Path){k1=l1.Path.split("@")[1];l1=k1&&h1[k1];}}if(l1.AnnotationPath){j1=l1.AnnotationPath.split("@")[1];l1=h1[j1];}for(var i in l1.SelectOptions){if(l1.SelectOptions[i].PropertyName){var m1=l1.SelectOptions[i].PropertyName.PropertyPath;for(var j in l1.SelectOptions[i].Ranges){var n1=l1.SelectOptions[i].Ranges[j].Sign;var o1=l1.SelectOptions[i].Ranges[j].Option;if(n1){o1.EnumMember=w(n1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeSignType/",""),o1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/",""));}else{o1.EnumMember=o1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");}var p1=l1.SelectOptions[i].Ranges[j].Low;var q1=l1.SelectOptions[i].Ranges[j].High;var r1=Object.keys(p1)[0];if(q1){var s1=Object.keys(q1)[0];i1.push(new F(m1,o1.EnumMember,p1[r1],q1[s1]));}else{i1.push(new F(m1,o1.EnumMember,p1[r1]));}}}}}return i1;}function w(i,j){var c1;var d1=new Map([["EQ","NE"],["BT","NB"],["CP","NP"],["LE","GT"],["GE","LT"],["NE","EQ"],["NB","BT"],["NP","CP"],["GT","LE"],["LT","GE"]]);if(i==="I"){c1=j;}else if(i==="E"){if(d1.has(j)){c1=d1.get(j);}else{c1=j;}}return c1;}function H(i){for(var j in s){var c1=s[j];if(c1.smartControl.getEntitySet()===i){return true;}}return false;}function O(i,j){var c1=i.filters.slice(0);var d1=y();i.filters=A(i.filters,d1,j,false);if(r){for(var e1 in s){var f1=s[e1];x(c1,f1,j);}}}function x(i,j,c1){j.getFiltersForCount=function(){return A(i,j,c1,true);};}function A(i,j,c1,d1){if(I.getFiltersAdaptedFromItem){i=I.getFiltersAdaptedFromItem(i,j,c1,d1);}return i.concat(j.selectionVariantFilters);}function y(){return s[u];}function z(i,u){return I.formatMessageStrip(i,u);}function E(){return u;}function J(){return I.getMode();}function K(u){h.setProperty(P,u||q);}function L(){return I.getContentForIappState(u);}function N(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var c1=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=c1.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function Q(i){u=I.getSelectedKeyAndRestoreFromIappState(i);if(s[u]){h.setProperty(P,u);}}function V(){return s[u].templateSortOrder;}function W(i){var j=y();var c1=c.isSmartTable(j.smartControl);if(i!==2){j.smartControl[c1?"rebindTable":"rebindChart"]();}if(i>1){if(c1){if(o.refreshModelOnTableRefresh){var d1=T.oCommonUtils.refreshModel(j.smartControl);if(d1){b1(j.smartControl);}}T.oCommonUtils.refreshSmartTable(j.smartControl);}else{}}}function X(i,j,c1){var d1=Array.isArray(j);var e1=T.oComponentUtils.isComponentActive();if((d1&&j.length===0)||(c1&&f(c1))){return;}I.refreshOperation(i,j,c1,u,d1,e1,W);}function Y(){var i=y();return I.setActiveButtonState(i);}function Z(){var i=y();return I.restoreActiveButtonState&&I.restoreActiveButtonState(i);}function $(i,j,c1){if(I.setControlVariant){I.setControlVariant(i,j,c1);}}function _(i,j,c1,d1){return T.oCommonUtils.getCustomDataText(i).then(function(e1){c1.text=e1;d1.text=e1;return{modelEntry:c1,pathToTheItem:j};});}function a1(i){h.setProperty(i.pathToTheItem,i.modelEntry);}function b1(i){if(I.refreshSiblingControls){I.refreshSiblingControls(i);}}(function(){t.testable(function(){return I;},"getImplementingHelper");t.testable(function(){return r;},"getShowCounts");t.testable(function(){return s[u];},"getCurrentViewMeta");var j=function(f1,l1,m1,n1){if(f1.numberOfUpdates!==m1){return;}var i1=p+"/"+f1.switchingKey;var j1=e({},h.getProperty(i1));if(!j1.state&&l1=="busy"){setTimeout(function(){if(h.getProperty(i1).state==="busy"){j1=e({},h.getProperty(i1));j1.state="busyLong";h.setProperty(i1,j1);}},k);}j1.state=l1;if(!l1){j1.count=n1;}h.setProperty(i1,j1);};var c1=o.switchingControl.getItems();for(var i=0;i<c1.length;i++){var d1=c1[i];var e1=d1.getKey();if(i===0){q=e1;}var f1={smartControl:o.smartControl||o.getSmartControl(e1),switchingKey:e1};var g1=I.getCustomDataHost(f1.smartControl,d1);var h1=T.oCommonUtils.getElementCustomData(g1);var i1=p+"/"+f1.switchingKey;var j1=Object.create(null);j1.text=h1.text;j1.count=0;j1.state="";j1.facetId=o.sectionKey;_(g1,i1,j1,f1).then(a1);f1.templateSortOrder=h1.TemplateSortOrder;f1.getPath=G.bind(null,f1.smartControl);f1.selectionVariantFilters=v(f1.smartControl,h1);f1.numberOfUpdates=0;f1.updateStartFunction=j.bind(null,f1,"busy");f1.updateSuccessFunction=j.bind(null,f1,"");f1.errorFunction=j.bind(null,f1,"error");s[e1]=f1;}if(I.init){I.init(s,X,y);}if(o.manifestSettings.showCounts===undefined){r=I.getDefaultShowCounts();}else{r=o.manifestSettings.showCounts;}K();u=h.getProperty(P);var k1=h.bindProperty(P);k1.attachChange(function(l1){var m1=l1.getSource().getValue();if(m1===u){return;}u=m1;if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(m1);}var n1=o.isDataToBeShown();var o1=I.getRefreshMode(u);if(o.adaptRefreshRequestMode){o1=o.adaptRefreshRequestMode(o1);if(n1&&o1>0){W(o1);}else{var p1=y().smartControl;T.oCommonUtils.setEnabledToolbarButtons(p1);}}o.appStateChange();});})();return{updateCounts:U,refreshOperation:X,onRebindContentControl:O,formatMessageStrip:z,getSelectedKey:E,setSelectedKey:K,getContentForIappState:L,restoreFromIappState:Q,formatItemTextForMultipleView:N,determineSortOrder:V,setActiveButtonState:Y,restoreActiveButtonState:Z,setControlVariant:$,hasEntitySet:H,refreshSiblingControls:b1,resolveParameterizedEntitySet:R,getMode:J};}return B.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(C,T,o){e(this,g(C,T,o));}});});
