/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/core/PageController","sap/fe/core/controllerextensions/InternalRouting","./overrides/Routing","./overrides/InternalRouting","sap/fe/core/controllerextensions/SideEffects","sap/fe/core/controllerextensions/EditFlow","sap/fe/core/controllerextensions/InternalEditFlow","sap/fe/core/controllerextensions/PageReady","sap/fe/core/controllerextensions/InternalIntentBasedNavigation","sap/fe/core/controllerextensions/IntentBasedNavigation","./overrides/IntentBasedNavigation","sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/navigation/SelectionVariant","sap/fe/macros/table/Utils","sap/m/MessageBox","sap/fe/core/BusyLocker","sap/m/Link","sap/fe/macros/chart/ChartRuntime","sap/fe/templates/ObjectPage/ExtensionAPI","sap/ui/core/mvc/OverrideExecution","sap/fe/core/controllerextensions/ViewState","./overrides/ViewState","sap/fe/templates/RootContainer/overrides/EditFlow","sap/fe/core/helpers/ModelHelper","sap/fe/core/controllerextensions/Routing","sap/m/InstanceManager","sap/fe/core/controllerextensions/MessageHandler","./overrides/MessageHandler","sap/fe/core/controllerextensions/Share","./overrides/Share","sap/fe/macros/DelegateUtil","sap/fe/macros/CommonHelper"],function(P,I,R,a,S,E,b,c,d,e,f,L,m,C,g,T,M,B,h,j,k,O,V,l,n,o,p,q,r,s,t,u,D,v){"use strict";return P.extend("sap.fe.templates.ObjectPage.ObjectPageController",{metadata:{methods:{getExtensionAPI:{"public":true,"final":true},onPageReady:{"public":true,"final":false,overrideExecution:O.After}}},sideEffects:S,editFlow:E,share:t.override(u),_editFlow:b.override(n),_routing:I.override(a),messageHandler:r.override(s),intentBasedNavigation:e.override(f),_intentBasedNavigation:d.override({getNavigationMode:function(){var i=this._oView.getController().getStickyEditMode&&this._oView.getController().getStickyEditMode();return i?"explace":"inplace";}}),routing:p.override(R),viewState:V.override(l),pageReady:c.override({isContextExpected:function(){return true;}}),getExtensionAPI:function(i){if(i){this.mCustomSectionExtensionAPIs=this.mCustomSectionExtensionAPIs||{};if(!this.mCustomSectionExtensionAPIs[i]){this.mCustomSectionExtensionAPIs[i]=new k(this,i);}return this.mCustomSectionExtensionAPIs[i];}else{if(!this.extensionAPI){this.extensionAPI=new k(this);}return this.extensionAPI;}},onInit:function(){P.prototype.onInit.apply(this);var i=this.byId("fe::ObjectPage");var w=this.getView().getBindingContext("internal");w.setProperty("externalNavigationContext",{"page":true});w.setProperty("relatedApps",{visibility:false,items:null});w.setProperty("batchGroups",this._getBatchGroupsForView());if(i.getEnableLazyLoading()){i.attachEvent("subSectionEnteredViewPort",this._handleSubSectionEnteredViewPort.bind(this));}},onExit:function(){var i=this;if(this.mCustomSectionExtensionAPIs){Object.keys(this.mCustomSectionExtensionAPIs).forEach(function(y){i.mCustomSectionExtensionAPIs[y]&&i.mCustomSectionExtensionAPIs[y].destroy();});delete this.mCustomSectionExtensionAPIs;}this.extensionAPI&&this.extensionAPI.destroy();delete this.extensionAPI;var w=this.getView().byId("fe::FooterBar::MessageButton"),x=w?w.oMessagePopover:null;if(x&&x.isOpen()){x.close();}},_getTableBinding:function(i){return i&&i.getRowBinding();},onAfterRendering:function(i){var w=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(x){w.oResourceBundle=x;}).catch(function(x){L.error("Error while retrieving the resource bundle",x);});},_onBeforeBinding:function(w,x){var y=this,z=this._findTables(),F,A=this.byId("fe::ObjectPage"),G=x.listBinding,H=y.getView().getBindingContext("internal"),J=H.getProperty("batchGroups");J.push("$auto");if(x.bDraftNavigation!==true){this._closeSideContent();}if(A.getBindingContext()&&A.getBindingContext().hasPendingChanges()&&!J.some(A.getBindingContext().getModel().hasPendingChanges.bind(A.getBindingContext().getModel()))){A.getBindingContext().getBinding().resetChanges();}for(var i=0;i<z.length;i++){F=z[i].getCreationRow();if(F){F.setBindingContext(null);}}var K=function(d1){if(!A.isFirstRendering()&&!x.bPersistOPScroll){A.setSelectedSection(null);}};A.attachEventOnce("modelContextChange",K);var N={onAfterRendering:K};A.addEventDelegate(N,y);this.pageReady.attachEventOnce("pageReady",function(d1){A.removeEventDelegate(N);});if(G&&G.isA("sap.ui.model.odata.v4.ODataListBinding")){var Q=y.byId("fe::Paginator");if(Q){Q.setListBinding(G);}}if(A.getEnableLazyLoading()){var U=A.getSections(),W=A.getUseIconTabBar(),X=2,Y=A.getModel("ui").getProperty("/editMode")==="Editable",Z=this.getView().getViewData().editableHeaderContent;for(var $=0;$<U.length;$++){var _=U[$];var a1=_.getSubSections();for(var b1=0;b1<a1.length;b1++,X--){if(X<1||(W&&($>1||($===1&&!Z&&!Y)))){var c1=a1[b1];c1.setBindingContext(null);}}}}},_handleSubSectionEnteredViewPort:function(i){var w=i.getParameter("subSection");w.setBindingContext(undefined);},_onBackNavigationInDraft:function(i){C.fnProcessDataLossOrDraftDiscardConfirmation(function(){history.back();},Function.prototype,i,this.getView().getController(),false);},_onAfterBinding:function(i,w){var x=this.byId("fe::ObjectPage"),y=this,z=this._findTables();this.sideEffects.clearPropertiesStatus();i=x.getBindingContext();if(i){var A=o.isStickySessionSupported(i.getModel().getMetaModel());if(!A){var F=C.getAppComponent(this.getView());F.getShellServices().setBackNavigation(y._onBackNavigationInDraft.bind(y,i));}}var G=[];x.getSections().forEach(function(Y){Y.getSubSections().forEach(function(Z){G=C.getIBNActions(Z,G);});});z.forEach(function(Y){var Z=Y.getBindingContext("internal");Z.setProperty("creationRowFieldValidity",{});Z.setProperty("creationRowCustomValidity",{});G=C.getIBNActions(Y,G);var $=Y.getRowBinding();if($){if(o.isStickySessionSupported($.getModel().getMetaModel())){$.removeCachesAndMessages("");}}T.getSemanticTargetsFromTable(y,Y);var _=JSON.parse(v.parseCustomData(D.getCustomData(Y,"operationAvailableMap"))),a1=Y.getSelectedContexts();C.setActionEnablement(Z,_,a1);});C.getSemanticTargetsFromPageModel(y,"_pageModel");var H=x.getHeaderTitle();var J=[];J=C.getIBNActions(H,J);G=G.concat(J);C.updateDataFieldForIBNButtonsVisibility(G,this.getView());var K,N;function Q(Y,Z){var $=Y.getCreationRow(),_,a1;if($){N.then(function(){if($.getModel("ui").getProperty("/isEditable")){_=K.bindList(Z.getPath(),Z.getContext(),[],[],{$$updateGroupId:"doNotSubmit",$$groupId:"doNotSubmit"});_.refreshInternal=function(){};a1=_.create();$.setBindingContext(a1);a1.created().catch(function(){L.trace("transient fast creation context deleted");});}}).catch(function(b1){L.error("Error while computing the final UI state",b1);});}}function U(Y){var X=y._getTableBinding(Y),Z=function(){Q(Y,X);};if(!X){L.error("Expected binding missing for table: "+Y.getId());return;}if(X.oContext){Z();}else{var $=function(){if(X.oContext){Z();X.detachChange($);}};X.attachChange($);}}if(i){K=i.getModel();N=this._editFlow.computeEditMode(i);if(i.getBinding().oCache){y._updateRelatedApps();}else{var W=function(){y._updateRelatedApps();i.getBinding().detachDataReceived(W);};i.getBinding().attachDataReceived(W);}var X=(i.getBinding&&i.getBinding())||i;X.attachEvent("patchSent",this.editFlow.handlePatchSent,this);X.attachEvent("patchCompleted",this.editFlow.handlePatchCompleted,this);z.forEach(function(Y){T.whenBound(Y).then(U).catch(function(Z){L.error("Error while waiting for the table to be bound",Z);});});x._triggerVisibleSubSectionsEvents();}},onPageReady:function(i){this.getAppComponent().getAppStateHandler().applyAppState();var w=i.lastFocusedControl;if(w&&w.controlId&&w.focusInfo){var x=this.getView();var F=x.byId(w.controlId);if(F){F.applyFocusInfo(w.focusInfo);return;}}var y=this.byId("fe::ObjectPage");var z=y.getModel("ui").getProperty("/editMode")==="Display";var A;if(z){var G=y.getHeaderTitle()&&y.getHeaderTitle().getActions();if(G&&G.length){A=G.find(function(J){return J.mProperties["visible"];});if(A){A.focus();}}}else{var H=y._getFirstEditableInput();if(H){H.focus();}}this._checkDataPointTitleForExternalNavigation();},getStickyEditMode:function(){var i=this.oView.getBindingContext&&this.oView.getBindingContext(),w=false;if(i){var x=o.isStickySessionSupported(i.getModel().getMetaModel());if(x){w=this.oView.getModel("ui").getProperty("/isEditable");}}return w;},_getPageTitleInformation:function(){var i=this.byId("fe::ObjectPage");var w=i.getCustomData().find(function(y){return y.getKey()==="ObjectPageSubtitle";});var x={title:i.data("ObjectPageTitle")||"",subtitle:w&&w.getValue(),intent:"",icon:""};return Promise.resolve(x);},_executeHeaderShortcut:function(i){var w=this.getView().getId()+"--"+i,x=this.byId("fe::ObjectPage").getHeaderTitle().getActions().find(function(y){return y.getId()===w;});C.fireButtonPress(x);},_executeFooterShortcut:function(i){var w=this.getView().getId()+"--"+i,x=this.byId("fe::ObjectPage").getFooter().getContent().find(function(y){return y.getMetadata().getName()==="sap.m.Button"&&y.getId()===w;});C.fireButtonPress(x);},_executeTabShortCut:function(i){var w=this.byId("fe::ObjectPage"),x=w.indexOfSection(this.byId(w.getSelectedSection())),y=w.getSections(),z=y.length-1,A=i.oSource.getCommand(),F;if(x!==-1&&z>0){if(A==="NextTab"){if(x<=z-1){F=y[++x];}}else{if(x!==0){F=y[--x];}}if(F){w.setSelectedSection(F);F.focus();}}},_getFooterVisibility:function(i){var w=this.getView().getBindingContext("internal");var x=this.getView().getId();w.setProperty("messageFooterContainsErrors",false);sap.ui.getCore().getMessageManager().getMessageModel().getData().forEach(function(y){if(y.validation&&y.type==="Error"&&y.target.indexOf(x)>-1){w.setProperty("messageFooterContainsErrors",true);}});},_showMessagePopover:function(i,w){if(i){L.error(i);}var x=this;var y=x.getView().byId("fe::FooterBar::MessageButton"),z=y.oMessagePopover,A=z.getBinding("items");if(A.getLength()>0&&!z.isOpen()){y.setVisible(true);setTimeout(function(){z.openBy(y);},0);}return w;},_editDocument:function(i){var w=this.getView().getModel("ui"),x={prepareOnEdit:this.getView().getViewData().prepareOnEdit};B.lock(w);return this.editFlow.editDocument.apply(this.editFlow,[i,x]).finally(function(){B.unlock(w);});},_saveDocument:function(i){var w=this,x=this.getView().getModel("ui"),W=[];var y=false;B.lock(x);this._findTables().forEach(function(z){var A=w._getTableBinding(z);var F={creationMode:z.data("creationMode"),creationRow:z.getCreationRow(),createAtEnd:z.data("createAtEnd")==="true"};var G=F.creationRow&&F.creationRow.getBindingContext()&&Object.keys(F.creationRow.getBindingContext().getObject()).length>1;if(G){F.bSkipSideEffects=true;y=true;W.push(w.editFlow.createDocument(A,F).then(function(){return A;}));}});return Promise.all(W).then(function(z){var A={bExecuteSideEffectsOnError:y,bindings:z};return w.editFlow.saveDocument(i,A).catch(w._showMessagePopover.bind(w)).finally(function(){B.unlock(x);});});},_cancelDocument:function(i,w){w.cancelButton=this.getView().byId(w.cancelButton);return this.editFlow.cancelDocument(i,w);},_applyDocument:function(i){var w=this;return this.editFlow.applyDocument(i).catch(w._showMessagePopover.bind(w));},_updateRelatedApps:function(){var i=this.byId("fe::ObjectPage");if(C.resolveStringtoBoolean(i.data("showRelatedApps"))){C.updateRelatedAppsDetails(i);}},_findTableInSubSection:function(i,w,x){var y=[];for(var z=0;z<i.length;z++){var A=i[z].getContent instanceof Function&&i[z].getContent();if(A&&A.isA&&A.isA("sap.ui.layout.DynamicSideContent")){A=A.getMainContent instanceof Function&&A.getMainContent();if(A&&A.length>0){A=A[0];}}if(A&&A.isA&&A.isA("sap.fe.macros.TableAPI")){A=A.getContent instanceof Function&&A.getContent();if(A&&A.length>0){A=A[0];}}if(A&&A.isA&&A.isA("sap.ui.mdc.Table")){x.push(A);y.push({"table":A,"gridTable":A.getType().isA("sap.ui.mdc.table.GridTableType")});}}if(y.length===1&&i.length===1&&y[0].gridTable&&!w.hasStyleClass("sapUxAPObjectPageSubSectionFitContainer")){w.addStyleClass("sapUxAPObjectPageSubSectionFitContainer");}else{if(y&&!w.hasStyleClass("sapUxAPObjectPageSubSectionFitContainer")){y.forEach(function(F){if(F.gridTable){F.table.getType().setRowCount(null);}});}}},_getAllSubSections:function(){var i=this.byId("fe::ObjectPage"),w=[];i.getSections().forEach(function(x){w=w.concat(x.getSubSections());});return w;},_getAllBlocks:function(){var i=[];this._getAllSubSections().forEach(function(w){i=i.concat(w.getBlocks());});return i;},_findTables:function(){var i=this._getAllSubSections(),w=[];for(var x=0;x<i.length;x++){this._findTableInSubSection(i[x].getBlocks(),i[x],w);this._findTableInSubSection(i[x].getMoreBlocks(),i[x],w);}return w;},_closeSideContent:function(){this._getAllBlocks().forEach(function(i){var w=i.getContent instanceof Function&&i.getContent();if(w&&w.isA&&w.isA("sap.ui.layout.DynamicSideContent")){if(w.setShowSideContent instanceof Function){w.setShowSideContent(false);}}});},_getChartContextData:function(i,w){var x=i.getObject(),y=[x];if(i&&w){if(x[w]){y=x[w];delete x[w];y.push(x);}}return y;},_getTableRow:function(i,w){if(i.filter(function(y){return y!==undefined;}).length>0){var x=i.find(function(y){return y.getPath().indexOf(w)!==-1;});return x;}else{return undefined;}},_scrollTableToRow:function(i,w){var x=i.getRowBinding();var y=this;var z=new Promise(function(A,F){if(x){var G;switch(i.data().tableType){case"GridTable":G=x.getContexts(0);break;case"ResponsiveTable":G=x.getCurrentContexts();break;default:}if(G.filter(function(H){return H===undefined;}).length>0||G.length===0){x.attachChange(function J(H){var G=y._getTableRow(H.getSource().getCurrentContexts(),w);if(G){x.detachChange(J);A(G);}});}else{A(y._getTableRow(G,w));}}else{F();}});z.then(function(A){if(A){var F=A.iIndex;i.scrollToIndex(F);}}).catch(function(){L.warning("Could not find any matched row");});},_scrollTablesToRow:function(w){if(this._findTables&&this._findTables().length>0){var x=this._findTables();for(var i=0;i<x.length;i++){this._scrollTableToRow(x[i],w);}}},_mergeMultipleContexts:function(i,w,x){var y=this;var A=[],z=[],F,G,H,J,K,N,Q;Q=i.getPath();F=i&&i.getModel()&&i.getModel().getMetaModel();J=F&&F.getMetaPath(Q).replace(/^\/*/,"");if(w&&w.length){G=w[0];K=G.getPath();H=F&&F.getMetaPath(K).replace(/^\/*/,"");w.map(function(U){if(x){var W=y._getChartContextData(U,x);if(W){A=W.map(function(W){return{contextData:W,entitySet:J+"/"+x};});}}else{A.push({contextData:U.getObject(),entitySet:H});}});}z.push({contextData:i.getObject(),entitySet:J});z=C.removeSensitiveData(z,F);N=C.addPageContextToSelectionVariant(new g(),z,y.getView());A=C.removeSensitiveData(A,F);return{selectionVariant:N,attributes:A};},_getBatchGroupsForView:function(){var i=this,w=i.getView().getViewData(),x=w.controlConfiguration,y=x&&Object.keys(x),z=["$auto.Heroes","$auto.Decoration","$auto.Workers"];if(y&&y.length>0){y.forEach(function(K){var A=x[K];if(A.requestGroupId==="LongRunners"){z.push("$auto.LongRunners");}});}return z;},_setBreadcrumbLinks:function(w){var x=w.getBindingContext();var A=this.getAppComponent();if(x){var N=x.getPath(),y=N.split("/"),z="",F=A.getMetaModel(),G=0;y.shift();y.splice(-1,1);y.forEach(function(H,i){z+="/"+H;var J=A.getRootViewController();var K=J.getTitleHierarchyCache();var Q;var U=F.getMetaPath(z);var W=F.getProperty(U+"/@com.sap.vocabularies.Common.v1.ResultContext");if(W){G=1;return;}if(!K[z]){Q=J.addNewEntryInCacheTitle(z,A);}else{Q=Promise.resolve(K[z]);}Q.then(function(X){var Y=i-G,Z=w.getLinks()[Y]?w.getLinks()[Y]:new h();Z.setText(X.subtitle||X.title);Z.setHref(X.intent);if(!w.getLinks()[Y]){w.addLink(Z);}}).catch(function(X){L.error("Error while computing the title hierarchy",X);});});}},_checkDataPointTitleForExternalNavigation:function(){var i=this.getView();var w=i.getBindingContext("internal");var x=C.getHeaderFacetItemConfigForExternalNavigation(i.getViewData(),this.getAppComponent().getRoutingService().getOutbounds());var y=this.getAppComponent().getShellServices();var z=i&&i.getBindingContext();w.setProperty("isHeaderDPLinkVisible",{});if(z){z.requestObject().then(function(H){G(x,H);}).catch(function(H){L.error("Cannot retrieve the links from the shell service",H);});}function A(H){L.error(H);}function F(H){var J=this.id;if(H&&H.length===1&&H[0].supported){w.setProperty("isHeaderDPLinkVisible/"+J,true);}}function G(x,H){for(var J in x){var K=x[J];var N={};var Q=i.byId(J);if(!Q){continue;}var U=Q.getBindingContext();var W=U&&U.getObject();var X=m({},H,W);if(K.semanticObjectMapping){var Y=K.semanticObjectMapping;for(var Z in Y){var $=Y[Z];var _=$["LocalProperty"]["$PropertyPath"];var a1=$["SemanticObjectProperty"];if(_!==a1){if(X.hasOwnProperty(_)){var b1={};b1[a1]=X[_];X=m({},X,b1);delete X[_];}}}}if(X){for(var c1 in X){if(c1.indexOf("_")!==0&&c1.indexOf("odata.context")===-1){N[c1]=X[c1];}}}y.isNavigationSupported([{target:{semanticObject:K.semanticObject,action:K.action},params:N}]).then(F.bind({id:J})).catch(A);}}},handlers:{onTableContextChange:function(w){var x=this;var y=w.getSource();var z;this._findTables().some(function(_){if(_.getRowBinding()===y){z=_;return true;}return false;});var A=this._editFlow.getCurrentActionPromise();if(A){var F;if(z.getType().getMetadata().isA("sap.ui.mdc.table.GridTableType")){F=y.getContexts(0);}else{F=y.getCurrentContexts();}if(!F[0]){return;}A.then(function(J){if(!J||J.controlId!==z.sId){return;}var K=J.oData;var N=J.keys;var Q=-1;F.find(function(X,i){var Y=X.getObject();var Z=N.every(function($){return Y[$]===K[$];});if(Z){Q=i;}return Z;});if(Q!==-1){var U=q.getOpenDialogs();var W=U.length>0?U[0]:null;if(W){W.attachEventOnce("afterClose",function(){z.focusRow(Q,true);});}else{z.focusRow(Q,true);}x._editFlow.deleteCurrentActionPromise();}}).catch(function(i){L.error("An error occurs while scrolling to the newly created Item: "+i);});}var G=z.getDataStateIndicator();if(G.getFilter()(null,z)){G.fireDataStateChange();}var H=x.getView().byId("fe::FooterBar::MessageButton");H.fireModelContextChange();},onCallAction:function(i,A,w){var x=i.getController();var y=x;return x.editFlow.invokeAction(A,w).then(y._showMessagePopover.bind(y,undefined)).catch(y._showMessagePopover.bind(y));},onDataPointTitlePressed:function(i,w,x,y,z){x=typeof x==="string"?JSON.parse(x):x;var A=x[y],F=C.getSemanticObjectMapping(A),G=w.getBindingContext(),H=G.getModel().getMetaModel().getMetaPath(G.getPath()),N=i._getChartContextData(G,z);N=N.map(function(J){return{data:J,metaPath:H+(z?"/"+z:"")};});if(A&&A.semanticObject&&A.action){i._intentBasedNavigation.navigate(A.semanticObject,A.action,{navigationContexts:N,semanticObjectMapping:F});}},onChevronPressNavigateOutBound:function(i,w,x){var y=i.getAppComponent().getRoutingService().getOutbounds(),z=y[w];if(z&&z.semanticObject&&z.action){x=x&&x.isA&&x.isA("sap.ui.model.odata.v4.Context")?[x]:x;i._intentBasedNavigation.navigate(z.semanticObject,z.action,{navigationContexts:x});return Promise.resolve();}else{throw new Error("outbound target "+w+" not found in cross navigation definition of manifest");}},onNavigateChange:function(i){this.getExtensionAPI().updateAppState();this.bSectionNavigated=true;},onVariantSelected:function(i){this.getExtensionAPI().updateAppState();},onVariantSaved:function(i){var w=this;setTimeout(function(){w.getExtensionAPI().updateAppState();},500);},navigateToSubSection:function(i,w){var x=typeof w==="string"?JSON.parse(w):w,y=i.getView().byId("fe::ObjectPage"),z,A;if(x.sectionId){z=i.getView().byId(x.sectionId);A=x.subSectionId?i.getView().byId(x.subSectionId):z&&z.getSubSections()&&z.getSubSections()[0];}else if(x.subSectionId){A=i.getView().byId(x.subSectionId);z=A&&A.getParent();}if(!z||!A||!z.getVisible()||!A.getVisible()){i.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(F){var G=C.getTranslatedText("C_ROUTING_NAVIGATION_DISABLED_TITLE",F,null,i.getView().getViewData().entitySet);L.error(G);M.error(G);}).catch(function(F){L.error(F);});}else{y.scrollToSection(A.getId());y.fireNavigate({section:z,subSection:A});}},onChartSelectionChanged:function(i){j.fnUpdateChart(i);}}});});
