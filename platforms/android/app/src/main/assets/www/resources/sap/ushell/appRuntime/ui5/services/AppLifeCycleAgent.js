// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessageAPI","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/base/util/UriParameters","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ushell/appRuntime/ui5/services/TunnelsAgent","sap/ushell/appRuntime/ui5/services/AppDelegationBootstrap","sap/ui/Device","sap/ui/core/BusyIndicator"],function(A,a,U,b,q,t,d,D,B){"use strict";function c(){var e=this,s,o,E=true,f={},C,g={},r,R,h={};this.init=function(m,i,j,k,l,n){s=m;C=i;R=j;if(k!==undefined){E=k;}this.addAppInfoToCache(l,n);A.registerCommHandlers({"sap.ushell.services.appLifeCycle":{oServiceCalls:{create:{executeServiceCallFn:function(M){var p=JSON.parse(M.oMessage.data),l=new U(p.body.sUrl).get("sap-ui-app-id");e.create(l,p.body.sUrl);window.hasher.disableCFLPUpdate=true;window.hasher.replaceHash(p.body.sHash);window.hasher.disableCFLPUpdate=false;return new q.Deferred().resolve().promise();}},destroy:{executeServiceCallFn:function(M){var p=JSON.parse(M.oMessage.data);e.destroy(p.body.sCacheId);return new q.Deferred().resolve().promise();}},store:{executeServiceCallFn:function(M){var p=JSON.parse(M.oMessage.data);e.store(p.body.sCacheId);return new q.Deferred().resolve().promise();}},restore:{executeServiceCallFn:function(M){var p=JSON.parse(M.oMessage.data);e.restore(p.body.sCacheId);window.hasher.disableCFLPUpdate=true;window.hasher.replaceHash(p.body.sHash);window.hasher.disableCFLPUpdate=false;return new q.Deferred().resolve().promise();}}}},"sap.ushell.eventDelegation":{oServiceCalls:{registerEventHandler:{executeServiceCallFn:function(S){var p=JSON.parse(S.oMessageData.body.sEventObject),u=p.eventKey,v=p.eventData;if(h.hasOwnProperty(u)){var w=h[u];for(var x=0;x<w.length;x++){w[x](v);}}return new q.Deferred().resolve().promise();}}}}});this.initialSetup();};this.initialSetup=function(){d.bootstrap();a.sendMessageToOuterShell("sap.ushell.services.appLifeCycle.setup",{isStateful:true,isKeepAlive:true,lifecycle:{bActive:true,bSwitch:true,bStorageIdentifier:true},settings:{bTheme:true,bLocal:true},session:{bSignOffSupport:true,bExtendSessionSupport:true}});};this.restore=function(S){var i=g[S],j=i.getComponentInstance();i.setVisible(true);if(j){if(j.isKeepAliveSupported&&j.isKeepAliveSupported()===true){j.activate();}else{if(j.restore){j.restore();}if(j.getRouter&&j.getRouter()&&j.getRouter().initialize){j.getRouter().initialize();}}r=i;}};this.store=function(S){var i=r,j;g[S]=i;j=i.getComponentInstance();i.setVisible(false);if(j){if(j.isKeepAliveSupported&&j.isKeepAliveSupported()===true){j.deactivate();}else{if(j.suspend){j.suspend();}if(j.getRouter&&j.getRouter()){j.getRouter().stop();}}}};this.getURLParameters=function(u){return new Promise(function(i,j){if(u.hasOwnProperty("sap-intent-param")){var k=u["sap-intent-param"];a.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:k}).then(function(p){delete u["sap-intent-param"];var l=q.extend({},u,(new b("?"+p)).query(true),true);i(l);},function(l){i(u);});}else{i(u);}});};this.getAppInfo=function(i,u){return new Promise(function(j){function G(){o.getAppInfo(i,u).then(function(k){e.addAppInfoToCache(i,k);j(k);});}if(E===true&&f[i]){j(JSON.parse(JSON.stringify(f[i])));}else if(o){G();}else{sap.ui.require([s.replace(/\./g,"/")],function(O){o=O;G();});}});};this.addAppInfoToCache=function(i,j){if(i&&j&&E===true&&f[i]===undefined){f[i]=JSON.parse(JSON.stringify(j));}};this.create=function(i,u){if(D.browser.chrome){B.show(0);}var j=new Promise(function(k){e.getAppInfo(i,u).then(function(l){k(l);});}).then(function(k){e.getURLParameters(new b(u).query(true)).then(function(l){C(i,l,k).then(function(m){R(m);});});});return j;};this.setComponent=function(i){r=i;};this.destroy=function(S){if(S){if(g[S]===r){r=undefined;}g[S].destroy();delete g[S];}else if(r){r.destroy();r=undefined;}};this.jsonStringifyFn=function(j){var i=JSON.stringify(j,function(k,v){return(typeof v==="function")?v.toString():v;});return i;};}return new c();},true);
