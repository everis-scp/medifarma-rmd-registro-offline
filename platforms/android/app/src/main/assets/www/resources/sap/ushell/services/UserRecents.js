// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/Object","sap/ushell/services/AppType","sap/ushell/EventHub","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/Device","sap/ushell/utils","sap/base/util/ObjectPath"],function(B,c,E,q,L,D,u,O){"use strict";var P="sap.ushell.services.UserRecents";var U=B.extend("sap.ushell.services.UserRecentsBase",{constructor:function(p,m,a){this.aRecents=[];this.iMaxItems=m;this._oPersonalizerPromise=sap.ushell.Container.getServiceAsync("Personalization").then(function(b){return b.getPersonalizer({container:P,item:p});});this._compareItems=a;}});U.prototype._load=function(){var o=new q.Deferred();this._oPersonalizerPromise.then(function(p){p.getPersData().done(o.resolve).fail(o.reject);}).catch(function(a){L.error("Personalization service does not work:");L.error(a.name+": "+a.message);o.reject(a);});return o.promise();};U.prototype._save=function(l){var o=new q.Deferred();this._oPersonalizerPromise.then(function(p){p.setPersData(l).done(o.resolve).fail(o.reject);}).catch(function(a){L.error("Personalization service does not work:");L.error(a.name+": "+a.message);o.reject(a);});return o.promise();};U._itemSorter=function(i,I){return I.iTimestamp-i.iTimestamp;};var R=U.extend("sap.ushell.services.RecentsList");R.prototype._updateIfAlreadyIn=function(i,t){return this.aRecents.some(function(r){var F;if(this._compareItems(r.oItem,i)){r.oItem=i;r.iTimestamp=t;r.iCount=r.iCount+1;F=true;}else{F=false;}return F;}.bind(this));};R.prototype._insertNew=function(i,t){var n={oItem:i,iTimestamp:t,iCount:1};if(this.aRecents.length===this.iMaxItems){this.aRecents.sort(U._itemSorter);this.aRecents.pop();}this.aRecents.push(n);};R.prototype.clearAllActivities=function(){return this._save([]);};R.prototype.newItem=function(i){var o=new q.Deferred();var t=Date.now();var a;this._load().done(function(l){this.aRecents=l||[];a=this._updateIfAlreadyIn(i,t);if(!a){this._insertNew(i,t);}this._save(this.aRecents).done(function(){o.resolve();}).fail(function(){o.reject();});}.bind(this));return o.promise();};R.prototype.getRecentItems=function(){var o=new q.Deferred();this._load().done(function(l){l=l||[];l.sort(U._itemSorter);this.aRecents=l.slice(0,this.iMaxItems);o.resolve(q.map(this.aRecents,function(r){return r.oItem;}));}.bind(this));return o.promise();};var d=U.extend("sap.ushell.services.RecentActivity",{constructor:function(m){U.call(this,"RecentActivity",m,d._compareItems);}});d.MAX_DAYS=30;d.ITEM_COUNT=30;d._compareItems=function(a,b){if(a.appType===b.appType){if(a.appType!==c.APP){return a.url===b.url;}return a.appId===b.appId;}else if(a.appType===c.APP||b.appType===c.APP){return(a.appId===b.appId)&&(a.url===b.url);}return false;};d.prototype._updateIfAlreadyIn=function(i,t){return this.oRecentActivities.recentUsageArray.some(function(r){var F;if(d._compareItems(r.oItem,i)){if((i.appType===r.oItem.appType)||(i.appType!==c.APP)){q.extend(r.oItem,i);r.iTimestamp=t;r.oItem.timestamp=t;r.mobile=undefined;r.tablet=undefined;r.desktop=undefined;if((i.appType===r.oItem.appType)||(i.appType!==c.APP&&r.oItem.appType!==c.APP)){r.aUsageArray[r.aUsageArray.length-1]+=1;r.iCount+=1;}this.oRecentActivities.recentUsageArray.sort(U._itemSorter);}F=true;}else{F=false;}return F;}.bind(this));};d.prototype._insertNew=function(i,t,I){i.timestamp=t;if(I){i.icon=I;}var n={oItem:i,iTimestamp:t,aUsageArray:[1],iCount:1,mobile:undefined,tablet:undefined,desktop:undefined};if(this.oRecentActivities.recentUsageArray.length===this.iMaxItems){this.oRecentActivities.recentUsageArray.pop();}this.oRecentActivities.recentUsageArray.unshift(n);};d.prototype.newItem=function(i){var o=new q.Deferred();var t=Date.now();var I=this.getActivityIcon(i.appType,i.icon);var a;var b=this.getDayFromDateObj(new Date());this._load().done(function(l){this.oRecentActivities=this.getRecentActivitiesFromLoadedData(l);if(b!==this.oRecentActivities.recentDay){this.addNewDay();this.oRecentActivities.recentDay=b;}a=this._updateIfAlreadyIn(i,t);if(!a){this._insertNew(i,t,I);}this._save(this.oRecentActivities).done(function(){E.emit("newUserRecentsItem",this.oRecentActivities);o.resolve();}.bind(this)).fail(function(){o.reject();});}.bind(this));return o.promise();};d.prototype.getActivityIcon=function(a,i){switch(a){case c.SEARCH:return i||"sap-icon://search";case c.COPILOT:return i||"sap-icon://co";case c.URL:return i||"sap-icon://internet-browser";default:return i||"sap-icon://product";}};d.prototype.clearAllActivities=function(){var o=new q.Deferred();this._save([]).done(function(){E.emit("userRecentsCleared",Date.now());o.resolve();}).fail(function(){o.reject();});return o.promise();};d.prototype.getRecentItemsHelper=function(m){var o=new q.Deferred();var a;var A;var C;var i=false;var I=[];var b=[];var g=this.getDayFromDateObj(new Date());if(D.system.desktop){C="desktop";}else if(D.system.tablet){C="tablet";}else{C="mobile";}this._load().done(function(l){this.oRecentActivities=this.getRecentActivitiesFromLoadedData(l);var n=false;var M;if(g!==this.oRecentActivities.recentDay){this.addNewDay();this.oRecentActivities.recentDay=g;n=true;}for(a=0;a<this.oRecentActivities.recentUsageArray.length&&!i;a++){A=this.oRecentActivities.recentUsageArray[a];if(A[C]===undefined){if(!(A.oItem.url[0]==="#")){b.push(A.oItem.url);}else if(A.oItem.url.indexOf("?")>-1){M=A.oItem.url.substring(A.oItem.url.indexOf("?"));if(M.indexOf("&/")>-1){M=M.substring(0,M.indexOf("&/"));}I.push(A.oItem.appId+M);}else{I.push(A.oItem.appId);}}else{i=true;}}if(b.length>0){var h;for(a=0;a<this.oRecentActivities.recentUsageArray.length;a++){if(!(this.oRecentActivities.recentUsageArray[a].oItem.url[0]==="#")){h=this.oRecentActivities.recentUsageArray[a];h[C]=true;}}if(I.length<=0){this._save(this.oRecentActivities).done(function(){var j=this._getRecentItemsForDevice(C,this.oRecentActivities,m);o.resolve(j);}.bind(this)).fail(function(){o.reject();});}}if(I.length>0){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(k){k.isIntentSupported(I).done(function(r){i=false;for(a=0;a<this.oRecentActivities.recentUsageArray.length&&!i;a++){A=this.oRecentActivities.recentUsageArray[a];if(A[C]===undefined){M="";if(A.oItem.url.indexOf("?")>-1){M=A.oItem.url.substring(A.oItem.url.indexOf("?"));if(M.indexOf("&/")>-1){M=M.substring(0,M.indexOf("&/"));}}var p=r[A.oItem.appId+M];A[C]=!!(p&&p.supported);}else if(A.oItem.url[0]==="#"){i=true;}}this._save(this.oRecentActivities).done(function(){var j=this._getRecentItemsForDevice(C,this.oRecentActivities,m);o.resolve(j);}.bind(this)).fail(function(){o.reject();});}.bind(this)).fail(function(s){o.reject(s);});}.bind(this));}else if((I.length<=0)&&(b.length<=0)){if(n){this._save(this.oRecentActivities).done(function(){var j=this._getRecentItemsForDevice(C,this.oRecentActivities,m);o.resolve(j);}.bind(this)).fail(function(){o.reject();});}else{var j=this._getRecentItemsForDevice(C,this.oRecentActivities,m);o.resolve(j);}}}.bind(this)).fail(function(){o.reject();});return o.promise();};d.prototype._getRecentItemsForDevice=function(a,r,m){var b=[];var i=0;var A;for(var g=0;g<r.recentUsageArray.length&&(!m||i<m);g++){A=r.recentUsageArray[g];if(A[a]){b.push(A);i++;}}return b;};d.prototype.getRecentItems=function(){var o=new q.Deferred();this.getRecentItemsHelper(d.ITEM_COUNT).done(function(r){o.resolve(q.map(r,function(a){return a.oItem;}));}).fail(function(){o.reject();});return o.promise();};d.prototype.getFrequentItems=function(){var o=new q.Deferred();this.getRecentItemsHelper().done(function(r){var g;var w=0;var F=[];var A;var p=r[0]?new Date(r[0].iTimestamp):undefined;var h;for(g=0;g<r.length&&w<d.MAX_DAYS;g++){A=r[g];if(A.iCount>1){F.push(A);}h=new Date(A.iTimestamp);if(p.toDateString()!==h.toDateString()){w++;p=h;}}F.sort(function(a,b){return b.iCount-a.iCount;});F=F.slice(0,d.ITEM_COUNT);o.resolve(q.map(F,function(a){return a.oItem;}));}).fail(function(){o.reject();});return o.promise();};d.prototype.addNewDay=function(){var a,C;for(a=0;a<this.oRecentActivities.recentUsageArray.length;a++){if(this.oRecentActivities.recentUsageArray[a].aUsageArray){C=this.oRecentActivities.recentUsageArray[a].aUsageArray;}else{C=[];this.oRecentActivities.recentUsageArray[a].aUsageArray=C;this.oRecentActivities.recentUsageArray[a].iCount=0;}C[C.length]=0;if(C.length>d.MAX_DAYS){this.oRecentActivities.recentUsageArray[a].iCount-=C[0];C.shift();}}};d.prototype.getDayFromDateObj=function(a){return(a.getUTCFullYear()+"/"+(a.getUTCMonth()+1)+"/"+a.getUTCDate());};d.prototype.getRecentActivitiesFromLoadedData=function(l){var r;if(Array.isArray(l)){r={recentDay:null,recentUsageArray:l};}else{r=l||{recentDay:null,recentUsageArray:[]};}r.recentUsageArray=(r.recentUsageArray||[]).filter(function(a){var i=a&&a.oItem&&a.oItem.url;if(!i){L.error("FLP Recent Activity",a,"is not valid. The activity is removed from the list.");}return i;});return r;};var e=U.extend("sap.ushell.services.RecentAppsUsage",{constructor:function(){U.call(this,"AppsUsage");}});e.MAX_DAYS=30;e.prototype.init=function(){var C=this.getDayFromDateObj(new Date());var b=false;if(this._oInitDeferred===undefined){this._oInitDeferred=new q.Deferred();}if(!b||C!==this.oAppsUsageData.recentDay){b=true;this._load().done(function(a){this.oAppsUsageData=a||{recentDay:null,recentAppsUsageMap:{}};this.calculateInitialUsage(C);this._oInitDeferred.resolve(this.oAppsUsageData);}.bind(this)).fail(function(){L.error("UShell-lib ; RecentAppsUsage ; Load data in Init failed");this._oInitDeferred.reject();}.bind(this));}return this._oInitDeferred.promise();};e.prototype.calculateInitialUsage=function(a){if(a!==this.oAppsUsageData.recentDay){this.addNewDay();this.oAppsUsageData.recentDay=a;setTimeout(function(){this.cleanUnusedHashes();}.bind(this),3000);this.saveAppsUsage(this.oAppsUsageData);}};e.prototype.addAppUsage=function(h){if(!u.validHash(h)){return(new q.Deferred()).reject("Non valid hash").promise();}return this.init().done(function(){var a=this.oAppsUsageData.recentAppsUsageMap[h]||[];if(a.length===0){a[0]=1;}else{a[a.length-1]+=1;}this.oAppsUsageData.recentAppsUsageMap[h]=a;this.saveAppsUsage(this.oAppsUsageData);}.bind(this)).fail(function(){L.error("Ushell-lib ; addAppUsage ; Initialization falied!");});};e.prototype.getAppsUsage=function(){var r;var o=new q.Deferred();this.init().done(function(){r=this.summarizeUsage();o.resolve(r);}.bind(this)).fail(function(){o.reject("Not initialized yet");});return o.promise();};e.prototype.summarizeUsage=function(){var a={};var m,b;var g=true;for(var h in this.oAppsUsageData.recentAppsUsageMap){a[h]=this.getHashUsageSum(h);if(g){m=b=a[h];g=false;}else if(a[h]<b){b=a[h];}else if(a[h]>m){m=a[h];}}return{usageMap:a,maxUsage:m,minUsage:b};};e.prototype.addNewDay=function(){var a;for(var h in this.oAppsUsageData.recentAppsUsageMap){a=this.oAppsUsageData.recentAppsUsageMap[h];a[a.length]=0;if(a.length>e.MAX_DAYS){a=a.shift();}}};e.prototype.cleanUnusedHashes=function(){var i;for(var h in this.oAppsUsageData.recentAppsUsageMap){i=this.getHashUsageSum(h);if(i===0){delete(this.oAppsUsageData.recentAppsUsageMap[h]);}}};e.prototype.getHashUsageSum=function(h){var s=0;var a;var b=this.oAppsUsageData.recentAppsUsageMap[h];var l=b.length;for(a=0;a<l;a++){s+=b[a];}return s;};e.prototype.saveAppsUsage=function(o){return this._save(o).fail(function(){L.error("Ushell-lib ; saveAppsUsage ; Save action failed");});};e.prototype.getDayFromDateObj=function(a){return(a.getUTCFullYear()+"/"+(a.getUTCMonth()+1)+"/"+a.getUTCDate());};var f=B.extend("sap.ushell.services.UserRecents",{constructor:function(){this.oRecentSearches=new R("RecentSearches",10,f._compareSearchItems);this.oRecentDataSources=new R("RecentDataSources",6,f._compareDataSources);this.oRecentApps=new R("RecentApps",6,f._compareApps);this.oRecentActivity=new d(500);this.oAppsUsage=new e();}});f._compareSearchItems=function(a,b){var r=false;if(a.oDataSource&&b.oDataSource){if(a.oDataSource.objectName&&b.oDataSource.objectName){r=((a.sTerm===b.sTerm)&&(a.oDataSource.objectName.value===b.oDataSource.objectName.value));}if(!a.oDataSource.objectName&&!b.oDataSource.objectName){r=(a.sTerm===b.sTerm);}}if(!a.oDataSource&&!b.oDataSource){r=(a.sTerm===b.sTerm);}return r;};f._compareDataSources=function(a,b){if(a.objectName&&b.objectName){return a.objectName.value===b.objectName.value;}return false;};f._compareApps=function(a,b){return a.semanticObject===b.semanticObject&&a.action===b.action;};f.prototype.addActivity=function(a){var o=new q.Deferred();this.oRecentActivity.newItem(a).done(function(){this.oRecentActivity.getRecentItems().done(o.resolve).fail(o.reject);}.bind(this)).fail(o.reject);return o.promise();};f.prototype.clearRecentActivities=function(){return this.oRecentActivity.clearAllActivities();};f.prototype.getRecentActivity=function(){return this.oRecentActivity.getRecentItems();};f.prototype.getFrequentActivity=function(){return this.oRecentActivity.getFrequentItems();};f.prototype.noticeDataSource=function(o){var s=O.get("objectName.value",o)||"";var a=O.get("objectName",o)||"";var v=s.toLowerCase()==="$$all$$";var b=a.toLowerCase()==="$$all$$";if(!v&&!b){var g=new q.Deferred();this.oRecentDataSources.newItem(o).done(function(){this.oRecentDataSources.getRecentItems().done(g.resolve).fail(g.reject);}.bind(this)).fail(g.reject);return g.promise();}return this.oRecentDataSources.getRecentItems();};f.prototype.addDataSourceActivity=f.prototype.noticeDataSource;f.prototype.getRecentDataSources=function(){return this.oRecentDataSources.getRecentItems();};f.prototype.noticeSearch=function(s){var o=new q.Deferred();this.oRecentSearches.newItem(s).done(function(){this.oRecentSearches.getRecentItems().done(o.resolve).fail(o.reject);}.bind(this)).fail(o.reject);return o.promise();};f.prototype.addSearchActivity=f.prototype.noticeSearch;f.prototype.getRecentSearches=function(){return this.oRecentSearches.getRecentItems();};f.prototype.noticeApp=function(a){var o=new q.Deferred();this.oRecentApps.newItem(a).done(function(){this.oRecentApps.getRecentItems().done(o.resolve).fail(o.reject);}.bind(this)).fail(o.reject);return o.promise();};f.prototype.addAppActivity=f.prototype.noticeApp;f.prototype.getRecentApps=function(){return this.oRecentApps.getRecentItems();};f.prototype.addAppUsage=function(h){var r=u.getBasicHash(h);this.oAppsUsage.addAppUsage(r);};f.prototype.getAppsUsage=function(){return this.oAppsUsage.getAppsUsage();};f.hasNoAdapter=true;return f;},true);
