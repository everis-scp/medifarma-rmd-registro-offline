/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/base/ManagedObjectMetadata","sap/ui/core/ComponentContainer","sap/ui/core/Placeholder","sap/ui/core/library"],function(L,M,C,P,c){"use strict";var a=c.ComponentLifecycle;return{display:function(d){var s=Promise.resolve();return this._display(d,s);},_display:function(d,s,t){if(this._oParent){s=this._oParent._display(d,s,Object.assign({},t));}return this._place(d,s,t);},suspend:function(){if(this._oParent){this._oParent.suspend();}if(this._isLoaded()){var o=this._get(),r;if(o.isA("sap.ui.core.UIComponent")&&(r=o.getRouter())&&o.hasNativeRouter()){r.stop();}}else{L.warning("The target with name '"+this._oOptions._name+"' can't be suspended because it's being loaded or not loaded yet");}return this;},resume:function(){if(this._oParent){this._oParent.resume();}if(this._isLoaded()){var o=this._get(),r;if(o.isA("sap.ui.core.UIComponent")&&(r=o.getRouter())&&o.hasNativeRouter()){r.initialize(true);}}return this;},_isLoaded:function(){return this._bIsLoaded;},_getCreateOptions:function(t){var n=this._getEffectiveObjectName(this._oOptions.name),o=this._oOptions,b;t=t||{};switch(o.type){case"View":b={name:n,type:o.viewType,id:o.id,async:true};break;case"Component":b={id:o.id};if(o.usage){b.usage=o.usage;}else{b.name=n;}b=Object.assign({},o.options||{},b);break;default:throw new Error("The given type "+o.type+" isn't support by sap.ui.core.routing.Target");}return b;},_get:function(t){var o=this._getCreateOptions(t);return this._oCache._get(o,this._oOptions.type,this._bUseRawViewId,t);},_load:function(t){var o=this._get(t),p;if(!(o instanceof Promise)){if(o.isA("sap.ui.core.mvc.View")){p=o.loaded();}else{p=Promise.resolve(o);}}else{p=o;}return p.then(function(o){this._bIsLoaded=true;return o;}.bind(this));},_place:function(d,s,t){if(d instanceof Promise){t=s;s=d;d=undefined;}var o=this._oOptions,b=this,O,e,p,i=true,r,f,I=o.type==="Component";t=t||{};if((o.name||o.usage)&&o.type){f=new Promise(function(g){r=g;});if(I){t.componentId=b._oOptions.id||M.uid("uicomponent");}p=this._load(t).then(function(O){if(O.isA("sap.ui.core.UIComponent")){var R=O.getRouter();if(R&&O.hasNativeRouter()){var h=R.getHashChanger().getHash();var g=R.getRouteByHash(h);var j=t&&t.ignoreInitialHash;if(!R._oConfig.async){throw new Error("The router of component '"+O.getId()+"' which is loaded via the target '"+b._oOptions._name+"' is defined as synchronous which is not supported using as a nested component.");}if(R._oOwner&&t){R._oOwner._bRoutingPropagateTitle=t.propagateTitle;}if(!j&&(!R.isInitialized()||R._bMatchingProcessStarted)&&g&&g._oConfig.target){i=false;R.attachRouteMatched(r);}if(R.isStopped()){R.initialize(j);}}}if(i){r();}return O;});s=s.then(function(g){g=g||{};var v=b._isValid(g);if(v!==true){e=v;return b._refuseInvalidTarget(o._name,e);}var V=g.view,h=g.control,j,k;if(V&&V.isA("sap.ui.core.ComponentContainer")){V=V.getComponentInstance().getRootControl();}if(!V&&o.rootView){j=Promise.resolve(o.rootView).then(function(R){var l;if(R){l=sap.ui.getCore().byId(R);o.rootView=R;}if(!l){e="Did not find the root view with the id "+o.rootView;return b._refuseInvalidTarget(o._name,e);}else{return l;}});}else{j=Promise.resolve(V);}j=j.then(function(l){if(l&&l.isA("sap.ui.core.mvc.View")){return l.loaded();}else{return l;}});if(o.controlId){k=j.then(function(l){var m;if(l){m=l.byId(o.controlId);}if(!m){m=sap.ui.getCore().byId(o.controlId);}return m;});}else{k=Promise.resolve(h);}return k.then(function(l){if(!l){e="Control with ID "+o.controlId+" could not be found";return b._refuseInvalidTarget(o._name,e);}else{return l;}});}).then(function(g){var h=false;var j=t.placeholder||b._oOptions.placeholder||{};if(P.hasProviders()){Object.assign(j,P.getPlaceholderFromProviders({name:b._oOptions.name,type:b._oOptions.type}));}if(Object.keys(j).length>0){if(j.autoClose===undefined){j.autoClose=true;}h=true;}if(I){var k=b._oCache._oComponent;var l=t.componentId+"-container";O=(k&&k.byId(l))||sap.ui.getCore().byId(l);if(!O){var m=Object.assign({height:"100%",width:"100%",lifecycle:a.Application},o.containerOptions);if(k){k.runAsOwner(function(){O=new C(k.createId(l),m);});}else{O=new C(l,m);}}if(h){j.container=O;}}if(h&&g.isA("sap.ui.core.IPlaceholderSupport")){j.container=g;}if(j.container){j.aggregation=b._oOptions.controlAggregation;if(!t.repeatedRoute){var n=b._getCreateOptions(t);var q=b._oCache.fetch(n,b._oOptions.type);if(q&&I){j.object=O;}else{j.object=q;}}if(j.html){j.placeholder=new P({html:j.html});}if(j.placeholder){b.showPlaceholder(j);}}return{containerControl:g,object:O,placeholderConfig:j};}).then(function(v){return p.then(function(O){var V,R;if(I){var g=O.destroy;O.destroy=function(){if(g){g.apply(this);}v.object.destroy();};v.object.setComponent(O);R=O.getRootControl();if(R&&R.isA("sap.ui.core.mvc.View")){V=R;}}else{v.object=O;V=O;}b._bindTitleInTitleProvider(V);b._addTitleProviderAsDependent(V);return v;});}).then(function(v){var g=v.containerControl,O=v.object;b._beforePlacingViewIntoContainer({container:g,view:O,data:d});var A=g.getMetadata().getJSONKeys()[o.controlAggregation];if(!A){e="Control "+o.controlId+" does not have an aggregation called "+o.controlAggregation;return b._refuseInvalidTarget(o._name,e);}if(o.clearControlAggregation===true){g[A._sRemoveAllMutator]();}L.info("Did place the "+o.type.toLowerCase()+" target '"+(o.name?b._getEffectiveObjectName(o.name):o.usage)+"' with the id '"+O.getId()+"' into the aggregation '"+o.controlAggregation+"' of a control with the id '"+g.getId()+"'",b);g[A._sMutator](O);return{name:o._name,view:O,control:g,placeholderConfig:v.placeholderConfig};});}else{s=s.then(function(){return{name:o._name};});}return Promise.all([s,f]).then(function(g){var h=g[0].control;var O=g[0].view;if(h&&O){b.fireDisplay({view:O.isA("sap.ui.core.mvc.View")?O:undefined,object:O,control:h,config:b._oOptions,data:d,routeRelevant:t.routeRelevant});}if(g[0].placeholderConfig&&g[0].placeholderConfig.container&&b.hidePlaceholder&&g[0].placeholderConfig.autoClose){b.hidePlaceholder(g[0].placeholderConfig);}return g[0];});},showPlaceholder:function(s){if(s.container&&s.container.showPlaceholder){s.container.showPlaceholder(s);}},hidePlaceholder:function(s){if(s.container.hidePlaceholder){s.container.hidePlaceholder();}},_isValid:function(p){var o=this._oOptions,b=p&&p.control,h=(b||o.controlId),i=true,l="";if(!h){l="The target "+o._name+" has no controlId set and no parent so the target cannot be displayed.";i=false;}if(!o.controlAggregation){l="The target "+o._name+" has a control id or a parent but no 'controlAggregation' was set, so the target could not be displayed.";i=false;}if(l){L.error(l,this);}return i||l;},_refuseInvalidTarget:function(n,m){return Promise.reject(new Error(m+" - Target: "+n));}};});
