/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.sjax","sap/base/Log","sap/base/util/merge","sap/base/util/UriParameters","sap/ui/core/Core"],function(q,L,m,U){"use strict";var r=/\/\$batch($|\?)/,a=/(?:^|\r\n)Content-Id\s*:\s*(\S+)/i,b=/^(.*)?:\s*(.*)$/,j="application/json;charset=UTF-8;IEEE754Compatible=true",M={},s="\r\nContent-Type: application/http\r\n"+"Content-Transfer-Encoding: binary\r\n",c=/^Content-Type:\s*multipart\/mixed;\s*boundary=/i,u=U.fromQuery(window.location.search),A=u.get("autoRespondAfter"),R=u.get("realOData"),d=/^(\S+) (\S+)$/,e=/^(GET|DELETE|MERGE|PATCH|POST) (\S+) HTTP\/1\.1$/,D={},f=/^(OData-Version|DataServiceVersion)$/,g=R==="true"||R==="direct",h=0,S=u.get("supportAssistant")==="true",T;if(g){document.title=document.title+" (real OData)";}function k(o,E,P){var i=QUnit.objectType(o),l=QUnit.objectType(E),n;if(i==="string"&&l==="regexp"){if(!E.test(o)){throw new Error(P+": actual value "+o+" does not match expected regular expression "+E);}return;}if(i!==l){throw new Error(P+": actual type "+i+" does not match expected type "+l);}if(i==="array"){if(o.length<E.length){throw new Error(P+": array length: "+o.length+" < "+E.length);}}if(i==="array"||i==="object"){for(n in E){k(o[n],E[n],P==="/"?P+n:P+"/"+n);}}else if(o!==E){throw new Error(P+": actual value "+o+" does not match expected value "+E);}}function p(o,E,i,l){try{k(o,E,"/");QUnit.assert.pushResult({result:l,actual:o,expected:E,message:i});}catch(n){QUnit.assert.pushResult({result:!l,actual:o,expected:E,message:(i||"")+" failed because of "+n.message});}}T={awaitRendering:function(){if(sap.ui.getCore().getUIDirty()){return new Promise(function(i){function l(){if(sap.ui.getCore().getUIDirty()){setTimeout(l,1);}else{i();}}l();});}},checkError:function(i,E,C,l){i.strictEqual(E.constructor,C);i.strictEqual(E.message,l);i.strictEqual(E.name,C.name);},deepContains:function(o,E,i){p(o,E,i,true);},notDeepContains:function(o,E,i){p(o,E,i,false);},useFakeServer:function(o,B,F,i,l){var n,t;function v(W,X){var Y=K(W,X.requestBody),Z=I(X);h+=1;X.respond(200,q.extend({},Z,{"Content-Type":"multipart/mixed;boundary="+Y.boundary}),E(Y,Z));}function w(W){var X={buildResponse:W.buildResponse,code:W.code||200,headers:W.headers||{},ifMatch:W.ifMatch};if(W.source){X.message=P(B+W.source);X.headers["Content-Type"]=X.headers["Content-Type"]||y(W.source);}else if(typeof W.message==="object"){X.headers["Content-Type"]=j;X.message=JSON.stringify(W.message);}else{X.message=W.message;}return X;}function x(){var W,X,Y={};for(X in F){W=F[X];if(!X.includes(" ")){X="GET "+X;}if(Array.isArray(W)){Y[X]=W.map(w);}else{Y[X]=[w(W)];}}return Y;}function y(W){if(/\.xml$/.test(W)){return"application/xml";}if(/\.json$/.test(W)){return j;}return"application/x-octet-stream";}function z(W,X,Y){L.error(X.requestLine,Y,"sap.ui.test.TestUtils");return{code:W,headers:{"Content-Type":"text/plain"},message:Y};}function C(W){return W.slice(0,W.indexOf("\r\n"));}function E(W,X){var Y=[""];W.parts.every(function(Z){Y.push(Z.boundary?"\r\nContent-Type: multipart/mixed;boundary="+Z.boundary+"\r\n\r\n"+E(Z,X):G(Z,X));return!Z.code||Z.code<400||X.DataServiceVersion==="2.0";});Y.push("--\r\n");return Y.join("--"+W.boundary);}function G(W,X){var Y=q.extend({},X,W.headers);return s+(W.contentId?"Content-ID: "+W.contentId+"\r\n":"")+"\r\nHTTP/1.1 "+W.code+" \r\n"+Object.keys(Y).map(function(Z){return Z+": "+Y[Z];}).join("\r\n")+"\r\n\r\n"+(W.message||"")+"\r\n";}function H(W,X){var Y,Z,$=W+" "+X;if(t[$]){return{responses:t[$]};}if(!n){return undefined;}Y=[];Z=n.filter(function(_){var a1=$.match(_.regExp);if(a1){Y.push(a1);}return a1;});if(Z.length>1){L.warning("Multiple matches found for "+$,undefined,"sap.ui.test.TestUtils");return undefined;}return Z.length?{responses:Z[0].response,match:Y[0]}:undefined;}function I(W){var X,Y={};for(X in W.requestHeaders){if(f.test(X)){Y[X]=W.requestHeaders[X];}}return Y;}function J(W,X){var Y,Z=H(W.method,W.url),$,_=Z&&Z.responses;_=(_||[]).filter(function($){if(typeof $.ifMatch==="function"){return $.ifMatch(W);}return!$.ifMatch||$.ifMatch.test(W.requestBody);});if(_.length){$=_[0];if(typeof $.buildResponse==="function"){$=m({},$);$.buildResponse(Z.match,$);}if(Z.responses.length>1){Y=Z.responses.indexOf($);}}else{switch(W.method){case"HEAD":$={code:200};break;case"DELETE":case"MERGE":case"PATCH":$={code:204};break;case"POST":$={code:200,headers:{"Content-Type":j},message:W.requestBody};break;}}if($){L.info(W.method+" "+W.url+(Y!==undefined?", alternative (ifMatch) #"+Y:""),'{"If-Match":'+JSON.stringify(W.requestHeaders["If-Match"])+'}',"sap.ui.test.TestUtils");}else{$=z(404,W,"No mock data found");}$.headers=q.extend({},I(W),$.headers);if(X&&$.code<300){$.contentId=X;}return $;}function K(W,X){var Y;X=X.replace(/^\s+/,"");Y=C(X);return{boundary:C(X).slice(2),parts:X.split(Y).slice(1,-1).map(function(Z){var $,_,a1,b1,c1,d1;Z=Z.slice(2);_=C(Z);if(c.test(_)){b1=K(W,Z.slice(_.length+4));$=b1.parts.filter(function(e1){return e1.code>=300;});return $.length?$[0]:b1;}d1=Z.indexOf("\r\n\r\n")+4;c1=N(W,Z.slice(d1));a1=a.exec(Z.slice(0,d1));return J(c1,a1&&a1[1]);})};}function N(W,X){var Y=X.indexOf("\r\n\r\n"),Z,$,_={requestHeaders:{}};_.requestBody=X.slice(Y+4,X.length-2);X=X.slice(0,Y);Z=X.split("\r\n");_.requestLine=Z.shift();$=e.exec(_.requestLine);if($){_.method=$[1];_.url=W+$[2];Z.forEach(function(a1){var $=b.exec(a1);if($){_.requestHeaders[$[1]]=$[2];}});}return _;}function O(W){var X=W.url;if(r.test(X)){v(X.slice(0,X.indexOf("/$batch")+1),W);}else{Q(W);}}function P(W){var X=M[W];if(!X){q.ajax({async:false,url:W,dataType:"text",success:function(Y){X=Y;}});if(!X){throw new Error(W+": resource not found");}M[W]=X;}return X;}function Q(W){var X=J(W);h+=1;W.respond(X.code,X.headers,X.message);}function V(){var W,X;t=x();if(i){n=i.map(function(Y){return{regExp:Y.regExp,response:Array.isArray(Y.response)?Y.response.map(w):[w(Y.response)]};});}X=sinon.fakeServer.create();o.add(X);X.autoRespond=true;if(A){X.autoRespondAfter=parseInt(A);}X.respondWith("GET",/./,Q);X.respondWith("DELETE",/./,Q);X.respondWith("HEAD",/./,Q);X.respondWith("PATCH",/./,Q);X.respondWith("MERGE",/./,Q);X.respondWith("POST",/./,O);W=X.restore;X.restore=function(){sinon.FakeXMLHttpRequest.filters=[];W.apply(this,arguments);};sinon.xhr.supportsCORS=q.support.cors;sinon.FakeXMLHttpRequest.useFilters=true;sinon.FakeXMLHttpRequest.addFilter(function(Y,Z){var $=H(Y,Z)||(l?Z.startsWith(l)||r.test(Z):Y==="DELETE"||Y==="HEAD"||Y==="MERGE"||Y==="PATCH"||Y==="POST");return!$;});}B=sap.ui.require.toUrl(B).replace(/(^|\/)resources\/(~[-a-zA-Z0-9_.]*~\/)?/,"$1test-resources/")+"/";V();},withNormalizedMessages:function(C){var o=sinon.sandbox.create();try{var l=sap.ui.getCore(),G=l.getLibraryResourceBundle;o.stub(l,"getLibraryResourceBundle").returns({getText:function(K,n){var t=K,v=G.call(l).getText(K),i;for(i=0;i<10;i+=1){if(v.indexOf("{"+i+"}")>=0){t+=" "+(i>=n.length?"{"+i+"}":n[i]);}}return t;}});C.apply(this);}finally{o.verifyAndRestore();}},isRealOData:function(){if(R==="proxy"){throw new Error("realOData=proxy is no longer supported");}return g;},isSupportAssistant:function(){return S;},getRealOData:function(){return R?"&realOData="+R:"";},getRequestCount:function(){return h;},proxy:function(i){L.warning("#proxy is no longer supported",null,"sap.ui.test.TestUtils");return i;},resetRequestCount:function(){h=0;},retrieveData:function(K){var v=D[K];delete D[K];return v;},setData:function(K,v){D[K]=v;},setupODataV4Server:function(o,F,i,l,n){var t={};if(this.isRealOData()){return;}if(!l){l="/";}else if(l.slice(-1)!=="/"){l+="/";}Object.keys(F).forEach(function(v){var w=d.exec(v),x,y;if(w){x=w[1]||"GET";y=w[2];}else{x="GET";y=v;}if(!y.startsWith("/")){y=l+y;}t[x+" "+y]=F[v];});T.useFakeServer(o,i||"sap/ui/core/qunit/odata/v4/data",t,n,l!=="/"?l:undefined);}};return T;},true);
