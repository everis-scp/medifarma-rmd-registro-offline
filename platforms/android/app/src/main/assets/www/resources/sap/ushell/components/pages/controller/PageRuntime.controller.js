//Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/library","sap/ushell/library","sap/ui/core/mvc/Controller","sap/ui/events/KeyCodes","sap/m/GenericTile","sap/ushell/resources","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/m/library","sap/m/MessageToast","sap/ushell/components/pages/StateManager","sap/ushell/EventHub","sap/ushell/utils","sap/m/Button","sap/base/strings/capitalize","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ushell/components/pages/controller/PagesAndSpaceId","sap/ushell/components/pages/MyHomeImport","sap/ui/thirdparty/hasher"],function(c,u,C,K,G,r,J,a,l,M,s,E,U,B,b,F,d,P,e,h){"use strict";var I=c.InvisibleMessageMode;var L=l.LoadState;var D=u.DisplayFormat;return C.extend("sap.ushell.components.pages.controller.Pages",{onInit:function(){this._oVisualizationInstantiationServicePromise=sap.ushell.Container.getServiceAsync("VisualizationInstantiation");this._oURLParsingService=sap.ushell.Container.getServiceAsync("URLParsing");this._oViewSettingsModel=new J({sizeBehavior:a.last("/core/home/sizeBehavior"),actionModeActive:false,showHideButton:a.last("/core/catalog/enableHideGroups"),showAddButton:a.last("/core/catalog/enabled"),personalizationEnabled:a.last("/core/shell/enablePersonalization"),showPageTitle:false});this.getView().setModel(this._oViewSettingsModel,"viewSettings");this._aConfigListeners=a.on("/core/home/sizeBehavior").do(function(S){this._oViewSettingsModel.setProperty("/sizeBehavior",S);}.bind(this));this._oErrorPageModel=new J({icon:"sap-icon://documents",text:"",description:"",details:""});this.getView().setModel(this._oErrorPageModel,"errorPage");this.oInitFinishedPromise=Promise.all([this._oVisualizationInstantiationServicePromise,this.getOwnerComponent().getPagesService()]).then(function(S){this._oVisualizationInstantiationService=S[0];this.getView().setModel(S[1].getModel());}.bind(this));this.sCurrentTargetPageId="";this._openFLPPage();var R=sap.ushell.Container.getRenderer();this.oContainerRouter=R.getRouter();this.oContainerRouter.getRoute("home").attachMatched(this._onPageComponentNavigation,this);this.oContainerRouter.getRoute("openFLPPage").attachMatched(this._onPageComponentNavigation,this);this.bIsHomeIntentRootIntent=U.isFlpHomeIntent(R.getShellConfig().rootIntent);this.oErrorPage=this.byId("errorPage");this.oPagesNavContainer=this.byId("pagesNavContainer");this.oPagesRuntimeNavContainer=this.byId("pagesRuntimeNavContainer");s.init(this.oPagesRuntimeNavContainer,this.oPagesNavContainer);this.oEventHubListener=E.once("PagesRuntimeRendered").do(this._onFirstPageRendering.bind(this));this._oEventBus=sap.ui.getCore().getEventBus();this._oEventBus.subscribe("launchpad","shellFloatingContainerIsDocked",this._handleUshellContainerDocked,this);this._oEventBus.subscribe("launchpad","shellFloatingContainerIsUnDocked",this._handleUshellContainerDocked,this);this.oVisualizationInstantiationListener=E.on("VizInstanceLoaded").do(function(){this._setPerformanceMark();if(!this.oVisualizationInstantiationListenerTimeout){this.oVisualizationInstantiationListenerTimeout=setTimeout(function(){this.oVisualizationInstantiationListener.off();}.bind(this),5000);}}.bind(this));},_onFirstPageRendering:function(){var p=a.last("/core/shell/enablePersonalization");var m=a.last("/core/spaces/myHome/userEnabled")&&a.last("/core/spaces/myHome/enabled");if(p){this._createActionModeButton();}else if(m){sap.ushell.Container.getServiceAsync("Menu").then(function(o){return o.getMyHomeSpace();}).then(function(H){if(!H||!H.pages.length){return;}var f=H.pages[0].title;this._createActionModeButton(f);}.bind(this));}E.emit("firstSegmentCompleteLoaded",true);},_onPageComponentNavigation:function(){this._removeMyHomePage();this._openFLPPage();var A=sap.ui.getCore().byId("ActionModeBtn");if(A&&!this.bIsHomeIntentRootIntent){var R=sap.ushell.Container.getRenderer("fiori2");if(R.getShellConfig().moveEditHomePageActionToShellHeader){R.showHeaderEndItem(A.getId(),true);}else{R.showActionButton(A.getId(),true);}}},_setPerformanceMark:function(){U.setPerformanceMark("FLP-TTI-Homepage",{bUseUniqueMark:true,bUseLastMark:true});},_openFLPPage:function(){var p,S;return P._getPageAndSpaceId().then(function(i){p=i.pageId;S=i.spaceId;this.sCurrentTargetPageId=p;this.sCurrentTargetSpaceId=S;return Promise.all([this.oInitFinishedPromise,sap.ushell.Container.getServiceAsync("Menu")]).then(function(R){var m=R[1];return m.isSpacePageAssigned(S,p);}).then(function(A){if(!A){return Promise.reject("The combination of space and page is not assgined to the user.");}return this.getOwnerComponent().getPagesService();}.bind(this)).then(function(f){return f.loadPage(p);}).then(function(){this._showActionModeButton();if(this.sCurrentTargetPageId===p){if(this._isMyHomeRouteActive()){this._oViewSettingsModel.setProperty("/personalizationEnabled",true);if(this._isMyHomePageEmpty()){return this._navigateToInitialMyHome();}}else{this._oViewSettingsModel.setProperty("/personalizationEnabled",a.last("/core/shell/enablePersonalization"));}return this._navigate(p,S);}return Promise.resolve();}.bind(this)).then(this._notifyOnPageRuntimeRendered).catch(function(f){if(f instanceof Error){this._oErrorPageModel.setProperty("/text",r.i18n.getText("PageRuntime.GeneralError.Text"));}else{var g=r.i18n.getText("PageRuntime.CannotLoadPage.Description")+JSON.stringify(f);this._oErrorPageModel.setProperty("/icon","sap-icon://documents");this._oErrorPageModel.setProperty("/text",r.i18n.getText("PageRuntime.CannotLoadPage.Text",[p,S]));this._oErrorPageModel.setProperty("/description","");this._oErrorPageModel.setProperty("/details",g);}this.oPagesRuntimeNavContainer.to(this.oErrorPage);this._hideActionModeButton();this._cancelActionMode();this._notifyOnPageRuntimeRendered();}.bind(this));}.bind(this)).catch(this._onError.bind(this));},_onError:function(f){this._oErrorPageModel.setProperty("/icon","sap-icon://documents");this._oErrorPageModel.setProperty("/text",f||"");this._oErrorPageModel.setProperty("/description","");this._oErrorPageModel.setProperty("/details","");this.oPagesRuntimeNavContainer.to(this.oErrorPage);this._hideActionModeButton();this._cancelActionMode();this._notifyOnPageRuntimeRendered();},_navigate:function(t,f,k){var p=this.oPagesNavContainer.getPages().find(function(o){return t===o.data("pageId");});if(!p){return Promise.reject();}return sap.ushell.Container.getServiceAsync("Menu").then(function(m){m.hasMultiplePages(f).then(function(H){var S=this.oPagesNavContainer.getCurrentPage()===p;this._oViewSettingsModel.setProperty("/showPageTitle",H);this.oPagesNavContainer.to(p);this.oPagesRuntimeNavContainer.to(this.oPagesNavContainer);if(!S&&!k){this._cancelActionMode();}}.bind(this));m.getSpaceAndPageTitles(f,t).then(function(T){var S={pageTitle:T.pageTitle,spaceTitle:T.spaceTitle,hash:h.getHash()};a.emit("/core/shell/model/currentSpaceAndPage",S);});}.bind(this));},_navigateToInitialMyHome:function(){if(!this._pLoadMyHomeView){this._pLoadMyHomeView=new Promise(function(f,g){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(X){X.create({id:"sapUshellMyHomePage",viewName:"sap.ushell.components.pages.view.MyHomeStart"}).then(function(p){p.getController().connect({onEdit:this.pressActionModeButton.bind(this),onOpenDialog:this.openMyHomeImportDialog.bind(this)});f(p);}.bind(this)).catch(g);}.bind(this),g);}.bind(this));}return this._pLoadMyHomeView.then(function(p){this._cancelActionMode();this.oPagesNavContainer.insertPage(p,0);this.oPagesNavContainer.to(p);}.bind(this));},_notifyOnPageRuntimeRendered:function(){E.emit("PagesRuntimeRendered");if(E.last("AppRendered")!==undefined){E.emit("AppRendered",undefined);}},_pressViewDetailsButton:function(){var f=this._oErrorPageModel.getProperty("/details")||"";this._oErrorPageModel.setProperty("/description",f);},_copyToClipboard:function(){var t=document.createElement("textarea");try{t.contentEditable=true;t.readonly=false;t.textContent=this._oErrorPageModel.getProperty("/description");document.documentElement.appendChild(t);t.select();document.execCommand("copy");M.show(r.i18n.getText("PageRuntime.CannotLoadPage.CopySuccess"),{closeOnBrowserNavigation:false});}catch(o){M.show(r.i18n.getText("PageRuntime.CannotLoadPage.CopyFail"),{closeOnBrowserNavigation:false});}finally{t.parentNode.removeChild(t);}},_visualizationFactory:function(i,f){if(this._oVisualizationInstantiationService){var o=f.getObject();var p=f.getPath();var S=p.replace(/\/visualizations\/\d*\/?$/,"");var g=f.getModel().getProperty(S);var v=this._oVisualizationInstantiationService.instantiateVisualization(o);v.attachPress(this.onVisualizationPress,this);v.bindEditable("viewSettings>/actionModeActive");if(!g.default){this._addTileActions(v);}var j=f.getPath().split("/")[2];var A=!!s.getPageVisibility("/pages/"+j);v.setActive(A);return v;}return new G({state:L.Failed});},_addTileActions:function(v){var A=v.getAvailableDisplayFormats();for(var i=0;i<A.length;i++){v.addTileAction(new B({text:"{i18n>VisualizationInstance.ConvertTo"+b(A[i])+"Action}",press:[A[i],this._updateVisualizationDisplayFormat,this]}));}v.addTileAction(new B({text:"{i18n>moveTileDialog_action}",press:[v,this._openMoveVisualizationDialog,this]}));},_openMoveVisualizationDialog:function(o,v){this._oVizInstanceToBeMoved=v;var V=v.getBindingContext().getPath();var f=V.split("/");var g="/pages/"+f[2]+"/sections";if(!this._oMoveVisualizationDialog){sap.ui.require(["sap/ui/core/Fragment"],function(i){i.load({name:"sap.ushell.components.pages.MoveVisualization",controller:this}).then(function(j){this._oMoveVisualizationDialog=j;this.getView().addDependent(j);j.bindObject({path:g});j.open();}.bind(this));}.bind(this));}else{this._oMoveVisualizationDialog.bindObject({path:g});this._oMoveVisualizationDialog.open();}},_confirmSelect:function(o){var f=new F("default",d.EQ,false);var i=o.getSource().getBinding("items");i.filter([f]);var v=this._oVizInstanceToBeMoved.getBindingContext().getPath();var V=v.split("/");var p=V[2];var g=V[4];var j=V[6];var t=o.getParameter("selectedItem").getBindingContext().getPath();var T=t.split("/");var k=T[4];var S=this._getAncestorControl(this._oVizInstanceToBeMoved,"sap.ushell.ui.launchpad.Section");var m=this._getAncestorControl(this._oVizInstanceToBeMoved,"sap.ushell.ui.launchpad.Page");var n=m.getSections();var q=n[k];var A=S.getItemPosition(this._oVizInstanceToBeMoved).area;this._oVizInstanceToBeMoved=null;var w=this.getOwnerComponent();return w.getPagesService().then(function(x){return x.moveVisualization(p,g,j,k,-1);}).then(function(R){var x=q.getVisualizations()[R.visualizationIndex];if(x){q.focusVisualization(x);}var y=this._getVizMoveAnnouncement(A,A);w.getInvisibleMessageInstance().announce(y,I.Polite);}.bind(this));},_onMoveTileSearch:function(o){var v=o.getParameter("value");var f=new F("title",d.Contains,v);var g=new F("default",d.EQ,false);var i=o.getParameter("itemsBinding");i.filter([f,g]);},_onMoveTileDialogClose:function(o){this._oVizInstanceToBeMoved=null;var f=new F("default",d.EQ,false);o.getSource().getBinding("items").filter([f]);},_updateVisualizationDisplayFormat:function(o,n){var f=o.getSource().getBindingContext();var p=f.getPath();var g=p.split("/");var O;var i=this.getOwnerComponent();return i.getPagesService().then(function(j){O=j.getModel().getProperty(p).displayFormatHint;var v={displayFormatHint:n};return j.updateVisualization(g[2],g[4],g[6],v);}).then(function(){var j=this._getVizMoveAnnouncement(O,n);i.getInvisibleMessageInstance().announce(j,I.Polite);}.bind(this));},onVisualizationPress:function(o){var S=o.getParameter("scope");var A=o.getParameter("action");var v=o.getSource();var f=v.getBindingContext();var p=f.getPath();var g=p.split("/");var i=this._getAncestorControl(v,"sap.ushell.ui.launchpad.Section");if(S==="Actions"&&A==="Remove"){return this.getOwnerComponent().getPagesService().then(function(j){var O=i.getItemPosition(v);j.deleteVisualization(g[2],g[4],g[6]);M.show(r.i18n.getText("PageRuntime.MessageToast.TileRemoved"));i._focusItem(O);});}return Promise.resolve();},onExit:function(){this.oContainerRouter.getRoute("home").detachMatched(this._onPageComponentNavigation,this);this.oContainerRouter.getRoute("openFLPPage").detachMatched(this._onPageComponentNavigation,this);this._aConfigListeners.off();this.oEventHubListener.off();this._oEventBus.unsubscribe("launchpad","shellFloatingContainerIsDocked",this._handleUshellContainerDocked,this);this._oEventBus.unsubscribe("launchpad","shellFloatingContainerIsUnDocked",this._handleUshellContainerDocked,this);s.exit();var A=sap.ui.getCore().byId("ActionModeBtn");if(A){A.destroy();}},_hideActionModeButton:function(){var A=sap.ui.getCore().byId("ActionModeBtn");if(A){A.setVisible(false);}},_showActionModeButton:function(){var A=sap.ui.getCore().byId("ActionModeBtn");if(A){A.setVisible(true);}},_createActionModeButton:function(p){var f=p?r.i18n.getText("PageRuntime.EditModeForPage.Activate",p):r.i18n.getText("PageRuntime.EditMode.Activate");var A={id:"ActionModeBtn",text:f,tooltip:f,icon:"sap-icon://edit",press:[this.pressActionModeButton,this]};var R=sap.ushell.Container.getRenderer("fiori2");var m=R.getShellConfig().moveEditHomePageActionToShellHeader;if(m){this._createHeaderActionModeButton(A);}else{this._createUserActionModeButton(A);}},_createHeaderActionModeButton:function(A){sap.ui.require(["sap/ushell/ui/shell/ShellHeadItem"],function(S){var o=new S(A);if(a.last("/core/extension/enableHelp")){o.addStyleClass("help-id-ActionModeBtn");}var R=sap.ushell.Container.getRenderer("fiori2");if(this.bIsHomeIntentRootIntent){R.showHeaderEndItem(o.getId(),false,["home"]);}else{R.showHeaderEndItem(o.getId(),true);}}.bind(this));},_createUserActionModeButton:function(A){var o={controlType:"sap.ushell.ui.launchpad.ActionItem",oControlProperties:A,bIsVisible:true,aStates:["home"]};if(!this.bIsHomeIntentRootIntent){o.aStates=null;o.bCurrentState=true;}sap.ushell.Container.getRenderer("fiori2").addUserAction(o).done(function(f){if(a.last("/core/extension/enableHelp")){f.addStyleClass("help-id-ActionModeBtn");}});},pressActionModeButton:function(){var v=this.getView().getModel("viewSettings");var A=v.getProperty("/actionModeActive");var p=v.getProperty("/personalizationEnabled");sap.ui.require(["sap/ushell/components/pages/ActionMode"],function(f){if(A){f.cancel();return;}else if(p||this._isMyHomeRouteActive()){f.start(this);}else{this.oPagesNavContainer.attachEventOnce("afterNavigate",function(){f.start(this);}.bind(this));this.oContainerRouter.navTo("home");}}.bind(this));},_cancelActionMode:function(){var A=this.getView().getModel("viewSettings").getProperty("/actionModeActive");if(A){sap.ui.require(["sap/ushell/components/pages/ActionMode"],function(f){f.cancel();});}},handleEditModeAction:function(H,o,S,p){sap.ui.require(["sap/ushell/components/pages/ActionMode"],function(A){A[H](o,S,p);});},_getAncestorControl:function(f,g){if(f&&f.isA&&f.isA(g)){return f;}else if(f&&f.getParent){return this._getAncestorControl(f.getParent(),g);}return null;},moveVisualization:function(o){var f=o.getParameter("draggedControl"),g=o.getParameter("droppedControl"),i=o.getParameter("dropPosition"),j=o.getParameter("browserEvent"),k=j&&j.keyCode,p=this._getAncestorControl(f,"sap.ushell.ui.launchpad.Page"),m=parseInt(f.getBindingContext().getPath().split("/")[2],10),n=this._getAncestorControl(f,"sap.ushell.ui.launchpad.Section"),q=p.indexOfSection(n),t=n.indexOfVisualization(f),v=n.getVisualizations()[t],w=n.getItemPosition(v),T,x,y,z,A;if(!g){var H=o.mParameters.browserEvent.keyCode===K.ARROW_UP,S=p.getSections();x=q;while(true){x=H?--x:++x;T=S[x];if(!T||T.getDefault()){v.invalidate();return Promise.resolve();}if(T.getShowSection()||T.getEditable()){y=T.getClosestCompactItemIndex(f.getDomRef(),H);z=T.getVisualizations()[y];A=T.getItemPosition(z);if(A.area!==w.area){A=w;}break;}}}else{if(g.isA("sap.ushell.ui.launchpad.section.CompactArea")){var N=g.getItems();if(N.length){g=N[N.length-1];i="After";}}T=this._getAncestorControl(g,"sap.ushell.ui.launchpad.Section");x=p.indexOfSection(T);if(T.getDefault()&&!n.getDefault()){v.invalidate();return Promise.resolve();}y=T.indexOfVisualization(g);z=T.getVisualizations()[y];A=T.getItemPosition(z);if(A.index===-1){A.area=w.area;}if(q===x){if(i==="Before"&&t<y){y--;}else if(i==="After"&&t>y){y++;}if(t===y&&A.area===w.area){v.invalidate();return Promise.resolve();}}else if(i==="After"){y++;}}if((q!==x)&&(k===K.ARROW_UP||k===K.ARROW_DOWN)&&(w.index>A.index)){y++;}var O;var Q=this.getOwnerComponent();return Q.getPagesService().then(function(R){O=R;O.enableImplicitSave(false);return O.moveVisualization(m,q,t,x,y);}).then(function(R){y=R.visualizationIndex;if(w.area!==A.area){var V={displayFormatHint:A.area};return O.updateVisualization(m,x,y,V);}return Promise.resolve();}).then(function(){return O.savePersonalization();}).then(function(){var V=T.getVisualizations()[y];if(V){T.focusVisualization(V);V.invalidate();}var R=this._getVizMoveAnnouncement(w.area,A.area);Q.getInvisibleMessageInstance().announce(R,I.Polite);}.bind(this)).finally(function(){O.enableImplicitSave(true);});},_getVizMoveAnnouncement:function(f,t){if(f===t){if(t===D.Compact){return r.i18n.getText("PageRuntime.Message.LinkMoved");}return r.i18n.getText("PageRuntime.Message.TileMoved");}else if(f===D.Compact){return r.i18n.getText("PageRuntime.Message.LinkConverted");}return r.i18n.getText("PageRuntime.Message.TileConverted");},onDragEnter:function(o){var t=o.getParameter("dragSession").getDropControl();if(t.getDefault()){o.preventDefault();}},onAreaDragEnter:function(o){var S=o.getParameter("sourceArea");var t=o.getParameter("targetArea");if(S===t){return;}var v=o.getParameter("dragControl");var A=v.getAvailableDisplayFormats();if(A.indexOf(t)===-1){if(t===D.Standard&&A.indexOf(D.StandardWide)>-1){return;}if(t===D.Flat&&A.indexOf(D.FlatWide)>-1){return;}o.getParameter("originalEvent").preventDefault();}},_handleUshellContainerDocked:function(f,g){this._oViewSettingsModel.setProperty("/ushellContainerDocked",g==="shellFloatingContainerIsDocked");},_isMyHomeRouteActive:function(){return a.last("/core/spaces/myHome/enabled")&&a.last("/core/spaces/myHome/userEnabled")&&a.last("/core/spaces/myHome/myHomeSpaceId")===this.sCurrentTargetSpaceId;},_getMyHomePageData:function(){var p=this.getView().getModel().getProperty("/pages")||[];for(var i=0;i<p.length;i++){if(p[i]&&p[i].id==="SAP_BASIS_PG_UI_MYHOME"){return p[i];}}return null;},_isMyHomePageEmpty:function(){var p=this._getMyHomePageData();if(p&&p.sections){return p.sections.every(function(S){var v=S.visualizations;return!(v&&v.length);});}return false;},handleMyHomeActionMode:function(f){if(this._isMyHomeRouteActive()){if(f){return this._enterMyHomeActionMode();}else if(this._isMyHomePageEmpty()){return this._navigateToInitialMyHome();}}return Promise.resolve();},_enterMyHomeActionMode:function(){return Promise.all([this._navigate(this.sCurrentTargetPageId,this.sCurrentTargetSpaceId,true),e.isImportEnabled()]).then(function(R){if(!R[1]){if(this._pMessageStrip){this._pMessageStrip.then(function(m){m.setVisible(false);});}return Promise.resolve();}if(!this._pMessageStrip){this._pMessageStrip=new Promise(function(f,g){sap.ui.require(["sap/ui/core/Fragment"],function(i){i.load({name:"sap.ushell.components.pages.view.MessageStrip",controller:this}).then(function(m){E.on("importBookmarksFlag").do(function(v){m.setVisible(!!v);});m.addStyleClass("sapUiSmallMarginBottom");f(m);}).catch(g);}.bind(this),g);}.bind(this));}return this._pMessageStrip.then(function(m){this.oPagesNavContainer.getCurrentPage().getContent()[0].setMessageStrip(m);}.bind(this));}.bind(this));},openMyHomeImportDialog:function(){if(!this._pLoadImportDialog){this._pLoadImportDialog=new Promise(function(f,g){sap.ui.require(["sap/ushell/components/pages/controller/ImportDialog.controller"],function(i){f(new i());},g);});}return this._pLoadImportDialog.then(function(i){return i.open();});},onImportDialogPress:function(){this.openMyHomeImportDialog();},onMessageStripClose:function(){e.setImportEnabled(false);sap.ui.require(["sap/m/MessageBox"],function(f){f.information(r.i18n.getText("MyHome.InitialPage.MessageStrip.Popup"));});},_removeMyHomePage:function(){this.oPagesNavContainer.removePage("sapUshellMyHomePage");},_sectionEnableReset:function(f,p){if(f===a.last("/core/spaces/myHome/presetSectionId")){return false;}return p;},_sectionEnableDelete:function(f,p){if(f===a.last("/core/spaces/myHome/presetSectionId")){return false;}return!p;}});});
