/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){var a=(this&&this.__extends)||(function(){var e=function(d,b){e=Object.setPrototypeOf||({__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b;})||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p];};return e(d,b);};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");e(d,b);function _(){this.constructor=d;}d.prototype=b===null?Object.create(b):(_.prototype=b.prototype,new _());};})();var c=(this&&this.__awaiter)||function(t,_,P,g){function b(v){return v instanceof P?v:new P(function(r){r(v);});}return new(P||(P=Promise))(function(r,d){function f(v){try{s(g.next(v));}catch(e){d(e);}}function i(v){try{s(g["throw"](v));}catch(e){d(e);}}function s(e){e.done?r(e.value):b(e.value).then(f,i);}s((g=g.apply(t,_||[])).next());});};var h=(this&&this.__generator)||function(b,d){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1];},trys:[],ops:[]},f,y,t,g;return g={next:i(0),"throw":i(1),"return":i(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this;}),g;function i(n){return function(v){return s([n,v]);};}function s(o){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=o[0]&2?y["return"]:o[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,o[1])).done)return t;if(y=0,t)o=[o[0]&2,t.value];switch(o[0]){case 0:case 1:t=o;break;case 4:_.label++;return{value:o[1],done:false};case 5:_.label++;y=o[1];o=[0];continue;case 7:o=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(o[0]===6||o[0]===2)){_=0;continue;}if(o[0]===3&&(!t||(o[1]>t[0]&&o[1]<t[3]))){_.label=o[1];break;}if(o[0]===6&&_.label<t[1]){_.label=t[1];t=o;break;}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(o);break;}if(t[2])_.ops.pop();_.trys.pop();continue;}o=d.call(b,_);}catch(e){o=[6,e];y=0;}finally{f=t=0;}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true};}};sap.ui.define(["require","exports","../../core/ajax","../../core/core","./MetadataParserXML","./MetadataParserJson","./ItemParser","./FacetParser","./suggestionParser","./eshObjects/src/index","./conditionSerializerEshObj","../../core/Log","../../sina/SearchQuery","../../sina/SortOrder","../AbstractProvider","../../sina/SuggestionType","../../sina/ComplexCondition","../../core/errors","./HierarchyParser"],function(r,e,b,d,M,f,I,F,s,g,k,L,S,l,A,m,C,n,H){"use strict";Object.defineProperty(e,"__esModule",{value:true});e.Provider=void 0;var P=(function(_){a(P,_);function P(){var i=_!==null&&_.apply(this,arguments)||this;i.id="hana_odata";return i;}P.prototype._initAsync=function(i){var j,o;return c(this,void 0,void 0,function(){var p,q;return h(this,function(t){switch(t.label){case 0:this.requestPrefix=i.url;this.odataVersion=i.odataVersion;this.sina=i.sina;this.querySuffix=this.convertQuerySuffixToExpression(i.querySuffix);this.metaDataSuffix=(j=i.metaDataSuffix)!==null&&j!==void 0?j:"";this.ajaxClient=(o=i.ajaxClient)!==null&&o!==void 0?o:new b.Client({csrf:false,});p=i.metaDataJsonType;if(p){this.metadataParser=new f.MetadataParserJson(this);}else{this.metadataParser=new M.MetadataParserXML(this);}this.itemParser=new I.ItemParser(this);this.facetParser=new F.FacetParser(this);this.suggestionParser=new s.SuggestionParser(this);q=this;return[4,this.loadServerInfo()];case 1:q.serverInfo=t.sent();if(!this.supports("Search")){throw new n.ESHNotActiveError();}return[4,this.loadBusinessObjectDataSources()];case 2:t.sent();if(this.sina.dataSources.length===0){return[2,Promise.reject(new n.ESHNotActiveError("Enterprise Search is not active - no datasources"))];}return[2,{capabilities:this.sina._createCapabilities({fuzzy:false,}),}];}});});};P.prototype.supports=function(i,o){var p=this.serverInfo.services;for(var q in p){if(q===i){if(!o){return true;}var t=p[q].Capabilities;for(var j=0;j<t.length;++j){var u=t[j];if(u===o){return true;}}}}return false;};P.prototype.loadServerInfo=function(){return c(this,void 0,void 0,function(){var i;return h(this,function(j){i={rawServerInfo:{Services:[{Service:"Search",Capabilities:[{Capability:"SemanticObjectType",},],},{Service:"Suggestions2",Capabilities:[{Capability:"ScopeTypes",},],},],},services:{Suggestions:{suggestionTypes:["objectdata"],},Search:{capabilities:["SemanticObjectType"],},},};return[2,i];});});};P.prototype._prepareMetadataRequest=function(){var i={metadataCall:true,resourcePath:this.getPrefix()+"/$metadata",};if(typeof this.metaDataSuffix==="string"&&this.metaDataSuffix.length>0){if(this.metaDataSuffix.startsWith("/EntitySets")){this.metaDataSuffix=this.metaDataSuffix.replace(/\/EntitySets\(/,"");this.metaDataSuffix=this.metaDataSuffix.substring(0,this.metaDataSuffix.length-1);}i.metadataObjects={entitySets:this.metaDataSuffix,};}return g.getEshSearchQuery(i);};P.prototype.loadBusinessObjectDataSources=function(){return c(this,void 0,void 0,function(){var j,o,p,i,q;return h(this,function(t){switch(t.label){case 0:j=this._prepareMetadataRequest();return[4,this.metadataParser.fireRequest(this.ajaxClient,j)];case 1:o=t.sent();return[4,this.metadataParser.parseResponse(o)];case 2:p=t.sent();for(i=0;i<p.dataSourcesList.length;++i){q=p.dataSourcesList[i];this.metadataParser.fillMetadataBuffer(q,p.businessObjectMap[q.id]);}return[2];}});});};P.prototype.assembleOrderBy=function(q){var j=[];if(Array.isArray(q.sortOrder)){for(var i=0;i<q.sortOrder.length;++i){var o=q.sortOrder[i];var p=o.order===l.SortOrder.Descending?g.ESOrderType.Descending:g.ESOrderType.Ascending;j.push({key:o.id,order:p,});}}return j;};P.prototype.assembleGroupBy=function(q){var i=null;if(q.groupBy&&q.groupBy.attributeName&&q.groupBy.attributeName.length>0){i.properties=q.groupBy.attributeName;if(q.groupBy.aggregateCountAlias&&q.groupBy.aggregateCountAlias!==""){i.aggregateCountAlias=q.groupBy.aggregateCountAlias;}}return i;};P.prototype.executeSearchQuery=function(q){var u=this._prepareSearchObjectSuggestionRequest(q);return this._fireSearchQuery(u);};P.prototype._prepareSearchObjectSuggestionRequest=function(q){var i=q.filter.rootCondition.clone();var j=k.serialize(q.filter.dataSource,i);if(!Array.isArray(j.items)){j.items=[];}var o=q.filter.searchTerm;if(this.querySuffix){j.items.push(this.querySuffix);}var p=q.filter.dataSource;var t=q.top||10;var u=q.skip||0;var v=this.assembleOrderBy(q);var w={resourcePath:this.getPrefix()+"/$all",$top:t,$skip:u,whyfound:true,$count:true,$orderby:v,freeStyleText:o,searchQueryFilter:j,};if(p!==this.sina.getAllDataSource()){w.scope=p.id;}if(q instanceof S.SearchQuery){if(q.calculateFacets){w.facets=["all"];w.facetlimit=q.facetTop||5;}var x=this.assembleGroupBy(q);if(x){w.groupby=x;w.whyfound=false;}}var y={url:g.getEshSearchQuery(w),query:q,};return y;};P.prototype._fireSearchQuery=function(i){return c(this,void 0,void 0,function(){var j,o,p,q,t;return h(this,function(u){switch(u.label){case 0:return[4,this.ajaxClient.getJson(i.url)];case 1:j=u.sent();this.metadataParser.parseDynamicMetadata(j);return[4,this.itemParser.parse(i.query,j.data)];case 2:o=u.sent();q=j.data["@com.sap.vocabularies.Search.v1.SearchStatistics"].ConnectorStatistics;if(!(i.query.getDataSource()===this.sina.getAllDataSource()&&q&&Array.isArray(q)&&q.length===1))return[3,4];t=[{"@com.sap.vocabularies.Search.v1.Facet":{PropertyName:"scope",isConnectorFacet:true,},Items:[{scope:q[0].OdataID,_Count:j.data["@odata.count"],},],},];return[4,this.facetParser.parse(i.query,t)];case 3:p=u.sent();return[3,6];case 4:return[4,this.facetParser.parse(i.query,j.data)];case 5:p=u.sent();u.label=6;case 6:return[2,this.sina._createSearchResultSet({title:"Search Result List",query:i.query,items:o,totalCount:j.data["@odata.count"]||0,facets:p,})];}});});};P.prototype._fireObjectSuggestionsQuery=function(i){return c(this,void 0,void 0,function(){var j,o;return h(this,function(p){switch(p.label){case 0:return[4,this.ajaxClient.getJson(i.url)];case 1:j=p.sent();this.metadataParser.parseDynamicMetadata(j);return[4,this.itemParser.parse(i.query,j.data)];case 2:o=p.sent();return[2,this.suggestionParser.parseObjectSuggestions(i.query,o)];}});});};P.prototype._prepareChartQueryRequest=function(q,i,j){var o=q.filter.searchTerm;var p=q.filter.dataSource;var t=15;var u=j.deleted||false;var v=k.serialize(p,i);if(!Array.isArray(v.items)){v.items=[];}var w=q.top||5;if(u===true){if(!j.value||j.value===""||j.value.match(/^[*\s]+$/g)!==null){j.value="*";v.items.push(new g.Comparison({property:j.attribute,operator:g.SearchQueryComparisonOperator.Search,value:new g.Term({term:"*"}),}));}else{v.items.push(new g.Comparison({property:j.attribute,operator:g.SearchQueryComparisonOperator.EqualCaseInsensitive,value:new g.Phrase({phrase:j.value+"*",}),}));}}if(this.querySuffix){v.items.push(this.querySuffix);}var x={resourcePath:this.getPrefix()+"/$all",$top:0,$count:true,searchQueryFilter:v,freeStyleText:o,};if(p!==this.sina.getAllDataSource()){x.scope=p.id;}var y=[];x.facetlimit=w;if(q.dimension){y.push(q.dimension);var z=q.filter.dataSource.getAttributeMetadata(q.dimension);if(z&&(z.type==="Double"||z.type==="Integer")&&w>=20){x.facetlimit=t;}}x.facets=y;return g.getEshSearchQuery(x);};P.prototype.executeChartQuery=function(q){var i=new L.Log();var j=q.filter.rootCondition.clone();var o=j.removeAttributeConditions(q.dimension);var u=this._prepareChartQueryRequest(q,j,o);return this.ajaxClient.getJson(u).then(function(p){var t=this.facetParser.parse(q,p.data,i);return t;}.bind(this)).then(function(p){if(p.length>0){return p[0];}var t="";var v=q.filter.dataSource.getAttributeMetadata(q.dimension);if(v&&v.label){t=v.label;}return this.sina._createChartResultSet({title:t,items:[],query:q,log:i,});}.bind(this));};P.prototype.executeHierarchyQuery=function(q){return c(this,void 0,void 0,function(){var i,j,o,p,t,u,v;return h(this,function(w){switch(w.label){case 0:i=new H.HierarchyParser();j=k.serialize(q.filter.dataSource,q.filter.rootCondition);if(!Array.isArray(j.items)){j.items=[];}if(this.querySuffix){j.items.push(this.querySuffix);}o=g.getEshSearchQuery({resourcePath:this.getPrefix()+"/$all",$top:0,searchQueryFilter:j,freeStyleText:q.filter.searchTerm,scope:q.filter.dataSource.id,facets:[q.attributeId],facetroot:[new g.HierarchyFacet({facetColumn:q.attributeId,rootIds:[q.nodeId],levels:1}),],});return[4,this.ajaxClient.getJson(o)];case 1:p=w.sent();t=q.filter.dataSource.getAttributeMetadata(q.attributeId);u=p.data["@com.sap.vocabularies.Search.v1.Facets"];v=u.find(function(v){var x=d.getProperty(v,["@com.sap.vocabularies.Search.v1.Facet","Dimensions",0,"PropertyName",]);return x===q.attributeId;});return[2,i.parseHierarchyFacet(q,t,v)];}});});};P.prototype.executeSuggestionQuery=function(q){return c(this,void 0,void 0,function(){return h(this,function(i){return[2,Promise.all([this.executeRegularSuggestionQuery(q),this.executeObjectSuggestionQuery(q),]).then(function(j){var o=[];o.push.apply(o,j[1]);o.push.apply(o,j[0]);return this.sina._createSuggestionResultSet({title:"Suggestions",query:q,items:o,});}.bind(this))];});});};P.prototype.isObjectSuggestionQuery=function(q){return(q.types.indexOf(m.SuggestionType.Object)>=0&&q.filter.dataSource.type===q.sina.DataSourceType.BusinessObject);};P.prototype.executeObjectSuggestionQuery=function(q){return c(this,void 0,void 0,function(){var u;return h(this,function(i){switch(i.label){case 0:if(!this.isObjectSuggestionQuery(q)){return[2,Promise.resolve([])];}return[4,this._prepareSearchObjectSuggestionRequest(q)];case 1:u=i.sent();return[2,this._fireObjectSuggestionsQuery(u)];}});});};P.prototype.executeRegularSuggestionQuery=function(q){var o={SearchTerm:{Data:"SuggestObjectData",History:"SuggestSearchHistory",},Object:{},DataSource:{Data:"SuggestDataSources",},};var p=q.types;var t=q.calculationModes;var u=Promise.resolve([]);for(var i=0;i<p.length;i++){var v=p[i];for(var j=0;j<t.length;j++){var w=t[j];var x=o[v][w];switch(x){case"SuggestObjectData":return this._fireSuggestionQuery(q);default:return u;}}}};P.prototype._prepareSuggestionQueryRequest=function(q){var i=q.filter.searchTerm;var j=q.filter.dataSource;var o=q.filter.rootCondition.clone();var p=k.serialize(q.filter.dataSource,o);if(!Array.isArray(p.items)){p.items=[];}var t=q.top||10;var u=q.skip||0;if(this.querySuffix){p.items.push(this.querySuffix);}var v={suggestTerm:i,resourcePath:this.getPrefix()+"/$all",$top:t,$skip:u,searchQueryFilter:p,};if(j!==this.sina.getAllDataSource()){v.scope=j.id;}return g.getEshSearchQuery(v);};P.prototype._fireSuggestionQuery=function(q){var u=this._prepareSuggestionQueryRequest(q);return this.ajaxClient.getJson(u).then(function(i){var j=[];if(i.data.value){j=this.suggestionParser.parse(q,i.data.value);}return j;}.bind(this));};P.prototype.getPrefix=function(){var i,j;var o=(i=this.odataVersion)!==null&&i!==void 0?i:"/v20411";var p=(j=this.requestPrefix)!==null&&j!==void 0?j:"/sap/es/odata";var q=p+o;return q;};P.prototype.convertQuerySuffixToExpression=function(i){var j=null;if(i&&i instanceof C.ComplexCondition){j=k.serialize(null,i);}return j;};P.prototype.getDebugInfo=function(){return"ESH API Provider: "+this.id;};return P;}(A.AbstractProvider));e.Provider=P;});})();
